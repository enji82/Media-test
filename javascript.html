<div id="appModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div id="modalIconBox"></div><h3 id="modalTitle"></h3><p id="modalMessage"></p>
        <div class="modal-actions"><button id="modalBtnMain" class="modal-btn">OK</button></div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-icon-danger"><i class="fas fa-trash-alt"></i></div>
        <h3 class="modal-title-danger">Hapus Data</h3>
        <div class="delete-info-card"></div>
        <div class="delete-input-group" style="text-align:center; margin-top:25px;">
            <label class="delete-input-label" style="text-align:center; font-size:1.2em; margin-bottom:10px;">Masukkan Kode Konfirmasi</label>
            <input type="password" id="delCode" class="modal-input-code" maxlength="8" style="text-align:center;">
            <small style="color:#64748b; font-size:1em; margin-top:10px; display:block; text-align:center;"><i class="fas fa-info-circle"></i> Hubungi admin untuk mendapatkan kode.</small>
        </div>
        <div class="modal-actions-right" style="justify-content: center; gap: 15px;">
            <button id="cancelDeleteBtn" class="btn-md btn-outline-gray" style="min-width:100px;">Batal</button>
            <button id="confirmDeleteBtn" class="btn-md btn-solid-red" style="min-width:140px;">Ya, Hapus</button>
        </div>
    </div>
</div>

<div id="previewModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width:90%; height:90vh; padding:0; background:#333; display:flex; flex-direction:column;">
        <div style="padding:10px; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="color:#fff; margin:0; font-size:1.1em;">Pratinjau</h3>
            <button onclick="App.closePreview()" style="background:none; border:none; color:#fff; font-size:1.5em; cursor:pointer;">&times;</button>
        </div>
        <div style="flex:1; background:#fff; position:relative;">
            <iframe id="previewFrame" style="width:100%; height:100%; border:none;"></iframe>
            <div id="previewLoading" style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:rgba(255,255,255,0.8);"><div class="app-spinner"></div></div>
        </div>
    </div>
</div>

<div id="verificationModal" class="modal-overlay" style="display: none;">
    <div class="modal-content verif-box">
        <div class="verif-header"><h3>Verifikasi</h3><button onclick="document.getElementById('verificationModal').style.display='none'" class="close-btn">&times;</button></div>
        <div class="verif-body">
            <div class="verif-left"><div class="preview-container-box"><iframe id="verifPreviewFrame" src=""></iframe><div id="verifLoading" class="loader-overlay">Memuat...</div><div id="verifNoDoc" class="no-doc-overlay" style="display:none;"><i class="fas fa-file-excel"></i><p>Tidak ada dokumen</p></div></div></div>
            <div class="verif-right"><form id="verifForm"><input type="hidden" id="verifRowIndex"><div class="info-block"><label>Sekolah</label><span id="verifSekolahName">-</span></div><div class="form-group"><label>Keputusan</label><select id="verifStatus" class="std-input" style="width:100%; font-weight:bold;"><option value="Diproses">Diproses</option><option value="OK" style="color:green;">OK (Disetujui)</option><option value="Revisi" style="color:#d97706;">Revisi</option><option value="Ditolak" style="color:red;">Ditolak</option></select></div><div class="form-group" style="flex:1; display:flex; flex-direction:column;"><label>Keterangan</label><textarea id="verifKeterangan" class="std-input" style="flex:1; resize:none; padding:10px;" placeholder="Catatan..."></textarea></div><div style="margin-top:auto;"><button type="submit" class="submit-btn" style="width:100%;">SIMPAN</button></div></form></div>
        </div>
    </div>
</div>

<script>
const App = {}; 

// ===========================================
// 1. SYSTEM INIT
// ===========================================
App.init = function() {
    document.querySelectorAll('.modal-overlay').forEach(function(el) { el.style.display = 'none'; el.classList.remove('show'); });
    var userSession = localStorage.getItem('user_session');
    var sidebar = document.querySelector('.sidebar');
    var mainContent = document.getElementById('main-content');

    if (!userSession) {
        if(sidebar) sidebar.style.display = 'none';
        if(mainContent) {
            mainContent.style.marginLeft = '0'; mainContent.style.width = '100%'; mainContent.style.padding = '0';
            mainContent.style.display = 'flex'; mainContent.style.alignItems = 'center'; mainContent.style.justifyContent = 'center';
        }
        App.loadPage(null, 'login'); 
    } else {
        var user;
        try { user = JSON.parse(userSession); } catch (e) { localStorage.removeItem('user_session'); window.location.reload(); return; }
        
        var role = (user.role || '').toLowerCase();
        var isAdmin = (role === 'admin' || role === 'administrator');

        if(sidebar) sidebar.style.display = 'flex';
        if(mainContent) mainContent.removeAttribute('style'); 

        var adminMenus = document.querySelectorAll('.admin-only');
        for(var j=0; j<adminMenus.length; j++) { adminMenus[j].style.display = isAdmin ? 'block' : 'none'; }
        
        setTimeout(function() {
            var elName = document.getElementById('sidebar-user-name');
            var elRole = document.getElementById('sidebar-user-role');
            var elAvatar = document.querySelector('.user-avatar-small'); 

            if (elName) elName.textContent = user.nama || "User";
            if (elRole) elRole.textContent = user.role || "Staff";
            
            if (elAvatar && user.foto && String(user.foto).trim() !== "") {
                var imgUrl = user.foto.trim();
                if (imgUrl.indexOf('drive.google.com') !== -1 && imgUrl.indexOf('/view') !== -1) {
                    var parts = imgUrl.split('/d/');
                    if (parts.length > 1) imgUrl = 'https://drive.google.com/thumbnail?id=' + parts[1].split('/')[0] + '&sz=s1000';
                } else if (imgUrl.indexOf('http') === -1) {
                     imgUrl = 'https://drive.google.com/thumbnail?id=' + imgUrl + '&sz=s1000';
                }
                elAvatar.innerHTML = '<img src="' + imgUrl + '" alt="Profil" style="width:100%; height:100%; object-fit:cover;">';
            } else if (elAvatar) {
                elAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
        }, 50);

        // Toggle Folder Sidebar
        var parentMenus = document.querySelectorAll('.has-submenu > a');
        for(var i=0; i<parentMenus.length; i++) {
            var menu = parentMenus[i];
            var newMenu = menu.cloneNode(true);
            menu.parentNode.replaceChild(newMenu, menu);
            newMenu.addEventListener('click', function(e) {
                e.preventDefault();
                var p = this.parentElement;
                var sub = p.querySelector('.submenu');
                var icon = this.querySelector('.submenu-icon');
                p.classList.toggle('open');
                if(sub) {
                    if(p.classList.contains('open')) {
                        sub.style.maxHeight = sub.scrollHeight + "px";
                        if(icon) icon.style.transform = "rotate(90deg)";
                    } else {
                        sub.style.maxHeight = null;
                        if(icon) icon.style.transform = "rotate(0deg)";
                    }
                }
            });
        }

        // Navigasi Link
        var navLinks = document.querySelectorAll('.sidebar-menu a[data-page]');
        for(var k=0; k<navLinks.length; k++) {
            var link = navLinks[k];
            if(link.getAttribute('data-page') !== 'logout' && !link.parentElement.classList.contains('has-submenu')) {
                var newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);
                newLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    var page = this.getAttribute('data-page');
                    App.loadPage(e, page);
                });
            }
        }
        
        var logoutLink = document.querySelector('a[data-page="logout"]');
        if(logoutLink) {
            logoutLink.onclick = function(e) { e.preventDefault(); localStorage.removeItem('user_session'); location.reload(); };
        }

        var currentContent = mainContent.innerHTML.trim();
        if (!currentContent || document.getElementById('loginForm')) {
            App.loadPage(null, 'home');
        }
    }
};

App.loadPage = function(e, p, arg) {
    if(e) e.preventDefault();
    var main = document.getElementById('main-content');
    main.innerHTML = '<div class="loading-container"><div class="app-spinner"></div><div class="loading-text">Memuat Halaman...</div></div>';
    
    var menus = document.querySelectorAll('.sidebar-menu a');
    for(var i=0; i<menus.length; i++) menus[i].classList.remove('active');
    
    var cur = document.querySelector('.sidebar-menu a[data-page="' + p + '"]');
    if(cur) {
        cur.classList.add('active');
        var parentLi = cur.closest('.has-submenu');
        if(parentLi && !parentLi.classList.contains('open')) {
            var parentLink = parentLi.querySelector('a');
            if(parentLink) parentLink.click();
        }
    }

    google.script.run.withSuccessHandler(function(h) {
        main.innerHTML = h;
        if(App.inits[p]) {
            setTimeout(function() { App.inits[p](arg); }, 50);
        }
    }).withFailureHandler(function(err) {
        main.innerHTML = '<div style="color:red; text-align:center; padding:50px;">Gagal: ' + err.message + '</div>';
    }).include('page_' + p);
};

// ===========================================
// 2. TABEL ENGINE (PERBAIKAN LOGIKA TOMBOL)
// ===========================================
App.initSmartTable = function(cfg) {
    var tb = document.querySelector(`#${cfg.tableId} tbody`);
    var thd = document.querySelector(`#${cfg.tableId} thead`);
    
    if(!tb) return;

    document.getElementById('tableWrapper').style.display = 'flex';
    document.getElementById('loadingStatus').style.display = 'none';
    
    if(thd && cfg.headers) { var h='<tr><th>No.</th>'; cfg.headers.forEach(function(x){ h+='<th>'+x+'</th>'; }); thd.innerHTML=h+'</tr>'; }
    var sk=''; for(var i=0;i<10;i++) { sk+='<tr class="skeleton-row"><td></td>'; cfg.headers.forEach(function(){ sk+='<td><div class="skeleton-bar"></div></td>'; }); sk+='</tr>'; }
    tb.innerHTML = sk;

    google.script.run.withSuccessHandler(function(d) {
        if(!d || d.length===0 || d.error) { tb.innerHTML='<tr><td colspan="100" style="text-align:center;padding:20px;">'+(d.error||'Data Kosong')+'</td></tr>'; return; }
        
        var rows = d.rows || d;
        var render = function(data) {
            tb.innerHTML = '';
            data.forEach(function(r, ix) {
                var tr = document.createElement('tr');
                tr.innerHTML = '<td>'+(ix+1)+'</td>';
                cfg.headers.forEach(function(k) {
                    var td = document.createElement('td');
                    var v = r[k]===null||r[k]===undefined?'-':r[k];
                    
                    if(k==='Dokumen' && String(v).indexOf('http')!==-1) {
                        td.className='view-btn-container';
                        td.innerHTML='<button class="action-btn view-btn" onclick="event.preventDefault();App.showFilePreview(\''+v+'\')"><i class="fas fa-eye"></i> Lihat</button>';
                    }
                    else if(k==='Aksi') { 
                        // HAPUS: td.className='action-buttons'; (Ini yang bikin garis rusak)
                        // GANTI DENGAN: Style biasa untuk sel
                        td.style.textAlign = 'center'; 
                        td.style.whiteSpace = 'nowrap'; // Agar tidak turun baris

                        var lock = ['ok','v','disetujui'].indexOf(String(r['Status']||'').replace(/<[^>]*>?/gm, '').trim().toLowerCase()) !== -1;
                        
                        // PINDAHKAN Class 'action-buttons' ke DIV pembungkus
                        var html = '<div class="action-buttons" style="display:flex; gap:5px; justify-content:center;">';
                        
                        // Edit
                        html += '<button class="action-btn edit-btn" '+(lock?'disabled':'')+' onclick="App.loadPage(event,\'sk_edit\',{rowIndex:'+r._rowIndex+'})"><i class="fas fa-pencil-alt"></i></button>';
                        
                        // Hapus
                        var json = JSON.stringify({_rowIndex:r._rowIndex, 'Nama Sekolah':r['Nama Sekolah'], 'Tahun Ajaran':r['Tahun Ajaran'], 'Semester':r['Semester']}).replace(/"/g, '&quot;');
                        html += '<button class="action-btn delete-btn" '+(lock?'disabled':'')+' onclick="App.showDeleteConfirmation(this)" data-row-info="'+json+'"><i class="fas fa-trash"></i></button>';
                        
                        // Verif (Admin)
                        var s=JSON.parse(localStorage.getItem('user_session'));
                        if(s.role.toLowerCase().indexOf('admin')!==-1) {
                           var rowJson = JSON.stringify(r).replace(/"/g, "&quot;");
                           html += '<button class="action-btn submit-btn" onclick=\'App.openVerifModal('+rowJson+')\'><i class="fas fa-check"></i></button>';
                        }
                        
                        html += '</div>';
                        td.innerHTML = html;
                    }
                    else if(['Status','Validasi'].indexOf(k)!==-1) td.innerHTML = v;
                    else td.textContent = v;
                    tr.appendChild(td);
                });
                tb.appendChild(tr);
            });
            tb.classList.add('fade-in-table');
        };
        render(rows);

        if(cfg.filters) {
            cfg.filters.forEach(function(f) {
                var el = document.getElementById(f.id);
                if(el) {
                    var vals=[]; rows.forEach(function(rx){ vals.push(rx[f.col]); });
                    var u = vals.filter(function(v, i, a){ return a.indexOf(v) === i; }).sort();
                    if(f.desc) u.reverse();
                    u.forEach(function(x){ el.add(new Option(x,x)); });
                    el.onchange = function() {
                         var val = el.value;
                         var res = rows.filter(function(row){ return !val || String(row[f.col]) === val; });
                         render(res);
                    };
                }
            });
        }
    }).withFailureHandler(function(e){ tb.innerHTML='<tr><td>Error: '+e.message+'</td></tr>'; })[cfg.serverFunc]();
};

App.initMatrixTable = function(tid, func) {
    var t=document.getElementById(tid); if(!t)return;
    var tb=t.querySelector('tbody'), thd=t.querySelector('thead');
    t.classList.add('matrix-mode');
    document.getElementById('tableWrapper').style.display='flex';
    document.getElementById('loadingStatus').style.display='none';
    if(thd) thd.innerHTML = '<tr><th rowspan="2" class="col-no">No</th><th rowspan="2" class="col-nama">Sekolah</th><th>Loading...</th></tr><tr><th>Loading...</th></tr>';
    google.script.run.withSuccessHandler(function(d) {
        if(!d.length) { tb.innerHTML='<tr><td>Kosong</td></tr>'; return; }
        var h1=d[0], h2=d[1];
        var th = '<tr><th rowspan="2" class="col-no">No</th><th rowspan="2" class="col-nama">Nama Sekolah</th>';
        for(var i=1;i<h1.length;i++) if(h1[i]) th+='<th colspan="'+(h1.slice(i+1).findIndex(function(x){return x;})+1||1)+'" style="border-left:1px solid #cbd5e1">'+h1[i]+'</th>';
        th+='</tr><tr>';
        for(var i=1;i<h2.length;i++) th+='<th class="col-data" style="'+(i>1&&h1[i]?'border-left:1px solid #cbd5e1':'')+'">'+(h2[i]||'-')+'</th>';
        thd.innerHTML = th+'</tr>';
        var tr='';
        for(var i=2;i<d.length;i++) {
            tr+='<tr><td class="col-no">'+(i-1)+'</td><td class="col-nama">'+d[i][0]+'</td>';
            for(var j=1;j<d[i].length;j++) tr+='<td class="col-data" style="'+(j>1&&h1[j]?'border-left:1px solid #cbd5e1':'')+'">'+d[i][j]+'</td>';
            tr+='</tr>';
        }
        tb.innerHTML = tr;
    }).withFailureHandler(function(e){alert(e.message);})[func]();
};

App.arsipPath = [];
App.loadFolder = function(fid, refresh) {
    var g=document.getElementById('fileGrid'), l=document.getElementById('arsipLoading'), em=document.getElementById('emptyFolderMsg');
    if(!g) return;
    em.style.display='none'; l.style.display='flex'; 
    if(refresh && !fid && App.arsipPath.length>0) fid = App.arsipPath[App.arsipPath.length-1].id;
    google.script.run.withSuccessHandler(function(d) {
        l.style.display='none';
        if(d.error) { g.innerHTML=d.error; return; }
        g.innerHTML=''; 
        if(fid && !refresh) {
             var exists=false; for(var i=0;i<App.arsipPath.length;i++) if(App.arsipPath[i].id===d.currentId) exists=true;
             if(!exists) App.arsipPath.push({id:d.currentId, name:d.currentName});
        }
        renderBreadcrumb();
        if(!d.items.length) em.style.display='flex';
        else d.items.forEach(function(i) {
            var c = document.createElement('div'); c.className='fm-card';
            var ic='fa-file file'; 
            if(i.type==='folder') ic='fa-folder folder'; 
            else if(i.mime.indexOf('pdf')!==-1) ic='fa-file-pdf pdf';
            else if(i.mime.indexOf('sheet')!==-1) ic='fa-file-excel sheet';
            else if(i.mime.indexOf('image')!==-1) ic='fa-file-image img';
            c.innerHTML = '<i class="fas '+ic+' fm-icon"></i><div class="fm-name">'+i.name+'</div><div class="fm-meta">'+(i.type==='folder'?'':i.size)+'</div>';
            c.onclick = function() { i.type==='folder' ? App.loadFolder(i.id) : App.showFilePreview(i.url); };
            g.appendChild(c);
        });
    }).getDriveContents(fid);
};

function renderBreadcrumb() {
    var c = document.getElementById('arsipBreadcrumb'); if(!c) return; c.innerHTML='';
    App.arsipPath.forEach(function(x, i) {
        if(i>0) c.innerHTML += '<span class="breadcrumb-sep"><i class="fas fa-chevron-right" style="font-size:0.7em"></i></span>';
        var s = document.createElement('span'); s.className='breadcrumb-item'; s.textContent=x.name;
        s.onclick = function() { if(i!==App.arsipPath.length-1) { App.arsipPath=App.arsipPath.slice(0,i+1); App.loadFolder(x.id,true); } };
        c.appendChild(s);
    });
}

// --- 3. MODAL UTILS ---
App.showAppModal = function(st, msg, redir) {
    var m = document.getElementById('appModal'), b = document.getElementById('modalBtnMain'), icon = document.getElementById('modalIconBox');
    document.getElementById('modalMessage').textContent = msg;
    document.getElementById('modalTitle').textContent = st==='loading'?'Memproses...':(st==='success'?'Berhasil':'Gagal');
    icon.innerHTML = st==='loading'?'<div class="app-spinner"></div>':(st==='success'?'<i class="fas fa-check" style="color:green;font-size:2em"></i>':'<i class="fas fa-times" style="color:red;font-size:2em"></i>');
    m.style.display = 'flex';
    b.onclick = function() { m.style.display = 'none'; if(redir) App.loadPage(null, redir); };
};

App.showFilePreview = function(url) {
    if(!url || url.indexOf('http') === -1) return alert('URL Invalid');
    if(url.indexOf('drive') !== -1) url = url.replace('/view', '/preview');
    document.getElementById('previewModal').style.display = 'flex';
    document.getElementById('previewLoading').style.display = 'flex';
    var f = document.getElementById('previewFrame'); f.src = url;
    f.onload = function() { document.getElementById('previewLoading').style.display = 'none'; };
};
App.closePreview = function() { document.getElementById('previewModal').style.display = 'none'; };

App.showDeleteConfirmation = function(btn) {
    var d = JSON.parse(btn.dataset.rowInfo);
    var m = document.getElementById('deleteModal');
    m.querySelector('.delete-info-card').innerHTML = '<div><strong>Sekolah:</strong> '+d['Nama Sekolah']+'</div><div><strong>Periode:</strong> '+d['Tahun Ajaran']+' ('+(d['Semester']||'-')+')</div>';
    
    m.style.display = 'flex';
    setTimeout(function(){ m.classList.add('show'); }, 10);
    setTimeout(function(){ var inp = document.getElementById('delCode'); if(inp) inp.focus(); }, 100);

    document.getElementById('cancelDeleteBtn').onclick = function() { m.classList.remove('show'); setTimeout(function(){ m.style.display='none'; }, 200); };
    
    var ok = document.getElementById('confirmDeleteBtn');
    var newOk = ok.cloneNode(true); ok.parentNode.replaceChild(newOk, ok);
    newOk.onclick = function() {
        var c = document.getElementById('delCode').value;
        if(!c) { alert('Kode wajib diisi.'); return; }
        
        var name="User", role="User";
        try{ var s=JSON.parse(localStorage.getItem('user_session')); if(s){ name=s.nama||s.username||"User"; role=s.role||"User"; } }catch(e){}

        App.showAppModal('loading', 'Menghapus...'); m.style.display = 'none';
        google.script.run.withSuccessHandler(function(r){ App.showAppModal('success',r,'sk_kelola'); })
        .withFailureHandler(function(e){ App.showAppModal('error',e.message); })
        .deleteSKData(d._rowIndex, c, name, role);
    };
};

App.openVerifModal = function(row) {
    var m = document.getElementById('verificationModal');
    document.getElementById('verifRowIndex').value = row._rowIndex;
    document.getElementById('verifSekolahName').textContent = row['Nama Sekolah'];
    document.getElementById('verifKeterangan').value = row['Keterangan'] !== '-' ? row['Keterangan'] : '';
    
    var s = row['Status'].replace(/<[^>]*>?/gm, '').toLowerCase(); 
    var sel = document.getElementById('verifStatus');
    if(['ok','v','disetujui'].indexOf(s)!==-1) sel.value='OK';
    else if(['ditolak','x'].indexOf(s)!==-1) sel.value='Ditolak';
    else if(['revisi'].indexOf(s)!==-1) sel.value='Revisi';
    else sel.value='Diproses';

    var url = row['Dokumen'];
    if(url && url.includes('http')) {
        document.getElementById('verifNoDoc').style.display='none';
        document.getElementById('verifLoading').style.display='flex';
        var f = document.getElementById('verifPreviewFrame'); f.style.display='block';
        if(url.includes('drive')) url = url.replace('/view', '/preview');
        f.src = url; f.onload = function() { document.getElementById('verifLoading').style.display='none'; };
    } else {
        document.getElementById('verifPreviewFrame').style.display='none';
        document.getElementById('verifLoading').style.display='none';
        document.getElementById('verifNoDoc').style.display='flex';
    }
    m.style.display = 'flex';
    
    var form = document.getElementById('verifForm');
    form.onsubmit = function(e) {
        e.preventDefault();
        var btn = form.querySelector('button[type="submit"]'); btn.disabled=true; btn.textContent='Menyimpan...';
        var usr = document.getElementById('sidebar-user-name').textContent;
        google.script.run.withSuccessHandler(function(r) { m.style.display='none'; App.showAppModal('success',r,'sk_kelola'); })
        .withFailureHandler(function(e) { alert(e.message); btn.disabled=false; btn.textContent='SIMPAN'; })
        .updateSKVerificationStatus(document.getElementById('verifRowIndex').value, document.getElementById('verifStatus').value, document.getElementById('verifKeterangan').value, usr);
    };
};

// ===========================================
// 4. MAPPING & FUNGSI EDIT (LENGKAP)
// ===========================================
App.inits = {
    'home': function(){},
    'sk_menu': function(){},
    
    'sk_riwayat': function() {
        App.initSmartTable({
            tableId: 'riwayatTable', serverFunc: 'getSKRiwayatData',
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK", "Status", "Dokumen", "Tanggal Unggah", "User"],
            filters: [{id:'filterTahun',col:'Tahun Ajaran',desc:true}, {id:'filterSemester',col:'Semester'}, {id:'filterNamaSekolah',col:'Nama Sekolah'}]
        });
    },
    'sk_kelola': function() {
        App.initSmartTable({
            tableId: 'kelolaTable', serverFunc: 'getSKKelolaData',
            // --- FIX URUTAN KOLOM: KETERANGAN DI AKHIR ---
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK", "Dokumen", "Status", "Aksi", "Tanggal Unggah", "Update", "User", "Verifikator", "Keterangan"],
            filters: [{id:'filterTahun',col:'Tahun Ajaran',desc:true}, {id:'filterSemester',col:'Semester'}, {id:'filterNamaSekolah',col:'Nama Sekolah'}]
        });
    },
    'sk_trash': function() {
        App.initSmartTable({
            tableId: 'trashTable', serverFunc: 'getSKTrashData',
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK", "Dokumen", "Status", "Keterangan", "Update", "User"],
            filters: [{id:'filterTahun',col:'Tahun Ajaran',desc:true}, {id:'filterNamaSekolah',col:'Nama Sekolah'}]
        });
    },
    'sk_status': function() { if(App.initMatrixTable) App.initMatrixTable('statusTable', 'getSKStatusData'); },
    'sk_arsip': function() { App.arsipPath=[{id:null,name:'Home'}]; App.loadFolder(null); },
    
    'sk_edit': function(arg) { 
        if(typeof initSkEditPage === 'function') { initSkEditPage(arg); } 
    },
    'sk_unggah': function() { if(typeof initSkUnggahPage === 'function') initSkUnggahPage(); }
};

// --- FUNGSI INIT EDIT (TERMASUK KIRIM NAMA EDITOR) ---
function initSkEditPage(arg) {
    if (!arg || !arg.rowIndex) { console.error("Row Index tidak ditemukan"); return; }
    var form = document.getElementById('skEditForm');
    var rowIndexInput = document.getElementById('editRowIndex');
    if(!form || !rowIndexInput) return;

    rowIndexInput.value = arg.rowIndex; 
    App.showAppModal('loading', 'Mengambil data...');
    
    google.script.run.withSuccessHandler(function(data) {
        document.getElementById('appModal').style.display = 'none'; 
        if (data.error) { alert(data.error); return; }

        document.getElementById('editNamaSekolah').value = data.namaSekolah || '';
        document.getElementById('editTahun').value = data.tahunAjaran || '';
        document.getElementById('editSemester').value = data.semester || '';
        document.getElementById('editNomorSK').value = data.nomorSK || '';
        document.getElementById('editKriteria').value = data.kriteriaSK || '';
        document.getElementById('editTanggalSK').value = data.tanggalSK || '';
        
        var fileInfo = document.getElementById('editFileInfo');
        if(fileInfo && data.dokumen) {
            fileInfo.innerHTML = '<small>File saat ini: <a href="'+data.dokumen+'" target="_blank">Lihat File</a></small>';
        }
    }).withFailureHandler(function(e) { alert("Gagal ambil data: " + e.message); }).getSKDataByRow(arg.rowIndex);

    var newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    newForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var currentUser = "User";
        try { 
            var sess = JSON.parse(localStorage.getItem('user_session')); 
            if(sess && sess.nama) currentUser = sess.nama;
            else currentUser = document.getElementById('sidebar-user-name').textContent;
        } catch(err) {}

        var btn = newForm.querySelector('button[type="submit"]');
        var originalBtnText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

        var fileInput = document.getElementById('editFileSK');
        var fileData = null;
        if (fileInput.files.length > 0) {
            var file = fileInput.files[0];
            var reader = new FileReader();
            reader.onload = function(ex) {
                fileData = { fileName: file.name, mimeType: file.type, data: ex.target.result.split(',')[1] };
                sendData(fileData);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(null); 
        }

        function sendData(fData) {
            var formData = {
                rowIndex: document.getElementById('editRowIndex').value,
                statusSekolah: document.getElementById('editStatusSekolah').value,
                namaSekolah: document.getElementById('editNamaSekolah').value,
                tahunAjaran: document.getElementById('editTahun').value,
                semester: document.getElementById('editSemester').value,
                nomorSK: document.getElementById('editNomorSK').value,
                tanggalSK: document.getElementById('editTanggalSK').value,
                kriteriaSK: document.getElementById('editKriteria').value,
                fileData: fData,
                editorName: currentUser // KIRIM NAMA KE SERVER
            };
            google.script.run.withSuccessHandler(function(res) {
                App.showAppModal('success', res, 'sk_kelola'); 
            }).withFailureHandler(function(err) {
                btn.disabled = false; btn.innerHTML = originalBtnText; alert("Gagal simpan: " + err.message);
            }).updateSKData(formData);
        }
    });
}

// ===========================================
// 6. FUNGSI UNGGAH HALAMAN (INIT DROP DOWN)
// ===========================================
function initSkUnggahPage() {
    var form = document.getElementById('skUnggahForm');
    if (!form) return; // Stop jika bukan halaman unggah

    // 1. Ambil Data Dropdown dari Server
    // Cari elemen select
    var elTahun = document.getElementById('unggahTahun');
    var elSmt = document.getElementById('unggahSemester');
    var elStatus = document.getElementById('unggahStatusSekolah');
    var elNama = document.getElementById('unggahNamaSekolah');
    var elKriteria = document.getElementById('unggahKriteria');

    // Tampilkan loading di dalam dropdown
    if(elTahun) elTahun.innerHTML = '<option>Memuat...</option>';

    google.script.run.withSuccessHandler(function(opts) {
        if (opts.error) {
            console.error("Gagal load dropdown:", opts.error);
            if(elTahun) elTahun.innerHTML = '<option value="">Gagal memuat data</option>';
            return;
        }

        // Helper untuk isi option
        var populate = function(el, data) {
            if(!el) return;
            el.innerHTML = '<option value="">-- Pilih --</option>';
            data.forEach(function(item) {
                el.add(new Option(item, item));
            });
        };

        // Isi Dropdown Sederhana
        populate(elTahun, opts['Tahun Ajaran']);
        populate(elSmt, opts['Semester']);
        populate(elKriteria, opts['Kriteria SK']);

        // Logika Dropdown Berantai (Status Sekolah -> Nama Sekolah)
        var schoolMap = opts['Nama Sekolah List'] || {};
        var statusList = Object.keys(schoolMap).sort();
        
        populate(elStatus, statusList);

        // Event saat Status Sekolah dipilih
        if(elStatus) {
            elStatus.addEventListener('change', function() {
                var selectedStatus = this.value;
                var sekolahList = schoolMap[selectedStatus] || [];
                populate(elNama, sekolahList);
            });
        }

    }).withFailureHandler(function(err) {
        alert("Gagal menghubungi server: " + err.message);
    }).getMasterSkOptions();

    // 2. Handle Submit Form Unggah
    // Hapus listener lama (recreate node)
    var newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);

    newForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        var btn = newForm.querySelector('button[type="submit"]');
        var originalText = btn.innerHTML;
        var fileInput = document.getElementById('unggahFile');

        if (fileInput.files.length === 0) {
            alert("Harap pilih file PDF SK terlebih dahulu.");
            return;
        }

        // Validasi User
        var currentUser = "User";
        try { currentUser = document.getElementById('sidebar-user-name').textContent; } catch(err){}

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengunggah...';

        // Baca File
        var file = fileInput.files[0];
        if (file.size > 5 * 1024 * 1024) { // Max 5MB
            alert("Ukuran file terlalu besar (Maks 5MB)");
            btn.disabled = false; btn.innerHTML = originalText;
            return;
        }

        var reader = new FileReader();
        reader.onload = function(ex) {
            var fileData = {
                fileName: file.name,
                mimeType: file.type,
                data: ex.target.result.split(',')[1] // Ambil base64
            };

            var formData = {
                tahunAjaran: document.getElementById('unggahTahun').value,
                semester: document.getElementById('unggahSemester').value,
                statusSekolah: document.getElementById('unggahStatusSekolah').value,
                namaSekolah: document.getElementById('unggahNamaSekolah').value,
                nomorSK: document.getElementById('unggahNomorSK').value,
                tanggalSK: document.getElementById('unggahTanggalSK').value,
                kriteriaSK: document.getElementById('unggahKriteria').value,
                fileData: fileData,
                loggedInUser: currentUser
            };

            google.script.run.withSuccessHandler(function(res) {
                App.showAppModal('success', res, 'sk_riwayat'); // Pindah ke Riwayat
            }).withFailureHandler(function(err) {
                btn.disabled = false; btn.innerHTML = originalText;
                App.showAppModal('error', err.message);
            }).processManualForm(formData);
        };
        reader.readAsDataURL(file);
    });
}

document.addEventListener('DOMContentLoaded', App.init);
</script>