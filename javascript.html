<script>
const App = {}; 

// ===========================================
// 1. GLOBAL HELPER (UMUM)
// ===========================================

// Helper Kolom Nomor
var colNo = { 
    name: "No.", 
    width: "40px", 
    formatter: function(row, key, index) { return index + 1; },
    tdStyle: "text-align:center; font-weight:bold; color:#64748b;" 
};

// Tutup Modal dengan Aman
App.closeAppModal = function() {
    var modal = document.getElementById('appModal');
    if(modal) {
        modal.classList.remove('show'); 
        setTimeout(function() {
            modal.style.display = 'none';
            modal.className = 'modal-overlay'; 
        }, 100); 
    }
};

// Tampilkan Modal/Notifikasi
App.showAppModal = function(status, msg, redirectPage) {
    var modal = document.getElementById('appModal');
    if(!modal) return alert(msg);
    var content = modal.querySelector('.modal-content'); 
    var iconBox = document.getElementById('modalIconBox'); 
    var title = document.getElementById('modalTitle'); 
    var message = document.getElementById('modalMessage'); 
    var btn = document.getElementById('modalBtnMain');
    
    content.className = 'modal-content'; 
    btn.style.display = 'block';
    
    if (status === 'loading') {
        content.classList.add('loading'); 
        iconBox.innerHTML = '<div class="modal-spinner"></div>';
        title.textContent = 'Memproses...'; 
        message.textContent = msg || 'Mohon tunggu sebentar...';
        btn.style.display = 'none';
    } else if (status === 'success') {
        content.classList.add('success'); 
        iconBox.innerHTML = '<i class="fas fa-check"></i>';
        title.textContent = 'Berhasil!'; 
        message.innerHTML = msg; 
        btn.textContent = 'Lanjutkan';
    } else if (status === 'error') {
        content.classList.add('error'); 
        iconBox.innerHTML = '<i class="fas fa-exclamation"></i>';
        title.textContent = 'Terjadi Kesalahan'; 
        message.innerHTML = msg; 
        btn.textContent = 'Tutup';
    } else if (status === 'warning') {
        content.classList.add('warning'); 
        iconBox.innerHTML = '<i class="fas fa-bell"></i>';
        title.textContent = 'Perhatian'; 
        message.innerHTML = msg; 
        btn.textContent = 'Mengerti';
    }
    
    modal.style.display = 'flex'; 
    setTimeout(function() { modal.classList.add('show'); }, 10);
    
    if(status !== 'loading') {
        setTimeout(function(){ btn.focus(); }, 100);
        var newBtn = btn.cloneNode(true); 
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = function() {
            modal.classList.remove('show');
            setTimeout(function() {
                modal.style.display = 'none';
                if (redirectPage && status === 'success') App.loadPage(null, redirectPage);
            }, 300);
        };
    }
};

// Konfirmasi Hapus
App.showDeleteConfirmation = function(btn) {
    var rowData = JSON.parse(btn.getAttribute('data-row-info').replace(/&apos;/g, "'").replace(/&quot;/g, '"'));
    var namaSekolah = rowData['Nama Sekolah'] || rowData['Nama Lembaga'] || '-';
    var detail = (rowData['Bulan'] ? rowData['Bulan'] + ' ' : '') + (rowData['Tahun'] || rowData['Tahun Ajaran'] || '');

    Swal.fire({
        title: 'Hapus Data?',
        html: `Anda akan menghapus data dari:<br><b>${namaSekolah}</b><br><small>${detail}</small><br><br><small style='color:#64748b;'>Data akan dipindahkan ke Trash (Sampah).</small>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#94a3b8',
        confirmButtonText: 'Ya, Hapus',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            // Generate Code Hari Ini
            var d = new Date();
            var yyyy = d.getFullYear();
            var mm = String(d.getMonth() + 1).padStart(2, '0');
            var dd = String(d.getDate()).padStart(2, '0');
            var code = yyyy + mm + dd;
            
            // Info User
            var actorName = (App.currentUser && App.currentUser.nama) ? App.currentUser.nama : 'Admin';
            var actorRole = (App.currentUser && App.currentUser.role) ? App.currentUser.role : 'User';

            // Panggil Fungsi Hapus Sesuai Modul
            var isLapbul = rowData.hasOwnProperty('Bulan');
            if(isLapbul) {
                // Hapus Lapbul
                App.showAppModal('loading', 'Menghapus data...');
                var jenjang = rowData.Jenjang === 'SD' ? 'SD' : 'PAUD';
                google.script.run.withSuccessHandler(function(r) {
                    App.showAppModal('success', r);
                    if(App.inits['lapbul_kelola']) App.inits['lapbul_kelola']();
                }).withFailureHandler(function(e) {
                    App.showAppModal('error', e.message);
                }).deleteLapbulData(rowData._rowIndex, jenjang, code, actorName, actorRole);
            } else {
                // Hapus SK
                App.showAppModal('loading', 'Menghapus data...');
                google.script.run.withSuccessHandler(function(r) {
                    App.showAppModal('success', r);
                    if(App.inits['sk_kelola']) App.inits['sk_kelola']();
                }).withFailureHandler(function(e) {
                    App.showAppModal('error', e.message);
                }).deleteSKData(rowData._rowIndex, code, actorName, actorRole);
            }
        }
    });
};

// Preview File
App.showFilePreview = function(url, title) {
    if (!url) return;
    var safeUrl = decodeURIComponent(url);
    var fileId = "";
    var match = safeUrl.match(/[-\w]{25,}/);
    if (match) fileId = match[0];
    var previewLink = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : safeUrl;
    var downloadLink = fileId ? "https://drive.google.com/uc?export=download&id=" + fileId : safeUrl;

    var htmlContent = `
        <div style="height:80vh; display:flex; flex-direction:column;">
            <div style="flex:1; background:#f1f5f9; border-radius:6px; overflow:hidden; position:relative;">
                 <iframe src="${previewLink}" style="width:100%; height:100%; border:none;" allow="autoplay"></iframe>
            </div>
            <div style="margin-top:15px; text-align:center;">
                <a href="${downloadLink}" target="_blank" class="btn btn-primary" style="text-decoration:none; color:white; padding:8px 20px; border-radius:4px;">
                    <i class="fas fa-download"></i> Unduh Dokumen
                </a>
            </div>
        </div>
    `;
    
    Swal.fire({
        title: title || 'Pratinjau Dokumen',
        html: htmlContent,
        width: '80%',
        showConfirmButton: false,
        showCloseButton: true
    });
};

// Init Smart Table
App.initSmartTable = function(config) {
    var table = document.getElementById(config.tableId); if (!table) return;
    var thead = table.querySelector('thead'); var tbody = table.querySelector('tbody');
    var colCount = (config.headers ? config.headers.length : 0) + 1; 

    // Render Header
    if (config.headers && thead && !config.skipRenderHeader) {
        var headerHtml = '<tr><th style="width:40px; text-align:center;">No.</th>';
        config.headers.forEach(function(h) { var label = (typeof h === 'object') ? h.name : h; headerHtml += '<th>' + label + '</th>'; });
        headerHtml += '</tr>'; thead.innerHTML = headerHtml;
    }

    // Call Server
    google.script.run.withSuccessHandler(function(response) {
        var allRows = (response && response.rows) ? response.rows : (Array.isArray(response) ? response : []);
        var renderTableBody = function(rows) {
            tbody.innerHTML = ''; 
            if (rows.length === 0) { tbody.innerHTML = '<tr><td colspan="' + colCount + '" style="text-align:center;">Data tidak ditemukan.</td></tr>'; return; }
            rows.forEach(function(row, i) {
                var tr = document.createElement('tr'); 
                tr.innerHTML = '<td style="text-align:center;">' + (i + 1) + '</td>';
                config.headers.forEach(function(h) {
                    var td = document.createElement('td'); var key = (typeof h === 'object') ? h.name : h;
                    if (typeof h === 'object' && h.formatter) { td.innerHTML = h.formatter(row, key, i); } else { td.textContent = row[key] || ""; }
                    if (typeof h === 'object' && h.tdStyle) td.style = h.tdStyle;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        };
        renderTableBody(allRows);
        if (config.onLoad) config.onLoad(allRows);
        
        // Filter Logic
        if (config.filters) {
             var applyAllFilters = function(triggeredById) {
                 var filtered = allRows;
                 config.filters.forEach(function(f) {
                     var el = document.getElementById(f.id);
                     if (el && el.value) { 
                         // Case insensitive partial match for robustness
                         var term = el.value.toLowerCase();
                         filtered = filtered.filter(r => String(r[f.col]).toLowerCase().includes(term)); 
                     }
                 });
                 
                 // Search Box Global
                 var searchBox = document.getElementById('searchFilter') || document.getElementById('kelolaSearch') || document.getElementById('trashSearch');
                 if(searchBox && searchBox.value) {
                     var s = searchBox.value.toLowerCase();
                     if(s.length >= 3) { // Min 3 chars search
                        filtered = filtered.filter(r => Object.values(r).some(val => String(val).toLowerCase().includes(s)));
                     }
                 }
                 
                 renderTableBody(filtered);
                 if (config.onFilterChange && triggeredById) config.onFilterChange(triggeredById, document.getElementById(triggeredById).value, filtered, allRows);
             };
             
             config.filters.forEach(function(f) {
                 var el = document.getElementById(f.id);
                 if(el) { 
                     el.onchange = function() { applyAllFilters(f.id); }; 
                     // Populate jika select kosong
                     if(el.tagName === 'SELECT' && el.options.length <= 1 && f.id !== 'filterSekolah' && f.id !== 'filterNamaSekolah') {
                         var vals = [...new Set(allRows.map(r => r[f.col]))].filter(Boolean).sort();
                         if(f.sortOptions) vals.sort(f.sortOptions);
                         else if(f.desc) vals.reverse();
                         vals.forEach(v => el.add(new Option(v,v)));
                     }
                 }
             });
             
             var searchBox = document.getElementById('searchFilter') || document.getElementById('kelolaSearch') || document.getElementById('trashSearch');
             if (searchBox) { searchBox.onkeyup = function() { applyAllFilters('search'); }; }
        }

    }).withFailureHandler(function(err) {
        if(tbody) tbody.innerHTML = '<tr><td colspan="' + colCount + '">Error: ' + err.message + '</td></tr>';
    })[config.serverFunc](config.params || undefined);
};

// ===========================================
// 2. SYSTEM INIT & NAVIGASI
// ===========================================
App.init = function() {
    var userSession = localStorage.getItem('user_session');
    var sidebar = document.querySelector('.sidebar'); var mainContent = document.getElementById('main-content');
    
    if (!userSession) {
        if(sidebar) sidebar.style.display = 'none';
        if(mainContent) { mainContent.style.marginLeft = '0'; mainContent.style.width = '100%'; mainContent.style.display = 'flex'; mainContent.style.alignItems = 'center'; mainContent.style.justifyContent = 'center'; }
        App.loadPage(null, 'login'); 
    } else {
        var user; try { user = JSON.parse(userSession); } catch (e) { localStorage.removeItem('user_session'); window.location.reload(); return; }
        App.currentUser = user; 
        if(sidebar) sidebar.style.display = 'flex';
        if(mainContent) mainContent.removeAttribute('style'); 
        
        // Show Admin Menus
        var isAdmin = (user.role || '').toLowerCase().includes('admin');
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'block' : 'none');
        
        // Profile Info
        setTimeout(function() {
            var elName = document.getElementById('sidebar-user-name'); 
            var elRole = document.getElementById('sidebar-user-role'); 
            if (elName) elName.textContent = user.nama || "User"; 
            if (elRole) elRole.textContent = user.role || "Staff";
        }, 50);
        
        App.setupSidebar();

        // Load Home Default
        var currentContent = mainContent.innerHTML.trim();
        if (!currentContent || document.getElementById('loginForm')) { App.loadPage(null, 'home'); }
    }
};

App.loadPage = function(e, p, arg) {
    if(e) e.preventDefault(); var main = document.getElementById('main-content');
    if(p !== 'login' && main) { main.innerHTML = '<div class="loading-container"><div class="app-spinner"></div><p class="loading-text">Memuat...</p></div>'; }
    
    document.querySelectorAll('.sidebar-menu a').forEach(function(a) { a.classList.remove('active'); });
    
    // Set Active Link & Open Submenu
    var activeLink = document.querySelector('.sidebar-menu a[data-page="' + p + '"]');
    if(activeLink) {
        activeLink.classList.add('active'); 
        var parentLi = activeLink.closest('li.has-submenu');
        while(parentLi) {
            parentLi.classList.add('open'); 
            var sub = parentLi.querySelector('.submenu');
            if(sub) sub.style.maxHeight = "3000px"; 
            parentLi = parentLi.parentElement.closest('li.has-submenu');
        }
    }

    google.script.run.withSuccessHandler(function(h) {
        if(main) main.innerHTML = h;
        if(App.inits[p]) setTimeout(function() { App.inits[p](arg); }, 50);
    }).withFailureHandler(function(err) { if(main) main.innerHTML = '<div style="color:red;padding:20px;">Error: ' + err.message + '</div>'; }).include('page_' + p);
};

App.handleLogin = function(e) {
    e.preventDefault(); var btn = document.getElementById('btnLogin'); var err = document.getElementById('loginError');
    var u = document.getElementById('username').value; var p = document.getElementById('password').value;
    if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...'; }
    if(err) err.style.display = 'none';
    google.script.run.withSuccessHandler(function(res) {
        if(res.status === 'success') { localStorage.setItem('user_session', JSON.stringify(res.user)); App.init(); } 
        else { if(err) { err.textContent = res.message; err.style.display = 'block'; } else alert(res.message); if(btn) { btn.disabled = false; btn.innerHTML = 'MASUK'; } }
    }).withFailureHandler(function(e) { alert("Error: " + e.message); if(btn) { btn.disabled = false; btn.innerHTML = 'MASUK'; } }).loginUser(u, p);
};

App.setupSidebar = function() {
    var toggles = document.querySelectorAll('.has-submenu > a');
    for(var i=0; i<toggles.length; i++) {
        var menuLink = toggles[i]; 
        var newLink = menuLink.cloneNode(true);
        menuLink.parentNode.replaceChild(newLink, menuLink);
        newLink.addEventListener('click', function(e) {
            e.preventDefault(); 
            var currentLi = this.parentElement; 
            var submenu = currentLi.querySelector('.submenu'); 
            currentLi.classList.toggle('open');
            if(currentLi.classList.contains('open')) { if(submenu) submenu.style.maxHeight = "3000px"; } 
            else { if(submenu) submenu.style.maxHeight = null; }
        });
    }
    
    // Link Menu Biasa
    var navLinks = document.querySelectorAll('.sidebar-menu a[data-page]');
    for(var k=0; k<navLinks.length; k++) {
        var link = navLinks[k];
        if(link.parentElement.classList.contains('has-submenu')) continue; 
        if(link.getAttribute('data-page') === 'logout') continue;
        var newLink = link.cloneNode(true); 
        link.parentNode.replaceChild(newLink, link);
        newLink.addEventListener('click', function(e) { 
            e.preventDefault(); 
            App.loadPage(e, this.getAttribute('data-page')); 
        });
    }
    
    // Khusus Menu Induk Dashboard (Klik judul menu utama)
    var parentLinks = ['sk_menu', 'lapbul_menu', 'ptk_menu'];
    parentLinks.forEach(pid => {
        var plink = document.querySelector('a[data-page="'+pid+'"]');
        if(plink) {
            var nplink = plink.cloneNode(true); plink.parentNode.replaceChild(nplink, plink);
            nplink.addEventListener('click', function(e){ App.loadPage(e, pid); });
        }
    });

    var logoutBtn = document.querySelector('a[data-page="logout"]');
    if(logoutBtn) { logoutBtn.onclick = function(e) { e.preventDefault(); localStorage.removeItem('user_session'); App.init(); }; }
};

// ===========================================
// 3. DEFINISI HALAMAN (App.inits)
// ===========================================
App.inits = {};
App.inits['home'] = function(){};


// ===========================================
// MENU: SK PEMBAGIAN TUGAS
// ===========================================

// 1. Dashboard SK
App.inits['sk_menu'] = function() {
    var ids = ['statTotal', 'statToday', 'statProses', 'statOK', 'statRevisi', 'statDitolak'];
    ids.forEach(id => { var el = document.getElementById(id); if(el) el.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; });
    
    google.script.run.withSuccessHandler(function(stats) {
        if(stats.error) { console.error(stats.error); return; }
        var setVal = function(id, v) { var el = document.getElementById(id); if(el) el.textContent = v; };
        setVal('statTotal', stats.total); setVal('statToday', stats.today);
        setVal('statProses', stats.status.proses); setVal('statOK', stats.status.ok);
        setVal('statRevisi', stats.status.revisi); setVal('statDitolak', stats.status.ditolak);
        
        var listC = document.getElementById('listRecent');
        if(listC) {
            if(!stats.recent || stats.recent.length === 0) listC.innerHTML = '<div style="padding:10px;text-align:center;color:#ccc">Belum ada aktivitas</div>';
            else {
                var html = '<ul style="list-style:none;padding:0;margin:0">';
                stats.recent.forEach(function(item){
                    var color='#64748b'; var bg='#f1f5f9'; var s=(item.status||"").toLowerCase();
                    if(s.includes('ok')) { color='#10b981'; bg='#dcfce7'; } else if(s.includes('revisi')) { color='#f59e0b'; bg='#fef9c3'; } else if(s.includes('tolak')) { color='#ef4444'; bg='#fee2e2'; }
                    html += `<li style="padding:10px 0;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center;"><div><div style="font-weight:600;color:#334155;font-size:0.9em;">${item.sekolah}</div><div style="font-size:0.75em;color:#94a3b8;">${item.waktu}</div></div><span style="font-size:0.75em;font-weight:bold;color:${color};background:${bg};padding:2px 8px;border-radius:4px;">${item.status}</span></li>`;
                });
                html += '</ul>'; listC.innerHTML = html;
            }
        }
        if(typeof Chart !== 'undefined') {
            var ctx = document.getElementById('chartTrend');
            if(ctx) {
                if(window.mySkChart) window.mySkChart.destroy();
                window.mySkChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'], datasets: [{ label:'SK Masuk', data: stats.monthlyTrend, backgroundColor:'#3b82f6', borderRadius:4 }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true},x:{grid:{display:false}}} }
                });
            }
        }
    }).getSKDashboardStats();
};

// 2. Unggah SK
App.inits['sk_unggah'] = function() {
    if(typeof initSkUnggahPage === 'function') initSkUnggahPage(); // (Fungsi ini ada di bawah)
};

// 3. Kelola SK
App.inits['sk_kelola'] = function() {
    App.initSmartTable({
        tableId: 'kelolaTable', serverFunc: 'getSKKelolaData',
        headers: [
            "Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK",
            { name: "Dokumen", tdStyle: "text-align:center;", formatter: function(row) {
                var url = row.Dokumen; if (url && url.includes('http')) {
                    var safeUrl = encodeURIComponent(url); var safeTitle = encodeURIComponent('SK ' + (row['Nomor SK'] || ''));
                    return `<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent('${safeUrl}'), decodeURIComponent('${safeTitle}'))"><i class="fas fa-eye"></i> Lihat</button>`;
                } return '<span style="color:#cbd5e1;">-</span>';
            }},
            { name: "Status", tdStyle: "text-align:center;", formatter: function(row) { return row.Status || '<span class="status-badge status-diproses">Proses</span>'; } },
            { name: "Keterangan", tdStyle: "font-size:0.85em; color:#64748b; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" },
            { name: "Aksi", width: "140px", tdStyle: "text-align:center;", formatter: function(row) {
                var isAdmin = (App.currentUser && App.currentUser.role === 'Admin');
                var statusRaw = String(row['_statusRaw'] || row['Status'] || '').toLowerCase();
                var isLocked = statusRaw.includes('ok') || statusRaw.includes('disetujui');
                var vId = row._rowIndex; var vNama = encodeURIComponent(row['Nama Sekolah'] || ''); var vNomor = encodeURIComponent(row['Nomor SK'] || ''); var vTgl = encodeURIComponent(row['Tanggal SK'] || ''); var vThn = encodeURIComponent(row['Tahun Ajaran'] || ''); var vSmt = encodeURIComponent(row['Semester'] || ''); var vKrit = encodeURIComponent(row['Kriteria SK'] || ''); var vUrl = encodeURIComponent(row['Dokumen'] || '');
                var editAttr = isLocked ? 'disabled style="background:#cbd5e1; cursor:not-allowed;"' : `onclick="App.skEdit('${vId}', '${vNama}', '${vThn}', '${vSmt}', '${vNomor}', '${vTgl}', '${vKrit}', '${vUrl}')"`;
                var btnEdit = `<button class="btn-action-sm btn-edit" title="Edit Data" ${editAttr}><i class="fas fa-pencil-alt"></i></button>`;
                var delAttr = isLocked ? 'disabled style="background:#cbd5e1; cursor:not-allowed;"' : `onclick="App.skHapus('${vId}', '${vNama}')"`;
                var btnDel = `<button class="btn-action-sm btn-delete" title="Hapus Data" ${delAttr}><i class="fas fa-trash"></i></button>`;
                var btnVerif = '';
                if (isAdmin) { btnVerif = `<button class="btn-action-sm btn-verify" title="Verifikasi" onclick="App.skVerifikasi('${vId}', '${vNama}', '${vThn}', '${vSmt}', '${vUrl}', '${vNomor}', '${vTgl}', '${vKrit}')"><i class="fas fa-check-circle"></i></button>`; }
                return `<div style="display:flex; justify-content:center; gap:5px;">${btnVerif} ${btnEdit} ${btnDel}</div>`;
            }},
            { name: "Tanggal Unggah", tdStyle: "font-size:0.8em; color:#64748b;" }, { name: "Pengunggah", tdStyle: "font-size:0.8em; color:#334155;" },
            { name: "Edit", tdStyle: "font-size:0.8em; color:#f59e0b;" }, { name: "Editor", tdStyle: "font-size:0.8em; color:#f59e0b;" },
            { name: "Verifikasi", tdStyle: "font-size:0.8em; color:#10b981;" }, { name: "Verifikator", tdStyle: "font-size:0.8em; color:#10b981;" }
        ],
        filters: [ {id:'kelolaTahun',col:'Tahun Ajaran',desc:true}, {id:'kelolaSemester',col:'Semester'}, {id:'kelolaSekolah',col:'Nama Sekolah'}, {id:'kelolaStatus', col:'_statusRaw'} ]
    });
    var searchBox = document.getElementById('kelolaSearch');
    if(searchBox) { searchBox.onkeyup = function() { var term = this.value.toLowerCase(); var rows = document.querySelectorAll('#kelolaTable tbody tr'); rows.forEach(function(r) { r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none'; }); }; }
};

// 4. Edit SK (Halaman)
App.inits['sk_edit'] = function() {
    if (!App.tempEditData) { App.loadPage(null, 'sk_kelola'); return; }
    var data = App.tempEditData; var form = document.getElementById('skEditForm');
    if (form) {
        document.getElementById('editRowIndex').value = data.rowIndex; document.getElementById('viewNamaSekolah').value = data.namaSekolah; document.getElementById('editNamaSekolah').value = data.namaSekolah;
        document.getElementById('viewTahun').value = data.tahun; document.getElementById('editTahun').value = data.tahun; document.getElementById('viewSemester').value = data.semester; document.getElementById('editSemester').value = data.semester;
        document.getElementById('editNomorSK').value = data.nomor;
        var elKriteria = document.getElementById('editKriteria');
        if (elKriteria) { google.script.run.withSuccessHandler(function(opts) { var kriteriaList = opts['Kriteria SK'] || []; elKriteria.innerHTML = '<option value="">-- Pilih Kriteria --</option>'; kriteriaList.forEach(function(k) { elKriteria.add(new Option(k, k)); }); elKriteria.value = data.kriteria; }).getMasterSkOptions(); }
        if(data.tanggal) { var d = null; if (typeof data.tanggal === 'string' && data.tanggal.includes('/')) { var parts = data.tanggal.split('/'); if(parts.length === 3) d = new Date(parts[2], parts[1] - 1, parts[0]); } else { d = new Date(data.tanggal); } if(d && !isNaN(d.getTime())) { var yyyy = d.getFullYear(); var mm = String(d.getMonth() + 1).padStart(2, '0'); var dd = String(d.getDate()).padStart(2, '0'); document.getElementById('editTanggalSK').value = `${yyyy}-${mm}-${dd}`; } }
        var btnContainer = document.getElementById('btnLihatFileContainer');
        if (data.fileUrl && data.fileUrl !== 'undefined' && data.fileUrl !== '') { var safeUrl = encodeURIComponent(data.fileUrl); var safeTitle = encodeURIComponent('SK ' + data.nomor); btnContainer.innerHTML = `<button type="button" class="btn-action-sm btn-view" style="font-size:0.85em; padding:6px 12px;" onclick="App.showFilePreview(decodeURIComponent('${safeUrl}'), decodeURIComponent('${safeTitle}'))"><i class="fas fa-eye"></i> Lihat Dokumen</button>`; } else { btnContainer.innerHTML = '<span class="text-muted small italic">Tidak ada file.</span>'; }
        form.onsubmit = function(e) { e.preventDefault(); var fileInput = document.getElementById('editFile'); if (fileInput.files.length > 0) { var f = fileInput.files[0]; if (f.size > 1048576) { App.showAppModal('error', 'File terlalu besar. Maksimal 1MB.'); return; } if (f.type !== 'application/pdf') { App.showAppModal('error', 'File harus format PDF.'); return; } } var btn = document.getElementById('btnSimpanEdit'); var oldHtml = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...'; var editor = (App.currentUser && App.currentUser.nama) ? App.currentUser.nama : 'Admin'; var dataPayload = { rowIndex: document.getElementById('editRowIndex').value, nomor: document.getElementById('editNomorSK').value, tanggal: document.getElementById('editTanggalSK').value, tahun: document.getElementById('editTahun').value, semester: document.getElementById('editSemester').value, kriteria: document.getElementById('editKriteria').value, editorName: editor }; var send = function() { google.script.run.withSuccessHandler(function(res) { App.showAppModal('success', res, 'sk_kelola'); }).withFailureHandler(function(err) { btn.disabled = false; btn.innerHTML = oldHtml; App.showAppModal('error', err.message); }).updateSKData(dataPayload); }; if (fileInput.files.length > 0) { var r = new FileReader(); r.onload = function(evt) { dataPayload.fileData = { data: evt.target.result.split(',')[1], mimeType: fileInput.files[0].type, fileName: fileInput.files[0].name }; send(); }; r.readAsDataURL(fileInput.files[0]); } else { send(); } };
    }
};

// 5. Riwayat SK
App.inits['sk_riwayat'] = function() {
    App.initSmartTable({
        tableId: 'riwayatTable', serverFunc: 'getSKRiwayatData',
        headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK", 
            { name: "Dokumen", tdStyle: "text-align:center;", formatter: function(row) {
                var url = row.Dokumen; if (url && url.includes('http')) {
                    var safeUrl = encodeURIComponent(url); var safeTitle = encodeURIComponent('SK ' + (row['Nomor SK'] || ''));
                    return `<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent('${safeUrl}'), decodeURIComponent('${safeTitle}'))"><i class="fas fa-eye"></i> Lihat</button>`;
                } return '<span style="color:#cbd5e1;">-</span>';
            }}, "Tanggal Unggah", "User"
        ],
        filters: [{id:'filterTahun',col:'Tahun Ajaran',desc:true}, {id:'filterSemester',col:'Semester'}, {id:'filterNamaSekolah',col:'Nama Sekolah'}]
    });
};

// 6. Status SK
App.inits['sk_status'] = function() { 
    var container = document.getElementById('tableWrapper'); if(!container) return;
    var skeletonHtml = '<div class="std-filter-card"><div class="skeleton-anim" style="width:250px; height:35px; border-radius:6px;"></div></div><div class="std-table-container"><div style="padding:20px; text-align:center;">Loading...</div></div>';
    container.innerHTML = skeletonHtml;
    google.script.run.withSuccessHandler(function(data) {
        if (data.error) { App.showAppModal('error', data.error); return; }
        var html = '<div class="std-filter-card" style="padding:15px; display:flex; align-items:center; gap:10px;"><div style="position:relative; width:300px;"><i class="fas fa-search" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#94a3b8;"></i><input type="text" id="searchMatrix" class="std-search-input" placeholder="Cari Sekolah..." style="padding-left:35px;"></div><button onclick="App.inits[\'sk_status\']()" class="std-filter-btn" title="Refresh"><i class="fas fa-sync-alt"></i></button><div style="margin-left:auto; font-size:0.85em; color:#64748b;">Legend: <span style="background:#dcfce7; padding:2px 5px;">OK</span> <span style="background:#dbeafe; padding:2px 5px;">Diproses</span> <span style="background:#fef9c3; padding:2px 5px;">Revisi</span></div></div><div class="std-table-container" style="overflow:auto; max-height:100vh;"><table class="std-table matrix-mode table-bordered" id="realMatrixTable" style="width:100%;"><thead><tr><th rowspan="2" class="col-no">No</th><th rowspan="2" class="col-nama">Sekolah</th>';
        data.years.forEach(y => html+=`<th colspan="2" class="text-center">${y}</th>`); html+='</tr><tr>';
        data.years.forEach(()=>html+='<th class="col-data text-center">Sem 1</th><th class="col-data text-center">Sem 2</th>'); html+='</tr></thead><tbody>';
        data.rows.forEach((r,i)=>{
            html+=`<tr><td class="col-no text-center">${i+1}</td><td class="col-nama">${r.nama}</td>`;
            data.years.forEach(y=>{ ['Ganjil','Genap'].forEach(s=>{ 
                var v=r[y+'_'+s]; var bg='#f1f5f9'; var txt='-'; var clr='#475569';
                if(v){ var l=String(v).toLowerCase(); if(l.includes('ok')) { bg='#dcfce7'; txt='OK'; clr='#166534'; } else if(l.includes('revisi')) { bg='#fef9c3'; txt='Rev'; clr='#854d0e'; } else if(l.includes('tolak')) { bg='#fee2e2'; txt='Tolak'; clr='#991b1b'; } else { bg='#dbeafe'; txt='Pros'; clr='#1e40af'; } }
                html+=`<td class="col-data text-center" style="background:${bg}; color:${clr}; font-weight:bold;">${txt}</td>`; 
            });});
            html+='</tr>';
        });
        html+='</tbody></table></div>'; container.innerHTML=html;
        document.getElementById('searchMatrix').onkeyup=function(){ var v=this.value.toLowerCase(); document.querySelectorAll('#realMatrixTable tbody tr').forEach(r=>{ var n=r.querySelector('.col-nama'); if(n) r.style.display=n.textContent.toLowerCase().includes(v)?'':'none'; }); };
    }).getSKStatusMatrixAll();
};

// 7. Arsip SK
App.inits['sk_arsip'] = function() { App.arsipState.history = [{id: null, name: 'SK Pembagian Tugas'}]; App.loadArsipSK(null); };

// 8. Trash SK
App.inits['sk_trash'] = function() {
    var session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!(session.role || '').toLowerCase().includes('admin')) { document.getElementById('main-content').innerHTML = '<div style="text-align:center; margin-top:50px;">Akses Ditolak</div>'; return; }
    App.initSmartTable({ tableId: 'trashTable', serverFunc: 'getSKTrashData', headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", { name: "Info Hapus", tdStyle: "text-align:left; color:#ef4444; font-size:0.85em;" }, { name: "Waktu Hapus", tdStyle: "text-align:left; color:#64748b; font-size:0.85em;" }, { name: "Dokumen", tdStyle: "text-align:center;", formatter: function(row) { var url = row.Dokumen; if (url && url.includes('http')) { var safeUrl = encodeURIComponent(url); var safeTitle = encodeURIComponent('Deleted'); return '<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), decodeURIComponent(\'' + safeTitle + '\'))"><i class="fas fa-eye"></i> Lihat</button>'; } return '-'; }}] });
    var searchInput = document.getElementById('trashSearch');
    if(searchInput) { searchInput.onkeyup = function() { var val = this.value.toLowerCase(); var tbody = document.querySelector('#trashTable tbody'); var rows = tbody.getElementsByTagName('tr'); for (var i = 0; i < rows.length; i++) { var text = rows[i].textContent.toLowerCase(); rows[i].style.display = text.indexOf(val) > -1 ? '' : 'none'; } }; }
};


// ===========================================
// MENU: LAPORAN BULAN
// ===========================================

// 1. Dashboard Lapbul
App.inits['lapbul_menu'] = function() {
    ['lbTotal', 'lbToday', 'lbSD', 'lbPAUD'].forEach(function(id) { var el = document.getElementById(id); if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size:0.6em"></i>'; });
    var elList = document.getElementById('lbListRecent'); if(elList) elList.innerHTML = '<div style="text-align:center; padding:10px;">Memuat...</div>';
    google.script.run.withSuccessHandler(function(stats) {
        if (!stats || stats.error) { var errMsg = stats ? stats.error : "Data null"; if(elList) elList.innerHTML = '<div style="color:red; padding:10px;">Error: ' + errMsg + '</div>'; return; }
        var animate = function(id, val) { var el = document.getElementById(id); if(el) el.textContent = val || 0; };
        animate('lbTotal', stats.total); animate('lbToday', stats.today); animate('lbSD', stats.countSD); animate('lbPAUD', stats.countPAUD);
        if(typeof Chart !== 'undefined') {
            var ctxTrend = document.getElementById('lbChartTrend');
            if (ctxTrend) { if (ctxTrend.chartInstance) ctxTrend.chartInstance.destroy();
                ctxTrend.chartInstance = new Chart(ctxTrend.getContext('2d'), { type: 'bar', data: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'], datasets: [ { label: 'SD', data: stats.trendSD, backgroundColor: '#3b82f6', borderRadius: 4 }, { label: 'PAUD', data: stats.trendPAUD, backgroundColor: '#8b5cf6', borderRadius: 4 } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' }, tooltip: { mode: 'index', intersect: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { grid: { display: false } } } } });
            }
            var ctxJenjang = document.getElementById('lbChartJenjang');
            if (ctxJenjang) { if (ctxJenjang.chartInstance) ctxJenjang.chartInstance.destroy();
                ctxJenjang.chartInstance = new Chart(ctxJenjang.getContext('2d'), { type: 'doughnut', data: { labels: ['SD', 'PAUD'], datasets: [{ data: [stats.countSD, stats.countPAUD], backgroundColor: ['#3b82f6', '#8b5cf6'], borderWidth: 2, borderColor: '#ffffff' }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } } } });
            }
        }
        var listHtml = '';
        if(!stats.recent || stats.recent.length === 0) listHtml = '<div style="padding:10px; color:#ccc;">Belum ada aktivitas</div>';
        else {
            stats.recent.forEach(function(r) {
                var color = r.jenjang === 'SD' ? '#3b82f6' : '#8b5cf6'; 
                listHtml += `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f1f5f9;"><div><div style="font-weight:600; font-size:0.85em; color:#334155;">${r.sekolah}</div><div style="font-size:0.75em; color:#94a3b8;">${r.waktu}</div></div><div style="font-size:0.75em; font-weight:bold; color:${color};">${r.jenjang}</div></div>`;
            });
        }
        if(elList) elList.innerHTML = listHtml;
    }).getLapbulDashboardStats();
};

// 2. Unggah Lapbul (Placeholder)
App.inits['lapbul_unggah'] = function() {
    // Logika form unggah (bisa ditambahkan jika perlu inisialisasi khusus)
};

// 3. Kelola Lapbul
App.inits['lapbul_kelola'] = function() {
    var curYear = new Date().getFullYear();
    var selTahun = document.getElementById('kelolaTahun'); var selBulan = document.getElementById('kelolaBulan');
    var selJenjang = document.getElementById('kelolaJenjang'); var selSekolah = document.getElementById('kelolaSekolah');
    if(selTahun && selTahun.options.length <= 1) { selTahun.innerHTML = '<option value="">-- Semua Tahun --</option>'; for(var y = curYear; y >= 2023; y--) selTahun.add(new Option(y, y)); }
    if(selBulan && selBulan.options.length <= 1) { selBulan.innerHTML = '<option value="">-- Semua Bulan --</option>'; var mList = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"]; mList.forEach(function(m) { selBulan.add(new Option(m, m)); }); }
    var allTableData = [];
    App.initSmartTable({
        tableId: 'lapbulKelolaTable', serverFunc: 'getLapbulKelolaData',
        headers: [ "Nama Sekolah", { name: "Jenjang", width: "80px", tdStyle: "text-align:center;" }, { name: "Status", width: "100px", tdStyle: "text-align:center;" }, { name: "Bulan", width: "100px" }, { name: "Tahun", width: "80px", tdStyle: "text-align:center;" },
            { name: "Dokumen", width: "100px", tdStyle: "text-align:center;", formatter: function(row) {
                var url = row.Dokumen; if (url && url.includes('http')) { var safeUrl = encodeURIComponent(url); var safeTitle = encodeURIComponent('Laporan ' + (row['Bulan'] || '') + ' ' + (row['Tahun'] || ''));
                return '<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), decodeURIComponent(\'' + safeTitle + '\'))"><i class="fas fa-eye"></i> Lihat</button>';
                } return '<span style="color:#cbd5e1;">-</span>';
            }},
            { name: "Aksi", width: "100px", tdStyle: "text-align:center;", formatter: function(row) {
                var editPage = (row.Jenjang === 'SD') ? 'lapbul_edit_sd' : 'lapbul_edit_paud';
                var btnEdit = `<button class="btn-action-sm btn-edit" title="Edit" onclick="App.loadPage(null, '${editPage}', {rowIndex: ${row._rowIndex}})"><i class="fas fa-pencil-alt"></i></button>`;
                var rowStr = JSON.stringify(row).replace(/'/g, "&apos;");
                var btnDel = `<button class="btn-action-sm btn-delete" title="Hapus" onclick='App.showDeleteConfirmation(this)' data-row-info='${rowStr}'><i class="fas fa-trash"></i></button>`;
                return `<div style="display:flex; gap:5px; justify-content:center;">${btnEdit}${btnDel}</div>`;
            }},
            { name: "Tanggal Unggah", width: "150px", tdStyle: "color:#64748b; font-size:0.9em;" }, { name: "Update", width: "150px", tdStyle: "color:#64748b; font-size:0.9em;" }, { name: "User", width: "120px", tdStyle: "text-align:left;" }, { name: "User Edit", width: "120px", tdStyle: "text-align:left;" }
        ],
        filters: [ { id:'kelolaTahun', col:'Tahun', label:'-- Semua Tahun --' }, { id:'kelolaBulan', col:'Bulan', label:'-- Semua Bulan --' }, { id:'kelolaJenjang', col:'Jenjang', label:'-- Semua Jenjang --' }, { id:'kelolaSekolah', col:'Nama Sekolah', label:'-- Cari Sekolah --' } ],
        onLoad: function(rows) { allTableData = rows; updateSekolahDropdown(); }
    });
    var searchBox = document.getElementById('kelolaSearch');
    var searchTimeout = null;
    if(searchBox) {
        searchBox.onkeyup = function() {
            var term = this.value.toLowerCase();
            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                var rows = document.querySelectorAll('#lapbulKelolaTable tbody tr');
                requestAnimationFrame(function() {
                    rows.forEach(function(r) { 
                        if (term.length > 0 && term.length < 5) return; 
                        var isMatch = r.innerText.toLowerCase().includes(term);
                        r.style.display = isMatch ? '' : 'none'; 
                    });
                });
            }, 500); 
        };
    }
    if(selJenjang) { selJenjang.addEventListener('change', function() { if(selSekolah) selSekolah.value = ""; updateSekolahDropdown(); }); }
    function updateSekolahDropdown() {
        if(!selSekolah) return;
        var selectedJenjang = selJenjang ? selJenjang.value : ""; var currentSelection = selSekolah.value;
        var uniqueSet = new Set();
        allTableData.forEach(function(r) { if (!selectedJenjang || r.Jenjang === selectedJenjang) { if (r['Nama Sekolah']) uniqueSet.add(r['Nama Sekolah']); } });
        var filteredSchools = Array.from(uniqueSet).sort();
        selSekolah.innerHTML = '<option value="">-- Cari Sekolah --</option>';
        filteredSchools.forEach(function(s) { selSekolah.add(new Option(s, s)); });
        if(filteredSchools.includes(currentSelection)) { selSekolah.value = currentSelection; }
    }
};

// 4. Edit Lapbul SD
App.inits['lapbul_edit_sd'] = function(params) {
    if (!params || !params.rowIndex) return App.loadPage(null, 'lapbul_kelola');
    var formId = 'lapbulEditFormSd'; var form = document.getElementById(formId);
    
    // Tampilkan Loading
    var loadingDiv = document.getElementById('loading-data');
    var formContainer = document.getElementById('form-edit-container');

    if (loadingDiv) loadingDiv.style.display = 'block';
    if (formContainer) formContainer.style.display = 'none';

    google.script.run.withSuccessHandler(function(data) {
        // Tutup Modal Loading Global jika ada
        App.closeAppModal();

        if (!data) { 
             if(loadingDiv) loadingDiv.innerHTML = '<div style="color:red;text-align:center;">Data tidak ditemukan.</div>';
             return; 
        }

        try {
            if(loadingDiv) loadingDiv.style.display = 'none';
            if(formContainer) {
                formContainer.style.display = 'block'; 
                formContainer.style.opacity = '0';
                setTimeout(() => formContainer.style.opacity = '1', 100);
            }

            // 1. POPULATE TAHUN (FIX EMPTY YEAR)
            var selTahun = form.querySelector('select[name="Tahun"]');
            if(selTahun) {
                selTahun.innerHTML = ''; // Bersihkan "Memuat..."
                var thn = data['Tahun'] || new Date().getFullYear();
                selTahun.add(new Option(thn, thn));
                selTahun.add(new Option(parseInt(thn)+1, parseInt(thn)+1));
                selTahun.add(new Option(parseInt(thn)-1, parseInt(thn)-1));
                selTahun.value = thn;
            }

            // 2. SETUP LOGIKA KELAS DINAMIS
            if (typeof App.setupSdEditLogic === 'function') App.setupSdEditLogic(form, data);

            // 3. POPULATE FORM DASAR
            if (typeof App.populateForm === 'function') App.populateForm(formId, data);
            
            // 4. ISI HIDDEN FIELDS
            var inpRow = form.querySelector('input[name="rowIndex"]');
            var inpSrc = form.querySelector('input[name="source"]');
            if(inpRow) inpRow.value = params.rowIndex;
            if(inpSrc) inpSrc.value = 'SD';
            
            // 5. USER EDIT
            if(App.currentUser) {
                var editorName = App.currentUser.nama || App.currentUser.username || 'User';
                var uInput = form.querySelector('input[name="User Edit"]');
                if(!uInput) { uInput = document.createElement('input'); uInput.type='hidden'; uInput.name='User Edit'; form.appendChild(uInput); }
                uInput.value = editorName; 
            }

            // 6. FILE PREVIEW
            var fileBox = document.getElementById('existingFileLink');
            if (fileBox) {
                if (data['Dokumen'] && String(data['Dokumen']).includes('http')) {
                     var safeUrl = encodeURIComponent(data['Dokumen']);
                     fileBox.innerHTML = `
                         <i class="fas fa-file-pdf" style="color:#ef4444; font-size:2em;"></i>
                         <div style="flex-grow:1;">
                            <span style="display:block; font-weight:600; color:#334155;">Dokumen Tersimpan</span>
                            <span style="font-size:0.85em; color:#94a3b8;">Klik tombol lihat untuk preview</span>
                         </div>
                         <button type="button" class="btn-download" style="padding:8px 20px; font-weight:bold; background:#3b82f6; color:white; border:none; border-radius:4px; cursor:pointer;" 
                            onclick="App.showFilePreview(decodeURIComponent('${safeUrl}'), 'Dokumen Laporan')">
                            <i class="fas fa-eye"></i> LIHAT
                         </button>`;
                } else { 
                    fileBox.innerHTML = '<div style="color:#94a3b8; font-style:italic;">Belum ada dokumen yang diunggah.</div>'; 
                }
            }

            // 7. SETUP TABS & VALIDASI
            if (typeof App.setupFormTabs === 'function') App.setupFormTabs(form);
            if (typeof App.setupSdValidation === 'function') App.setupSdValidation(form);

        } catch(err) {
            console.error('[ERROR] Render Edit SD:', err);
            if(loadingDiv) {
                loadingDiv.style.display = 'block';
                loadingDiv.innerHTML = '<div class="text-danger p-3 text-center">Terjadi kesalahan script: ' + err.message + '</div>';
            }
        }

    }).withFailureHandler(function(e) {
        App.closeAppModal(); 
        if(loadingDiv) {
            loadingDiv.style.display = 'block';
            loadingDiv.innerHTML = '<div class="text-danger p-3">Gagal mengambil data: ' + e.message + '</div>';
        }
    }).getLapbulDataByRow(params.rowIndex, 'SD');

    if(form) {
        form.onsubmit = function(e) {
            e.preventDefault();
            
            // Validasi File Baru
            var fileInput = document.getElementById('fileLapbulSdEdit');
            if (fileInput && fileInput.files.length > 0) {
                if (fileInput.files[0].size > 307200) return App.showAppModal('error', 'File Terlalu Besar', 'Maksimal 300 KB.');
                if (fileInput.files[0].type !== 'application/pdf') return App.showAppModal('error', 'Format Salah', 'Wajib PDF.');
            }

            if (typeof App.handleEditSubmit === 'function') { 
                App.handleEditSubmit(this); 
            } else { 
                alert("Fungsi App.handleEditSubmit tidak ditemukan!"); 
            }
        };
    }
};

// 5. Riwayat Lapbul
App.inits['lapbul_riwayat'] = function() {
    App.initSmartTable({
        tableId: 'riwayatTable', serverFunc: 'getLapbulRiwayatData',
        headers: ["Nama Sekolah", { name: "Jenjang", width: "80px", tdStyle: "text-align:center;" }, { name: "Status", width: "100px", tdStyle: "text-align:center;" }, { name: "Bulan", width: "100px" }, { name: "Tahun", width: "80px", tdStyle: "text-align:center;" }, { name: "Rombel", width: "80px", tdStyle: "text-align:center;" },
            { name: "Dokumen", width: "100px", tdStyle: "text-align:center;", formatter: function(row) {
                var url = row.Dokumen; if (url && url.includes('http')) { var safeUrl = encodeURIComponent(url); var safeTitle = encodeURIComponent('Laporan ' + (row['Bulan'] || '') + ' ' + (row['Tahun'] || ''));
                return '<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), decodeURIComponent(\'' + safeTitle + '\'))"><i class="fas fa-eye"></i> Lihat</button>';
                } return '<span style="color:#cbd5e1;">-</span>';
            }},
            { name: "Tanggal Unggah", width: "150px", tdStyle: "text-align:center; color:#64748b; font-size:0.9em;" }, { name: "User", tdStyle: "text-align:left; color:#334155; font-weight:500;" }
        ],
        filters: [
            {id:'filterTahun',col:'Tahun',label:'-- Pilih Tahun --',desc:true},
            {id:'filterBulan',col:'Bulan',label:'-- Pilih Bulan --', sortOptions: function(a, b) { var months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"]; return months.indexOf(a) - months.indexOf(b); }},
            {id:'filterJenjang',col:'Jenjang',label:'-- Pilih Jenjang --'},
            {id:'filterSekolah',col:'Nama Sekolah',label:'-- Pilih Sekolah --'}
        ],
        onFilterChange: function(filterId, value, filteredRows, allRows) {
            if (filterId === 'filterJenjang') {
                var elSekolah = document.getElementById('filterSekolah'); if(!elSekolah) return;
                elSekolah.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
                var sourceData = value ? allRows.filter(function(r) { return r.Jenjang === value; }) : allRows;
                var schools = []; sourceData.forEach(function(r) { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                var uniqueSchools = [...new Set(schools)].sort();
                uniqueSchools.forEach(function(s) { elSekolah.add(new Option(s, s)); });
                elSekolah.value = ""; 
            }
        },
        onLoad: function(allRows) {
             var elSekolah = document.getElementById('filterSekolah');
             if(elSekolah && elSekolah.options.length <= 1) {
                 var schools = []; allRows.forEach(function(r) { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                 var uniqueSchools = [...new Set(schools)].sort(); uniqueSchools.forEach(function(s) { elSekolah.add(new Option(s, s)); });
             }
        }
    });
    var searchBox = document.getElementById('searchFilter'); if(searchBox) { searchBox.onkeyup = function() { var term = this.value.toLowerCase(); var rows = document.querySelectorAll('#riwayatTable tbody tr'); rows.forEach(function(r) { r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none'; }); }; }
};

// 6. Status Lapbul
App.inits['lapbul_status'] = function() {
    var curYear = new Date().getFullYear();
    var selTahun = document.getElementById('filterTahun'); var selJenjang = document.getElementById('filterJenjang');
    if(selTahun && selTahun.options.length === 0) { selTahun.innerHTML = ''; for(var y = curYear; y >= 2023; y--) selTahun.add(new Option(y, y)); }
    
    var loadTable = function() {
        var params = { tahun: document.getElementById('filterTahun') ? document.getElementById('filterTahun').value : new Date().getFullYear(), jenjang: "" };
        App.initSmartTable({
            tableId: 'lapbulStatusTable', serverFunc: 'getLapbulStatusData', params: params,
            headers: ["Nama Sekolah", { name: "Jenjang", width: "80px", tdStyle: "text-align:center;" },
                { name: "Januari", width: "70px", tdStyle: "text-align:center;" }, { name: "Februari", width: "70px", tdStyle: "text-align:center;" }, 
                { name: "Maret", width: "70px", tdStyle: "text-align:center;" }, { name: "April", width: "70px", tdStyle: "text-align:center;" },   
                { name: "Mei", width: "70px", tdStyle: "text-align:center;" }, { name: "Juni", width: "70px", tdStyle: "text-align:center;" },
                { name: "Juli", width: "70px", tdStyle: "text-align:center;" }, { name: "Agustus", width: "70px", tdStyle: "text-align:center;" },  
                { name: "September", width: "70px", tdStyle: "text-align:center;" }, { name: "Oktober", width: "70px", tdStyle: "text-align:center;" }, 
                { name: "November", width: "70px", tdStyle: "text-align:center;" }, { name: "Desember", width: "70px", tdStyle: "text-align:center;" }
            ],
            filters: [],
            onLoad: function(rows) {
                 var allTableRows = rows;
                 var selSekolah = document.getElementById('filterNamaSekolah'); var selJenjang = document.getElementById('filterJenjang');
                 if(selJenjang && selJenjang.options.length <= 1) {
                     var uniqueJenjang = [...new Set(rows.map(r => r.Jenjang))].filter(Boolean).sort();
                     uniqueJenjang.forEach(j => selJenjang.add(new Option(j, j)));
                 }
                 var updateSekolahDropdown = function(schoolList) {
                    if(!selSekolah) return;
                    var currentVal = selSekolah.value; selSekolah.innerHTML = '<option value="">-- Cari Sekolah --</option>';
                    var uniqueSchools = [...new Set(schoolList)].sort();
                    uniqueSchools.forEach(function(s) { selSekolah.add(new Option(s, s)); });
                    if (uniqueSchools.includes(currentVal)) { selSekolah.value = currentVal; } else { selSekolah.value = ""; }
                };
                var applyFilters = function() {
                    var jenjangVal = selJenjang ? selJenjang.value : ""; var sekolahVal = selSekolah ? selSekolah.value : "";
                    var table = document.getElementById('lapbulStatusTable'); var tbody = table.querySelector('tbody'); var trs = tbody.querySelectorAll('tr');
                    var visibleSchools = []; var visibleCount = 0;
                    trs.forEach(function(tr, index) {
                        var rowData = allTableRows[index]; if(!rowData) return;
                        var txtNama = rowData['Nama Sekolah'] || ""; var txtJenjang = rowData['Jenjang'] || "";
                        var matchJenjang = (jenjangVal === "" || txtJenjang.toUpperCase().includes(jenjangVal.toUpperCase()));
                        var matchSekolah = (sekolahVal === "" || txtNama === sekolahVal);
                        if (matchJenjang && matchSekolah) {
                            tr.style.display = ""; visibleCount++;
                            if(tr.cells[0]) tr.cells[0].textContent = visibleCount;
                            if(matchJenjang) visibleSchools.push(txtNama); 
                        } else { tr.style.display = "none"; }
                    });
                    updateSekolahDropdown(visibleSchools);
                };
                if (selJenjang) { selJenjang.onchange = function() { if(selSekolah) selSekolah.value = ""; applyFilters(); }; }
                if (selSekolah) { selSekolah.onchange = function() { applyFilters(); }; }
                applyFilters();
                 var table = document.getElementById('lapbulStatusTable');
                 var cells = table.querySelectorAll('td');
                 cells.forEach(function(td) {
                     if (td.textContent === '' || td.textContent === 'v') { td.innerHTML = '<i class="fas fa-check-circle" style="color:#16a34a; font-size:1.2em;"></i>'; } 
                     else if (td.textContent === '' || td.textContent === '-') { td.style.backgroundColor = '#f8fafc'; td.innerHTML = '<span style="color:#e2e8f0;">-</span>'; }
                 });
            }
        });
    };
    loadTable();
};

// 7. Trash Lapbul
App.inits['lapbul_trash'] = function() {
    var session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!(session.role || '').toLowerCase().includes('admin')) { document.getElementById('main-content').innerHTML = '<div style="text-align:center; margin-top:50px;">Akses Ditolak</div>'; return; }
    App.initSmartTable({ tableId: 'trashTable', serverFunc: 'getLapbulTrashData', headers: [
        "Nama Sekolah", "Jenjang", "Bulan", "Tahun", 
        { name: "Info Hapus", tdStyle: "text-align:left; color:#ef4444; font-size:0.85em;" }, 
        { name: "Waktu Hapus", tdStyle: "text-align:left; color:#64748b; font-size:0.85em;" }, 
        { name: "Dokumen", tdStyle: "text-align:center;", formatter: function(row) { var url = row.Dokumen; if (url && url.includes('http')) { var safeUrl = encodeURIComponent(url); var safeTitle = encodeURIComponent('Deleted'); return '<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), decodeURIComponent(\'' + safeTitle + '\'))"><i class="fas fa-eye"></i> Lihat</button>'; } return '-'; }}
    ] });
};

// ===========================================
// FUNGSI NAVIGASI EDIT / HAPUS / VERIF
// ===========================================

// 1. FUNGSI EDIT SK
App.skEdit = function(rowIndex, encNama, encTahun, encSmt, encNomor, encTgl, encKrit, encUrl) {
    App.tempEditData = { rowIndex: rowIndex, namaSekolah: decodeURIComponent(encNama), tahun: decodeURIComponent(encTahun), semester: decodeURIComponent(encSmt), nomor: decodeURIComponent(encNomor), tanggal: decodeURIComponent(encTgl), kriteria: decodeURIComponent(encKrit), fileUrl: decodeURIComponent(encUrl || '') };
    App.loadPage(null, 'sk_edit');
};

// 2. FUNGSI HAPUS SK
App.skHapus = function(rowIndex, encNama) {
    var namaSekolah = decodeURIComponent(encNama);
    Swal.fire({ title: 'Hapus Data?', html: "Anda yakin ingin menghapus data dari:<br><b>" + namaSekolah + "</b>?<br><br><small style='color:#64748b;'>Data akan dipindahkan ke Trash (Sampah).</small>", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#94a3b8', confirmButtonText: 'Ya, Hapus!', cancelButtonText: 'Batal', focusCancel: true }).then((result) => { if (result.isConfirmed) { App.showAppModal('loading', 'Menghapus data...'); var d = new Date(); var yyyy = d.getFullYear(); var mm = String(d.getMonth() + 1).padStart(2, '0'); var dd = String(d.getDate()).padStart(2, '0'); var code = yyyy + mm + dd; var actorName = 'Admin'; var actorRole = 'Administrator'; if (App.currentUser) { actorName = App.currentUser.nama || App.currentUser.username || 'Admin'; actorRole = App.currentUser.role || 'User'; } google.script.run.withSuccessHandler(function(r) { App.showAppModal('success', r); if(App.inits['sk_kelola']) App.inits['sk_kelola'](); }).withFailureHandler(function(e) { App.showAppModal('error', e.message); }).deleteSKData(rowIndex, code, actorName, actorRole); } });
};

// 3. FUNGSI VERIFIKASI SK
App.skVerifikasi = function(rowIndex, encNama, encTahun, encSemester, encUrl, encNomor, encTgl, encKrit) {
    var namaSekolah = decodeURIComponent(encNama); var tahun = decodeURIComponent(encTahun); var semester = decodeURIComponent(encSemester);
    var docUrl = decodeURIComponent(encUrl || ''); var nomorSK = encNomor ? decodeURIComponent(encNomor) : '-';
    var tglSK = encTgl ? decodeURIComponent(encTgl) : '-'; var kriteria = encKrit ? decodeURIComponent(encKrit) : '-';
    var previewHtml = '';
    if (docUrl && docUrl.includes('http')) {
        var fileId = ""; var match = docUrl.match(/[-\w]{25,}/); if (match) fileId = match[0];
        var previewLink = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : docUrl;
        previewHtml = '<div style="flex:1; height:100%; min-height:500px; background:#f1f5f9; border-radius:8px; border:1px solid #e2e8f0; overflow:hidden; position:relative;"><iframe src="' + previewLink + '" style="width:100%; height:100%; border:none;" allow="autoplay"></iframe></div>';
    } else {
        previewHtml = '<div style="flex:1; height:100%; min-height:500px; background:#f8fafc; border-radius:8px; border:1px dashed #cbd5e1; display:flex; align-items:center; justify-content:center; color:#94a3b8; flex-direction:column;"><i class="fas fa-file-excel" style="font-size:4em; margin-bottom:15px; opacity:0.5;"></i><p style="font-weight:500;">Tidak ada dokumen untuk ditampilkan.</p></div>';
    }
    var htmlContent = '<div style="display:flex; flex-direction:row; gap:25px; text-align:left; font-size:0.95em; height:75vh; max-height:800px;">' + previewHtml + '<div style="width:320px; display:flex; flex-direction:column; gap:15px;"><div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #e2e8f0; box-shadow:0 2px 4px rgba(0,0,0,0.02);"><h6 style="margin:0 0 10px 0; color:#64748b; font-size:0.75em; text-transform:uppercase; letter-spacing:0.5px; font-weight:700;">Data Sekolah</h6><div style="margin-bottom:8px;"><strong style="display:block; color:#1e293b; font-size:1.1em; line-height:1.3;">' + namaSekolah + '</strong></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;"><div style="background:#f8fafc; padding:8px; border-radius:6px; text-align:center;"><span style="display:block; font-size:0.75em; color:#64748b;">Tahun</span><strong style="color:#334155; font-size:0.9em;">' + tahun + '</strong></div><div style="background:#f8fafc; padding:8px; border-radius:6px; text-align:center;"><span style="display:block; font-size:0.75em; color:#64748b;">Semester</span><strong style="color:#334155; font-size:0.9em;">' + semester + '</strong></div></div></div><div style="flex:1; display:flex; flex-direction:column; gap:15px;"><div><label style="font-weight:600; display:block; margin-bottom:6px; font-size:0.9em; color:#334155;">Keputusan Verifikasi</label><select id="verifStatus" class="std-filter-select" style="width:100%;"><option value="OK"> Disetujui (OK)</option><option value="Revisi"> Perlu Revisi</option><option value="Ditolak"> Ditolak</option></select></div><div style="flex-grow:1; display:flex; flex-direction:column;"><label style="font-weight:600; display:block; margin-bottom:6px; font-size:0.9em; color:#334155;">Catatan Verifikator</label><textarea id="verifNote" class="swal2-textarea" style="width:100%; margin:0; flex-grow:1; font-size:0.9em; line-height:1.5; padding:10px; border-color:#cbd5e1; resize:none;" placeholder="Berikan catatan perbaikan jika status Revisi atau alasan penolakan..."></textarea></div></div></div></div>';
    Swal.fire({ title: 'Verifikasi Data SK', html: htmlContent, width: '95%', padding: '20px', showCancelButton: true, confirmButtonText: '<i class="fas fa-save" style="margin-right:5px;"></i> Simpan Keputusan', cancelButtonText: 'Batal', confirmButtonColor: '#10b981', cancelButtonColor: '#94a3b8', reverseButtons: true, focusConfirm: false, customClass: { popup: 'swal-wide-popup' }, preConfirm: function() { var status = document.getElementById('verifStatus').value; var note = document.getElementById('verifNote').value; if (status !== 'OK' && !note) { Swal.showValidationMessage('Wajib isi catatan untuk status Revisi/Ditolak!'); return false; } return { status: status, note: note }; } }).then(function(result) { if (result.isConfirmed) { App.showAppModal('loading', 'Menyimpan Verifikasi...'); google.script.run.withSuccessHandler(function(response) { App.showAppModal('success', response); if (App.inits['sk_kelola']) App.inits['sk_kelola'](); }).withFailureHandler(function(error) { App.showAppModal('error', error.message); }).updateSKVerificationStatus({ rowIndex: rowIndex, status: result.value.status, keterangan: result.value.note, verifikator: 'Admin' }); } });
};

// ... Helper Functions (App.setupSdEditLogic, App.populateForm, App.handleEditSubmit) ...
App.setupSdEditLogic = function(form, data) {
    var tabContainer = document.getElementById('edit-subTabContainer'); var contentContainer = document.getElementById('edit-kelasContentArea');
    if (!tabContainer || !contentContainer) return;
    tabContainer.innerHTML = ''; contentContainer.innerHTML = '';
    var agamas = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
    for (var k = 1; k <= 6; k++) {
        var btn = document.createElement('button'); btn.type = 'button'; btn.className = (k === 1) ? 'sub-tab-btn active' : 'sub-tab-btn';
        btn.textContent = 'Kelas ' + k;
        btn.onclick = (function(idx) { return function() { 
            form.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active')); 
            form.querySelectorAll('.kelas-content').forEach(c => c.style.display = 'none');
            this.classList.add('active'); document.getElementById('edit_kelas_' + idx).style.display = 'block';
        }; })(k);
        tabContainer.appendChild(btn);
        var div = document.createElement('div'); div.id = 'edit_kelas_' + k; div.className = 'kelas-content'; div.style.display = (k === 1) ? 'block' : 'none';
        var createRombelBox = function(k, suffix, label) {
            var keyL = `K${k}${suffix} L`; var keyP = `K${k}${suffix} P`; var valL = data[keyL] || 0; var valP = data[keyP] || 0;
            return `<div class="input-box-card"><span class="box-title">${label}</span><div class="lp-wrapper"><div class="lp-field"><label>L</label><input type="number" name="${keyL}" class="form-control-mini val-rombel" style="text-align:center;" value="${valL}"></div><div class="lp-field"><label>P</label><input type="number" name="${keyP}" class="form-control-mini val-rombel" style="text-align:center;" value="${valP}"></div></div></div>`;
        };
        var rombelCount = "1";
        if (data[`K${k}C L`] > 0 || data[`K${k}C P`] > 0) rombelCount = "3"; else if (data[`K${k}B L`] > 0 || data[`K${k}B P`] > 0) rombelCount = "2";
        var rombelInputs = '';
        if (rombelCount === "3") { rombelInputs += createRombelBox(k, 'A', `Kelas ${k}A`) + createRombelBox(k, 'B', `Kelas ${k}B`) + createRombelBox(k, 'C', `Kelas ${k}C`); } 
        else if (rombelCount === "2") { rombelInputs += createRombelBox(k, 'A', `Kelas ${k}A`) + createRombelBox(k, 'B', `Kelas ${k}B`); } 
        else { rombelInputs += createRombelBox(k, '', `Kelas ${k}`); }
        var agamaInputs = '';
        agamas.forEach(agm => {
            var keyL = `K${k} ${agm} L`; var keyP = `K${k} ${agm} P`; var valL = data[keyL] || 0; var valP = data[keyP] || 0;
            agamaInputs += `<div class="input-box-card"><span class="box-title">${agm}</span><div class="lp-wrapper"><div class="lp-field"><label>L</label><input type="number" name="${keyL}" class="form-control-mini val-agama" style="text-align:center;" value="${valL}"></div><div class="lp-field"><label>P</label><input type="number" name="${keyP}" class="form-control-mini val-agama" style="text-align:center;" value="${valP}"></div></div></div>`;
        });
        div.innerHTML = `<div class="section-divider"><span>Data Kelas ${k} - Menurut Rombel</span></div><div class="rombel-control-box"><div class="form-group" style="margin-bottom:10px;"><label>Jumlah Rombel Terdeteksi: <b>${rombelCount}</b></label></div><div class="rombel-inputs-grid">${rombelInputs}</div></div><div class="section-divider"><span>Data Kelas ${k} - Menurut Agama</span></div><div class="input-grid-container">${agamaInputs}</div><div class="validation-footer" style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:10px;"><div id="edit_val_rombel_${k}">Rombel: 0</div><div id="edit_val_agama_${k}">Agama: 0</div><span id="edit_status_${k}" class="val-status-text">Checking...</span></div>`;
        contentContainer.appendChild(div);
    }
};

App.setupSdValidation = function(form) {
    if(!form) return;
    var validateKelas = function() {
        for (var k = 1; k <= 6; k++) {
            var div = document.getElementById('edit_kelas_' + k); if (!div) continue;
            var sumRombel = 0; div.querySelectorAll('.val-rombel').forEach(el => sumRombel += (parseInt(el.value)||0));
            var sumAgama = 0; div.querySelectorAll('.val-agama').forEach(el => sumAgama += (parseInt(el.value)||0));
            document.getElementById(`edit_val_rombel_${k}`).textContent = `Total Rombel: ${sumRombel}`;
            document.getElementById(`edit_val_agama_${k}`).textContent = `Total Agama: ${sumAgama}`;
            var st = document.getElementById(`edit_status_${k}`);
            if(sumRombel === sumAgama && sumRombel > 0) { st.textContent = "VALID"; st.style.color = "green"; st.style.fontWeight="bold"; } 
            else if (sumRombel === 0 && sumAgama === 0) { st.textContent = "Kosong"; st.style.color = "#94a3b8"; } 
            else { st.textContent = "TIDAK SAMA"; st.style.color = "red"; st.style.fontWeight="bold"; }
        }
    };
    form.addEventListener('input', function(e) { if(e.target.type === 'number') { validateKelas(); } });
    validateKelas();
};

App.populateForm = function(formId, data) {
    var form = document.getElementById(formId); if (!form) return;
    var elements = form.querySelectorAll('input, select, textarea');
    elements.forEach(function(el) {
        var name = el.name;
        if (name && data.hasOwnProperty(name)) el.value = data[name];
    });
};

App.setupFormTabs = function(form) {
    var tabs = form.querySelectorAll('.tab-link'); var panels = form.querySelectorAll('.tab-content-form');
    tabs.forEach(btn => {
        btn.onclick = function() {
            tabs.forEach(t => t.classList.remove('active')); panels.forEach(p => { p.classList.remove('active'); p.style.display = 'none'; });
            this.classList.add('active'); var target = document.getElementById(this.dataset.tab); if(target) { target.classList.add('active'); target.style.display = 'block'; }
        };
    });
};

App.handleEditSubmit = function(formElement) {
    var btn = formElement.querySelector('button[type="submit"]'); var oldHtml = btn.innerHTML;
    var formData = {}; var inputs = formElement.querySelectorAll('input, select, textarea');
    inputs.forEach(el => { if(el.name) formData[el.name] = el.value; });
    var sendData = function(filePayload) {
        if (filePayload) formData.fileData = filePayload;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        google.script.run.withSuccessHandler(function(res) {
            btn.disabled = false; btn.innerHTML = oldHtml;
            App.showAppModal('success', res, 'lapbul_kelola');
        }).withFailureHandler(function(err) {
            btn.disabled = false; btn.innerHTML = oldHtml; App.showAppModal('error', 'Gagal', err.message);
        }).updateLapbulData(formData);
    };
    var fileInput = formElement.querySelector('input[type="file"]');
    if (fileInput && fileInput.files.length > 0) {
        var reader = new FileReader();
        reader.onload = function(e) { sendData({ data: e.target.result.split(',')[1], mimeType: fileInput.files[0].type, fileName: fileInput.files[0].name }); };
        reader.readAsDataURL(fileInput.files[0]);
    } else { sendData(null); }
};

document.addEventListener('DOMContentLoaded', App.init);
</script>