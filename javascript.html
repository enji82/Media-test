<script>
const App = {}; 

// ===========================================
// 1. INIT SYSTEM (ANTI-BLANK + AVATAR FIX)
// ===========================================
App.init = function() {
    // Reset Modal
    document.querySelectorAll('.modal-overlay').forEach(function(el) { el.style.display = 'none'; el.classList.remove('show'); });
    
    var userSession = localStorage.getItem('user_session');
    var sidebar = document.querySelector('.sidebar');
    var mainContent = document.getElementById('main-content');

    if (!userSession) {
        // --- MODE: BELUM LOGIN ---
        if(sidebar) sidebar.style.display = 'none';
        if(mainContent) {
            mainContent.style.marginLeft = '0'; mainContent.style.width = '100%'; mainContent.style.padding = '0';
            mainContent.style.display = 'flex'; mainContent.style.alignItems = 'center'; mainContent.style.justifyContent = 'center';
        }
        App.loadPage(null, 'login'); 
    } else {
        // --- MODE: SUDAH LOGIN ---
        var user;
        try { user = JSON.parse(userSession); } catch (e) { localStorage.removeItem('user_session'); window.location.reload(); return; }
        
        var role = (user.role || '').toLowerCase();
        var isAdmin = (role.indexOf('admin') !== -1); // Pakai indexOf agar lebih kompatibel

        if(sidebar) sidebar.style.display = 'flex';
        if(mainContent) mainContent.removeAttribute('style'); 

        // Atur Menu Admin
        var adminMenus = document.querySelectorAll('.admin-only');
        for(var j=0; j<adminMenus.length; j++) { adminMenus[j].style.display = isAdmin ? 'block' : 'none'; }
        
        // --- FIX AVATAR (LOGIKA ASLI DIKEMBALIKAN) ---
        setTimeout(function() {
            var elName = document.getElementById('sidebar-user-name');
            var elRole = document.getElementById('sidebar-user-role');
            var elAvatar = document.querySelector('.user-avatar-small'); 

            if (elName) elName.textContent = user.nama || "User";
            if (elRole) elRole.textContent = user.role || "Staff";
            
            // --- LOGIKA THUMBNAIL DARI FILE LAMA ANDA ---
            if (elAvatar && user.foto && String(user.foto).trim() !== "") {
                var imgUrl = user.foto.trim();
                
                // Cek 1: Apakah link Google Drive View?
                if (imgUrl.indexOf('drive.google.com') !== -1 && imgUrl.indexOf('/view') !== -1) {
                    var parts = imgUrl.split('/d/');
                    if (parts.length > 1) imgUrl = 'https://drive.google.com/thumbnail?id=' + parts[1].split('/')[0] + '&sz=s1000';
                } 
                // Cek 2: Apakah hanya ID saja (tanpa http)?
                else if (imgUrl.indexOf('http') === -1) {
                     imgUrl = 'https://drive.google.com/thumbnail?id=' + imgUrl + '&sz=s1000';
                }
                
                // Tampilkan Gambar
                elAvatar.innerHTML = '<img src="' + imgUrl + '" alt="Profil" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">';
            } else if (elAvatar) {
                // Fallback Icon
                elAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
            // ---------------------------------------------

        }, 50);

        // Jalankan Sidebar Interaksi
        App.setupSidebar();

        // Load Home
        var currentContent = mainContent.innerHTML.trim();
        if (!currentContent || document.getElementById('loginForm')) {
            App.loadPage(null, 'home');
        }
        // PATCH: Agar klik menu induk 'SK Pembagian Tugas' juga membuka dashboard
        var skMenuLink = document.querySelector('a[data-page="sk_menu"]');
        if (skMenuLink) {
            skMenuLink.addEventListener('click', function(e) {
                // Jangan preventDefault sepenuhnya agar submenu tetap toggle (jika pakai CSS/JS lain)
                // Tapi kita paksa load halaman dashboard
                App.loadPage(e, 'sk_menu');
            });
        }
    }
};

// ===========================================
// 2. LOGIKA UTAMA (LOGIN, NAVIGASI)
// ===========================================

// Login Tanpa Refresh
App.handleLogin = function(e) {
    e.preventDefault();
    var btn = document.getElementById('btnLogin');
    var err = document.getElementById('loginError');
    var u = document.getElementById('username').value;
    var p = document.getElementById('password').value;
    
    if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...'; }
    if(err) err.style.display = 'none';

    google.script.run.withSuccessHandler(function(res) {
        if(res.status === 'success') {
            localStorage.setItem('user_session', JSON.stringify(res.user));
            // RE-INIT LANGSUNG (ANTI BLANK)
            App.init(); 
        } else {
            if(err) { err.textContent = res.message; err.style.display = 'block'; }
            else alert(res.message);
            if(btn) { btn.disabled = false; btn.innerHTML = 'MASUK'; }
        }
    }).withFailureHandler(function(e) {
        alert("Error: " + e.message);
        if(btn) { btn.disabled = false; btn.innerHTML = 'MASUK'; }
    }).loginUser(u, p);
};

// Navigasi Halaman
App.loadPage = function(e, p, arg) {
    if(e) e.preventDefault();
    var main = document.getElementById('main-content');
    
    // --- UPDATE BAGIAN INI ---
    if(p !== 'login' && main) {
        // Gunakan Spinner Lingkaran Baru
        main.innerHTML = '<div class="loading-container">' +
                         '<div class="app-spinner"></div>' +
                         '<p class="loading-text">Memuat Halaman...</p>' +
                         '</div>';
    }
    // -------------------------
    
    // ... sisa kode highlight menu dan google.script.run biarkan sama ...
    var menus = document.querySelectorAll('.sidebar-menu a');
    for(var i=0; i<menus.length; i++) menus[i].classList.remove('active');
    
    var cur = document.querySelector('.sidebar-menu a[data-page="' + p + '"]');
    if(cur) {
        cur.classList.add('active');
        var parentLi = cur.closest('.has-submenu');
        if(parentLi && !parentLi.classList.contains('open')) {
            var parentLink = parentLi.querySelector('a');
            if(parentLink) parentLink.click();
        }
    }

    google.script.run.withSuccessHandler(function(h) {
        if(main) main.innerHTML = h;
        if(App.inits[p]) setTimeout(function() { App.inits[p](arg); }, 50);
    }).withFailureHandler(function(err) {
        if(main) main.innerHTML = '<div style="color:red; text-align:center; padding:50px;">Gagal: ' + err.message + '</div>';
    }).include('page_' + p);
};

// Setup Interaksi Sidebar (Dropdown)
App.setupSidebar = function() {
    var parentMenus = document.querySelectorAll('.has-submenu > a');
    for(var i=0; i<parentMenus.length; i++) {
        var menu = parentMenus[i];
        var newMenu = menu.cloneNode(true);
        menu.parentNode.replaceChild(newMenu, menu);
        newMenu.addEventListener('click', function(e) {
            e.preventDefault();
            var p = this.parentElement;
            var sub = p.querySelector('.submenu');
            var icon = this.querySelector('.submenu-icon');
            
            // Accordion: Tutup menu lain
            var siblings = p.parentElement.children;
            for (var k = 0; k < siblings.length; k++) {
                if (siblings[k] !== p && siblings[k].classList.contains('has-submenu')) {
                    siblings[k].classList.remove('open');
                    var sibSub = siblings[k].querySelector('.submenu');
                    var sibIcon = siblings[k].querySelector('.submenu-icon');
                    if (sibSub) sibSub.style.maxHeight = null;
                    if (sibIcon) sibIcon.style.transform = "rotate(0deg)";
                }
            }

            p.classList.toggle('open');
            if(sub) {
                if(p.classList.contains('open')) {
                    sub.style.maxHeight = sub.scrollHeight + "px";
                    if(icon) icon.style.transform = "rotate(90deg)";
                } else {
                    sub.style.maxHeight = null;
                    if(icon) icon.style.transform = "rotate(0deg)";
                }
            }
        });
    }

    var navLinks = document.querySelectorAll('.sidebar-menu a[data-page]');
    for(var k=0; k<navLinks.length; k++) {
        var link = navLinks[k];
        if(link.getAttribute('data-page') !== 'logout' && !link.parentElement.classList.contains('has-submenu')) {
            var newLink = link.cloneNode(true);
            link.parentNode.replaceChild(newLink, link);
            newLink.addEventListener('click', function(e) {
                e.preventDefault();
                App.loadPage(e, this.getAttribute('data-page'));
            });
        }
    }

    var logoutLink = document.querySelector('a[data-page="logout"]');
    if(logoutLink) {
        logoutLink.onclick = function(e) { 
            e.preventDefault(); 
            localStorage.removeItem('user_session'); 
            App.init(); // Soft Logout
        };
    }
};

// ===========================================
// 3. LOGIKA HALAMAN (UNGGAH, EDIT, TABLE)
// ===========================================
App.inits = {
    'home': function(){},
    
    // Modul SK
    'sk_riwayat': function() {
        App.initSmartTable({
            tableId: 'riwayatTable', serverFunc: 'getSKRiwayatData',
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK", "Status", "Dokumen", "Tanggal Unggah", "User"],
            filters: [{id:'filterTahun',col:'Tahun Ajaran',desc:true}, {id:'filterSemester',col:'Semester'}, {id:'filterNamaSekolah',col:'Nama Sekolah'}]
        });
    },
    'sk_kelola': function() {
        App.initSmartTable({
            tableId: 'kelolaTable', 
            serverFunc: 'getSKKelolaData',
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK", "Dokumen", "Status", "Aksi", "Tanggal Unggah", "Update", "User", "Verifikator", "Keterangan"],
            filters: [
              {id:'filterTahun',col:'Tahun Ajaran',desc:true}, {id:'filterSemester',col:'Semester'}, 
              {id:'filterNamaSekolah',col:'Nama Sekolah'},
              {id:'filterStatus', col:'_statusRaw'}]
        });
    },
    'sk_trash': function() {
        // 1. CEK KEAMANAN (ADMIN ONLY)
        var session = JSON.parse(localStorage.getItem('user_session') || '{}');
        var role = (session.role || '').toLowerCase();
        
        if (!role.includes('admin')) {
            document.getElementById('main-content').innerHTML = 
                '<div style="text-align:center; margin-top:50px; color:#64748b;">' +
                '<i class="fas fa-lock" style="font-size:3rem; margin-bottom:20px;"></i>' +
                '<h3>Akses Ditolak</h3>' +
                '<p>Halaman ini hanya dapat diakses oleh Administrator.</p>' +
                '</div>';
            return;
        }

        // 2. JIKA ADMIN, MUAT TABEL
        App.initSmartTable({
            tableId: 'trashTable', 
            serverFunc: 'getSKTrashData',
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Info Hapus", "Waktu Hapus", "Dokumen"],
            
            // Filter Search Manual (karena initSmartTable punya search bawaan id='searchFilter' tapi kita pakai id beda)
            // Kita bisa inject logika search manual di callback success jika mau, 
            // tapi agar konsisten dengan halaman lain, kita gunakan id='trashSearch' sebagai search filter.
        });

        // 3. AKTIFKAN SEARCH (Manual Binding karena ID beda dengan default SmartTable)
        var searchInput = document.getElementById('trashSearch');
        if(searchInput) {
            searchInput.onkeyup = function() {
                var val = this.value.toLowerCase();
                var tbody = document.querySelector('#trashTable tbody');
                var rows = tbody.getElementsByTagName('tr');
                
                for (var i = 0; i < rows.length; i++) {
                    var text = rows[i].textContent.toLowerCase();
                    rows[i].style.display = text.indexOf(val) > -1 ? '' : 'none';
                }
            };
        }
    },
    'sk_status': function() { if(App.initMatrixTable) App.initMatrixTable('statusTable', 'getSKStatusData'); },
    'sk_arsip': function() { App.arsipPath=[{id:null,name:'Home'}]; App.loadFolder(null); },
    'sk_edit': function(arg) { if(typeof initSkEditPage === 'function') initSkEditPage(arg); },
    'sk_unggah': function() { if(typeof initSkUnggahPage === 'function') initSkUnggahPage(); },
    'sk_menu': function() {
        // --- 1. SET LOADING STATE (6 ITEM) ---
        ['statTotal', 'statToday', 'statProses', 'statOK', 'statRevisi', 'statDitolak'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size:0.6em"></i>';
        });
        document.getElementById('listRecent').innerHTML = '<div style="text-align:center; padding:10px;">Memuat...</div>';

        // --- 2. REQUEST DATA ---
        google.script.run.withSuccessHandler(function(stats) {
            if(stats.error) { console.error(stats.error); return; }

            // A. ISI KARTU (ANIMASI)
            var animate = function(id, val) {
                var el = document.getElementById(id);
                if(el) el.textContent = val || 0;
            };
            animate('statTotal', stats.total);
            animate('statToday', stats.today);
            animate('statProses', stats.status.proses);
            animate('statOK', stats.status.ok);
            animate('statRevisi', stats.status.revisi);
            animate('statDitolak', stats.status.ditolak); // <-- TAMBAHAN INI

            // B. UPDATE SEMESTER
            var semHtml = '';
            if (stats.topSemesters && stats.topSemesters.length > 0) {
                stats.topSemesters.forEach(function(s) {
                    semHtml += '<div class="sem-badge">' + 
                               '<i class="fas fa-tag" style="color:#64748b"></i> ' + s.label + 
                               '<span class="sem-count">' + s.count + '</span></div>';
                });
            } else {
                semHtml = '<span style="color:#94a3b8; font-size:0.9em;">Belum ada data semester</span>';
            }
            var elSem = document.getElementById('semesterStats');
            if(elSem) elSem.innerHTML = semHtml;

            // C. RENDER CHART
            if(typeof Chart !== 'undefined') {
                
                // Chart Tren
                var ctxTrend = document.getElementById('chartTrend');
                if (ctxTrend) {
                    if (ctxTrend.chartInstance) ctxTrend.chartInstance.destroy();
                    
                    ctxTrend.chartInstance = new Chart(ctxTrend.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'],
                            datasets: [{
                                label: 'Data Masuk',
                                data: stats.monthlyTrend,
                                backgroundColor: '#3b82f6',
                                borderRadius: 4,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, ticks: { precision: 0 } }, 
                                x: { grid: { display: false } } 
                            }
                        }
                    });
                }

                // Chart Status
                var ctxStatus = document.getElementById('chartStatus');
                if (ctxStatus) {
                    if (ctxStatus.chartInstance) ctxStatus.chartInstance.destroy();

                    ctxStatus.chartInstance = new Chart(ctxStatus.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Diproses', 'OK', 'Revisi', 'Ditolak'],
                            datasets: [{
                                data: [
                                    stats.status.proses, 
                                    stats.status.ok, 
                                    stats.status.revisi, 
                                    stats.status.ditolak
                                ],
                                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '65%',
                            plugins: { 
                                legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
                            }
                        }
                    });
                }
            }

            // D. RECENT ACTIVITY
            var listHtml = '';
            if(stats.recent.length === 0) listHtml = '<div style="padding:10px; color:#ccc;">Belum ada aktivitas</div>';
            else {
                stats.recent.forEach(function(r) {
                    var st = String(r.status).replace(/<[^>]*>?/gm, '').trim(); 
                    var color = '#64748b';
                    if(st.includes('OK') || st.includes('Setuju')) color='#10b981';
                    else if(st.includes('Revisi')) color='#f59e0b';
                    else if(st.includes('Ditolak')) color='#ef4444';
                    
                    listHtml += '<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f1f5f9;">' +
                                '<div><div style="font-weight:600; font-size:0.85em; color:#334155;">'+r.sekolah+'</div>' +
                                '<div style="font-size:0.75em; color:#94a3b8;">'+r.waktu+'</div></div>' +
                                '<div style="font-size:0.75em; font-weight:bold; color:'+color+';">'+st+'</div>' +
                                '</div>';
                });
            }
            var elList = document.getElementById('listRecent');
            if(elList) elList.innerHTML = listHtml;

        }).getSKDashboardStats();
    },
    
    // Tambahkan init modul lain di sini jika perlu
};

// --- FUNGSI UNGGAH SK (DENGAN LOGIKA DROPDOWN BERANTAI) ---
function initSkUnggahPage() {
    var form = document.getElementById('skUnggahForm');
    if (!form) return;

    // --- BAGIAN 1: LOGIKA DROPDOWN (KEMBALI KE VERSI ASLI ANDA) ---
    var elTahun = document.getElementById('unggahTahun');
    
    // Tampilkan loading
    if(elTahun) elTahun.innerHTML = '<option>Memuat...</option>';

    google.script.run.withSuccessHandler(function(opts) {
        // Helper isi option (Versi Asli)
        var populate = function(el, data) {
            if(!el) return; 
            el.innerHTML = '<option value="">-- Pilih --</option>';
            if(data) {
                data.forEach(function(i) { el.add(new Option(i, i)); });
            }
        };

        // Isi Dropdown
        populate(document.getElementById('unggahTahun'), opts['Tahun Ajaran']);
        populate(document.getElementById('unggahSemester'), opts['Semester']);
        populate(document.getElementById('unggahKriteria'), opts['Kriteria SK']);
        
        var schoolMap = opts['Nama Sekolah List'] || {};
        var elStatus = document.getElementById('unggahStatusSekolah');
        
        // Isi Status
        populate(elStatus, Object.keys(schoolMap).sort());
        
        // Logika Berantai (Status -> Nama)
        if(elStatus) {
            // Clone untuk reset listener
            var newStatus = elStatus.cloneNode(true);
            elStatus.parentNode.replaceChild(newStatus, elStatus);
            
            newStatus.addEventListener('change', function() {
                var list = schoolMap[this.value] || [];
                // Isi Nama Sekolah
                populate(document.getElementById('unggahNamaSekolah'), list);
            });
        }
    }).getMasterSkOptions();


    // --- BAGIAN 2: LOGIKA SUBMIT (VALIDASI 1MB & POPUP TEMA) ---
    var newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);

    newForm.onsubmit = function(e) {
        e.preventDefault();
        
        var btn = newForm.querySelector('button[type="submit"]');
        var oriText = btn.innerHTML;
        var fileInput = document.getElementById('unggahFile');

        // VALIDASI: File Ada?
        if (fileInput.files.length === 0) { 
            App.showAppModal('error', "Harap pilih file PDF SK terlebih dahulu."); 
            return false; 
        }

        // VALIDASI: Ukuran 1MB (1,048,576 bytes)
        if (fileInput.files[0].size > 1048576) { 
            App.showAppModal('error', "Ukuran file terlalu besar. Maksimal 1 MB."); 
            return false; 
        }

        // VALIDASI: Tipe PDF
        if (fileInput.files[0].type !== 'application/pdf') {
            App.showAppModal('error', "Format file harus PDF.");
            return false;
        }

        // PROSES UPLOAD
        var user = "User";
        try { user = document.getElementById('sidebar-user-name').textContent; } catch(err){}

        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengunggah...';

        var reader = new FileReader();
        reader.onload = function(ex) {
            var data = {
                tahunAjaran: document.getElementById('unggahTahun').value,
                semester: document.getElementById('unggahSemester').value,
                statusSekolah: document.getElementById('unggahStatusSekolah').value,
                namaSekolah: document.getElementById('unggahNamaSekolah').value,
                nomorSK: document.getElementById('unggahNomorSK').value,
                tanggalSK: document.getElementById('unggahTanggalSK').value,
                kriteriaSK: document.getElementById('unggahKriteria').value,
                fileData: { 
                    fileName: fileInput.files[0].name, 
                    mimeType: fileInput.files[0].type, 
                    data: ex.target.result.split(',')[1] 
                },
                loggedInUser: user
            };

            google.script.run.withSuccessHandler(function(r) {
                App.showAppModal('success', r, 'sk_riwayat');
            }).withFailureHandler(function(e) {
                btn.disabled = false; btn.innerHTML = oriText;
                App.showAppModal('error', e.message);
            }).processManualForm(data);
        };
        reader.readAsDataURL(fileInput.files[0]);
        return false;
    };
}

// --- FUNGSI EDIT SK ---
function initSkEditPage(arg) {
    if (!arg || !arg.rowIndex) return;
    
    var form = document.getElementById('skEditForm');
    var rowIndexInput = document.getElementById('editRowIndex');
    if(!form || !rowIndexInput) return;

    // Set Row Index
    rowIndexInput.value = arg.rowIndex; 
    
    // Tampilkan Loading Modal
    App.showAppModal('loading', 'Mengambil data...');
    
    // --- LANGKAH 1: AMBIL OPSI DROPDOWN DULU ---
    google.script.run.withSuccessHandler(function(opts) {
        
        // Helper isi dropdown
        var populate = function(id, data) {
            var el = document.getElementById(id);
            if(!el) return;
            el.innerHTML = '<option value="">-- Pilih --</option>';
            if(data) data.forEach(function(i){ el.add(new Option(i,i)); });
        };

        populate('editTahun', opts['Tahun Ajaran']);
        populate('editSemester', opts['Semester']);
        populate('editKriteria', opts['Kriteria SK']);

        // --- LANGKAH 2: AMBIL DATA BARIS (Setelah dropdown siap) ---
        google.script.run.withSuccessHandler(function(data) {
            // Tutup Loading
            document.getElementById('appModal').style.display = 'none'; 
            
            // Isi Form
            document.getElementById('editStatusSekolah').value = data.statusSekolah || '';
            document.getElementById('editNamaSekolah').value = data.namaSekolah || '';
            document.getElementById('editNomorSK').value = data.nomorSK || '';
            document.getElementById('editTanggalSK').value = data.tanggalSK || '';
            
            // Set Nilai Dropdown
            var setVal = function(id, v) { 
                var el = document.getElementById(id); 
                if(el) el.value = v; 
            };
            setVal('editTahun', data.tahunAjaran);
            setVal('editSemester', data.semester);
            setVal('editKriteria', data.kriteriaSK);
            
            // Render Tombol File
            var linkArea = document.getElementById('currentFileLink');
            if(data.dokumen && data.dokumen.includes('http')) {
                linkArea.innerHTML = '<button type="button" class="btn-download" style="font-size:0.85em; padding:5px 12px; background:#3b82f6;" ' +
                                     'onclick="App.showFilePreview(\''+data.dokumen+'\')">' +
                                     '<i class="fas fa-eye"></i> Lihat File</button>';
            } else {
                linkArea.innerHTML = '<span style="color:#ef4444; font-style:italic;">Tidak ada file</span>';
            }

        }).withFailureHandler(function(e){
            App.showAppModal('error', "Gagal ambil data: " + e.message);
        }).getSKDataByRow(arg.rowIndex);

    }).withFailureHandler(function(e){
        App.showAppModal('error', "Gagal load dropdown: " + e.message);
    }).getMasterSkOptions();


    // --- LANGKAH 3: HANDLE SUBMIT (VALIDASI 1MB + POPUP TEMA) ---
    var newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    newForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        var btn = newForm.querySelector('button[type="submit"]');
        var originalBtnText = btn.innerHTML;
        var fileInput = document.getElementById('editFile');

        // Validasi File (Jika ada file baru dipilih)
        if (fileInput.files.length > 0) {
            // Cek Ukuran 1MB
            if (fileInput.files[0].size > 1048576) { 
                App.showAppModal('error', "Ukuran file baru terlalu besar. Maksimal 1 MB."); 
                return false; 
            }
            // Cek PDF
            if (fileInput.files[0].type !== 'application/pdf') {
                App.showAppModal('error', "File baru harus format PDF.");
                return false;
            }
        }

        var currentUser = document.getElementById('sidebar-user-name').textContent;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

        var send = function(fData) {
            var d = {
                rowIndex: document.getElementById('editRowIndex').value,
                statusSekolah: document.getElementById('editStatusSekolah').value,
                namaSekolah: document.getElementById('editNamaSekolah').value,
                tahunAjaran: document.getElementById('editTahun').value,
                semester: document.getElementById('editSemester').value,
                nomorSK: document.getElementById('editNomorSK').value,
                tanggalSK: document.getElementById('editTanggalSK').value,
                kriteriaSK: document.getElementById('editKriteria').value,
                fileData: fData, // Bisa null jika tidak ganti file
                editorName: currentUser 
            };

            google.script.run.withSuccessHandler(function(res) {
                App.showAppModal('success', res, 'sk_kelola'); 
            }).withFailureHandler(function(err) {
                btn.disabled = false; btn.innerHTML = originalBtnText;
                App.showAppModal('error', err.message);
            }).updateSKData(d);
        };

        // Baca File jika ada
        if (fileInput.files.length > 0) {
            var r = new FileReader();
            r.onload = function(ex) { 
                send({ 
                    fileName: fileInput.files[0].name, 
                    mimeType: fileInput.files[0].type, 
                    data: ex.target.result.split(',')[1] 
                }); 
            };
            r.readAsDataURL(fileInput.files[0]);
        } else {
            send(null); // Kirim null, backend akan pakai file lama
        }
    });
}

App.initSmartTable = function(cfg) {
    var tb = document.querySelector(`#${cfg.tableId} tbody`);
    var thd = document.querySelector(`#${cfg.tableId} thead`);
    
    if(!tb) return;

    // Tampilkan Wrapper
    document.getElementById('tableWrapper').style.display = 'flex';
    var oldLoader = document.getElementById('loadingStatus');
    if(oldLoader) oldLoader.style.display = 'none';
    
    // 1. Render Header
    if(thd && cfg.headers) { 
        var h='<tr><th>No.</th>'; 
        cfg.headers.forEach(function(x){ h+='<th>'+x+'</th>'; }); 
        thd.innerHTML=h+'</tr>'; 
    }

    // 2. Render Skeleton
    var skeletonHTML = ''; 
    for(var i=0; i<8; i++) { 
        skeletonHTML += '<tr class="skeleton-row"><td><div class="skeleton-bar" style="width:20px"></div></td>'; 
        cfg.headers.forEach(function(){ skeletonHTML += '<td><div class="skeleton-bar"></div></td>'; }); 
        skeletonHTML += '</tr>'; 
    }
    tb.innerHTML = skeletonHTML;

    // 3. Panggil Data
    google.script.run.withSuccessHandler(function(d) {
        if(!d || d.length === 0 || d.error) { 
            tb.innerHTML = '<tr><td colspan="100" style="text-align:center; padding:30px; color:#64748b;">Data Kosong</td></tr>'; 
            return; 
        }
        
        var rows = d.rows || d;
        
        // 4. Render Data
        var render = function(data) {
            tb.innerHTML = '';
            data.forEach(function(r, ix) {
                var tr = document.createElement('tr');
                tr.style.animation = "fadeIn 0.3s ease-in forwards";
                tr.style.opacity = "0"; 
                tr.style.animationDelay = (ix * 0.05) + "s"; 

                tr.innerHTML = '<td>'+(ix+1)+'</td>';
                
                cfg.headers.forEach(function(k) {
                    var td = document.createElement('td');
                    var v = r[k]===null || r[k]===undefined ? '-' : r[k];
                    
                    if(k==='Dokumen' && String(v).includes('http')) {
                        td.innerHTML='<button class="action-btn view-btn" onclick="event.preventDefault();App.showFilePreview(\''+v+'\')"><i class="fas fa-eye"></i> Lihat</button>';
                    }
                    else if(k==='Aksi') { 
                        var div = document.createElement('div');
                        div.style.cssText = "display:flex; gap:5px; justify-content:center;";

                        // --- LOGIKA PENGUNCIAN STATUS ---
                        // Bersihkan tag HTML dari status untuk pengecekan text murni
                        var rawStatus = String(r['Status']).replace(/<[^>]*>?/gm, '').trim().toLowerCase();
                        // Kunci jika OK, Disetujui, atau V
                        var isLocked = (rawStatus === 'ok' || rawStatus === 'disetujui' || rawStatus === 'v');

                        // 1. Tombol Edit
                        var btnEdit = document.createElement('button');
                        btnEdit.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                        
                        if (isLocked) {
                            // Style Disabled (Abu-abu)
                            btnEdit.className = 'action-btn'; // Hapus class edit-btn biar warnanya netral
                            btnEdit.style.cssText = "color:#cbd5e1; cursor:not-allowed; background:none; border:1px solid #e2e8f0;";
                            btnEdit.disabled = true;
                            btnEdit.title = "Data sudah disetujui (Terkunci)";
                        } else {
                            btnEdit.className = 'action-btn edit-btn';
                            btnEdit.title = 'Edit Data';
                            btnEdit.onclick = function() { App.loadPage(null, 'sk_edit', {rowIndex: r._rowIndex}); };
                        }
                        div.appendChild(btnEdit);

                        // 2. Tombol Hapus
                        var btnDel = document.createElement('button');
                        btnDel.innerHTML = '<i class="fas fa-trash"></i>';
                        
                        if (isLocked) {
                            // Style Disabled (Abu-abu)
                            btnDel.className = 'action-btn';
                            btnDel.style.cssText = "color:#cbd5e1; cursor:not-allowed; background:none; border:1px solid #e2e8f0;";
                            btnDel.disabled = true;
                            btnDel.title = "Data sudah disetujui (Terkunci)";
                        } else {
                            btnDel.className = 'action-btn delete-btn';
                            btnDel.title = 'Hapus Data';
                            btnDel.dataset.rowInfo = JSON.stringify(r);
                            btnDel.onclick = function() { App.showDeleteConfirmation(this); };
                        }
                        div.appendChild(btnDel);

                        // 3. Tombol Verifikasi (Admin Only) - Selalu aktif buat admin (untuk pembatalan status)
                        var userSession = localStorage.getItem('user_session');
                        if (userSession) {
                            var u = JSON.parse(userSession);
                            if (u.role && u.role.toLowerCase().indexOf('admin') !== -1) {
                                var btnVerif = document.createElement('button');
                                btnVerif.className = 'action-btn submit-btn';
                                btnVerif.innerHTML = '<i class="fas fa-check"></i>';
                                btnVerif.title = 'Verifikasi';
                                btnVerif.onclick = function() { App.openVerifModal(r); };
                                div.appendChild(btnVerif);
                            }
                        }

                        td.appendChild(div);
                    }
                    else if(['Status','Validasi'].includes(k)) td.innerHTML = v;
                    else td.textContent = v;
                    tr.appendChild(td);
                });
                tb.appendChild(tr);
            });
        };
        render(rows);

        if(cfg.filters) {
            cfg.filters.forEach(function(f) {
                var el = document.getElementById(f.id);
                if(el) {
                    el.innerHTML = '<option value="">Semua</option>';
                    var vals=[]; rows.forEach(function(rx){ vals.push(rx[f.col]); });
                    var u = vals.filter(function(v, i, a){ return a.indexOf(v) === i; }).sort();
                    if(f.desc) u.reverse();
                    u.forEach(function(x){ el.add(new Option(x,x)); });
                    el.onchange = function() {
                         var val = el.value;
                         var res = rows.filter(function(row){ return !val || String(row[f.col]) === val; });
                         render(res);
                    };
                }
            });
        }
        
        var searchInput = document.getElementById('searchFilter');
        if(searchInput) {
            searchInput.onkeyup = function() {
                var val = this.value.toLowerCase();
                var res = rows.filter(function(row) {
                    return Object.values(row).some(function(txt) {
                        return String(txt).toLowerCase().includes(val);
                    });
                });
                render(res);
            };
        }

    }).withFailureHandler(function(e){ 
        tb.innerHTML='<tr><td colspan="100" style="color:red; text-align:center; padding:20px;">Gagal: '+e.message+'</td></tr>'; 
    })[cfg.serverFunc]();
};

App.initMatrixTable = function(tid, func) {
    var t = document.getElementById(tid); 
    if (!t) return;
    
    var tb = t.querySelector('tbody');
    var thd = t.querySelector('thead');
    var searchInput = document.getElementById('matrixSearch');

    // 1. Setup UI Awal
    t.classList.add('matrix-mode');
    document.getElementById('tableWrapper').style.display = 'flex';
    
    // 2. RENDER SKELETON (LEBIH RAPI)
    // Kita buat header palsu yang mirip struktur matriks (No, Nama, dan 5 kolom status dummy)
    if(thd) {
        var dummyCols = '';
        for(var k=0; k<5; k++) dummyCols += '<th style="width:60px"><div class="skeleton-bar status"></div></th>';
        
        thd.innerHTML = '<tr>' +
                        '<th rowspan="2" class="col-no">No</th>' +
                        '<th rowspan="2" class="col-nama">Sekolah</th>' +
                        '<th colspan="5">Memuat Data...</th>' +
                        '</tr>' +
                        '<tr>' + dummyCols + '</tr>';
    }

    // Buat baris skeleton (8 baris)
    var skeletonHTML = '';
    for(var i=0; i<8; i++) {
        // Variasi panjang bar nama biar terlihat natural (random 50% - 90%)
        var randW = Math.floor(Math.random() * 40) + 50; 
        
        var dummyCells = '';
        for(var j=0; j<5; j++) dummyCells += '<td><div class="skeleton-bar status"></div></td>';

        skeletonHTML += '<tr class="skeleton-row">' +
                        '<td class="col-no"><div class="skeleton-bar short"></div></td>' + 
                        '<td class="col-nama"><div class="skeleton-bar" style="width:'+randW+'%"></div></td>' + 
                        dummyCells + // Masukkan 5 sel dummy
                        '</tr>';
    }
    
    if(tb) tb.innerHTML = skeletonHTML;

    // 3. Panggil Data
    google.script.run.withSuccessHandler(function(d) {
        
        if (!d || d.length === 0 || d.error) { 
            tb.innerHTML = '<tr><td colspan="100" style="padding:20px; text-align:center;">Data Matriks Kosong / Belum Tersedia</td></tr>'; 
            return; 
        }

        // --- RENDER HEADER ASLI ---
        var h1 = d[0]; 
        var h2 = d[1];
        
        var thHTML = '<tr><th rowspan="2" class="col-no">No</th><th rowspan="2" class="col-nama">Nama Sekolah</th>';
        
        for (var i = 1; i < h1.length; i++) {
            if (h1[i]) {
                var span = 1;
                var nextIdx = h1.slice(i + 1).findIndex(function(x) { return x !== ""; });
                if (nextIdx !== -1) span = nextIdx + 1;
                else span = h1.length - i; 
                
                thHTML += '<th colspan="' + span + '" style="border-left:1px solid #cbd5e1">' + h1[i] + '</th>';
            }
        }
        thHTML += '</tr><tr>';
        
        for (var i = 1; i < h2.length; i++) {
            var borderStyle = (i > 1 && h1[i]) ? 'border-left:1px solid #cbd5e1' : '';
            thHTML += '<th class="col-data" style="' + borderStyle + '">' + (h2[i] || '-') + '</th>';
        }
        thHTML += '</tr>';
        thd.innerHTML = thHTML;

        // --- RENDER BODY ASLI ---
        var allRows = d.slice(2);
        
        var renderRows = function(dataSet) {
            var trHTML = '';
            if(dataSet.length === 0) {
                tb.innerHTML = '<tr><td colspan="100" style="text-align:center; padding:20px;">Tidak ditemukan</td></tr>';
                return;
            }

            dataSet.forEach(function(row, idx) {
                trHTML += '<tr>';
                trHTML += '<td class="col-no">' + (idx + 1) + '</td>';
                trHTML += '<td class="col-nama" style="text-align:left;">' + row[0] + '</td>';
                
                for (var j = 1; j < row.length; j++) {
                    var cellStyle = (j > 1 && h1[j]) ? 'border-left:1px solid #cbd5e1' : '';
                    trHTML += '<td class="col-data" style="' + cellStyle + '">' + row[j] + '</td>';
                }
                trHTML += '</tr>';
            });
            tb.innerHTML = trHTML;
        };

        renderRows(allRows);

        if (searchInput) {
            searchInput.onkeyup = function() {
                var keyword = this.value.toLowerCase();
                var filtered = allRows.filter(function(row) {
                    return String(row[0]).toLowerCase().includes(keyword);
                });
                renderRows(filtered);
            };
        }

    }).withFailureHandler(function(e) {
        tb.innerHTML = '<tr><td colspan="100" style="color:red; text-align:center; padding:20px;">Gagal memuat: ' + e.message + '</td></tr>';
    })[func]();
};

// ===========================================
// LOGIKA FILE MANAGER (FIXED & HARDENED)
// ===========================================

App.arsipPath = []; 
App.currentArsipItems = [];
App.arsipViewMode = 'grid'; 

// 1. Fungsi Load Folder (Navigasi)
App.loadFolder = function(fid, isBack) {
    App.closePreview(); 
    
    var grid = document.getElementById('fileGrid'); 
    var loader = document.getElementById('arsipLoading');
    var emptyMsg = document.getElementById('emptyFolderMsg');
    
    if(!grid) return;

    // --- PERBAIKAN: JANGAN KOSONGKAN GRID ---
    // Biarkan item lama tetap terlihat tapi blur
    grid.classList.add('blur-loading'); 
    
    // Tampilkan loader overlay di tengah
    if(loader) loader.style.display = 'flex'; 
    if(emptyMsg) emptyMsg.style.display = 'none';

    // Init Home Path
    if (!fid && App.arsipPath.length === 0) {
        App.arsipPath.push({id: null, name: 'Home'});
    }

    google.script.run.withSuccessHandler(function(d) {
        setTimeout(function() {
            // Hapus blur dan loader
            grid.classList.remove('blur-loading');
            loader.style.display = 'none';
            
            // BARU SEKARANG KITA GANTI ISINYA
            grid.innerHTML = ''; 

            if (d.status === 'error') { 
                grid.innerHTML = '<div style="color:red;padding:20px;text-align:center;">'+d.message+'</div>'; 
                return; 
            }

            // Update Path
            if (d.currentId === d.rootId) {
                App.arsipPath = [{id: null, name: 'Home'}];
            } else if (fid && isBack !== true) {
                var last = App.arsipPath[App.arsipPath.length-1];
                if (!last || last.id !== d.currentId) {
                    App.arsipPath.push({id: d.currentId, name: d.currentName});
                }
            }

            App.currentArsipItems = d.items || [];
            renderBreadcrumb();
            
            // Set Class Grid/List
            if (App.arsipViewMode === 'list') grid.className = 'file-list-view';
            else grid.className = 'file-grid';

            App.renderCurrentItems();
        }, 50); // Delay sedikit agar mata sempat melihat transisi blur-clear

    }).withFailureHandler(function(e) {
        grid.classList.remove('blur-loading');
        loader.style.display = 'none';
        grid.innerHTML = '<div style="color:red;padding:20px;">Gagal: '+e.message+'</div>';
    }).apiGetArsipFiles(fid); 
};

// 2. Helper Render Item
App.renderCurrentItems = function() {
    var grid = document.getElementById('fileGrid');
    var emptyMsg = document.getElementById('emptyFolderMsg');
    var input = document.getElementById('arsipSearchInput');
    
    var keyword = input ? input.value.toLowerCase() : '';
    
    var itemsToShow = App.currentArsipItems.filter(function(item) {
        return item.name.toLowerCase().includes(keyword);
    });

    grid.innerHTML = '';

    if (itemsToShow.length === 0) {
        if(emptyMsg) {
            emptyMsg.style.display = 'flex';
            emptyMsg.querySelector('p').textContent = keyword ? "Tidak ditemukan." : "Folder kosong";
        }
    } else {
        if(emptyMsg) emptyMsg.style.display = 'none';
        
        itemsToShow.forEach(function(i) {
            var c = document.createElement('div'); 
            c.className = 'fm-card';
            
            var ic = 'fa-file'; var colorClass = 'file';
            var isFolder = (i.type === 'folder' || (i.mime && i.mime.indexOf('folder') !== -1));

            if(isFolder) { ic = 'fa-folder'; colorClass = 'folder'; }
            else if(i.mime.includes('pdf')) { ic = 'fa-file-pdf'; colorClass = 'pdf'; }
            else if(i.mime.includes('sheet') || i.mime.includes('excel')) { ic = 'fa-file-excel'; colorClass = 'sheet'; }
            else if(i.mime.includes('image')) { ic = 'fa-file-image'; colorClass = 'img'; }
            
            c.innerHTML = '<i class="fas '+ic+' fm-icon '+colorClass+'"></i>' +
                          '<div class="fm-name" title="'+i.name+'">'+i.name+'</div>' +
                          '<div class="fm-meta">'+(isFolder ? i.updated : i.size)+'</div>';
            
            c.onclick = function(e) { 
                e.preventDefault(); 
                e.stopPropagation(); 
                
                // Tutup preview lama sebelum aksi baru
                App.closePreview();

                if (isFolder) {
                    App.loadFolder(i.id); 
                } else {
                    App.showFilePreview(i.url); 
                }
            };
            grid.appendChild(c);
        });
    }
};

// 3. Toggle View
App.toggleArsipView = function(mode) {
    App.arsipViewMode = mode;
    var btnGrid = document.getElementById('btnViewGrid');
    var btnList = document.getElementById('btnViewList');
    
    if(btnGrid) btnGrid.classList.toggle('active', mode === 'grid');
    if(btnList) btnList.classList.toggle('active', mode === 'list');
    
    var grid = document.getElementById('fileGrid');
    if (grid) {
        grid.className = (mode === 'list') ? 'file-list-view' : 'file-grid';
    }
    App.renderCurrentItems(); 
};

App.filterArsipFiles = function() { App.renderCurrentItems(); };

App.navToPath = function(targetIndex) {
    var targetItem = App.arsipPath[targetIndex];
    App.arsipPath = App.arsipPath.slice(0, targetIndex + 1);
    renderBreadcrumb();
    App.loadFolder(targetItem.id, true);
};

function renderBreadcrumb() {
    var container = document.getElementById('arsipBreadcrumb'); 
    if(!container) return;
    container.innerHTML = '';
    
    App.arsipPath.forEach(function(item, index) {
        if (index > 0) {
            var sep = document.createElement('i');
            sep.className = 'fas fa-chevron-right breadcrumb-sep';
            sep.style.cssText = 'font-size:0.8em; margin:0 6px; color:#cbd5e1;';
            container.appendChild(sep);
        }
        var span = document.createElement('span');
        span.textContent = item.name;
        
        if (index === App.arsipPath.length - 1) {
            span.className = 'breadcrumb-item active';
            span.style.fontWeight = 'bold';
            span.style.color = '#334155';
            span.style.cursor = 'default';
        } else {
            span.className = 'breadcrumb-item';
            span.style.cursor = 'pointer';
            span.style.color = '#0284c7';
            span.onclick = function() { App.navToPath(index); };
        }
        container.appendChild(span);
    });
}

// 4. Preview File (Container Reset Logic)
App.showFilePreview = function(url) {
    var modal = document.getElementById('previewModal');
    
    // Cari container iframe
    var container = modal.querySelector('.modal-content > div:nth-child(2)');
    
    // Self-healing jika container hilang
    if (!container) {
        var content = modal.querySelector('.modal-content');
        container = document.createElement('div');
        container.style.cssText = "flex: 1; position: relative; background: #fff; overflow: hidden; min-height: 400px;";
        content.appendChild(container);
    }

    // Reset isi container
    container.innerHTML = ''; 

    // Ekstrak ID
    var fileId = "";
    var match = url.match(/[-\w]{25,}/); 
    if (match) fileId = match[0];

    var previewUrl = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : url;
    var downloadUrl = fileId ? "https://drive.google.com/uc?export=download&id=" + fileId : url;

    // Update Tombol Download
    var header = modal.querySelector('.modal-content > div:first-child');
    var oldBtn = document.getElementById('dynamicDownloadBtn');
    if (oldBtn) oldBtn.remove();

    var btnDl = document.createElement('a');
    btnDl.id = 'dynamicDownloadBtn';
    btnDl.className = 'btn-download';
    btnDl.href = downloadUrl;
    btnDl.target = '_blank'; 
    btnDl.innerHTML = '<i class="fas fa-download"></i> Unduh';
    
    var closeBtn = header.querySelector('button');
    header.insertBefore(btnDl, closeBtn);

    // Buat Iframe Baru
    var iframe = document.createElement('iframe');
    iframe.id = 'previewFrame';
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.src = previewUrl;
    
    container.appendChild(iframe);
    modal.style.display = 'flex';
};

App.closePreview = function() { 
    var modal = document.getElementById('previewModal');
    if(modal) modal.style.display = 'none'; 
    
    // Kosongkan Container
    var container = modal.querySelector('.modal-content > div:nth-child(2)');
    if (container) {
        container.innerHTML = ''; 
    }
};

App.showAppModal = function(st, msg, redir) {
    var m = document.getElementById('appModal');
    var content = m.querySelector('.modal-content');
    var btn = document.getElementById('modalBtnMain');
    var icon = document.getElementById('modalIconBox');
    var title = document.getElementById('modalTitle');
    var msgEl = document.getElementById('modalMessage');

    // Reset Class
    content.classList.remove('success', 'error', 'loading');
    
    // Setup Konten Berdasarkan Status
    if (st === 'loading') {
        content.classList.add('loading');
        icon.innerHTML = '<div class="app-spinner"></div>';
        title.textContent = 'Memproses...';
        title.style.color = '#3b82f6';
        msgEl.textContent = msg || 'Mohon tunggu sebentar.';
        btn.style.display = 'none'; // Sembunyikan tombol saat loading
    } 
    else if (st === 'success') {
        content.classList.add('success');
        icon.innerHTML = '<i class="fas fa-check-circle animate-pop" style="color:#10b981;"></i>';
        title.textContent = 'BERHASIL!';
        title.style.color = '#10b981';
        msgEl.textContent = msg;
        btn.style.display = 'block';
        btn.textContent = 'OK, Lanjutkan';
    } 
    else { // error atau info
        content.classList.add('error');
        icon.innerHTML = '<i class="fas fa-times-circle animate-pop" style="color:#ef4444;"></i>';
        title.textContent = 'GAGAL / ERROR';
        title.style.color = '#ef4444';
        msgEl.textContent = msg;
        btn.style.display = 'block';
        btn.textContent = 'Tutup';
    }

    m.style.display = 'flex';
    
    // Fokus ke tombol
    if(st !== 'loading') setTimeout(function(){ btn.focus(); }, 100);

    // Event Klik Tombol
    btn.onclick = function() { 
        m.style.display = 'none'; 
        if (redir && st === 'success') {
            App.loadPage(null, redir); 
        }
    };
};

App.showFilePreview = function(url) {
    if(url.includes('drive')) url = url.replace('/view', '/preview');
    document.getElementById('previewModal').style.display = 'flex';
    document.getElementById('previewFrame').src = url;
};
App.closePreview = function() { document.getElementById('previewModal').style.display = 'none'; };

App.showDeleteConfirmation = function(btn) {
    // Ambil data baris dari tombol
    var d = JSON.parse(btn.dataset.rowInfo);
    var m = document.getElementById('deleteModal');
    
    // 1. ISI KOTAK INFORMASI (Detail Data)
    var infoHtml = 
        '<div class="delete-detail-row">' +
            '<span class="delete-detail-label">Sekolah</span>' +
            '<span class="delete-detail-value">' + d['Nama Sekolah'] + '</span>' +
        '</div>' +
        '<div class="delete-detail-row">' +
            '<span class="delete-detail-label">Tahun</span>' +
            '<span class="delete-detail-value">' + d['Tahun Ajaran'] + '</span>' +
        '</div>' +
        '<div class="delete-detail-row">' +
            '<span class="delete-detail-label">Semester</span>' +
            '<span class="delete-detail-value">' + d['Semester'] + '</span>' +
        '</div>';
    
    m.querySelector('.delete-info-card').innerHTML = infoHtml;
    
    // Reset Input Kode
    document.getElementById('delCode').value = '';

    // Tampilkan Modal
    m.style.display = 'flex';
    
    // Event Batal
    document.getElementById('cancelDeleteBtn').onclick = function() { 
        m.style.display='none'; 
    };
    
    // Event Hapus (Clone node untuk reset listener lama)
    var ok = document.getElementById('confirmDeleteBtn');
    var newOk = ok.cloneNode(true); 
    ok.parentNode.replaceChild(newOk, ok);
    
    newOk.onclick = function() {
        var c = document.getElementById('delCode').value;
        if(!c) { 
            App.showAppModal('error', 'Kode konfirmasi wajib diisi.'); 
            return; 
        }
        
        var s = JSON.parse(localStorage.getItem('user_session'));
        App.showAppModal('loading', 'Menghapus data...'); 
        m.style.display = 'none';
        
        google.script.run.withSuccessHandler(function(r) {
            App.showAppModal('success', r, 'sk_kelola');
        }).withFailureHandler(function(e) {
            App.showAppModal('error', e.message);
        }).deleteSKData(d._rowIndex, c, s.nama, s.role);
    };
};

App.openVerifModal = function(row) {
    // 1. Cek Admin
    var session = JSON.parse(localStorage.getItem('user_session') || '{}');
    var role = (session.role || '').toLowerCase();
    if (!role.includes('admin')) {
        App.showAppModal('error', 'Akses Ditolak. Fitur ini hanya untuk Admin.');
        return;
    }

    // 2. Cek HTML
    var m = document.getElementById('modalVerifikasi');
    var elNama = document.getElementById('v-nama');
    if (!m || !elNama) return alert("HTML Error: Struktur Modal belum sesuai.");

    // --- 3. RESET TOMBOL SIMPAN (PENTING!) ---
    // Ini memperbaiki masalah tombol "Menyimpan..." yang macet
    var btnSimpan = document.querySelector('#formVerifikasi button[type="submit"]');
    if (btnSimpan) {
        btnSimpan.disabled = false;
        btnSimpan.innerHTML = '<i class="fas fa-save"></i> SIMPAN PERUBAHAN';
    }

    // 4. Tampilkan Modal
    m.style.display = 'flex';

    // 5. Isi Data Teks
    document.getElementById('v-row-index').value = row._rowIndex;
    
    var set = function(id, val) { 
        var el = document.getElementById(id);
        if(el) el.textContent = (val && val !== '') ? val : '-'; 
    };

    set('v-nama', row['Nama Sekolah']);
    set('v-tahun', row['Tahun Ajaran']);
    set('v-semester', row['Semester']);
    set('v-nomor', row['Nomor SK']);
    set('v-tanggal', row['Tanggal SK']);
    set('v-kriteria', row['Kriteria SK']);

    // Isi Status Saat Ini
    document.getElementById('v-status-current').innerHTML = row['Status'] || '<span class="status-badge status-belum">-</span>';

    // Reset Dropdown & Keterangan
    document.getElementById('v-status').value = "";
    document.getElementById('v-keterangan').value = row['Keterangan'] || '';

    // --- 6. PREVIEW DOKUMEN ---
    var container = document.getElementById('v-preview-area');
    var url = row['Dokumen'];

    container.innerHTML = ''; 

    if (url && url.includes('http')) {
        // Mode Iframe (Inline Preview)
        var fileId = "";
        var match = url.match(/[-\w]{25,}/);
        if(match) fileId = match[0];
        
        var previewUrl = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : url;

        var iframe = document.createElement('iframe');
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.src = previewUrl;
        
        container.appendChild(iframe);
    } else {
        container.innerHTML = '<div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; opacity:0.6;">' +
                              '<i class="fas fa-file-excel" style="font-size:3rem; margin-bottom:10px;"></i>' +
                              '<p>Tidak ada dokumen</p></div>';
    }

    // --- 7. HANDLE SIMPAN ---
    var form = document.getElementById('formVerifikasi');
    var newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);

    newForm.onsubmit = function(e) {
        e.preventDefault();
        
        var dropdown = document.getElementById('v-status');
        if (!dropdown.value) {
            alert("Harap pilih Keputusan Verifikasi terlebih dahulu.");
            dropdown.focus();
            return;
        }

        var btnSubmit = newForm.querySelector('button[type="submit"]');
        var oldText = btnSubmit.innerHTML;
        btnSubmit.disabled = true; btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

        var payload = {
            rowIndex: document.getElementById('v-row-index').value,
            status: dropdown.value,
            keterangan: document.getElementById('v-keterangan').value,
            verifikator: session.nama || 'Admin'
        };

        google.script.run.withSuccessHandler(function(res) {
            App.tutupVerifikasi();
            App.showAppModal('success', res, 'sk_kelola');
        }).withFailureHandler(function(err) {
            btnSubmit.disabled = false; btnSubmit.innerHTML = oldText;
            alert("Gagal: " + err.message);
        }).updateSKVerificationStatus(payload);
    };
};

// Fungsi Tutup
App.tutupVerifikasi = function() {
    var m = document.getElementById('modalVerifikasi');
    if(m) m.style.display = 'none';
    
    var c = document.getElementById('v-preview-area');
    if(c) c.innerHTML = '';
};

document.addEventListener('DOMContentLoaded', App.init);
</script>