<script>
const App = {}; 
var colNo = { 
    name: "No.", 
    width: "40px", 
    formatter: function(row, key, index) { return index + 1; },
    tdStyle: "text-align:center; font-weight:bold; color:#64748b;"
};

// ===========================================
// GLOBAL HELPER: NOTIFIKASI & SUBMIT (FIX FINAL)
// ===========================================

// 1. CUSTOM ALERT (Pop-up Info/Error)
App.showAlert = function(type, title, msg) {
    var modal = document.getElementById('customAlertModal');
    // Fallback jika modal belum siap
    if(!modal) return alert(msg.replace(/<br>/g, '\n')); 

    var icon = document.getElementById('alertIcon');
    var btn = document.getElementById('btnAlertOk');
    
    document.getElementById('alertTitle').textContent = title;
    document.getElementById('alertDesc').innerHTML = msg;
    
    // Reset Kelas
    icon.className = 'confirm-icon';
    btn.className = 'btn-confirm-yes';

    // Atur Tipe
    if(type === 'error') {
        icon.classList.add('error');
        btn.classList.add('error');
        icon.innerHTML = '<i class="fas fa-times-circle"></i>';
    } else if(type === 'success') {
        icon.classList.add('success');
        btn.classList.add('success');
        icon.innerHTML = '<i class="fas fa-check-circle"></i>';
    } else {
        icon.innerHTML = '<i class="fas fa-info-circle"></i>';
    }

    // Tampilkan
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);
    
    // Reset Tombol
    var newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);
    newBtn.onclick = function() {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    };
};

// 2. CUSTOM CONFIRM
App.showConfirm = function(title, msg, callback) {
    var modal = document.getElementById('customConfirmModal');
    if(!modal) return callback(confirm(msg.replace(/<br>/g, '\n')));

    var btnYes = document.getElementById('btnConfirmYes');
    var btnNo = document.getElementById('btnConfirmNo');
    
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmDesc').innerHTML = msg;
    
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('show'), 10);

    var newYes = btnYes.cloneNode(true);
    var newNo = btnNo.cloneNode(true);
    btnYes.parentNode.replaceChild(newYes, btnYes);
    btnNo.parentNode.replaceChild(newNo, btnNo);

    newYes.onclick = function() {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
        callback(true);
    };
    newNo.onclick = function() {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
        callback(false);
    };
};

// 3. HANDLE FORM SUBMIT (INI YANG HARUS DIGANTI AGAR ALERT BERUBAH)
App.handleFormSubmit = function(formEl, funcName) {
    var btn = formEl.querySelector('button[type="submit"]');
    var fileIn = formEl.querySelector('input[type="file"]');
    
    // 1. VALIDASI FILE (Gunakan showAppModal)
    if(fileIn) {
        if(fileIn.files.length === 0) {
            return App.showAppModal('error', 'Harap pilih file dokumen yang akan diunggah.');
        }
        if(fileIn.files[0].size > 307200) { 
            return App.showAppModal('error', 'Ukuran file terlalu besar. Maksimal <b>300 KB</b>.<br>Silakan kompres file PDF Anda.');
        }
    }

    // Efek Loading
    var oldTxt = btn.innerHTML;
    btn.disabled = true; 
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';

    // Ambil Data Form
    var formData = {}; 
    var els = formEl.querySelectorAll('input, select');
    els.forEach(el => { if(el.name) formData[el.name] = el.value; });

    // Sisipkan User Login
    var activeUser = App.currentUser ? App.currentUser.nama : 'Admin/Guest';
    formData.User = activeUser;

    // Baca File & Kirim
    var reader = new FileReader();
    reader.onload = function(e) {
        formData.fileData = {
            data: e.target.result.split(',')[1],
            mimeType: fileIn.files[0].type,
            fileName: fileIn.files[0].name
        };
        
        google.script.run.withSuccessHandler(function(res) {
            btn.disabled = false; btn.innerHTML = oldTxt;
            formEl.reset();
            
            // Reset Tab ke Halaman Pertama (Jika ada tab)
            if(formEl.querySelectorAll('.tab-link').length > 0) {
                var firstTab = formEl.querySelector('.tab-link[data-tab]');
                if(firstTab) firstTab.click(); 
            }
            
            // [FIX] GUNAKAN NOTIFIKASI GLOBAL (App.showAppModal)
            // Parameter ke-3 ('lapbul_riwayat') akan mengarahkan user ke halaman riwayat setelah klik OK
            App.showAppModal('success', res, 'lapbul_riwayat'); 

        }).withFailureHandler(function(err) {
            btn.disabled = false; btn.innerHTML = oldTxt;
            // [FIX] GUNAKAN NOTIFIKASI GLOBAL ERROR
            App.showAppModal('error', err.message);
        })[funcName](formData);
    };
    reader.readAsDataURL(fileIn.files[0]);
};

// ===========================================
// 1. INIT SYSTEM (ANTI-BLANK + AVATAR FIX)
// ===========================================
App.init = function() {
    // Reset Modal
    document.querySelectorAll('.modal-overlay').forEach(function(el) { el.style.display = 'none'; el.classList.remove('show'); });
    
    var userSession = localStorage.getItem('user_session');
    var sidebar = document.querySelector('.sidebar');
    var mainContent = document.getElementById('main-content');

    if (!userSession) {
        // --- MODE: BELUM LOGIN ---
        if(sidebar) sidebar.style.display = 'none';
        if(mainContent) {
            mainContent.style.marginLeft = '0'; mainContent.style.width = '100%'; mainContent.style.padding = '0';
            mainContent.style.display = 'flex'; mainContent.style.alignItems = 'center'; mainContent.style.justifyContent = 'center';
        }
        App.loadPage(null, 'login'); 
    } else {
        // --- MODE: SUDAH LOGIN ---
        var user;
        try { user = JSON.parse(userSession); } catch (e) { localStorage.removeItem('user_session'); window.location.reload(); return; }
        App.currentUser = user;
        var role = (user.role || '').toLowerCase();
        var isAdmin = (role.indexOf('admin') !== -1); // Pakai indexOf agar lebih kompatibel

        if(sidebar) sidebar.style.display = 'flex';
        if(mainContent) mainContent.removeAttribute('style'); 

        // Atur Menu Admin
        var adminMenus = document.querySelectorAll('.admin-only');
        for(var j=0; j<adminMenus.length; j++) { adminMenus[j].style.display = isAdmin ? 'block' : 'none'; }
        
        // --- FIX AVATAR (LOGIKA ASLI DIKEMBALIKAN) ---
        setTimeout(function() {
            var elName = document.getElementById('sidebar-user-name');
            var elRole = document.getElementById('sidebar-user-role');
            var elAvatar = document.querySelector('.user-avatar-small'); 

            if (elName) elName.textContent = user.nama || "User";
            if (elRole) elRole.textContent = user.role || "Staff";
            
            // --- LOGIKA THUMBNAIL DARI FILE LAMA ANDA ---
            if (elAvatar && user.foto && String(user.foto).trim() !== "") {
                var imgUrl = user.foto.trim();
                
                // Cek 1: Apakah link Google Drive View?
                if (imgUrl.indexOf('drive.google.com') !== -1 && imgUrl.indexOf('/view') !== -1) {
                    var parts = imgUrl.split('/d/');
                    if (parts.length > 1) imgUrl = 'https://drive.google.com/thumbnail?id=' + parts[1].split('/')[0] + '&sz=s1000';
                } 
                // Cek 2: Apakah hanya ID saja (tanpa http)?
                else if (imgUrl.indexOf('http') === -1) {
                     imgUrl = 'https://drive.google.com/thumbnail?id=' + imgUrl + '&sz=s1000';
                }
                
                // Tampilkan Gambar
                elAvatar.innerHTML = '<img src="' + imgUrl + '" alt="Profil" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">';
            } else if (elAvatar) {
                // Fallback Icon
                elAvatar.innerHTML = '<i class="fas fa-user"></i>';
            }
            // ---------------------------------------------

        }, 50);

        // Jalankan Sidebar Interaksi
        App.setupSidebar();

        // Load Home
        var currentContent = mainContent.innerHTML.trim();
        if (!currentContent || document.getElementById('loginForm')) {
            App.loadPage(null, 'home');
        }
        // PATCH: Agar klik menu induk 'SK Pembagian Tugas' juga membuka dashboard
        var skMenuLink = document.querySelector('a[data-page="sk_menu"]');
        if (skMenuLink) {
            skMenuLink.addEventListener('click', function(e) {
                // Jangan preventDefault sepenuhnya agar submenu tetap toggle (jika pakai CSS/JS lain)
                // Tapi kita paksa load halaman dashboard
                App.loadPage(e, 'sk_menu');
            });
        }
    }
};

// ===========================================
// 2. LOGIKA UTAMA (LOGIN, NAVIGASI)
// ===========================================

// Login Tanpa Refresh
App.handleLogin = function(e) {
    e.preventDefault();
    var btn = document.getElementById('btnLogin');
    var err = document.getElementById('loginError');
    var u = document.getElementById('username').value;
    var p = document.getElementById('password').value;
    
    if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...'; }
    if(err) err.style.display = 'none';

    google.script.run.withSuccessHandler(function(res) {
        if(res.status === 'success') {
            localStorage.setItem('user_session', JSON.stringify(res.user));
            // RE-INIT LANGSUNG (ANTI BLANK)
            App.init(); 
        } else {
            if(err) { err.textContent = res.message; err.style.display = 'block'; }
            else alert(res.message);
            if(btn) { btn.disabled = false; btn.innerHTML = 'MASUK'; }
        }
    }).withFailureHandler(function(e) {
        alert("Error: " + e.message);
        if(btn) { btn.disabled = false; btn.innerHTML = 'MASUK'; }
    }).loginUser(u, p);
};

// Navigasi Halaman
App.loadPage = function(e, p, arg) {
    if(e) e.preventDefault();
    var main = document.getElementById('main-content');
    
    // Tampilkan Loading
    if(p !== 'login' && main) {
        main.innerHTML = '<div class="loading-container"><div class="app-spinner"></div><p class="loading-text">Memuat...</p></div>';
    }
    
    // ============================================================
    // PERBAIKAN SIDEBAR: RESET & RE-ACTIVATE (LEVEL 3 SUPPORT)
    // ============================================================
    
    // 1. Matikan semua status 'active' pada link
    document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
    
    // 2. Tutup SEMUA menu (Reset total)
    document.querySelectorAll('.has-submenu').forEach(li => {
        li.classList.remove('open');
        var sub = li.querySelector('.submenu');
        if(sub) sub.style.maxHeight = null;
        var icon = li.querySelector('.submenu-icon');
        if(icon) icon.style.transform = 'rotate(0deg)';
    });

    // 3. Cari link target berdasarkan data-page
    var activeLink = document.querySelector(`.sidebar-menu a[data-page="${p}"]`);
    
    if(activeLink) {
        // A. Aktifkan link
        activeLink.classList.add('active');
        
        // B. Buka Orang Tua (Induk) secara rekursif (Naik ke atas)
        // Kita gunakan loop untuk menangani Level 2, Level 3, dst.
        var parentLi = activeLink.closest('li.has-submenu');
        
        while(parentLi) {
            parentLi.classList.add('open');
            
            var sub = parentLi.querySelector('.submenu');
            if(sub) sub.style.maxHeight = "3000px"; // Paksa tinggi maksimal
            
            var icon = parentLi.querySelector('.submenu-icon');
            if(icon) icon.style.transform = "rotate(90deg)";
            
            // Naik lagi ke kakek/buyut (jika ada)
            // parentLi.parentElement adalah <ul>, parentElement-nya lagi adalah <li> induk
            parentLi = parentLi.parentElement.closest('li.has-submenu');
        }
    }
    // ============================================================

    google.script.run.withSuccessHandler(function(h) {
        if(main) main.innerHTML = h;
        if(App.inits[p]) setTimeout(function() { App.inits[p](arg); }, 50);
    }).withFailureHandler(function(err) {
        if(main) main.innerHTML = '<div style="color:red;padding:20px;">Error: ' + err.message + '</div>';
    }).include('page_' + p);
};

// Setup Interaksi Sidebar (Accordion Strict)
App.setupSidebar = function() {
    var toggles = document.querySelectorAll('.has-submenu > a');
    
    for(var i=0; i<toggles.length; i++) {
        var menuLink = toggles[i];
        
        // Clone untuk reset listener
        var newLink = menuLink.cloneNode(true);
        menuLink.parentNode.replaceChild(newLink, menuLink);
        
        newLink.addEventListener('click', function(e) {
            e.preventDefault();
            
            var currentLi = this.parentElement; // li.has-submenu yang diklik
            var parentUl = currentLi.parentElement; // ul pembungkus (bisa root sidebar atau submenu induk)
            
            // 1. TUTUP TETANGGA (ACCORDION)
            // Cari semua li.has-submenu lain di dalam ul yang sama
            var siblings = parentUl.children;
            for(var j=0; j<siblings.length; j++) {
                var sibling = siblings[j];
                if(sibling !== currentLi && sibling.classList.contains('has-submenu')) {
                    // Tutup paksa
                    sibling.classList.remove('open');
                    var sub = sibling.querySelector('.submenu');
                    var icon = sibling.querySelector('.submenu-icon');
                    if(sub) sub.style.maxHeight = null;
                    if(icon) icon.style.transform = 'rotate(0deg)';
                }
            }

            // 2. TOGGLE DIRI SENDIRI
            var submenu = currentLi.querySelector('.submenu');
            var icon = this.querySelector('.submenu-icon');
            
            currentLi.classList.toggle('open');
            
            if(currentLi.classList.contains('open')) {
                // BUKA
                if(submenu) submenu.style.maxHeight = "3000px"; // Gunakan nilai besar aman
                if(icon) icon.style.transform = "rotate(90deg)";
                
                // Jika ini adalah submenu level 3 (anak), pastikan induknya (Level 1) tetap tinggi
                var grandParentSubmenu = parentUl.closest('.submenu'); // Cek apakah kita di dalam submenu lain
                if (grandParentSubmenu) {
                    grandParentSubmenu.style.maxHeight = "3000px";
                }
            } else {
                // TUTUP
                if(submenu) submenu.style.maxHeight = null;
                if(icon) icon.style.transform = "rotate(0deg)";
            }
        });
    }

    // Listener link biasa (Navigasi Halaman)
    var navLinks = document.querySelectorAll('.sidebar-menu a[data-page]');
    for(var k=0; k<navLinks.length; k++) {
        var link = navLinks[k];
        // Skip yang punya submenu & tombol logout
        if(link.parentElement.classList.contains('has-submenu')) continue;
        if(link.getAttribute('data-page') === 'logout') continue;

        var newLink = link.cloneNode(true);
        link.parentNode.replaceChild(newLink, link);
        newLink.addEventListener('click', function(e) {
            e.preventDefault();
            // App.loadPage akan menangani reset active class
            App.loadPage(e, this.getAttribute('data-page'));
        });
    }
    
    // Logout Handler
    var logoutBtn = document.querySelector('a[data-page="logout"]');
    if(logoutBtn) {
        logoutBtn.onclick = function(e) { 
            e.preventDefault(); 
            localStorage.removeItem('user_session'); 
            App.init(); 
        };
    }
};

// ===========================================
// 3. LOGIKA HALAMAN (UNGGAH, EDIT, TABLE)
// ===========================================
App.inits = {
    'home': function(){},
    
    // Modul SK
    'sk_riwayat': function() {
        App.initSmartTable({
            tableId: 'riwayatTable', serverFunc: 'getSKRiwayatData',
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK", "Dokumen", "Tanggal Unggah", "User"],
            filters: [{id:'filterTahun',col:'Tahun Ajaran',desc:true}, {id:'filterSemester',col:'Semester'}, {id:'filterNamaSekolah',col:'Nama Sekolah'}]
        });
    },
    'sk_kelola': function() {
        App.initSmartTable({
            tableId: 'kelolaTable', 
            serverFunc: 'getSKKelolaData',
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK", "Dokumen", "Status", "Aksi", "Tanggal Unggah", "Update", "User", "Verifikator", "Keterangan"],
            filters: [
              {id:'filterTahun',col:'Tahun Ajaran',desc:true}, {id:'filterSemester',col:'Semester'}, 
              {id:'filterNamaSekolah',col:'Nama Sekolah'},
              {id:'filterStatus', col:'_statusRaw'}]
        });
    },
    'sk_trash': function() {
        // 1. CEK KEAMANAN (ADMIN ONLY)
        var session = JSON.parse(localStorage.getItem('user_session') || '{}');
        var role = (session.role || '').toLowerCase();
        
        if (!role.includes('admin')) {
            document.getElementById('main-content').innerHTML = 
                '<div style="text-align:center; margin-top:50px; color:#64748b;">' +
                '<i class="fas fa-lock" style="font-size:3rem; margin-bottom:20px;"></i>' +
                '<h3>Akses Ditolak</h3>' +
                '<p>Halaman ini hanya dapat diakses oleh Administrator.</p>' +
                '</div>';
            return;
        }

        // 2. JIKA ADMIN, MUAT TABEL
        App.initSmartTable({
            tableId: 'trashTable', 
            serverFunc: 'getSKTrashData',
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Info Hapus", "Waktu Hapus", "Dokumen"],
            
            // Filter Search Manual (karena initSmartTable punya search bawaan id='searchFilter' tapi kita pakai id beda)
            // Kita bisa inject logika search manual di callback success jika mau, 
            // tapi agar konsisten dengan halaman lain, kita gunakan id='trashSearch' sebagai search filter.
        });

        // 3. AKTIFKAN SEARCH (Manual Binding karena ID beda dengan default SmartTable)
        var searchInput = document.getElementById('trashSearch');
        if(searchInput) {
            searchInput.onkeyup = function() {
                var val = this.value.toLowerCase();
                var tbody = document.querySelector('#trashTable tbody');
                var rows = tbody.getElementsByTagName('tr');
                
                for (var i = 0; i < rows.length; i++) {
                    var text = rows[i].textContent.toLowerCase();
                    rows[i].style.display = text.indexOf(val) > -1 ? '' : 'none';
                }
            };
        }
    },
    'sk_status': function() { if(App.initMatrixTable) App.initMatrixTable('statusTable', 'getSKStatusData'); },
    'sk_arsip': function() { App.arsipPath=[{id:null,name:'Home'}]; App.loadFolder(null); },
    'sk_edit': function(arg) { if(typeof initSkEditPage === 'function') initSkEditPage(arg); },
    'sk_unggah': function() { if(typeof initSkUnggahPage === 'function') initSkUnggahPage(); },
    'sk_menu': function() {
        // --- 1. SET LOADING STATE (6 ITEM) ---
        ['statTotal', 'statToday', 'statProses', 'statOK', 'statRevisi', 'statDitolak'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size:0.6em"></i>';
        });
        document.getElementById('listRecent').innerHTML = '<div style="text-align:center; padding:10px;">Memuat...</div>';

        // --- 2. REQUEST DATA ---
        google.script.run.withSuccessHandler(function(stats) {
            if(stats.error) { console.error(stats.error); return; }

            // A. ISI KARTU (ANIMASI)
            var animate = function(id, val) {
                var el = document.getElementById(id);
                if(el) el.textContent = val || 0;
            };
            animate('statTotal', stats.total);
            animate('statToday', stats.today);
            animate('statProses', stats.status.proses);
            animate('statOK', stats.status.ok);
            animate('statRevisi', stats.status.revisi);
            animate('statDitolak', stats.status.ditolak); // <-- TAMBAHAN INI

            // B. UPDATE SEMESTER
            var semHtml = '';
            if (stats.topSemesters && stats.topSemesters.length > 0) {
                stats.topSemesters.forEach(function(s) {
                    semHtml += '<div class="sem-badge">' + 
                               '<i class="fas fa-tag" style="color:#64748b"></i> ' + s.label + 
                               '<span class="sem-count">' + s.count + '</span></div>';
                });
            } else {
                semHtml = '<span style="color:#94a3b8; font-size:0.9em;">Belum ada data semester</span>';
            }
            var elSem = document.getElementById('semesterStats');
            if(elSem) elSem.innerHTML = semHtml;

            // C. RENDER CHART
            if(typeof Chart !== 'undefined') {
                
                // Chart Tren
                var ctxTrend = document.getElementById('chartTrend');
                if (ctxTrend) {
                    if (ctxTrend.chartInstance) ctxTrend.chartInstance.destroy();
                    
                    ctxTrend.chartInstance = new Chart(ctxTrend.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'],
                            datasets: [{
                                label: 'Data Masuk',
                                data: stats.monthlyTrend,
                                backgroundColor: '#3b82f6',
                                borderRadius: 4,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, ticks: { precision: 0 } }, 
                                x: { grid: { display: false } } 
                            }
                        }
                    });
                }

                // Chart Status
                var ctxStatus = document.getElementById('chartStatus');
                if (ctxStatus) {
                    if (ctxStatus.chartInstance) ctxStatus.chartInstance.destroy();

                    ctxStatus.chartInstance = new Chart(ctxStatus.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Diproses', 'OK', 'Revisi', 'Ditolak'],
                            datasets: [{
                                data: [
                                    stats.status.proses, 
                                    stats.status.ok, 
                                    stats.status.revisi, 
                                    stats.status.ditolak
                                ],
                                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '65%',
                            plugins: { 
                                legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
                            }
                        }
                    });
                }
            }

            // D. RECENT ACTIVITY
            var listHtml = '';
            if(stats.recent.length === 0) listHtml = '<div style="padding:10px; color:#ccc;">Belum ada aktivitas</div>';
            else {
                stats.recent.forEach(function(r) {
                    var st = String(r.status).replace(/<[^>]*>?/gm, '').trim(); 
                    var color = '#64748b';
                    if(st.includes('OK') || st.includes('Setuju')) color='#10b981';
                    else if(st.includes('Revisi')) color='#f59e0b';
                    else if(st.includes('Ditolak')) color='#ef4444';
                    
                    listHtml += '<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f1f5f9;">' +
                                '<div><div style="font-weight:600; font-size:0.85em; color:#334155;">'+r.sekolah+'</div>' +
                                '<div style="font-size:0.75em; color:#94a3b8;">'+r.waktu+'</div></div>' +
                                '<div style="font-size:0.75em; font-weight:bold; color:'+color+';">'+st+'</div>' +
                                '</div>';
                });
            }
            var elList = document.getElementById('listRecent');
            if(elList) elList.innerHTML = listHtml;

        }).getSKDashboardStats();
    },

    // Tambahkan init modul lain di sini jika perlu
};

// --- FUNGSI UNGGAH SK (DENGAN LOGIKA DROPDOWN BERANTAI) ---
function initSkUnggahPage() {
    var form = document.getElementById('skUnggahForm');
    if (!form) return;

    // --- BAGIAN 1: LOGIKA DROPDOWN (KEMBALI KE VERSI ASLI ANDA) ---
    var elTahun = document.getElementById('unggahTahun');
    
    // Tampilkan loading
    if(elTahun) elTahun.innerHTML = '<option>Memuat...</option>';

    google.script.run.withSuccessHandler(function(opts) {
        // Helper isi option (Versi Asli)
        var populate = function(el, data) {
            if(!el) return; 
            el.innerHTML = '<option value="">-- Pilih --</option>';
            if(data) {
                data.forEach(function(i) { el.add(new Option(i, i)); });
            }
        };

        // Isi Dropdown
        populate(document.getElementById('unggahTahun'), opts['Tahun Ajaran']);
        populate(document.getElementById('unggahSemester'), opts['Semester']);
        populate(document.getElementById('unggahKriteria'), opts['Kriteria SK']);
        
        var schoolMap = opts['Nama Sekolah List'] || {};
        var elStatus = document.getElementById('unggahStatusSekolah');
        
        // Isi Status
        populate(elStatus, Object.keys(schoolMap).sort());
        
        // Logika Berantai (Status -> Nama)
        if(elStatus) {
            // Clone untuk reset listener
            var newStatus = elStatus.cloneNode(true);
            elStatus.parentNode.replaceChild(newStatus, elStatus);
            
            newStatus.addEventListener('change', function() {
                var list = schoolMap[this.value] || [];
                // Isi Nama Sekolah
                populate(document.getElementById('unggahNamaSekolah'), list);
            });
        }
    }).getMasterSkOptions();


    // --- BAGIAN 2: LOGIKA SUBMIT (VALIDASI 1MB & POPUP TEMA) ---
    var newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);

    newForm.onsubmit = function(e) {
        e.preventDefault();
        
        var btn = newForm.querySelector('button[type="submit"]');
        var oriText = btn.innerHTML;
        var fileInput = document.getElementById('unggahFile');

        // VALIDASI: File Ada?
        if (fileInput.files.length === 0) { 
            App.showAppModal('error', "Harap pilih file PDF SK terlebih dahulu."); 
            return false; 
        }

        // VALIDASI: Ukuran 1MB (1,048,576 bytes)
        if (fileInput.files[0].size > 1048576) { 
            App.showAppModal('error', "Ukuran file terlalu besar. Maksimal 1 MB."); 
            return false; 
        }

        // VALIDASI: Tipe PDF
        if (fileInput.files[0].type !== 'application/pdf') {
            App.showAppModal('error', "Format file harus PDF.");
            return false;
        }

        // PROSES UPLOAD
        var user = "User";
        try { user = document.getElementById('sidebar-user-name').textContent; } catch(err){}

        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengunggah...';

        var reader = new FileReader();
        reader.onload = function(ex) {
            var data = {
                tahunAjaran: document.getElementById('unggahTahun').value,
                semester: document.getElementById('unggahSemester').value,
                statusSekolah: document.getElementById('unggahStatusSekolah').value,
                namaSekolah: document.getElementById('unggahNamaSekolah').value,
                nomorSK: document.getElementById('unggahNomorSK').value,
                tanggalSK: document.getElementById('unggahTanggalSK').value,
                kriteriaSK: document.getElementById('unggahKriteria').value,
                fileData: { 
                    fileName: fileInput.files[0].name, 
                    mimeType: fileInput.files[0].type, 
                    data: ex.target.result.split(',')[1] 
                },
                loggedInUser: user
            };

            google.script.run.withSuccessHandler(function(r) {
                App.showAppModal('success', r, 'sk_riwayat');
            }).withFailureHandler(function(e) {
                btn.disabled = false; btn.innerHTML = oriText;
                App.showAppModal('error', e.message);
            }).processManualForm(data);
        };
        reader.readAsDataURL(fileInput.files[0]);
        return false;
    };
}

// --- FUNGSI EDIT SK ---
function initSkEditPage(arg) {
    if (!arg || !arg.rowIndex) return;
    
    var form = document.getElementById('skEditForm');
    var rowIndexInput = document.getElementById('editRowIndex');
    if(!form || !rowIndexInput) return;

    // Set Row Index
    rowIndexInput.value = arg.rowIndex; 
    
    // Tampilkan Loading Modal
    App.showAppModal('loading', 'Mengambil data...');
    
    // --- LANGKAH 1: AMBIL OPSI DROPDOWN DULU ---
    google.script.run.withSuccessHandler(function(opts) {
        
        // Helper isi dropdown
        var populate = function(id, data) {
            var el = document.getElementById(id);
            if(!el) return;
            el.innerHTML = '<option value="">-- Pilih --</option>';
            if(data) data.forEach(function(i){ el.add(new Option(i,i)); });
        };

        populate('editTahun', opts['Tahun Ajaran']);
        populate('editSemester', opts['Semester']);
        populate('editKriteria', opts['Kriteria SK']);

        // --- LANGKAH 2: AMBIL DATA BARIS (Setelah dropdown siap) ---
        google.script.run.withSuccessHandler(function(data) {
            // Tutup Loading
            document.getElementById('appModal').style.display = 'none'; 
            
            // Isi Form
            document.getElementById('editStatusSekolah').value = data.statusSekolah || '';
            document.getElementById('editNamaSekolah').value = data.namaSekolah || '';
            document.getElementById('editNomorSK').value = data.nomorSK || '';
            document.getElementById('editTanggalSK').value = data.tanggalSK || '';
            
            // Set Nilai Dropdown
            var setVal = function(id, v) { 
                var el = document.getElementById(id); 
                if(el) el.value = v; 
            };
            setVal('editTahun', data.tahunAjaran);
            setVal('editSemester', data.semester);
            setVal('editKriteria', data.kriteriaSK);
            
            // Render Tombol File
            var linkArea = document.getElementById('currentFileLink');
            if(data.dokumen && data.dokumen.includes('http')) {
                linkArea.innerHTML = '<button type="button" class="btn-download" style="font-size:0.85em; padding:5px 12px; background:#3b82f6;" ' +
                                     'onclick="App.showFilePreview(\''+data.dokumen+'\')">' +
                                     '<i class="fas fa-eye"></i> Lihat File</button>';
            } else {
                linkArea.innerHTML = '<span style="color:#ef4444; font-style:italic;">Tidak ada file</span>';
            }

        }).withFailureHandler(function(e){
            App.showAppModal('error', "Gagal ambil data: " + e.message);
        }).getSKDataByRow(arg.rowIndex);

    }).withFailureHandler(function(e){
        App.showAppModal('error', "Gagal load dropdown: " + e.message);
    }).getMasterSkOptions();


    // --- LANGKAH 3: HANDLE SUBMIT (VALIDASI 1MB + POPUP TEMA) ---
    var newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);
    
    newForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        var btn = newForm.querySelector('button[type="submit"]');
        var originalBtnText = btn.innerHTML;
        var fileInput = document.getElementById('editFile');

        // Validasi File (Jika ada file baru dipilih)
        if (fileInput.files.length > 0) {
            // Cek Ukuran 1MB
            if (fileInput.files[0].size > 1048576) { 
                App.showAppModal('error', "Ukuran file baru terlalu besar. Maksimal 1 MB."); 
                return false; 
            }
            // Cek PDF
            if (fileInput.files[0].type !== 'application/pdf') {
                App.showAppModal('error', "File baru harus format PDF.");
                return false;
            }
        }

        var currentUser = document.getElementById('sidebar-user-name').textContent;
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

        var send = function(fData) {
            var d = {
                rowIndex: document.getElementById('editRowIndex').value,
                statusSekolah: document.getElementById('editStatusSekolah').value,
                namaSekolah: document.getElementById('editNamaSekolah').value,
                tahunAjaran: document.getElementById('editTahun').value,
                semester: document.getElementById('editSemester').value,
                nomorSK: document.getElementById('editNomorSK').value,
                tanggalSK: document.getElementById('editTanggalSK').value,
                kriteriaSK: document.getElementById('editKriteria').value,
                fileData: fData, // Bisa null jika tidak ganti file
                editorName: currentUser 
            };

            google.script.run.withSuccessHandler(function(res) {
                App.showAppModal('success', res, 'sk_kelola'); 
            }).withFailureHandler(function(err) {
                btn.disabled = false; btn.innerHTML = originalBtnText;
                App.showAppModal('error', err.message);
            }).updateSKData(d);
        };

        // Baca File jika ada
        if (fileInput.files.length > 0) {
            var r = new FileReader();
            r.onload = function(ex) { 
                send({ 
                    fileName: fileInput.files[0].name, 
                    mimeType: fileInput.files[0].type, 
                    data: ex.target.result.split(',')[1] 
                }); 
            };
            r.readAsDataURL(fileInput.files[0]);
        } else {
            send(null); // Kirim null, backend akan pakai file lama
        }
    });
}

// --- FUNGSI SMART TABLE (FINAL: ANIMATED) ---
App.initSmartTable = function(config) {
    var table = document.getElementById(config.tableId);
    if (!table) return;
    
    var thead = table.querySelector('thead');
    var tbody = table.querySelector('tbody');
    
    // Hitung total kolom
    var colCount = (config.headers ? config.headers.length : 0) + 1; 

    // 1. RENDER HEADER
    if (config.headers && thead) {
        var headerHtml = '<tr>';
        headerHtml += '<th style="width:40px; text-align:center;">No.</th>';

        config.headers.forEach(function(h) {
            var label = (typeof h === 'object') ? h.name : h;
            var width = (typeof h === 'object' && h.width) ? 'width:'+h.width : '';
            headerHtml += `<th style="${width}">${label}</th>`;
        });
        headerHtml += '</tr>';
        thead.innerHTML = headerHtml;
    }

    // 2. RENDER SKELETON (DENGAN ANIMASI PULSE & SLIDE DOWN)
    if (tbody) {
        var skeletonHtml = '';
        for(var i=0; i<5; i++) {
            // Tambahkan class 'row-animate' agar skeleton juga muncul pelan-pelan
            skeletonHtml += '<tr class="row-animate">'; 
            for(var j=0; j<colCount; j++) {
                // Tambahkan class 'skeleton-anim' agar warna berdenyut
                skeletonHtml += '<td><div class="skeleton-anim" style="height:12px; width:100%; border-radius:4px; background-color: #e2e8f0;"></div></td>';
            }
            skeletonHtml += '</tr>';
        }
        tbody.innerHTML = skeletonHtml;
    }

    // 3. PANGGIL SERVER
    google.script.run
    .withSuccessHandler(function(response) {
        if (!response || !response.rows) {
            if(tbody) tbody.innerHTML = '<tr><td colspan="100" style="text-align:center;">Gagal memuat data.</td></tr>';
            return;
        }

        var allRows = response.rows; 
        var renderTableBody = function(rows) {
            tbody.innerHTML = ''; 
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100" style="text-align:center; padding:15px;">Data tidak ditemukan.</td></tr>';
                return;
            }

            rows.forEach(function(row, i) {
                var tr = document.createElement('tr');
                
                // [PENTING] Tambahkan class animasi ke baris Data Asli
                tr.className = 'row-animate'; 
                
                // Kolom No.
                var tdNo = document.createElement('td');
                tdNo.textContent = i + 1;
                tdNo.style = "text-align:center; font-weight:bold; color:#64748b;";
                tr.appendChild(tdNo);

                // Kolom Data
                config.headers.forEach(function(h) {
                    var td = document.createElement('td');
                    var key = (typeof h === 'object') ? h.name : h;
                    if (typeof h === 'object' && h.formatter) {
                        td.innerHTML = h.formatter(row, key, i);
                    } else {
                        td.textContent = row[key] || ""; 
                        if (typeof h === 'object' && h.tdStyle) td.style = h.tdStyle;
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            // Info Total
            var infoEl = document.getElementById(config.tableId + '_info');
            if(infoEl) infoEl.textContent = 'Total: ' + rows.length + ' Data';
        };

        renderTableBody(allRows);
        if (config.onRender && typeof config.onRender === 'function') {
        config.onRender(response.rows || []);
    }

        // 4. LOGIKA FILTER
        if (config.filters && config.filters.length > 0) {
            config.filters.forEach(function(f) {
                var el = document.getElementById(f.id);
                if (el && el.tagName === 'SELECT') {
                    var colName = f.col;
                    var uniqueValues = [];
                    allRows.forEach(function(r) {
                        var val = r[colName];
                        if (val && !uniqueValues.includes(val)) uniqueValues.push(val);
                    });
                    uniqueValues.sort();
                    var firstOptionText = el.options[0] ? el.options[0].text : '-- Semua --';
                    el.innerHTML = ''; 
                    var optDefault = document.createElement('option');
                    optDefault.value = ''; optDefault.text = firstOptionText;
                    el.add(optDefault);
                    uniqueValues.forEach(function(v) {
                        var opt = document.createElement('option');
                        opt.value = v; opt.text = v; el.add(opt);
                    });
                }
                if (el) {
                    el.onchange = el.onkeyup = function() {
                        var val = this.value.toLowerCase();
                        var filtered = allRows.filter(function(r) {
                            var cellVal = String(r[f.col] || "").toLowerCase();
                            return cellVal.includes(val);
                        });
                        renderTableBody(filtered);
                    };
                }
            });
        }
    })
    .withFailureHandler(function(err) {
        if(tbody) tbody.innerHTML = '<tr><td colspan="100" style="color:red; text-align:center;">Error: ' + err.message + '</td></tr>';
    })
    [config.serverFunc](config.params || undefined);
};

App.initMatrixTable = function(tid, func, params) {
    var t = document.getElementById(tid); 
    if (!t) return;
    
    var tb = t.querySelector('tbody');
    var thd = t.querySelector('thead');
    var searchInput = document.getElementById('matrixSearch');
    var loader = document.getElementById('loadingStatus');

    // 1. Setup Tampilan
    t.classList.add('matrix-mode'); // Class CSS untuk freeze pane
    if(loader) loader.style.display = 'flex';
    
    // Render Skeleton Header (Sementara)
    if(thd) {
        thd.innerHTML = '<tr><th rowspan="2" style="width:40px">No</th><th rowspan="2" style="width:250px">Nama Sekolah</th><th colspan="12">Memuat Data...</th></tr>';
    }
    // Render Skeleton Body
    if(tb) {
        var skel = '';
        for(var i=0; i<10; i++) {
            skel += '<tr><td><div class="skeleton-bar short"></div></td><td><div class="skeleton-bar" style="width:60%"></div></td>';
            for(var j=0; j<12; j++) skel += '<td><div class="skeleton-bar status"></div></td>';
            skel += '</tr>';
        }
        tb.innerHTML = skel;
    }

    // 2. Panggil Data
    google.script.run.withSuccessHandler(function(d) {
        if(loader) loader.style.display = 'none';

        if (!d || d.length < 3) { 
            if(tb) tb.innerHTML = '<tr><td colspan="100" style="text-align:center; padding:30px;">Data Tidak Ditemukan</td></tr>';
            return; 
        }

        var h1 = d[0]; // Header Grup (Tahun)
        var h2 = d[1]; // Header Detail (Nama, Jenjang, Status, Bulan...)
        var rows = d.slice(2);

        // --- RENDER HEADER ---
        var htmlH = '<tr>';
        // Header Baris 1
        // Deteksi span tahun secara otomatis
        var colSpanMap = {};
        h1.forEach(h => { if(h) colSpanMap[h] = (colSpanMap[h] || 0) + 1; });
        
        // Render No & Nama (Selalu Fixed)
        htmlH += '<th rowspan="2" class="col-fixed-no">No</th>';
        htmlH += '<th rowspan="2" class="col-fixed-name">Nama Sekolah</th>';

        // Render Group Header (Misal: 2024)
        h1.forEach((h, idx) => {
             // Skip kolom kosong di awal (karena sudah diambil No & Nama)
             if (idx < 2) return; 
             // Jika ada teks dan berbeda dengan sebelumnya (logic sederhana untuk colspan)
             if (h && (idx === 0 || h !== h1[idx-1])) {
                 // Hitung span sisa
                 var span = 0;
                 for(var k=idx; k<h1.length; k++) { if(h1[k]===h) span++; else break; }
                 htmlH += `<th colspan="${span}" class="col-group">${h}</th>`;
             } else if (!h && !h1[idx-1]) {
                 // Kolom tanpa group (Metadata seperti Jenjang/Status) -> akan di-merge rowspannya nanti di baris 2
             }
        });
        htmlH += '</tr><tr>';

        // Header Baris 2
        h2.forEach((h, idx) => {
            if (idx < 2) return; // Skip No & Nama
            // Cek apakah header atasnya kosong? Jika ya, jadikan rowspan 2 (naik ke atas)
            // TAPI karena struktur HTML table rowspan agak ribet dinamis, 
            // cara termudah: Header atas kosong -> Header ini jadi th biasa.
            
            // Stylenya:
            var style = "min-width:60px; text-align:center;";
            if(h === 'Jenjang' || h === 'Status') style = "min-width:90px; text-align:center;";
            
            htmlH += `<th style="${style}">${h}</th>`;
        });
        htmlH += '</tr>';
        thd.innerHTML = htmlH;

        // --- RENDER BODY ---
        var renderRows = function(dataSet) {
            var htmlTr = '';
            dataSet.forEach((row, rIdx) => {
                htmlTr += '<tr>';
                // No
                htmlTr += `<td class="col-fixed-no">${rIdx + 1}</td>`;
                // Nama Sekolah
                htmlTr += `<td class="col-fixed-name">${row[0]}</td>`;
                
                // Sisa Kolom
                for(var c=1; c<row.length; c++) {
                    var val = row[c];
                    var cellContent = val;
                    var cellStyle = "text-align:center;";

                    // --- ATURAN GLOBAL KONTEN ---
                    
                    // 1. Ceklis (✅) -> Hijau & Besar
                    if (val === '✅' || val === 'v') {
                        cellContent = '<i class="fas fa-check" style="color:#16a34a; font-size:1.1em;"></i>';
                    }
                    // 2. Status -> Badge
                    else if (h2[c+1] === 'Status') { // +1 karena array row mulai dr index 0 (Nama=0), tapi h2 ada No
                        var badgeClass = 'status-badge';
                        if(val.includes('OK')) badgeClass += ' status-ok';
                        else if(val.includes('Revisi')) badgeClass += ' status-error';
                        else badgeClass += ' status-belum';
                        cellContent = `<span class="${badgeClass}">${val}</span>`;
                    }
                    // 3. Strip (-) -> Abu tipis
                    else if (val === '-' || val === '') {
                        cellContent = '<span style="color:#e2e8f0;">&bull;</span>';
                    }

                    htmlTr += `<td style="${cellStyle}">${cellContent}</td>`;
                }
                htmlTr += '</tr>';
            });
            tb.innerHTML = htmlTr;
        };
        renderRows(rows);

        // Search Filter
        if(searchInput) {
            var clone = searchInput.cloneNode(true);
            searchInput.parentNode.replaceChild(clone, searchInput);
            clone.addEventListener('keyup', function() {
                var term = this.value.toLowerCase();
                var filtered = rows.filter(r => r[0].toLowerCase().includes(term));
                renderRows(filtered);
            });
        }

    }).withFailureHandler(function(e) {
        if(loader) loader.style.display = 'none';
        tb.innerHTML = `<tr><td colspan="100" style="color:red; text-align:center;">Error: ${e.message}</td></tr>`;
    })[func](params);
};

// ===========================================
// LOGIKA FILE MANAGER (FIXED & HARDENED)
// ===========================================

App.arsipPath = []; 
App.currentArsipItems = [];
App.arsipViewMode = 'grid'; 

// 1. Fungsi Load Folder (Navigasi)
App.loadFolder = function(fid, isBack) {
    App.closePreview(); 
    
    var grid = document.getElementById('fileGrid'); 
    var loader = document.getElementById('arsipLoading');
    var emptyMsg = document.getElementById('emptyFolderMsg');
    
    if(!grid) return;

    // --- PERBAIKAN: JANGAN KOSONGKAN GRID ---
    // Biarkan item lama tetap terlihat tapi blur
    grid.classList.add('blur-loading'); 
    
    // Tampilkan loader overlay di tengah
    if(loader) loader.style.display = 'flex'; 
    if(emptyMsg) emptyMsg.style.display = 'none';

    // Init Home Path
    if (!fid && App.arsipPath.length === 0) {
        App.arsipPath.push({id: null, name: 'Home'});
    }

    google.script.run.withSuccessHandler(function(d) {
        setTimeout(function() {
            // Hapus blur dan loader
            grid.classList.remove('blur-loading');
            loader.style.display = 'none';
            
            // BARU SEKARANG KITA GANTI ISINYA
            grid.innerHTML = ''; 

            if (d.status === 'error') { 
                grid.innerHTML = '<div style="color:red;padding:20px;text-align:center;">'+d.message+'</div>'; 
                return; 
            }

            // Update Path
            if (d.currentId === d.rootId) {
                App.arsipPath = [{id: null, name: 'Home'}];
            } else if (fid && isBack !== true) {
                var last = App.arsipPath[App.arsipPath.length-1];
                if (!last || last.id !== d.currentId) {
                    App.arsipPath.push({id: d.currentId, name: d.currentName});
                }
            }

            App.currentArsipItems = d.items || [];
            renderBreadcrumb();
            
            // Set Class Grid/List
            if (App.arsipViewMode === 'list') grid.className = 'file-list-view';
            else grid.className = 'file-grid';

            App.renderCurrentItems();
        }, 50); // Delay sedikit agar mata sempat melihat transisi blur-clear

    }).withFailureHandler(function(e) {
        grid.classList.remove('blur-loading');
        loader.style.display = 'none';
        grid.innerHTML = '<div style="color:red;padding:20px;">Gagal: '+e.message+'</div>';
    }).apiGetArsipFiles(fid); 
};

// 2. Helper Render Item
App.renderCurrentItems = function() {
    var grid = document.getElementById('fileGrid');
    var emptyMsg = document.getElementById('emptyFolderMsg');
    var input = document.getElementById('arsipSearchInput');
    
    var keyword = input ? input.value.toLowerCase() : '';
    
    var itemsToShow = App.currentArsipItems.filter(function(item) {
        return item.name.toLowerCase().includes(keyword);
    });

    grid.innerHTML = '';

    if (itemsToShow.length === 0) {
        if(emptyMsg) {
            emptyMsg.style.display = 'flex';
            emptyMsg.querySelector('p').textContent = keyword ? "Tidak ditemukan." : "Folder kosong";
        }
    } else {
        if(emptyMsg) emptyMsg.style.display = 'none';
        
        itemsToShow.forEach(function(i) {
            var c = document.createElement('div'); 
            c.className = 'fm-card';
            
            var ic = 'fa-file'; var colorClass = 'file';
            var isFolder = (i.type === 'folder' || (i.mime && i.mime.indexOf('folder') !== -1));

            if(isFolder) { ic = 'fa-folder'; colorClass = 'folder'; }
            else if(i.mime.includes('pdf')) { ic = 'fa-file-pdf'; colorClass = 'pdf'; }
            else if(i.mime.includes('sheet') || i.mime.includes('excel')) { ic = 'fa-file-excel'; colorClass = 'sheet'; }
            else if(i.mime.includes('image')) { ic = 'fa-file-image'; colorClass = 'img'; }
            
            c.innerHTML = '<i class="fas '+ic+' fm-icon '+colorClass+'"></i>' +
                          '<div class="fm-name" title="'+i.name+'">'+i.name+'</div>' +
                          '<div class="fm-meta">'+(isFolder ? i.updated : i.size)+'</div>';
            
            c.onclick = function(e) { 
                e.preventDefault(); 
                e.stopPropagation(); 
                
                // Tutup preview lama sebelum aksi baru
                App.closePreview();

                if (isFolder) {
                    App.loadFolder(i.id); 
                } else {
                    App.showFilePreview(i.url); 
                }
            };
            grid.appendChild(c);
        });
    }
};

// --- FITUR 1: TOGGLE VIEW (GRID / LIST) ---
App.toggleArsipView = function(mode) {
    App.arsipViewMode = mode;
    var grid = document.getElementById('arsipGrid');
    var btnGrid = document.getElementById('btnGrid');
    var btnList = document.getElementById('btnList');

    if (mode === 'list') {
        grid.classList.add('view-list');
        btnList.style.background = '#e2e8f0'; // Active state
        btnGrid.style.background = 'transparent';
    } else {
        grid.classList.remove('view-list');
        btnGrid.style.background = '#e2e8f0'; // Active state
        btnList.style.background = 'transparent';
    }
};

// --- FITUR 2: PREVIEW FILE POPUP ---
App.previewFile = function(url, name) {
    var modal = document.getElementById('filePreviewModal');
    var frame = document.getElementById('previewFrame');
    var title = document.getElementById('previewTitle');
    
    // Ubah URL dari '/view' ke '/preview' agar bisa di-embed tanpa membuka tab baru
    // Contoh: .../d/XXX/view?usp=drivesdk -> .../d/XXX/preview
    var previewUrl = url.replace(/\/view.*/, '/preview');

    title.textContent = name;
    frame.src = previewUrl;
    modal.style.display = 'flex'; // Tampilkan Modal
};

App.filterArsipFiles = function() { App.renderCurrentItems(); };

App.navToPath = function(targetIndex) {
    var targetItem = App.arsipPath[targetIndex];
    App.arsipPath = App.arsipPath.slice(0, targetIndex + 1);
    renderBreadcrumb();
    App.loadFolder(targetItem.id, true);
};

function renderBreadcrumb() {
    var container = document.getElementById('arsipBreadcrumb'); 
    if(!container) return;
    container.innerHTML = '';
    
    App.arsipPath.forEach(function(item, index) {
        if (index > 0) {
            var sep = document.createElement('i');
            sep.className = 'fas fa-chevron-right breadcrumb-sep';
            sep.style.cssText = 'font-size:0.8em; margin:0 6px; color:#cbd5e1;';
            container.appendChild(sep);
        }
        var span = document.createElement('span');
        span.textContent = item.name;
        
        if (index === App.arsipPath.length - 1) {
            span.className = 'breadcrumb-item active';
            span.style.fontWeight = 'bold';
            span.style.color = '#334155';
            span.style.cursor = 'default';
        } else {
            span.className = 'breadcrumb-item';
            span.style.cursor = 'pointer';
            span.style.color = '#0284c7';
            span.onclick = function() { App.navToPath(index); };
        }
        container.appendChild(span);
    });
}

// 4. Preview File (Container Reset Logic)
App.showFilePreview = function(url) {
    var modal = document.getElementById('previewModal');
    if (!modal) return; // Safety check

    // 1. SETUP DISPLAY & Z-INDEX (Agar pasti muncul paling atas)
    modal.style.display = 'flex';
    modal.style.zIndex = '10005'; 

    // 2. CARI CONTAINER BODY (Tempat Iframe)
    // Asumsi struktur: .modal-content > div:first-child (Header) > div:nth-child(2) (Body)
    var content = modal.querySelector('.modal-content');
    var header = content.querySelector('div:first-child');
    var body = content.querySelector('div:nth-child(2)');

    // Self-healing jika Body hilang
    if (!body) {
        body = document.createElement('div');
        body.style.cssText = "flex: 1; position: relative; background: #fff; overflow: hidden; min-height: 400px;";
        content.appendChild(body);
    }
    body.innerHTML = ''; // Bersihkan iframe lama

    // 3. SIAPKAN LINK
    var fileId = "";
    var match = url.match(/[-\w]{25,}/); 
    if (match) fileId = match[0];

    var previewUrl = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : url;
    var downloadUrl = fileId ? "https://drive.google.com/uc?export=download&id=" + fileId : url;

    // 4. SETUP TOMBOL DOWNLOAD
    var oldDl = document.getElementById('dynamicDownloadBtn');
    if (oldDl) oldDl.remove(); // Hapus tombol download sisa sebelumnya

    var btnDl = document.createElement('a');
    btnDl.id = 'dynamicDownloadBtn';
    btnDl.className = 'btn-download';
    btnDl.href = downloadUrl;
    btnDl.target = '_blank'; 
    btnDl.innerHTML = '<i class="fas fa-download"></i> Unduh';
    
    // 5. FIX TOMBOL CLOSE (X)
    // Cari tombol X di header (Element <button> apapun di header selain tombol download)
    var allBtns = header.querySelectorAll('button');
    var closeBtn = null;
    
    // Loop cari tombol X
    for (var i = 0; i < allBtns.length; i++) {
        if (allBtns[i].id !== 'dynamicDownloadBtn') {
            closeBtn = allBtns[i];
            break;
        }
    }

    if (closeBtn) {
        // Sisipkan tombol Download di sebelah kiri tombol X
        header.insertBefore(btnDl, closeBtn);
        
        // --- PERBAIKAN UTAMA DI SINI ---
        // Kita paksa pasang ulang perintah tutup, jaga-jaga kalau onclick di HTML rusak
        closeBtn.onclick = function() { App.closePreview(); };
        
        // Pastikan kursor berubah jadi jari telunjuk
        closeBtn.style.cursor = 'pointer'; 
    } else {
        // Fallback jika tombol X hilang, tempel Download di akhir
        header.appendChild(btnDl);
    }

    // 6. RENDER IFRAME
    var iframe = document.createElement('iframe');
    iframe.id = 'previewFrame';
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.src = previewUrl;
    
    body.appendChild(iframe);
};

// UPDATE FUNGSI MODAL (SUPPORTS ANIMATION & NEW STYLE)
App.showAppModal = function(status, msg, redirectPage) {
    var modal = document.getElementById('appModal');
    var content = modal.querySelector('.modal-content');
    var iconBox = document.getElementById('modalIconBox');
    var title = document.getElementById('modalTitle');
    var message = document.getElementById('modalMessage');
    var btn = document.getElementById('modalBtnMain');

    // 1. Reset Kelas & State
    content.className = 'modal-content'; // Hapus success/error/loading lama
    btn.style.display = 'block';
    
    // 2. Tentukan Konten Berdasarkan Status
    if (status === 'loading') {
        content.classList.add('loading');
        iconBox.innerHTML = '<div class="modal-spinner"></div>';
        title.textContent = 'Memproses...';
        message.textContent = msg || 'Mohon tunggu sebentar, sistem sedang bekerja.';
        btn.style.display = 'none'; // Sembunyikan tombol saat loading
    
    } else if (status === 'success') {
        content.classList.add('success');
        iconBox.innerHTML = '<i class="fas fa-check"></i>';
        title.textContent = 'Berhasil!';
        message.innerHTML = msg; // Pakai innerHTML biar bisa ada <b> atau <br>
        btn.textContent = 'Lanjutkan';
    
    } else if (status === 'error') {
        content.classList.add('error');
        iconBox.innerHTML = '<i class="fas fa-exclamation"></i>';
        title.textContent = 'Terjadi Kesalahan';
        message.innerHTML = msg;
        btn.textContent = 'Tutup';
    
    } else if (status === 'warning') { // Tambahan status warning
        content.classList.add('warning');
        iconBox.innerHTML = '<i class="fas fa-bell"></i>';
        title.textContent = 'Perhatian';
        message.innerHTML = msg;
        btn.textContent = 'Mengerti';
    }

    // 3. Tampilkan Modal dengan Animasi
    modal.style.display = 'flex';
    // Timeout kecil agar transisi CSS 'opacity' & 'transform' berjalan
    setTimeout(function() {
        modal.classList.add('show');
    }, 10);

    // 4. Fokus Tombol & Handler Klik
    if(status !== 'loading') {
        setTimeout(function(){ btn.focus(); }, 100);
        
        // Clone button untuk reset event listener lama
        var newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.onclick = function() {
            // Animasi Keluar
            modal.classList.remove('show');
            setTimeout(function() {
                modal.style.display = 'none';
                if (redirectPage && status === 'success') {
                    App.loadPage(null, redirectPage);
                }
            }, 300); // Sesuaikan dengan durasi transition CSS (0.3s)
        };
    }
};

App.showDeleteConfirmation = function(btn) {
    // 1. Ambil Data
    var d = JSON.parse(btn.dataset.rowInfo);
    var m = document.getElementById('deleteModal');
    var isLapbul = d.hasOwnProperty('Bulan'); // Deteksi tipe data
    
    // 2. Render Info
    var infoHtml = '';
    if (isLapbul) {
        infoHtml = 
            '<div class="delete-detail-row"><span class="delete-detail-label">Sekolah</span><span class="delete-detail-value">' + d['Nama Sekolah'] + '</span></div>' +
            '<div class="delete-detail-row"><span class="delete-detail-label">Jenjang</span><span class="delete-detail-value">' + d['Jenjang'] + '</span></div>' +
            '<div class="delete-detail-row"><span class="delete-detail-label">Periode</span><span class="delete-detail-value">' + d['Bulan'] + ' ' + d['Tahun'] + '</span></div>';
    } else {
        infoHtml = 
            '<div class="delete-detail-row"><span class="delete-detail-label">Sekolah</span><span class="delete-detail-value">' + d['Nama Sekolah'] + '</span></div>' +
            '<div class="delete-detail-row"><span class="delete-detail-label">Tahun</span><span class="delete-detail-value">' + d['Tahun Ajaran'] + '</span></div>' +
            '<div class="delete-detail-row"><span class="delete-detail-label">Semester</span><span class="delete-detail-value">' + d['Semester'] + '</span></div>';
    }
    m.querySelector('.delete-info-card').innerHTML = infoHtml;
    document.getElementById('delCode').value = '';
    m.style.display = 'flex';
    
    // 3. Handle Actions
    document.getElementById('cancelDeleteBtn').onclick = function() { m.style.display='none'; };
    
    var ok = document.getElementById('confirmDeleteBtn');
    var newOk = ok.cloneNode(true); 
    ok.parentNode.replaceChild(newOk, ok);
    
    newOk.onclick = function() {
        var c = document.getElementById('delCode').value;
        if(!c) return App.showAppModal('error', 'Kode konfirmasi wajib diisi.'); 
        
        App.showAppModal('loading', 'Menghapus data...'); 
        m.style.display = 'none';
        
        // Ambil sesi user untuk log penghapusan
        var s = JSON.parse(localStorage.getItem('user_session') || '{}');
        
        if (isLapbul) {
            var source = (d._source || d.Jenjang || 'PAUD').toUpperCase();
            if (source.includes('SD')) source = 'SD';
            
            // PANGGIL BACKEND DELETE LAPBUL (Dengan info user)
            google.script.run.withSuccessHandler(function(r) {
                App.showAppModal('success', r, 'lapbul_kelola');
            }).withFailureHandler(function(e) {
                App.showAppModal('error', e.message);
            }).deleteLapbulData(d._rowIndex, source, c, s.nama, s.role); // <--- Kirim Nama & Role
            
        } else {
            // PANGGIL BACKEND DELETE SK
            google.script.run.withSuccessHandler(function(r) {
                App.showAppModal('success', r, 'sk_kelola');
            }).withFailureHandler(function(e) {
                App.showAppModal('error', e.message);
            }).deleteSKData(d._rowIndex, c, s.nama, s.role);
        }
    };
};

App.openVerifModal = function(row) {
    // 1. Cek Admin
    var session = JSON.parse(localStorage.getItem('user_session') || '{}');
    var role = (session.role || '').toLowerCase();
    if (!role.includes('admin')) {
        App.showAppModal('error', 'Akses Ditolak. Fitur ini hanya untuk Admin.');
        return;
    }

    // 2. Cek HTML
    var m = document.getElementById('modalVerifikasi');
    var elNama = document.getElementById('v-nama');
    if (!m || !elNama) return alert("HTML Error: Struktur Modal belum sesuai.");

    // --- 3. RESET TOMBOL SIMPAN (PENTING!) ---
    // Ini memperbaiki masalah tombol "Menyimpan..." yang macet
    var btnSimpan = document.querySelector('#formVerifikasi button[type="submit"]');
    if (btnSimpan) {
        btnSimpan.disabled = false;
        btnSimpan.innerHTML = '<i class="fas fa-save"></i> SIMPAN PERUBAHAN';
    }

    // 4. Tampilkan Modal
    m.style.display = 'flex';

    // 5. Isi Data Teks
    document.getElementById('v-row-index').value = row._rowIndex;
    
    var set = function(id, val) { 
        var el = document.getElementById(id);
        if(el) el.textContent = (val && val !== '') ? val : '-'; 
    };

    set('v-nama', row['Nama Sekolah']);
    set('v-tahun', row['Tahun Ajaran']);
    set('v-semester', row['Semester']);
    set('v-nomor', row['Nomor SK']);
    set('v-tanggal', row['Tanggal SK']);
    set('v-kriteria', row['Kriteria SK']);

    // Isi Status Saat Ini
    document.getElementById('v-status-current').innerHTML = row['Status'] || '<span class="status-badge status-belum">-</span>';

    // Reset Dropdown & Keterangan
    document.getElementById('v-status').value = "";
    document.getElementById('v-keterangan').value = row['Keterangan'] || '';

    // --- 6. PREVIEW DOKUMEN ---
    var container = document.getElementById('v-preview-area');
    var url = row['Dokumen'];

    container.innerHTML = ''; 

    if (url && url.includes('http')) {
        // Mode Iframe (Inline Preview)
        var fileId = "";
        var match = url.match(/[-\w]{25,}/);
        if(match) fileId = match[0];
        
        var previewUrl = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : url;

        var iframe = document.createElement('iframe');
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = 'none';
        iframe.src = previewUrl;
        
        container.appendChild(iframe);
    } else {
        container.innerHTML = '<div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; opacity:0.6;">' +
                              '<i class="fas fa-file-excel" style="font-size:3rem; margin-bottom:10px;"></i>' +
                              '<p>Tidak ada dokumen</p></div>';
    }

    // --- 7. HANDLE SIMPAN ---
    var form = document.getElementById('formVerifikasi');
    var newForm = form.cloneNode(true);
    form.parentNode.replaceChild(newForm, form);

    newForm.onsubmit = function(e) {
        e.preventDefault();
        
        var dropdown = document.getElementById('v-status');
        if (!dropdown.value) {
            alert("Harap pilih Keputusan Verifikasi terlebih dahulu.");
            dropdown.focus();
            return;
        }

        var btnSubmit = newForm.querySelector('button[type="submit"]');
        var oldText = btnSubmit.innerHTML;
        btnSubmit.disabled = true; btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

        var payload = {
            rowIndex: document.getElementById('v-row-index').value,
            status: dropdown.value,
            keterangan: document.getElementById('v-keterangan').value,
            verifikator: session.nama || 'Admin'
        };

        google.script.run.withSuccessHandler(function(res) {
            App.tutupVerifikasi();
            App.showAppModal('success', res, 'sk_kelola');
        }).withFailureHandler(function(err) {
            btnSubmit.disabled = false; btnSubmit.innerHTML = oldText;
            alert("Gagal: " + err.message);
        }).updateSKVerificationStatus(payload);
    };
};

// Fungsi Tutup
App.tutupVerifikasi = function() {
    var m = document.getElementById('modalVerifikasi');
    if(m) m.style.display = 'none';
    
    var c = document.getElementById('v-preview-area');
    if(c) c.innerHTML = '';
};

// ===========================================
// CONTROLLER LAPORAN BULAN (PAUD & SD)
// ===========================================

// Helper: Setup Tab Navigasi
App.setupTabs = function(formId) {
    var form = document.getElementById(formId);
    if (!form) return;

    var links = form.querySelectorAll('.tab-link');
    var contents = form.querySelectorAll('.tab-content-form');
    
    // Fungsi aktifkan tab
    function activate(targetId) {
        // Sembunyikan semua
        links.forEach(l => l.classList.remove('active'));
        contents.forEach(c => { c.classList.remove('active'); c.style.display = 'none'; });

        // Munculkan target
        var btn = form.querySelector(`.tab-link[data-tab="${targetId}"]`);
        var panel = document.getElementById(targetId);
        if(btn && panel) {
            btn.classList.add('active');
            btn.disabled = false;
            panel.classList.add('active');
            panel.style.display = 'block';
        }
    }

    // Klik Tab Atas
    links.forEach(btn => {
        btn.onclick = function() { if(!this.disabled) activate(this.dataset.tab); };
    });

    // Klik Tombol Next/Prev
    form.querySelectorAll('.next-tab-btn, .prev-tab-btn').forEach(btn => {
        btn.onclick = function() {
            var curr = form.querySelector('.tab-content-form.active');
            var arr = Array.from(contents);
            var idx = arr.indexOf(curr);
            var nextIdx = btn.classList.contains('next-tab-btn') ? idx + 1 : idx - 1;
            if(arr[nextIdx]) activate(arr[nextIdx].id);
        };
    });
};

// --- INIT FORM PAUD (UPDATE VALIDASI TAB 2) ---
App.inits['lapbul_form_paud'] = function() {
    console.log("Init Form PAUD: Validasi Tab 2...");

    var form = document.getElementById('lapbulFormPaud');
    if (!form) return;

    // 1. SETUP NAVIGASI TAB
    if(App.setupTabs) App.setupTabs('lapbulFormPaud');
    var tabs = form.querySelectorAll('.tab-link');
    // Kunci tab selain tab 1
    tabs.forEach((t, i) => { if (i > 0) t.disabled = true; });

    // FUNGSI PINDAH TAB MANUAL
    function goToTab(tabId) {
        var targetBtn = form.querySelector(`.tab-link[data-tab="${tabId}"]`);
        if(targetBtn) {
            targetBtn.disabled = false;
            // Simulasi klik agar CSS class 'active' berpindah otomatis lewat App.setupTabs
            targetBtn.click(); 
            
            // Scroll ke atas
            var mainContainer = document.querySelector('.manual-form');
            if(mainContainer) mainContainer.scrollTop = 0;
        }
    }

    // 2. DEFAULT TAHUN & BULAN
    var now = new Date();
    var curYear = now.getFullYear();
    var curMonthIdx = now.getMonth() - 1; 
    if (curMonthIdx < 0) curMonthIdx = 11;

    var selTahun = form.querySelector('select[name="tahun"]');
    var selBulan = form.querySelector('select[name="laporanBulan"]');
    
    if(selTahun) selTahun.innerHTML = `<option value="${curYear}" selected>${curYear}</option><option value="${curYear-1}">${curYear-1}</option>`;
    if(selBulan) {
        var bln = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        selBulan.innerHTML = '<option value="">-- Pilih Bulan --</option>' + 
            bln.map((b, i) => `<option value="${b}" ${i === curMonthIdx ? 'selected' : ''}>${b}</option>`).join('');
    }

    // 3. LOAD DATA SEKOLAH
    google.script.run.withSuccessHandler(function(lists) {
        var selJenjang = document.getElementById('jenjang');
        var selNama = document.getElementById('namaSekolah');
        if (selJenjang) {
            selJenjang.innerHTML = '<option value="">-- Pilih --</option><option value="KB">KB</option><option value="TK">TK</option>';
            selJenjang.addEventListener('change', function() {
                if(selNama) {
                    selNama.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
                    selNama.disabled = false;
                    var schools = lists[this.value] || [];
                    schools.forEach(s => selNama.add(new Option(s, s)));
                }
            });
        }
    }).getPaudSchoolLists();


    // ===============================================
    // LOGIKA VALIDASI
    // ===============================================

    // Validasi Tab 1
    function validateTab1() {
        var inputs = form.querySelectorAll('#dataSekolah [required]');
        for(var i=0; i<inputs.length; i++) {
            if(!inputs[i].value || inputs[i].value.trim() === '') {
                App.showAppModal('error', 'Harap lengkapi semua data Lembaga.');
                inputs[i].focus();
                return false;
            }
        }
        return true;
    }

    // --- VALIDASI TAB 2 (MURID) ---
    function checkMuridMatch() {
        var inputsUsiaL = form.querySelectorAll('input[name^="murid_"][name$="_L"]');
        var inputsUsiaP = form.querySelectorAll('input[name^="murid_"][name$="_P"]');
        var inputsRombelL = form.querySelectorAll('input[name^="kelompok_"][name$="_L"]');
        var inputsRombelP = form.querySelectorAll('input[name^="kelompok_"][name$="_P"]');

        var sumUsiaL = 0, sumUsiaP = 0;
        var sumRombelL = 0, sumRombelP = 0;

        inputsUsiaL.forEach(el => sumUsiaL += parseInt(el.value || 0));
        inputsUsiaP.forEach(el => sumUsiaP += parseInt(el.value || 0));
        inputsRombelL.forEach(el => sumRombelL += parseInt(el.value || 0));
        inputsRombelP.forEach(el => sumRombelP += parseInt(el.value || 0));

        var totalUsia = sumUsiaL + sumUsiaP;
        var totalRombel = sumRombelL + sumRombelP;

        // --- UPDATE TEKS VALIDASI (SESUAI REQUEST) ---
        var txtUsia = document.getElementById('val-text-usia');
        var txtRombel = document.getElementById('val-text-rombel');
        var txtStatus = document.getElementById('val-status-msg');
        var box = document.getElementById('murid-validation-feedback');

        if(txtUsia) txtUsia.textContent = `Total Murid (Menurut Usia): L = ${sumUsiaL}, P = ${sumUsiaP}, Jumlah = ${totalUsia}`;
        if(txtRombel) txtRombel.textContent = `Total Murid (Menurut Rombel): L = ${sumRombelL}, P = ${sumRombelP}, Jumlah = ${totalRombel}`;

        // --- LOGIKA STATUS ---
        // 1. Jika Masih 0
        if (totalUsia === 0 && totalRombel === 0) {
            txtStatus.textContent = "Data murid belum diisi.";
            box.className = "murid-val-box neutral"; 
            return false;
        } 
        // 2. Jika Tidak Sama (L vs L atau P vs P)
        else if (sumUsiaL !== sumRombelL || sumUsiaP !== sumRombelP) {
            txtStatus.textContent = "JUMLAH TIDAK SAMA!";
            box.className = "murid-val-box error";
            return false;
        } 
        // 3. Jika Valid
        else {
            txtStatus.textContent = "JUMLAH SAMA (VALID)";
            box.className = "murid-val-box success";
            return true;
        }
    }

    // Listener Input Murid
    form.querySelectorAll('#dataMurid input[type="number"]').forEach(inp => {
        inp.addEventListener('input', checkMuridMatch);
    });


    // Validasi Tab 3 (PTK)
    function validateTab3() {
        var kepsekASN = parseInt(form.querySelector('input[name="kepsek_ASN"]').value) || 0;
        var kepsekNon = parseInt(form.querySelector('input[name="kepsek_Non_ASN"]').value) || 0;
        
        if ((kepsekASN + kepsekNon) > 1) {
            App.showAppModal('error', 'Maksimal 1 Kepala Sekolah (ASN + Non ASN).');
            return false;
        }
        
        var totalPTK = 0;
        form.querySelectorAll('#dataPtk input[type="number"]').forEach(el => {
            totalPTK += parseInt(el.value || 0);
        });
        
        if (totalPTK < 1) {
            App.showAppModal('error', 'Minimal harus ada 1 PTK (Guru/Kepsek).');
            return false;
        }
        return true;
    }


    // ===============================================
    // TOMBOL BERIKUTNYA (AUTO SWITCH)
    // ===============================================
    var nextBtns = form.querySelectorAll('.next-tab-btn');
    nextBtns.forEach(btn => {
        var newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.addEventListener('click', function() {
            var activePanel = form.querySelector('.tab-content-form.active');
            if(!activePanel) return;

            // DARI TAB 1 KE 2
            if (activePanel.id === 'dataSekolah') {
                if(validateTab1()) goToTab('dataMurid');
            } 
            // DARI TAB 2 KE 3 (CEK DATA MURID)
            else if (activePanel.id === 'dataMurid') {
                if(checkMuridMatch()) {
                    goToTab('dataPtk'); // Pindah Otomatis ke Tab 3
                } else {
                    App.showAppModal('error', 'Data Murid Belum Valid (Jumlah Tidak Sama).');
                }
            }
            // DARI TAB 3 KE 4
            else if (activePanel.id === 'dataPtk') {
                if(validateTab3()) goToTab('dataUnggah');
            }
        });
    });

    // TOMBOL SEBELUMNYA
    var prevBtns = form.querySelectorAll('.prev-tab-btn');
    prevBtns.forEach(btn => {
        var newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = function() {
            var curr = form.querySelector('.tab-content-form.active');
            if(curr.id === 'dataUnggah') goToTab('dataPtk');
            else if(curr.id === 'dataPtk') goToTab('dataMurid');
            else if(curr.id === 'dataMurid') goToTab('dataSekolah');
        };
    });

    // FINAL SUBMIT
    form.onsubmit = function(e) {
        e.preventDefault();
        var fileInput = document.getElementById('fileLapbul');
        if(!fileInput.files.length) return App.showAppModal('error', 'Pilih file PDF!');
        var file = fileInput.files[0];
        if(file.type !== 'application/pdf') return App.showAppModal('error', 'Wajib format PDF.');
        if(file.size > 307200) return App.showAppModal('error', 'File max 300KB.');

        if(App.handleFormSubmit) App.handleFormSubmit(this, 'processLapbulFormPaud');
    };
};

// --- INIT FORM SD (BERSIH & TERINTEGRASI GLOBAL) ---
App.inits['lapbul_form_sd'] = function() {
    console.log("Init Form SD: Global Helpers...");
    var form = document.getElementById('lapbulFormSd');
    if (!form) return;

    // 1. Setup Tab & Lock
    if(App.setupTabs) App.setupTabs('lapbulFormSd');
    var tabs = form.querySelectorAll('.tab-link');
    tabs.forEach((t, i) => { if (i > 0) t.disabled = true; });

    // (Fungsi App.showAlert, App.showConfirm, App.handleFormSubmit SUDAH GLOBAL, dihapus dari sini)

    // --- 2. GENERATOR KELAS ---
    var agamas = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
    var tabContainer = document.getElementById('subTabContainer');
    var contentContainer = document.getElementById('kelasContentArea');
    
    tabContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    for (var k = 1; k <= 6; k++) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = (k === 1) ? 'sub-tab-btn active' : 'sub-tab-btn';
        btn.textContent = 'Kelas ' + k;
        btn.onclick = (function(idx) { return function() { App.navKelas(idx); }; })(k);
        tabContainer.appendChild(btn);

        var div = document.createElement('div');
        div.id = 'kelas_content_' + k;
        div.className = 'kelas-content';
        div.style.display = (k === 1) ? 'block' : 'none';

        var html = `
            <div class="section-divider"><span>Data Kelas ${k} - Menurut Rombel</span></div>
            <div class="rombel-control-box">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Jumlah Rombel</label>
                    <select name="Rombel ${k}" id="select_rombel_${k}" class="form-control" style="width:100px; font-weight:bold;" onchange="App.updateRombelLayout(${k}, this.value)">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="0">0</option>
                    </select>
                </div>
                <div id="rombel_inputs_container_${k}" class="rombel-inputs-grid"></div>
            </div>

            <div class="section-divider"><span>Data Kelas ${k} - Menurut Agama</span></div>
            <div class="input-grid-container">`;
        
        agamas.forEach(agama => {
            var isIslam = (agama === 'Islam');
            var displayStyle = isIslam ? 'block' : 'none';
            html += `
            <div class="input-box-card">
                <span class="box-title">${agama}</span>
                <select class="status-select" onchange="App.toggleAgamaInput(this)">
                    <option value="Ada" ${isIslam ? 'selected' : ''}>Ada</option>
                    <option value="Tidak" ${!isIslam ? 'selected' : ''}>Tidak Ada</option>
                </select>
                <div class="input-wrapper" style="display:${displayStyle};">
                    <div class="lp-wrapper">
                        <div class="lp-field"><label class="lp-label">L</label><input type="number" name="K${k} ${agama} L" class="form-control-mini input-agama" min="0"></div>
                        <div class="lp-field"><label class="lp-label">P</label><input type="number" name="K${k} ${agama} P" class="form-control-mini input-agama" min="0"></div>
                    </div>
                </div>
            </div>`;
        });

        html += `</div>
            <div class="validation-footer">
                <div id="val_text_rombel_${k}">Jumlah Menurut Rombel: L = 0, P = 0, Jumlah = 0</div>
                <div id="val_text_agama_${k}">Jumlah Menurut Agama: L = 0, P = 0, Jumlah = 0</div>
                <span id="val_status_${k}" class="val-status-text text-green">JUMLAH SESUAI</span>
                
                <div style="margin-top:20px; display:flex; justify-content:space-between;">
                    ${k > 1 ? `<button type="button" class="btn-secondary" onclick="App.navKelas(${k-1})"> < Kelas ${k-1}</button>` : '<div></div>'}
                    ${k < 6 ? `<button type="button" class="btn-primary" onclick="App.navKelas(${k+1})">Kelas ${k+1} ></button>` : '<div></div>'}
                </div>
            </div>`;
        div.innerHTML = html;
        contentContainer.appendChild(div);
        
        // Init Default Rombel 1
        (function(idx) {
            setTimeout(() => { 
                if(document.getElementById(`select_rombel_${idx}`)) App.updateRombelLayout(idx, "1"); 
            }, 0);
        })(k);
    }

    // --- LOGIKA HELPER ---
    App.navKelas = function(k) {
        document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.kelas-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.sub-tab-btn')[k-1].classList.add('active');
        document.getElementById('kelas_content_' + k).style.display = 'block';
        
        var mainFooter = document.getElementById('tab2Footer');
        if (k === 6) mainFooter.style.display = 'flex'; else mainFooter.style.display = 'none';
        
        var main = document.querySelector('.form-card');
        if(main) main.scrollTop = 0;
    };

    App.updateRombelLayout = function(k, val) {
        if (val === undefined || val === null) {
            var selectEl = document.getElementById(`select_rombel_${k}`);
            val = selectEl ? selectEl.value : "1";
        }
        var container = document.getElementById(`rombel_inputs_container_${k}`);
        if(!container) return;

        var html = '';
        if (val == '1') {
            html = createRombelBox(k, "", `K${k} L`, `K${k} P`, `Kelas ${k}`);
        } else if (val == '2') {
            html = createRombelBox(k, "A", `K${k}A L`, `K${k}A P`) + createRombelBox(k, "B", `K${k}B L`, `K${k}B P`);
        } else if (val == '3') {
            html = createRombelBox(k, "A", `K${k}A L`, `K${k}A P`) + createRombelBox(k, "B", `K${k}B L`, `K${k}B P`) + createRombelBox(k, "C", `K${k}C L`, `K${k}C P`);
        } else if (val == '0') {
            html = '<div style="color:#64748b; font-style:italic; grid-column:1/-1; text-align:center; padding:20px;">Tidak ada rombel (Kelas Kosong)</div>';
        }
        container.innerHTML = html;
        App.calculateSdValidation(k);
    };

    function createRombelBox(k, suffix, nameL, nameP, customLabel) {
        var label = customLabel || `Kelas ${k}${suffix}`;
        return `<div class="input-box-card"><span class="box-title">${label}</span><div class="lp-wrapper"><div class="lp-field"><label class="lp-label">L</label><input type="number" name="${nameL}" class="form-control-box input-rombel" min="0"></div><div class="lp-field"><label class="lp-label">P</label><input type="number" name="${nameP}" class="form-control-box input-rombel" min="0"></div></div></div>`;
    }

    App.toggleAgamaInput = function(selectEl) {
        var wrapper = selectEl.parentElement.querySelector('.input-wrapper');
        var inputs = wrapper.querySelectorAll('input');
        if (selectEl.value === 'Ada') {
            wrapper.style.display = 'block';
        } else {
            wrapper.style.display = 'none';
            inputs.forEach(i => i.value = ''); 
            var parent = selectEl.closest('.kelas-content');
            if(parent) App.calculateSdValidation(parent.id.split('_')[2]);
        }
    };

    App.calculateSdValidation = function(k) {
        var container = document.getElementById('kelas_content_' + k);
        var sumRombelL = 0, sumRombelP = 0;
        container.querySelectorAll('.input-rombel').forEach(el => {
            if(el.name.endsWith('L')) sumRombelL += Number(el.value || 0); else sumRombelP += Number(el.value || 0);
        });
        var sumAgamaL = 0, sumAgamaP = 0;
        container.querySelectorAll('.input-agama').forEach(el => {
            var wrapper = el.closest('.input-wrapper');
            if(wrapper && wrapper.style.display !== 'none') {
                if(el.name.endsWith('L')) sumAgamaL += Number(el.value || 0); else sumAgamaP += Number(el.value || 0);
            }
        });

        document.getElementById(`val_text_rombel_${k}`).textContent = `Jumlah Menurut Rombel: L = ${sumRombelL}, P = ${sumRombelP}, Jumlah = ${sumRombelL+sumRombelP}`;
        document.getElementById(`val_text_agama_${k}`).textContent = `Jumlah Menurut Agama: L = ${sumAgamaL}, P = ${sumAgamaP}, Jumlah = ${sumAgamaL+sumAgamaP}`;

        var statusEl = document.getElementById(`val_status_${k}`);
        if(sumRombelL === sumAgamaL && sumRombelP === sumAgamaP) {
            statusEl.textContent = "JUMLAH SESUAI"; statusEl.className = "val-status-text text-green";
            return true;
        } else {
            statusEl.textContent = "JUMLAH BELUM SESUAI"; statusEl.className = "val-status-text text-red";
            return false;
        }
    };

    form.addEventListener('input', function(e) {
        if(e.target.type === 'number' && form.contains(e.target)) {
            var parentContent = e.target.closest('.kelas-content');
            if(parentContent) App.calculateSdValidation(parentContent.id.split('_')[2]);
        }
    });

    // --- 3. LOGIKA DEFAULT ---
    var now = new Date();
    var curYear = now.getFullYear();
    var curMonthIdx = now.getMonth() - 1; if (curMonthIdx < 0) curMonthIdx = 11;

    var selTahun = form.querySelector('select[name="Tahun"]');
    var selBulan = form.querySelector('select[name="Bulan"]');
    if(selTahun) selTahun.innerHTML = `<option value="${curYear}" selected>${curYear}</option><option value="${curYear-1}">${curYear-1}</option>`;
    if(selBulan) selBulan.innerHTML = '<option value="">-- Pilih Bulan --</option>' + ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"].map((b, i) => `<option value="${b}" ${i === curMonthIdx ? 'selected' : ''}>${b}</option>`).join('');

    google.script.run.withSuccessHandler(function(lists) {
        var selStatus = document.getElementById('statusSekolah');
        var selNama = document.getElementById('namaSekolah');
        selStatus.addEventListener('change', function() {
            selNama.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
            selNama.disabled = false;
            var key = (this.value === 'Negeri') ? 'SDN' : 'SDS';
            (lists[key] || []).forEach(s => selNama.add(new Option(s, s)));
        });
    }).getSdSchoolLists();

    // --- 4. VALIDASI TAB ---
    function validateTab1() {
        var inputs = form.querySelectorAll('#dataSekolah [required]');
        for(var i=0; i<inputs.length; i++) {
            if(!inputs[i].value || inputs[i].value.trim() === '') { App.showAlert('error', 'Data Belum Lengkap', 'Mohon lengkapi semua data sekolah.'); inputs[i].focus(); return false; }
        }
        return true;
    }

    function validateTab2() {
        var emptyClasses = [];
        var invalidClasses = [];
        for(var k=1; k<=6; k++) {
            var container = document.getElementById('kelas_content_' + k);
            var sum = 0;
            container.querySelectorAll('.input-rombel').forEach(el => sum += Number(el.value||0));
            var rombelVal = document.getElementById(`select_rombel_${k}`).value;
            if (rombelVal != '0' && sum === 0) emptyClasses.push(k);
            if(sum > 0 && !App.calculateSdValidation(k)) invalidClasses.push(k);
        }

        if(invalidClasses.length > 0) { App.showAlert('error', 'Data Tidak Sesuai', 'Data Kelas ' + invalidClasses.join(', ') + ' tidak sesuai.'); return false; }
        if(emptyClasses.length > 0) {
            App.showConfirm('Data Siswa Kosong', `Data siswa di <b>Kelas ${emptyClasses.join(', ')}</b> masih kosong.<br>Lanjutkan?`, function(res) {
                if(res) goToTab('dataPtk');
            });
            return false;
        }
        return true;
    }

    function validateTab3() {
        var ks = Number(form.querySelector('input[name="KS PNS"]').value||0) + Number(form.querySelector('input[name="KS PPPK"]').value||0) + Number(form.querySelector('input[name="KS NON ASN"]').value||0);
        if(ks > 1) { App.showAlert('error', 'Data Tidak Valid', 'Maksimal 1 Kepala Sekolah.'); return false; }

        var totalGuru = 0;
        form.querySelectorAll('.matrix-input-table input').forEach(inp => totalGuru += Number(inp.value||0));
        if(totalGuru === 0) {
            App.showConfirm('Data Guru Kosong', 'Data Guru & Tendik kosong.<br>Lanjutkan?', function(res) {
                if(res) goToTab('dataUnggah');
            });
            return false;
        }
        return true;
    }

    function goToTab(tabId) {
        var btn = form.querySelector(`.tab-link[data-tab="${tabId}"]`);
        if(btn) { btn.disabled = false; btn.click(); document.querySelector('.form-card').scrollTop = 0; }
    }

    form.querySelectorAll('.next-tab-btn').forEach(btn => {
        var newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = function() {
            var curr = form.querySelector('.tab-content-form.active');
            if(curr.id === 'dataSekolah' && validateTab1()) goToTab('dataMurid');
            else if(curr.id === 'dataMurid' && validateTab2()) goToTab('dataPtk');
            else if(curr.id === 'dataPtk' && validateTab3()) goToTab('dataUnggah');
        };
    });

    form.querySelectorAll('.prev-tab-btn').forEach(btn => {
        btn.onclick = function() {
            var curr = form.querySelector('.tab-content-form.active');
            if(curr.id === 'dataUnggah') goToTab('dataPtk');
            else if(curr.id === 'dataPtk') goToTab('dataMurid');
            else if(curr.id === 'dataMurid') goToTab('dataSekolah');
        };
    });

    form.onsubmit = function(e) {
        e.preventDefault();
        // Validasi keberadaan file saja, ukurannya dicek di App.handleFormSubmit
        var fileIn = document.getElementById('fileLapbulSd');
        if(!fileIn.files.length) return App.showAlert('error', 'File Kosong', 'Pilih file PDF!');
        
        // Panggil Global Handler yang Baru
        if(App.handleFormSubmit) App.handleFormSubmit(this, 'processLapbulFormSd');
    };
};

App.inits['lapbul_riwayat'] = function() {
    App.initSmartTable({
        tableId: 'riwayatTable', 
        serverFunc: 'getLapbulRiwayatData',
        
        // URUTAN KOLOM BARU (Nama Sekolah di awal)
        // Tanpa object {name, width}, murni string agar auto-width
        headers: [
            "Nama Sekolah", // Kolom 2 (setelah No)
            "Jenjang", 
            "Status", 
            "Bulan", 
            "Tahun", 
            "Rombel", 
            "Dokumen",
            "Tanggal Unggah",
            "User"
        ],
        
        filters: [
            {id:'filterTahun',   col:'Tahun',    label:'-- Pilih Tahun --', desc:true},
            {id:'filterBulan',   col:'Bulan',    label:'-- Pilih Bulan --'},
            {id:'filterJenjang', col:'Jenjang',  label:'-- Pilih Jenjang --'},
            {id:'filterSekolah', col:'Nama Sekolah', label:'-- Pilih Sekolah --'}
        ],
        
        // Logika Dropdown Berantai (Tetap Sama)
        onFilterChange: function(filterId, value, filteredRows, allRows) {
            if(filterId === 'filterJenjang') {
                var elSekolah = document.getElementById('filterSekolah');
                if(!elSekolah) return;
                elSekolah.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
                var relevantRows = value ? allRows.filter(r => r.Jenjang === value) : allRows;
                var schools = [];
                relevantRows.forEach(r => { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                var uniqueSchools = schools.filter((v, i, a) => a.indexOf(v) === i).sort();
                uniqueSchools.forEach(s => elSekolah.add(new Option(s, s)));
            }
        },
        onLoad: function(allRows) {
             var elSekolah = document.getElementById('filterSekolah');
             if(elSekolah && elSekolah.options.length <= 1) {
                 var schools = [];
                 allRows.forEach(r => { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                 var uniqueSchools = schools.filter((v, i, a) => a.indexOf(v) === i).sort();
                 uniqueSchools.forEach(s => elSekolah.add(new Option(s, s)));
             }
        }
    });
};

App.inits['lapbul_status'] = function() {
    // 1. Setup Filter Data (Tahun & Jenjang)
    var curYear = new Date().getFullYear();
    var selTahun = document.getElementById('filterTahun');
    var selJenjang = document.getElementById('filterJenjang');

    if(selTahun && selTahun.options.length === 0) {
        selTahun.innerHTML = '';
        for(var y = curYear; y >= 2023; y--) selTahun.add(new Option(y, y));
    }
    if(selJenjang && selJenjang.options.length === 0) {
        selJenjang.innerHTML = '<option value="">Semua Jenjang</option><option value="SD">SD</option><option value="PAUD">PAUD</option>';
    }

    // 2. Fungsi Load Table
    var loadTable = function() {
        var params = {
            tahun: document.getElementById('filterTahun') ? document.getElementById('filterTahun').value : new Date().getFullYear(),
            jenjang: document.getElementById('filterJenjang') ? document.getElementById('filterJenjang').value : ""
        };

        App.initSmartTable({
            tableId: 'lapbulStatusTable', 
            serverFunc: 'getLapbulStatusData',
            params: params, // Kirim Filter
            
            // KONFIGURASI KOLOM
            headers: [
                "Nama Sekolah", 
                { name: "Jenjang", width: "80px" },
                { name: "Status", width: "100px" },
                // Bulan (Lebar kecil 50px cukup untuk icon)
                { name: "Januari", width: "50px" }, { name: "Februari", width: "50px" }, { name: "Maret", width: "50px" },
                { name: "April", width: "50px" },   { name: "Mei", width: "50px" },      { name: "Juni", width: "50px" },
                { name: "Juli", width: "50px" },    { name: "Agustus", width: "50px" },  { name: "September", width: "50px" },
                { name: "Oktober", width: "50px" }, { name: "November", width: "50px" },  { name: "Desember", width: "50px" }
            ],

            filters: [
                {id:'filterNamaSekolah', col:'Nama Sekolah', label:'-- Cari Sekolah --'}
            ],
            
            // CALLBACK CUSTOM STYLE (Agar ✅ jadi hijau)
            onLoad: function(rows) {
                 // 1. Isi Dropdown Sekolah (Optional)
                 var elSekolah = document.getElementById('filterNamaSekolah');
                 if(elSekolah && elSekolah.options.length <= 1) {
                     var schools = [];
                     rows.forEach(r => { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                     var uniqueSchools = schools.filter((v, i, a) => a.indexOf(v) === i).sort();
                     uniqueSchools.forEach(s => elSekolah.add(new Option(s, s)));
                 }

                 // 2. Styling Sel Tabel (Ubah Text ✅ jadi Icon)
                 var table = document.getElementById('lapbulStatusTable');
                 var cells = table.querySelectorAll('td');
                 
                 cells.forEach(function(td) {
                     if (td.textContent === '✅') {
                         td.innerHTML = '<i class="fas fa-check-circle" style="color:#16a34a; font-size:1.2em;"></i>';
                         td.style.textAlign = 'center';
                     } else if (td.textContent === '' || td.textContent === '-') {
                         // Bulan Kosong
                         td.style.backgroundColor = '#f8fafc'; // Abu tipis
                     }
                 });
            }
        });
    };

    // 3. Event Listener
    if(selTahun) selTahun.onchange = loadTable;
    if(selJenjang) selJenjang.onchange = loadTable;
    var selT = document.getElementById('filterTahun');
    var selJ = document.getElementById('filterJenjang');
    if(selT) selT.onchange = loadTable;
    if(selJ) selJ.onchange = loadTable;

    // Load Awal
    loadTable();
};

App.inits['lapbul_arsip'] = function() {
    // 1. Setup Dropdown (Tahun, Bulan, Jenjang)
    var curYear = new Date().getFullYear();
    var selTahun = document.getElementById('filterTahun');
    var selBulan = document.getElementById('filterBulan');
    var selJenjang = document.getElementById('filterJenjang');

    // Isi Tahun
    if(selTahun && selTahun.options.length === 0) {
        selTahun.innerHTML = '';
        for(var y = curYear; y >= 2023; y--) selTahun.add(new Option(y, y));
    }
    // Isi Bulan
    if(selBulan && selBulan.options.length === 0) {
        selBulan.innerHTML = '<option value="">Semua Bulan</option>';
        var mList = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        mList.forEach(m => selBulan.add(new Option(m, m)));
    }
    // Isi Jenjang
    if(selJenjang && selJenjang.options.length === 0) {
        selJenjang.innerHTML = '<option value="">Semua Jenjang</option><option value="SD">SD</option><option value="TK">TK</option><option value="KB">KB</option>';
    }

    // 2. Fungsi Load Table
    var loadTable = function() {
        var params = {
            tahun: selTahun ? selTahun.value : curYear,
            bulan: selBulan ? selBulan.value : "",
            jenjang: selJenjang ? selJenjang.value : ""
        };

        App.initSmartTable({
            tableId: 'arsipTable', 
            serverFunc: 'getLapbulArsipData', // Fungsi backend baru
            params: params,
            
            headers: [
                "Nama File", 
                { name: "Jenjang", width: "80px" },
                { name: "Bulan", width: "100px" },
                { name: "Tahun", width: "80px" },
                { name: "Ukuran", width: "80px" },
                { name: "Aksi", width: "100px" }
            ],
            
            // Custom Rendering untuk Tombol Aksi (Download)
            onLoad: function(rows) {
                var tb = document.querySelector('#arsipTable tbody');
                // Kita iterasi manual baris yang baru dirender untuk menyuntikkan tombol
                // Tapi lebih efektif jika kita handle di "Render Data" App.initSmartTable 
                // Namun karena App.initSmartTable kita generik, kita bisa pakai trick ini:
                
                // --- TRICK: Ubah Kolom "Aksi" menjadi Tombol ---
                // Karena data 'Aksi' di JSON backend sebenarnya kosong/undefined, 
                // kita ambil link dari properti row.Link
                
                // Cari index kolom file link
                Array.from(tb.rows).forEach((tr, idx) => {
                    var rowData = rows[idx]; // Data asli JSON
                    if (!rowData) return;

                    var lastCell = tr.lastElementChild; // Asumsi Aksi di akhir
                    var link = rowData.Link;
                    
                    if (link) {
                        lastCell.innerHTML = `
                            <button class="action-btn view-btn" onclick="window.open('${link}', '_blank')">
                                <i class="fas fa-file-download"></i> Buka
                            </button>
                        `;
                        lastCell.style.textAlign = "center";
                    }
                    
                    // Style Nama File agar tebal & truncate
                    var nameCell = tr.cells[1]; // Index 1 karena 0=No
                    nameCell.style.fontWeight = "600";
                    nameCell.style.color = "#334155";
                });
            }
        });
    };

    // 3. Listener
    if(selTahun) selTahun.onchange = loadTable;
    if(selBulan) selBulan.onchange = loadTable;
    if(selJenjang) selJenjang.onchange = loadTable;

    loadTable();
};

// STATE NAVIGASI ARSIP
App.arsipHistory = []; // Stack: [{id:null, name:'Beranda'}, {id:'xxx', name:'SD'}]

App.inits['lapbul_arsip'] = function() {
    App.arsipHistory = [{id: null, name: 'Beranda'}];
    App.toggleArsipView('grid'); // Set default view
    App.loadArsipFolder(null);
};

// Fungsi Helper untuk Refresh Tombol
App.refreshArsip = function() {
    // Ambil ID folder terakhir di history
    var current = App.arsipHistory[App.arsipHistory.length - 1];
    App.loadArsipFolder(current.id, true); // True = jangan tambah history (cuma refresh)
};

// UPDATE FUNGSI INI DI javascript.html
App.loadArsipFolder = function(folderId) {
    var grid = document.getElementById('arsipGrid');
    var loader = document.getElementById('arsipLoader');
    var empty = document.getElementById('arsipEmpty');
    
    if(!grid) return;

    grid.innerHTML = '';
    empty.style.display = 'none';
    if(loader) loader.style.display = 'flex'; 

    google.script.run.withSuccessHandler(function(res) {
        if(loader) loader.style.display = 'none';
        
        if (!res || res.error) {
            App.showAppModal('error', res ? res.error : 'Gagal memuat data.');
            return;
        }

        App.renderBreadcrumb();

        if (!res.items || res.items.length === 0) {
            empty.style.display = 'block';
            return;
        }

        var html = '';
        res.items.forEach(function(item) {
            var iconClass = item.type === 'folder' ? 'fas fa-folder folder-icon' : 'fas fa-file-pdf pdf-icon';
            
            // --- BAGIAN PENTING YANG DIUBAH ---
            var clickAction = '';
            if (item.type === 'folder') {
                clickAction = `onclick="App.enterFolder('${item.id}', '${item.name}')"`;
            } else {
                // SEBELUMNYA: App.previewFile(...) -> Salah (Fungsi lama)
                // SEKARANG: App.showFilePreview(...) -> Benar (Fungsi global baru)
                clickAction = `onclick="App.showFilePreview('${item.url}', '${item.name}')"`;
            }
            // ----------------------------------

            var metaInfo = '';
            if (item.type === 'file') {
                metaInfo = `<span class="item-meta">${item.size} &bull; ${item.updated}</span>`;
            } else {
                metaInfo = `<span class="item-meta">${item.updated || '-'}</span>`;
            }

            html += `
            <div class="explorer-item" ${clickAction} title="${item.name}">
                <i class="${iconClass} explorer-icon"></i>
                <div class="explorer-name">${item.name}</div>
                ${metaInfo}
            </div>`;
        });
        
        grid.innerHTML = html;

    }).withFailureHandler(function(e) {
        if(loader) loader.style.display = 'none';
        App.showAppModal('error', 'Koneksi Gagal: ' + e.message);
    }).getLapbulArsipContent(folderId);
};

// NAVIGASI: MASUK FOLDER (Maju)
App.enterFolder = function(id, name) {
    App.arsipHistory.push({ id: id, name: name });
    App.loadArsipFolder(id);
};

// NAVIGASI: KLIK BREADCRUMB (Mundur/Lompat)
App.jumpToFolder = function(index) {
    // Potong array history sampai index tersebut
    // Misal: [Beranda, SD, 2024]. Klik SD (index 1).
    // History jadi [Beranda, SD].
    var target = App.arsipHistory[index];
    App.arsipHistory = App.arsipHistory.slice(0, index + 1);
    App.loadArsipFolder(target.id);
};

// RENDER BREADCRUMB HTML
App.renderBreadcrumb = function() {
    var el = document.getElementById('arsipBreadcrumb');
    if(!el) return;

    var html = '';
    App.arsipHistory.forEach(function(crumb, idx) {
        // Separator (kecuali item pertama)
        if (idx > 0) html += '<span class="bc-sep"><i class="fas fa-chevron-right"></i></span>';
        
        // Item
        if (idx === App.arsipHistory.length - 1) {
            // Item Terakhir (Aktif) - Tidak bisa diklik
            html += `<span class="bc-item bc-active">${crumb.name}</span>`;
        } else {
            // Item Sebelumnya - Bisa diklik (Jump)
            html += `<span class="bc-item" onclick="App.jumpToFolder(${idx})">${crumb.name}</span>`;
        }
    });
    el.innerHTML = html;
};

// --- INIT HALAMAN KELOLA LAPORAN BULAN (FINAL FIX) ---
App.inits['lapbul_kelola'] = function() {
    
    // 1. SETUP FILTER DENGAN LABEL JELAS
    var curYear = new Date().getFullYear();
    var selTahun = document.getElementById('filterTahun');
    var selBulan = document.getElementById('filterBulan');
    var selJenjang = document.getElementById('filterJenjang');
    var selSekolah = document.getElementById('filterNamaSekolah');

    // Reset & Isi Label Default
    if(selTahun) {
        selTahun.innerHTML = '<option value="">-- Semua Tahun --</option>';
        for(var y = curYear; y >= 2023; y--) selTahun.add(new Option(y, y));
    }
    
    if(selBulan) {
        selBulan.innerHTML = '<option value="">-- Semua Bulan --</option>';
        var mList = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        mList.forEach(m => selBulan.add(new Option(m, m)));
    }

    if(selJenjang) {
        selJenjang.innerHTML = '<option value="">-- Semua Jenjang --</option><option value="SD">SD</option><option value="PAUD">PAUD</option>';
    }

    if(selSekolah) {
        selSekolah.innerHTML = '<option value="">-- Cari Sekolah --</option>';
    }

    // Variabel untuk menyimpan data mentah
    var allTableData = [];

    App.initSmartTable({
        tableId: 'lapbulKelolaTable', // Pastikan ID ini ada di HTML
        serverFunc: 'getLapbulKelolaData',
        
        // URUTAN KOLOM (DISESUAIKAN DENGAN BACKEND)
        headers: [
            "Nama Sekolah", 
            { name: "Jenjang", width: "80px" },
            { name: "Status", width: "100px" },
            { name: "Bulan", width: "100px" },
            { name: "Tahun", width: "80px" },
            { name: "Dokumen", width: "100px" },
            // Tombol Aksi
            { 
                name: "Aksi", 
                width: "100px",
                formatter: function(row) {
                    // Kita gunakan App.loadPage standar agar aman
                    // row._source penting untuk membedakan edit PAUD atau SD
                    var editPage = (row.Jenjang === 'SD') ? 'lapbul_edit_sd' : 'lapbul_edit_paud';
                    
                    // Button HTML
                    return `
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button class="action-btn edit-btn" title="Edit" 
                            onclick="App.loadPage(null, '${editPage}', {rowIndex: ${row._rowIndex}})">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="action-btn delete-btn" title="Hapus" 
                            onclick='App.showDeleteConfirmation(this)' 
                            data-row-info='${JSON.stringify(row).replace(/'/g, "&apos;")}'>
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>`;
                }
            },
            { name: "Tanggal Unggah", width: "150px" },
            { name: "Update", width: "150px" },
            { name: "User", width: "120px" },      // Pengunggah Awal
            { name: "User Edit", width: "120px" }  // [BARU] Penyunting Terakhir
        ],
        
        // Filter Custom
        filters: [
            { id:'filterTahun', col:'Tahun', label:'-- Semua Tahun --' },
            { id:'filterBulan', col:'Bulan', label:'-- Semua Bulan --' },
            { id:'filterJenjang', col:'Jenjang', label:'-- Semua Jenjang --' },
            { id:'filterNamaSekolah', col:'Nama Sekolah', label:'-- Cari Sekolah --' }
        ],
        
        onLoad: function(rows) {
            allTableData = rows;
            updateSekolahDropdown(); // Panggil fungsi lokal
        }
    });

    // 3. LOGIKA FILTER BERANTAI (JENJANG -> SEKOLAH)
    if(selJenjang) {
        selJenjang.addEventListener('change', function() {
            updateSekolahDropdown();
        });
    }

    // Fungsi Update Dropdown Sekolah (Lokal scope agar aman)
    function updateSekolahDropdown() {
        if(!selSekolah) return;
        
        var selectedJenjang = selJenjang ? selJenjang.value : "";
        var currentSelection = selSekolah.value;

        // Filter data unik
        var uniqueSet = new Set();
        allTableData.forEach(function(r) {
            if (!selectedJenjang || r.Jenjang === selectedJenjang) {
                if (r['Nama Sekolah']) uniqueSet.add(r['Nama Sekolah']);
            }
        });

        var filteredSchools = Array.from(uniqueSet).sort();

        // Render Ulang
        selSekolah.innerHTML = '<option value="">-- Cari Sekolah --</option>';
        filteredSchools.forEach(function(s) {
            selSekolah.add(new Option(s, s));
        });

        // Restore selection
        if(filteredSchools.includes(currentSelection)) {
            selSekolah.value = currentSelection;
        }
    }
};

// --- UPDATE HELPER: Agar menerima object row langsung ---
App.openLapbulEdit = function(row) {
    // Cek jika row masih string (kadang terjadi karena parsing HTML)
    if (typeof row === 'string') row = JSON.parse(row);

    var jenjang = (row.Jenjang || '').toUpperCase();
    var targetPage = (jenjang === 'SD') ? 'lapbul_edit_sd' : 'lapbul_edit_paud';
    
    App.loadPage(null, targetPage, {
        rowIndex: row._rowIndex,
        source: (jenjang === 'SD') ? 'SD' : 'PAUD'
    });
};

// --- FUNGSI DELETE KHUSUS LAPBUL ---
App.confirmDeleteLapbul = function(row) {
    if (typeof row === 'string') row = JSON.parse(row);
    var m = document.getElementById('deleteModal');
    if (!m) return;
    var infoHtml = 
        '<div class="delete-detail-row"><span class="delete-detail-label">Sekolah</span><span class="delete-detail-value">' + row['Nama Sekolah'] + '</span></div>' +
        '<div class="delete-detail-row"><span class="delete-detail-label">Laporan</span><span class="delete-detail-value">' + row['Bulan'] + ' ' + row['Tahun'] + '</span></div>';
    
    m.querySelector('.delete-info-card').innerHTML = infoHtml;
    document.getElementById('delCode').value = '';
    m.style.display = 'flex';
    
    document.getElementById('cancelDeleteBtn').onclick = function() { m.style.display='none'; };
    
    var btnConfirm = document.getElementById('confirmDeleteBtn');
    var newBtn = btnConfirm.cloneNode(true);
    btnConfirm.parentNode.replaceChild(newBtn, btnConfirm);
    
    newBtn.onclick = function() {
        var code = document.getElementById('delCode').value;
        if(!code) { App.showAlert('error', 'Kode Kosong', 'Isi kode konfirmasi.'); return; }
        
        App.showAppModal('loading', 'Menghapus...');
        m.style.display = 'none';

        google.script.run.withSuccessHandler(function(res) {
            App.showAppModal('success', 'Berhasil', res);
            App.inits['lapbul_kelola'](); // Refresh
        }).withFailureHandler(function(err) {
            App.showAppModal('error', 'Gagal', err.message);
        }).deleteLapbulData(row._rowIndex, (row.Jenjang==='SD'?'SD':'PAUD'), code);
    };
};

// --- INIT PAGE: EDIT SD ---
App.inits['lapbul_edit_sd'] = function(params) {
    if (!params || !params.rowIndex) {
        return App.showAppModal('error', 'Invalid Access', 'Tidak ada data baris yang dipilih.');
    }
    
    var form = document.getElementById('lapbulEditFormSd');
    if (!form) return;

    App.showAppModal('loading', 'Mengambil data formulir...');

    // 1. Ambil Data
    google.script.run.withSuccessHandler(function(data) {
        document.getElementById('appModal').style.display = 'none'; // Tutup modal loading global

        // 1. SEMBUNYIKAN LOADING PAGE
        var loadingDiv = document.getElementById('loading-data');
        if(loadingDiv) loadingDiv.style.display = 'none';

        // 2. TAMPILKAN FORM (ID BARU: form-edit-container)
        var formContainer = document.getElementById('form-edit-container'); // <-- ID BARU
        if(formContainer) {
            formContainer.style.display = 'block'; // Form Card defaultnya block
            formContainer.style.opacity = '0';
            setTimeout(() => formContainer.style.opacity = '1', 50);
        }

        // 3. ISI FORM (Populate)
        App.populateForm(formId, data);
        var setVal = function(name, val) {
            var el = form.querySelector('[name="'+name+'"]');
            if (el) el.value = (val === undefined || val === null) ? '' : val;
        };

        // 4. Populate Form
        for (var key in data) { setVal(key, data[key]); }
        
        // Populate Dropdown Bulan & Tahun Manual (karena ini edit, nilai harus masuk)
        var selBulan = form.querySelector('[name="Bulan"]');
        var selTahun = form.querySelector('[name="Tahun"]');
        if(selBulan) { 
             selBulan.innerHTML = `<option value="${data.Bulan}" selected>${data.Bulan}</option>`;
             // Tambah opsi lain jika perlu (opsional)
        }
        if(selTahun) selTahun.innerHTML = `<option value="${data.Tahun}" selected>${data.Tahun}</option>`;
        
        // 5. Setup File Link
        var fileBox = document.getElementById('existingFileLink');
        if (data['Dokumen'] && data['Dokumen'].includes('http')) {
            fileBox.innerHTML = `<button type="button" class="btn-download" style="font-size:0.9em; padding:5px 10px; background:#3b82f6;" 
                                 onclick="App.showFilePreview('${data['Dokumen']}')"><i class="fas fa-eye"></i> Lihat File Saat Ini</button>`;
        } else {
            fileBox.textContent = "Tidak ada file sebelumnya.";
        }
        
        // 6. Setup Tab (SD Tabs)
        App.setupFormTabs(form);
        var tabs = document.querySelectorAll('#tab-nav .tab-link');
        var contents = document.querySelectorAll('.tab-content-form');
        
        tabs.forEach(t => {
            t.onclick = function() {
                tabs.forEach(x => x.classList.remove('active'));
                contents.forEach(x => { x.classList.remove('active'); x.style.display='none'; });
                this.classList.add('active');
                document.getElementById(this.dataset.tab).style.display = 'block';
            };
        });

        // 7. Setup Sub-Tab Kelas (Kelas 1-6)
        App.setupPaudValidation(form);
        var classTabs = document.querySelectorAll('.sub-tab-link');
        var classContents = document.querySelectorAll('.tab-content'); // Container kelas
        classTabs.forEach(ct => {
            ct.onclick = function() {
                var k = this.dataset.kelas;
                classTabs.forEach(x => x.classList.remove('active'));
                classContents.forEach(x => x.style.display = 'none');
                
                this.classList.add('active');
                var target = document.getElementById('kelas-content-'+k);
                // Jika konten kelas kosong (belum di-render), render dulu (opsional, tapi karena ini edit, struktur HTML harus ada dulu)
                // ASUMSI: Struktur HTML edit SD sudah lengkap statis atau perlu digenerate.
                // Melihat file page_lapbul_edit_sd.html, div id="kelas-content-1" kosong.
                // KITA PERLU GENERATE FIELD KELAS SEPERTI FORM INPUT.
                if(target.innerHTML.trim() === '') {
                    App.generateSdEditClassFields(k, data, target);
                }
                target.style.display = 'block';
            };
        });
        
        // Trigger klik kelas 1 agar muncul
        if(classTabs.length > 0) classTabs[0].click();


    }).withFailureHandler(function(err) {
        App.showAppModal('error', 'Gagal', err.message);
    }).getLapbulDataByRow(params.rowIndex, 'SD');

    // 8. Submit Handler (Sama seperti PAUD)
    form.onsubmit = function(e) {
        e.preventDefault();
        var fileInput = document.getElementById('fileLapbul');
        var formData = {};
        var els = form.querySelectorAll('input, select');
        els.forEach(el => { if(el.name) formData[el.name] = el.value; });

        var submitData = function(fileObj) {
            formData.fileData = fileObj;
            var btn = document.getElementById('edit-lapbul-sd-submit');
            var old = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = 'Menyimpan...';
            
            google.script.run.withSuccessHandler(function(res) {
                App.showAppModal('success', 'Berhasil', res);
                App.loadPage(null, 'lapbul_kelola');
            }).withFailureHandler(function(err) {
                btn.disabled = false; btn.innerHTML = old;
                App.showAppModal('error', 'Gagal', err.message);
            }).updateLapbulData(formData);
        };

        if(fileInput.files.length > 0) {
            var fr = new FileReader();
            fr.onload = function(x) {
                submitData({
                    data: x.target.result.split(',')[1],
                    mimeType: fileInput.files[0].type,
                    fileName: fileInput.files[0].name
                });
            };
            fr.readAsDataURL(fileInput.files[0]);
        } else {
            submitData(null);
        }
    };
};

// Helper: Generate Field Kelas SD untuk Edit (Mirip Form Input tapi Value Terisi)
App.generateSdEditClassFields = function(k, data, container) {
    var html = `<div class="section-divider"><span>Data Kelas ${k}</span></div>`;
    
    // Rombel Input
    // Karena form edit SD HTML-nya mungkin belum punya struktur rombel yang sama persis dgn input, 
    // kita inject manual input rombel yang sesuai dengan nama field di Spreadsheet (Backend mapping).
    // Misal: K1 L, K1 P, K1A L, dll.
    
    // Sederhananya, kita tampilkan input Rombel A, B, C (sesuai kebutuhan umum)
    // Atau jika data di spreadsheet flat (K1 L, K1 P), kita tampilkan itu saja.
    
    // Cek Data: Apakah ada data "K1A L"?
    var suffixes = ['', 'A', 'B', 'C']; // K1 L, K1A L...
    
    html += '<div class="input-grid-container">';
    
    suffixes.forEach(suf => {
        var keyL = `K${k}${suf} L`;
        var keyP = `K${k}${suf} P`;
        
        // Hanya render jika salah satu data ada isinya (tidak 0 atau kosong)
        // ATAU render default (tanpa suffix) selalu.
        var valL = data[keyL];
        var valP = data[keyP];
        
        if (suf === '' || (valL && valL != 0) || (valP && valP != 0)) {
            html += `
            <div class="input-box-card">
                <span class="box-title">Kelas ${k}${suf}</span>
                <div class="lp-wrapper">
                    <div class="lp-field"><label class="lp-label">L</label>
                        <input type="number" name="${keyL}" class="form-control-box" value="${valL||0}">
                    </div>
                    <div class="lp-field"><label class="lp-label">P</label>
                        <input type="number" name="${keyP}" class="form-control-box" value="${valP||0}">
                    </div>
                </div>
            </div>`;
        }
    });
    
    html += '</div>';
    
    // Agama Input
    html += `<div class="section-divider"><span>Agama (Kelas ${k})</span></div><div class="input-grid-container">`;
    var agamas = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
    agamas.forEach(agm => {
        var keyL = `K${k} ${agm} L`;
        var keyP = `K${k} ${agm} P`;
        var valL = data[keyL];
        var valP = data[keyP];
        
        html += `
        <div class="input-box-card">
            <span class="box-title">${agm}</span>
            <div class="lp-wrapper">
                <div class="lp-field"><label class="lp-label">L</label><input type="number" name="${keyL}" class="form-control-mini" value="${valL||0}"></div>
                <div class="lp-field"><label class="lp-label">P</label><input type="number" name="${keyP}" class="form-control-mini" value="${valP||0}"></div>
            </div>
        </div>`;
    });
    html += '</div>';

    container.innerHTML = html;
};

// ===========================================
// FIX FINAL: PREVIEW MODAL SELF-HEALING (AGRESIF)
// (Letakkan/Timpa di paling bawah javascript.html)
// ===========================================

App.ensureModalExists = function() {
    var modal = document.getElementById('previewModal');
    
    // CEK KESEHATAN MODAL:
    // Jika modal ada, TAPI tidak punya elemen kunci '#previewBody',
    // berarti itu modal versi lama/rusak. Kita HAPUS saja biar dibuat ulang.
    if (modal && !modal.querySelector('#previewBody')) {
        console.warn('Modal Preview usang ditemukan. Menghapus dan membuat ulang...');
        modal.remove();
        modal = null; // Reset var
    }

    // JIKA MODAL TIDAK ADA (ATAU BARU DIHAPUS), BUAT BARU
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'previewModal';
        modal.className = 'modal-overlay'; 
        // Style inline super komplit agar tidak tergantung CSS luar
        modal.style.cssText = "display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10005; justify-content:center; align-items:center; backdrop-filter:blur(5px);";
        
        modal.innerHTML = `
        <div class="modal-content" style="width:90%; max-width:1000px; height:90vh; display:flex; flex-direction:column; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
            <div style="padding:15px 20px; display:flex; justify-content:space-between; align-items:center; background:#1e293b; color:#fff; border-bottom:1px solid #334155; flex-shrink:0;">
                <h3 style="margin:0; font-size:1.1em; color:#fff; font-weight:600; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:60%;">Pratinjau Dokumen</h3>
                <div id="previewHeaderActions" style="display:flex; align-items:center; gap:10px;">
                    </div>
            </div>
            <div id="previewBody" style="flex:1; position:relative; background:#eee; width:100%; height:100%;"></div>
        </div>`;
        document.body.appendChild(modal);
    }
    return modal;
};

App.showFilePreview = function(url, title) {
    // 1. Pastikan Modal Siap (Reset jika rusak)
    var modal = App.ensureModalExists();
    
    // 2. Setup Judul
    var h3 = modal.querySelector('h3');
    if(h3) h3.textContent = title || 'Pratinjau Dokumen';

    // 3. Setup Tombol (Header Actions)
    var headerActions = modal.querySelector('#previewHeaderActions');
    if (headerActions) {
        headerActions.innerHTML = ''; // Reset isi lama

        // A. Tombol Download
        var fileId = "";
        var match = url.match(/[-\w]{25,}/);
        if (match) fileId = match[0];
        var downloadUrl = fileId ? "https://drive.google.com/uc?export=download&id=" + fileId : url;

        var btnDl = document.createElement('a');
        btnDl.href = downloadUrl;
        btnDl.target = '_blank';
        // Style inline agar cantik
        btnDl.style.cssText = "background:#10b981; color:#fff; text-decoration:none; padding:6px 12px; border-radius:4px; font-size:0.9em; font-weight:600; display:inline-flex; align-items:center; gap:6px; transition:0.2s;";
        btnDl.innerHTML = '<i class="fas fa-download"></i> Unduh';
        btnDl.onmouseover = function() { this.style.background = '#059669'; };
        btnDl.onmouseout  = function() { this.style.background = '#10b981'; };
        headerActions.appendChild(btnDl);

        // B. Tombol Close (X)
        var btnClose = document.createElement('button');
        btnClose.innerHTML = '&times;';
        btnClose.style.cssText = "background:none; border:none; color:#cbd5e1; font-size:2.2em; cursor:pointer; line-height:0.8; padding:0 5px; margin-left:10px;";
        btnClose.onclick = function() { App.closePreview(); }; 
        btnClose.onmouseover = function() { this.style.color = '#ef4444'; };
        btnClose.onmouseout  = function() { this.style.color = '#cbd5e1'; };
        headerActions.appendChild(btnClose);
    }

    // 4. Setup Iframe (Body)
    var body = modal.querySelector('#previewBody');
    if (body) {
        body.innerHTML = ''; // Bersihkan iframe lama
        
        var previewUrl = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : url;
        
        var iframe = document.createElement('iframe');
        iframe.src = previewUrl;
        iframe.style.cssText = "width:100%; height:100%; border:none; display:block;";
        // Tambahkan atribut allow agar lebih permissive
        iframe.setAttribute('allow', 'autoplay');
        
        body.appendChild(iframe);
    }

    // 5. Tampilkan
    modal.style.display = 'flex';
};

App.closePreview = function() {
    var modal = document.getElementById('previewModal');
    if (modal) {
        modal.style.display = 'none';
        var body = modal.querySelector('#previewBody');
        if(body) body.innerHTML = ''; // Hapus iframe
    }
};

// --- HELPER POPULATE FORM ---
// Fungsi sakti untuk mengisi segala jenis input berdasarkan JSON
App.populateForm = function(formId, data) {
    var form = document.getElementById(formId);
    if (!form) return;

    // Loop semua elemen input/select/textarea di form
    var elements = form.querySelectorAll('input, select, textarea');
    elements.forEach(function(el) {
        var name = el.name;
        // Jika input punya nama & datanya ada di object 'data'
        if (name && data.hasOwnProperty(name)) {
            if (el.type === 'radio') {
                if (el.value == data[name]) el.checked = true;
            } else if (el.type === 'checkbox') {
                // Logika checkbox bisa variatif, ini default simpel
                el.checked = (String(data[name]).toLowerCase() === 'true' || el.value == data[name]);
            } else {
                el.value = data[name];
            }
        }
    });
};


// --- INIT PAGE EDIT PAUD (FIX USER EDIT, SPINNER & TAB 4) ---
App.inits['lapbul_edit_paud'] = function(params) {
    if (!params || !params.rowIndex) return App.loadPage(null, 'lapbul_kelola'); 

    var formId = 'lapbulEditFormPaud';
    var form = document.getElementById(formId);
    
    // [FIX 1] Hapus App.showAppModal('loading'...) di sini. 
    // HTML #loading-data sudah cukup.

    google.script.run.withSuccessHandler(function(data) {
        
        // [FIX 1] Transisi Halus (Spinner Hilang)
        var loadingDiv = document.getElementById('loading-data');
        var formContainer = document.getElementById('form-edit-container');
        
        if(loadingDiv) loadingDiv.style.display = 'none';
        if(formContainer) {
            formContainer.style.display = 'block'; 
            formContainer.style.opacity = '0';
            setTimeout(() => formContainer.style.opacity = '1', 100);
        }

        // --- POPULATE FORM ---
        App.populateForm(formId, data);
        
        // Setup Hidden Fields
        if(!form.querySelector('input[name="rowIndex"]')) {
             var ri = document.createElement('input'); ri.type='hidden'; ri.name='rowIndex'; form.appendChild(ri);
             var si = document.createElement('input'); si.type='hidden'; si.name='source'; form.appendChild(si);
        }
        form.querySelector('input[name="rowIndex"]').value = params.rowIndex;
        form.querySelector('input[name="source"]').value = 'PAUD';
        
        // --- [FIX 2] USER EDIT (INJECT NAMA USER) ---
        if(App.currentUser) {
             // Ambil Nama
             var editorName = App.currentUser.nama || App.currentUser.username || 'User';
             
             // Masukkan ke input User Edit
             var uInput = form.querySelector('input[name="User Edit"]');
             if(!uInput) { 
                 uInput = document.createElement('input'); 
                 uInput.type='hidden'; 
                 uInput.name='User Edit'; 
                 form.appendChild(uInput); 
             }
             uInput.value = editorName;
        }

        // --- SETUP FILE LINK (UNTUK TAB 4 BARU) ---
        var fileBox = document.getElementById('existingFileLink');
        if (fileBox) {
            if (data['Dokumen'] && data['Dokumen'].includes('http')) {
                 fileBox.innerHTML = `
                 <i class="fas fa-file-pdf" style="color:#ef4444; font-size:2em;"></i>
                 <div style="flex-grow:1;">
                    <span style="display:block; font-weight:600; color:#334155;">Dokumen Tersimpan</span>
                    <span style="font-size:0.85em; color:#94a3b8;">Klik tombol lihat untuk preview</span>
                 </div>
                 <button type="button" class="btn-download" style="padding:8px 20px; font-weight:bold; background:#3b82f6; color:white;" 
                        onclick="App.showFilePreview('${data['Dokumen']}', 'Dokumen Laporan')">
                        <i class="fas fa-eye"></i> LIHAT
                 </button>`;
            } else {
                 fileBox.innerHTML = '<div style="color:#94a3b8; font-style:italic;">Belum ada dokumen yang diunggah.</div>';
            }
        }

        // Init Tab & Validasi
        App.setupFormTabs(form);
        if(App.setupPaudValidation) App.setupPaudValidation(form);

    }).withFailureHandler(function(e) {
        App.showAppModal('error', 'Gagal', e.message);
    }).getLapbulDataByRow(params.rowIndex, 'PAUD');

    // 3. Handle Submit
    if(form) {
        form.onsubmit = function(e) {
            e.preventDefault();
            
            // Validasi File Baru (ID input harus sesuai HTML: fileLapbulPaudEdit)
            var fileInput = document.getElementById('fileLapbulPaudEdit');
            if (fileInput && fileInput.files.length > 0) {
                if (fileInput.files[0].size > 307200) return App.showAppModal('error', 'File Terlalu Besar', 'Maksimal 300 KB.');
                if (fileInput.files[0].type !== 'application/pdf') return App.showAppModal('error', 'Format Salah', 'Wajib PDF.');
            }

            // Gunakan global helper submit
            App.handleEditSubmit(this); 
        };
    }
};

// --- 2. FUNGSI VALIDASI (WAJIB ADA) ---
App.setupPaudValidation = function(form) {
    if(!form) return;

    // A. SETUP VARIABEL
    var inputsUmur = form.querySelectorAll('.val-umur');
    var inputsKel  = form.querySelectorAll('.val-kel');
    
    var elTotalUmur = document.getElementById('total-umur');
    var elTotalKel  = document.getElementById('total-kel');
    var elStatus    = document.getElementById('val-status-badge');
    var elBox       = document.getElementById('validation-box-paud');
    var elMsg       = document.getElementById('val-msg-box');

    // B. LOGIKA HITUNG MURID
    var validateMurid = function() {
        if(!elTotalUmur) return; 

        var sumUmur = 0;
        inputsUmur.forEach(el => sumUmur += (parseInt(el.value) || 0));

        var sumKel = 0;
        inputsKel.forEach(el => sumKel += (parseInt(el.value) || 0));

        // Update Angka di Layar
        elTotalUmur.textContent = sumUmur;
        elTotalKel.textContent  = sumKel;

        // Cek Kesamaan
        if (sumUmur === sumKel && sumUmur > 0) {
            // Valid (Hijau)
            elBox.style.borderColor = '#10b981';
            elStatus.style.background = '#10b981';
            elStatus.innerHTML = '<i class="fas fa-check"></i> DATA VALID';
            if(elMsg) elMsg.style.display = 'none';
        } else {
            if (sumUmur === 0 && sumKel === 0) {
                // Masih Kosong
                elBox.style.borderColor = '#cbd5e1';
                elStatus.style.background = '#94a3b8';
                elStatus.textContent = 'Belum Diisi';
            } else {
                // Error (Merah)
                elBox.style.borderColor = '#ef4444';
                elStatus.style.background = '#ef4444';
                elStatus.innerHTML = '<i class="fas fa-times"></i> TIDAK SAMA';
                if(elMsg) elMsg.style.display = 'block';
            }
        }
    };

    // C. LOGIKA HITUNG PTK (KS & Guru)
    var inputsKS = form.querySelectorAll('.val-ks');
    var ptkAlert = document.getElementById('ptk-alert-box');

    var validatePtk = function() {
        if(!ptkAlert) return;

        var sumKS = 0;
        inputsKS.forEach(el => sumKS += (parseInt(el.value) || 0));

        if (sumKS > 1) {
            ptkAlert.style.display = 'block';
            ptkAlert.style.background = '#fee2e2';
            ptkAlert.style.color = '#b91c1c';
            ptkAlert.style.border = '1px solid #fecaca';
            ptkAlert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Jumlah Kepala Sekolah maksimal 1.';
        } else {
            ptkAlert.style.display = 'none';
        }
    };

    // D. PASANG LISTENER (Agar hitung real-time saat diketik)
    var allInputs = form.querySelectorAll('input[type="number"]');
    allInputs.forEach(inp => {
        inp.addEventListener('input', function() {
            validateMurid();
            validatePtk();
        });
        inp.addEventListener('keyup', function() {
            validateMurid();
            validatePtk();
        });
    });

    // E. JALANKAN SEKALI SAAT LOAD
    validateMurid();
    validatePtk();
};


// --- INIT HALAMAN EDIT SD (UPDATE) ---
App.inits['lapbul_edit_sd'] = function(params) {
    if (!params || !params.rowIndex) return App.loadPage(null, 'lapbul_kelola');

    var formId = 'lapbulEditFormSd';
    var form = document.getElementById(formId);
    
    App.showAppModal('loading', 'Mengambil data SD...');

    google.script.run.withSuccessHandler(function(data) {
        document.getElementById('appModal').style.display = 'none';

        // 1. Tampilkan Form
        var loadingDiv = document.getElementById('loading-data');
        var formContainer = document.getElementById('form-edit-container');
        if(loadingDiv) loadingDiv.style.display = 'none';
        if(formContainer) {
            formContainer.style.display = 'block'; 
            formContainer.style.opacity = '0';
            setTimeout(() => formContainer.style.opacity = '1', 100);
        }

        // 2. Setup Struktur Kelas Dinamis
        App.setupSdEditLogic(form, data);

        // 3. Isi Form Dasar
        App.populateForm(formId, data);
        
        // 4. Setup Hidden Fields
        if(!form.querySelector('input[name="rowIndex"]')) {
             var ri = document.createElement('input'); ri.type='hidden'; ri.name='rowIndex'; form.appendChild(ri);
             var si = document.createElement('input'); si.type='hidden'; si.name='source'; form.appendChild(si);
        }
        form.querySelector('input[name="rowIndex"]').value = params.rowIndex;
        form.querySelector('input[name="source"]').value = 'SD';
        
        // --- [PERBAIKAN] PISAHKAN USER EDIT & AMBIL NAMA ASLI ---
        if(App.currentUser) {
             // 1. Ambil Nama Lengkap (Prioritas: nama -> username -> 'User')
             var editorName = App.currentUser.nama || App.currentUser.username || 'User';

             // 2. Masukkan ke input dengan name="User Edit" (Sesuai Header Baru di Excel)
             // Dengan begini, kolom "User" (Pengunggah) tidak akan tertimpa.
             var uInput = form.querySelector('input[name="User Edit"]');
             if(!uInput) { 
                 uInput = document.createElement('input'); 
                 uInput.type='hidden'; 
                 uInput.name='User Edit'; // Target Kolom Baru
                 form.appendChild(uInput); 
             }
             uInput.value = editorName; 
        }

        // 5. Setup Tampilan File Lama (TAB 4)
        var fileBox = document.getElementById('existingFileLink');
        if (fileBox) {
            if (data['Dokumen'] && data['Dokumen'].includes('http')) {
                 fileBox.innerHTML = `
                 <i class="fas fa-file-pdf" style="color:#ef4444; font-size:2em;"></i>
                 <div style="flex-grow:1;">
                    <span style="display:block; font-weight:600; color:#334155;">Dokumen Tersimpan</span>
                    <span style="font-size:0.85em; color:#94a3b8;">Klik tombol lihat untuk preview</span>
                 </div>
                 <button type="button" class="btn-download" style="padding:8px 20px; font-weight:bold; background:#3b82f6; color:white;" 
                        onclick="App.showFilePreview('${data['Dokumen']}', 'Dokumen Laporan')">
                        <i class="fas fa-eye"></i> LIHAT
                 </button>`;
            } else {
                 fileBox.innerHTML = '<div style="color:#94a3b8; font-style:italic;">Belum ada dokumen yang diunggah.</div>';
            }
        }

        // 6. Init Tab & Validasi
        App.setupFormTabs(form);
        App.setupSdValidation(form);

    }).withFailureHandler(function(e) {
        App.showAppModal('error', 'Gagal', e.message);
    }).getLapbulDataByRow(params.rowIndex, 'SD');

    // Handle Submit
    if(form) {
        form.onsubmit = function(e) {
            e.preventDefault();
            
            // Cek jika ada file baru
            var fileInput = document.getElementById('fileLapbulSdEdit');
            if (fileInput && fileInput.files.length > 0) {
                if (fileInput.files[0].size > 307200) return App.showAppModal('error', 'File Terlalu Besar', 'Maksimal 300 KB.');
                if (fileInput.files[0].type !== 'application/pdf') return App.showAppModal('error', 'Format Salah', 'Wajib PDF.');
            }

            App.handleEditSubmit(this); 
        };
    }
};

// --- HELPER: SUBMIT EDIT GENERIC (VERSI FINAL) ---
App.handleEditSubmit = function(formElement) {
    // 1. Ambil Elemen Kunci
    var fileInput = formElement.querySelector('input[type="file"]');
    var btn = formElement.querySelector('button[type="submit"]');
    var oldHtml = btn.innerHTML;
    
    // 2. Kumpulkan Data Form
    var formData = {};
    var inputs = formElement.querySelectorAll('input, select, textarea');
    inputs.forEach(el => {
        if(el.name) formData[el.name] = el.value;
    });

    // 3. Definisi Fungsi Kirim
    var sendData = function(filePayload) {
        if (filePayload) formData.fileData = filePayload;
        
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        
        google.script.run.withSuccessHandler(function(res) {
            btn.disabled = false; btn.innerHTML = oldHtml;
            
            // PERUBAHAN PENTING DI SINI:
            // Parameter ke-3 adalah halaman tujuan setelah klik OK ('lapbul_kelola')
            App.showAppModal('success', res, 'lapbul_kelola'); 
            
        }).withFailureHandler(function(err) {
            btn.disabled = false; btn.innerHTML = oldHtml;
            App.showAppModal('error', 'Gagal Menyimpan', err.message);
        }).updateLapbulData(formData);
    };

    // 4. Cek & Proses File Upload
    if (fileInput && fileInput.files.length > 0) {
        var file = fileInput.files[0];
        
        // Validasi Ukuran (300KB)
        if (file.size > 307200) { 
            return App.showAppModal('error', 'File Terlalu Besar', 'Maksimal 300 KB.');
        }
        // Validasi Tipe (PDF Only)
        if (file.type !== 'application/pdf') {
            return App.showAppModal('error', 'Format Salah', 'Wajib format PDF.');
        }

        var reader = new FileReader();
        reader.onload = function(e) {
            sendData({
                data: e.target.result.split(',')[1],
                mimeType: file.type,
                fileName: file.name
            });
        };
        reader.readAsDataURL(file);
    } else {
        // Tidak ada file baru, kirim data teks saja
        sendData(null); 
    }
};

// --- HELPER LOGIKA EDIT SD (GENERATE CLASS & DETECT ROMBEL) ---
App.setupSdEditLogic = function(form, data) {
    var tabContainer = document.getElementById('edit-subTabContainer');
    var contentContainer = document.getElementById('edit-kelasContentArea');
    var agamas = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];

    if (!tabContainer || !contentContainer) return;

    tabContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    // Fungsi Pembantu Bikin Kotak Input
    var createRombelBox = function(k, suffix, label) {
        var keyL = `K${k}${suffix} L`;
        var keyP = `K${k}${suffix} P`;
        var valL = data[keyL] || 0;
        var valP = data[keyP] || 0;
        
        return `<div class="input-box-card">
                    <span class="box-title">${label}</span>
                    <div class="lp-wrapper">
                        <div class="lp-field"><label>L</label><input type="number" name="${keyL}" class="form-control-mini val-rombel" style="text-align:center;" value="${valL}"></div>
                        <div class="lp-field"><label>P</label><input type="number" name="${keyP}" class="form-control-mini val-rombel" style="text-align:center;" value="${valP}"></div>
                    </div>
                </div>`;
    };

    // LOOP KELAS 1-6
    for (var k = 1; k <= 6; k++) {
        // 1. Tombol Tab
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = (k === 1) ? 'sub-tab-btn active' : 'sub-tab-btn';
        btn.textContent = 'Kelas ' + k;
        // Logic Klik Tab
        btn.onclick = (function(idx) { 
            return function() { 
                form.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
                form.querySelectorAll('.kelas-content').forEach(c => c.style.display = 'none');
                this.classList.add('active');
                document.getElementById('edit_kelas_' + idx).style.display = 'block';
            }; 
        })(k);
        tabContainer.appendChild(btn);

        // 2. Konten Kelas
        var div = document.createElement('div');
        div.id = 'edit_kelas_' + k;
        div.className = 'kelas-content';
        div.style.display = (k === 1) ? 'block' : 'none';

        // 3. Deteksi Jumlah Rombel dari Data
        // Cek apakah ada data di Rombel C? Jika ya, mode 3. Jika B? Mode 2. Default 1.
        var rombelCount = "1";
        if (data[`K${k}C L`] > 0 || data[`K${k}C P`] > 0) rombelCount = "3";
        else if (data[`K${k}B L`] > 0 || data[`K${k}B P`] > 0) rombelCount = "2";
        
        // Generate Input Rombel
        var rombelInputs = '';
        if (rombelCount === "3") {
            rombelInputs += createRombelBox(k, 'A', `Kelas ${k}A`) + createRombelBox(k, 'B', `Kelas ${k}B`) + createRombelBox(k, 'C', `Kelas ${k}C`);
        } else if (rombelCount === "2") {
            rombelInputs += createRombelBox(k, 'A', `Kelas ${k}A`) + createRombelBox(k, 'B', `Kelas ${k}B`);
        } else {
            rombelInputs += createRombelBox(k, '', `Kelas ${k}`);
        }

        // Generate Input Agama (Hanya tampilkan jika > 0 atau Islam default)
        var agamaInputs = '';
        agamas.forEach(agm => {
            var keyL = `K${k} ${agm} L`;
            var keyP = `K${k} ${agm} P`;
            var valL = data[keyL] || 0;
            var valP = data[keyP] || 0;
            var isAda = (valL > 0 || valP > 0 || agm === 'Islam'); // Default tampil jika ada data
            
            // Kita render semua tapi hide yang tidak ada isinya (kecuali Islam)
            // Agar sederhana di Edit, kita tampilkan semua saja tapi "Ada/Tidak" logic bisa ditambahkan nanti
            // Untuk sekarang, kita tampilkan kotak inputnya langsung
            
            agamaInputs += `
            <div class="input-box-card">
                <span class="box-title">${agm}</span>
                <div class="lp-wrapper">
                    <div class="lp-field"><label>L</label><input type="number" name="${keyL}" class="form-control-mini val-agama" style="text-align:center;" value="${valL}"></div>
                    <div class="lp-field"><label>P</label><input type="number" name="${keyP}" class="form-control-mini val-agama" style="text-align:center;" value="${valP}"></div>
                </div>
            </div>`;
        });

        // Rakit HTML
        div.innerHTML = `
            <div class="section-divider"><span>Data Kelas ${k} - Menurut Rombel</span></div>
            <div class="rombel-control-box">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Jumlah Rombel Terdeteksi: <b>${rombelCount}</b></label>
                    </div>
                <div class="rombel-inputs-grid">${rombelInputs}</div>
            </div>

            <div class="section-divider"><span>Data Kelas ${k} - Menurut Agama</span></div>
            <div class="input-grid-container">${agamaInputs}</div>

            <div class="validation-footer" style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:10px;">
                <div id="edit_val_rombel_${k}">Rombel: 0</div>
                <div id="edit_val_agama_${k}">Agama: 0</div>
                <span id="edit_status_${k}" class="val-status-text">Checking...</span>
            </div>
        `;
        contentContainer.appendChild(div);
    }
};

// --- VALIDASI SD (SAMA PERSIS DENGAN PAUD LOGIKANYA) ---
App.setupSdValidation = function(form) {
    if(!form) return;

    // 1. Validasi Kelas (Loop 1-6)
    var validateKelas = function() {
        for (var k = 1; k <= 6; k++) {
            var div = document.getElementById('edit_kelas_' + k);
            if (!div) continue;

            var sumRombel = 0;
            div.querySelectorAll('.val-rombel').forEach(el => sumRombel += (parseInt(el.value)||0));
            
            var sumAgama = 0;
            div.querySelectorAll('.val-agama').forEach(el => sumAgama += (parseInt(el.value)||0));

            document.getElementById(`edit_val_rombel_${k}`).textContent = `Total Rombel: ${sumRombel}`;
            document.getElementById(`edit_val_agama_${k}`).textContent = `Total Agama: ${sumAgama}`;
            
            var st = document.getElementById(`edit_status_${k}`);
            if(sumRombel === sumAgama && sumRombel > 0) {
                st.textContent = "VALID"; st.style.color = "green"; st.style.fontWeight="bold";
            } else if (sumRombel === 0 && sumAgama === 0) {
                st.textContent = "Kosong"; st.style.color = "#94a3b8";
            } else {
                st.textContent = "TIDAK SAMA"; st.style.color = "red"; st.style.fontWeight="bold";
            }
        }
    };

    // 2. Validasi PTK
    var validatePtk = function() {
        var ptkAlert = document.getElementById('ptk-alert-box');
        if(!ptkAlert) return;

        var sumKS = 0;
        form.querySelectorAll('.val-ks').forEach(el => sumKS += (parseInt(el.value)||0));
        
        var sumGuru = 0;
        form.querySelectorAll('.val-guru').forEach(el => sumGuru += (parseInt(el.value)||0));

        var msg = "";
        if(sumKS > 1) msg += "<div><i class='fas fa-exclamation-triangle'></i> Maksimal 1 Kepala Sekolah.</div>";
        if(sumGuru === 0) msg += "<div><i class='fas fa-info-circle'></i> Data Guru masih kosong.</div>";

        if(msg) {
            ptkAlert.style.display = 'block';
            ptkAlert.innerHTML = msg;
        } else {
            ptkAlert.style.display = 'none';
        }
    };

    // Listener
    form.addEventListener('input', function(e) {
        if(e.target.type === 'number') {
            validateKelas();
            validatePtk();
        }
    });

    // Run Once
    validateKelas();
    validatePtk();
};

// --- HELPER: TAB FORM SETUP ---
App.setupFormTabs = function(form) {
    // Logika Tab Utama (1, 2, 3, 4)
    var tabs = form.querySelectorAll('.tab-link');
    var panels = form.querySelectorAll('.tab-content-form');
    
    tabs.forEach(btn => {
        btn.onclick = function() {
            // Hapus aktif lama
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => { 
                p.classList.remove('active'); 
                p.style.display = 'none'; // Paksa hide
            });
            
            // Set aktif baru
            this.classList.add('active');
            var targetId = this.dataset.tab;
            var target = document.getElementById(targetId);
            if(target) {
                target.classList.add('active');
                target.style.display = 'block'; // Paksa show
            }
        };
    });

    // Tombol Next/Prev
    form.querySelectorAll('.next-tab-btn, .prev-tab-btn').forEach(btn => {
        btn.onclick = function() {
            var targetTabId = '';
            // Jika tombol punya data-target langsung (misal: data-target="dataMurid")
            if (this.dataset.target) {
                targetTabId = this.dataset.target;
            } else {
                // Logika otomatis (Cari tab berikutnya/sebelumnya)
                // ... (Opsional: lebih aman pakai data-target di HTML)
            }
            
            // Trigger klik pada tab header
            var tabBtn = form.querySelector(`.tab-link[data-tab="${targetTabId}"]`);
            if(tabBtn) tabBtn.click();
        };
    });
};

// --- INIT HALAMAN UNDUH FORMAT ---
App.inits['lapbul_unduh_format'] = function() {
    var btn = document.getElementById('infoDropdownBtn');
    var content = document.getElementById('infoDropdownContent');
    var chevron = document.getElementById('chevronIcon');
    
    // 1. Logic Dropdown Toggle
    if (btn && content) {
        btn.onclick = function() {
            var isClosed = content.style.display === 'none';
            content.style.display = isClosed ? 'block' : 'none';
            if (chevron) chevron.style.transform = isClosed ? 'rotate(180deg)' : 'rotate(0deg)';
            
            // Load data hanya jika dibuka pertama kali dan masih kosong/loading
            if (isClosed && content.querySelector('.loading-container')) {
                loadInfo();
            }
        };
    }

    // 2. Fungsi Load Data dari Backend
    function loadInfo() {
        google.script.run.withSuccessHandler(function(data) {
            if (!data || data.length === 0) {
                content.innerHTML = '<p style="text-align:center; color:#cbd5e1;">Tidak ada informasi tambahan.</p>';
                return;
            }

            // Render List Informasi
            var html = '<ul style="padding-left:20px; margin:0;">';
            data.forEach(function(item) {
                html += '<li style="margin-bottom:8px;">' + item + '</li>';
            });
            html += '</ul>';
            content.innerHTML = html;

        }).withFailureHandler(function(e) {
            content.innerHTML = '<p style="color:red; text-align:center;">Gagal memuat info: ' + e.message + '</p>';
        }).getUnduhFormatInfo(); // Memanggil fungsi di Lapbul.gs
    }
};

App.inits['lapbul_trash'] = function() {
    
    // CEK ADMIN (Tambahan keamanan)
    var session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!(session.role || '').toLowerCase().includes('admin')) {
        document.getElementById('main-content').innerHTML = '<div style="padding:50px;text-align:center;">Akses Ditolak</div>';
        return;
    }

    App.initSmartTable({
        tableId: 'trashTable', 
        serverFunc: 'getLapbulTrashData', // Pastikan fungsi backend ini sudah ada (dari step sebelumnya)
        
        // URUTAN KOLOM TRASH
        // SmartTable otomatis mendeteksi kolom "Dokumen" untuk jadi tombol, 
        // dan kolom pertama (Nama Sekolah) biasanya otomatis Bold oleh CSS .std-table
        headers: [
            "Nama Sekolah", 
            "Jenjang", 
            "Bulan", 
            "Tahun", 
            "Dokumen",       // SmartTable akan otomatis render tombol View/Download
            "Deleted By",    // Info Pen-delete
            "Deleted At"     // Waktu Hapus
        ],
        
        // MAPPING FILTER KE ID BARU
        filters: [
            {id:'filterTrashTahun',   col:'Tahun',    label:'-- Pilih Tahun --', desc:true},
            {id:'filterTrashBulan',   col:'Bulan',    label:'-- Pilih Bulan --'},
            {id:'filterTrashJenjang', col:'Jenjang',  label:'-- Pilih Jenjang --'},
            {id:'filterTrashSekolah', col:'Nama Sekolah', label:'-- Pilih Sekolah --'}
        ],
        
        // LOGIKA DROPDOWN BERANTAI (SAMA PERSIS DENGAN RIWAYAT)
        onFilterChange: function(filterId, value, filteredRows, allRows) {
            if(filterId === 'filterTrashJenjang') {
                var elSekolah = document.getElementById('filterTrashSekolah');
                if(!elSekolah) return;
                elSekolah.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
                
                // Ambil sekolah sesuai jenjang yang dipilih
                var relevantRows = value ? allRows.filter(r => r.Jenjang === value) : allRows;
                var schools = [];
                relevantRows.forEach(r => { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                
                // Urutkan dan Hapus Duplikat
                var uniqueSchools = schools.filter((v, i, a) => a.indexOf(v) === i).sort();
                uniqueSchools.forEach(s => elSekolah.add(new Option(s, s)));
            }
        },
        
        onLoad: function(allRows) {
             // Populate awal sekolah
             var elSekolah = document.getElementById('filterTrashSekolah');
             if(elSekolah && elSekolah.options.length <= 1) {
                 var schools = [];
                 allRows.forEach(r => { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                 var uniqueSchools = schools.filter((v, i, a) => a.indexOf(v) === i).sort();
                 uniqueSchools.forEach(s => elSekolah.add(new Option(s, s)));
             }
        }
    });
};

// --- DASHBOARD LAPORAN BULAN (FIX GRAFIK & RECENT) ---
App.inits['lapbul_menu'] = function() {
    
    // 1. SET LOADING STATE
    ['lbTotal', 'lbToday', 'lbSD', 'lbPAUD'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size:0.6em"></i>';
    });
    var elList = document.getElementById('lbListRecent');
    if(elList) elList.innerHTML = '<div style="text-align:center; padding:10px;">Memuat...</div>';

    // 2. REQUEST DATA
    google.script.run.withSuccessHandler(function(stats) {
        if (!stats || stats.error) {
            var errMsg = stats ? stats.error : "Data null";
            console.error(errMsg);
            if(elList) elList.innerHTML = '<div style="color:red; padding:10px;">Error: ' + errMsg + '</div>';
            return;
        }

        // A. ISI KARTU
        var animate = function(id, val) {
            var el = document.getElementById(id);
            if(el) el.textContent = val || 0;
        };
        animate('lbTotal', stats.total);
        animate('lbToday', stats.today);
        animate('lbSD', stats.countSD);
        animate('lbPAUD', stats.countPAUD);

        // B. RENDER CHART
        if(typeof Chart !== 'undefined') {
            
            // 1. CHART TREN (DOUBLE DATASET: SD & PAUD)
            var ctxTrend = document.getElementById('lbChartTrend');
            if (ctxTrend) {
                if (ctxTrend.chartInstance) ctxTrend.chartInstance.destroy();
                
                ctxTrend.chartInstance = new Chart(ctxTrend.getContext('2d'), {
                    type: 'bar', // Gunakan Bar Chart untuk perbandingan yang jelas
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'],
                        datasets: [
                            {
                                label: 'SD',
                                data: stats.trendSD, // Data Backend
                                backgroundColor: '#3b82f6', // Biru
                                borderRadius: 4
                            },
                            {
                                label: 'PAUD',
                                data: stats.trendPAUD, // Data Backend
                                backgroundColor: '#8b5cf6', // Ungu
                                borderRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true, position: 'top' }, // Tampilkan Legend
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: { 
                            y: { beginAtZero: true, ticks: { precision: 0 } }, 
                            x: { grid: { display: false } } 
                        }
                    }
                });
            }

            // 2. CHART KOMPOSISI (SD vs PAUD)
            var ctxJenjang = document.getElementById('lbChartJenjang');
            if (ctxJenjang) {
                if (ctxJenjang.chartInstance) ctxJenjang.chartInstance.destroy();

                ctxJenjang.chartInstance = new Chart(ctxJenjang.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['SD', 'PAUD'],
                        datasets: [{
                            data: [stats.countSD, stats.countPAUD],
                            backgroundColor: ['#3b82f6', '#8b5cf6'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: { 
                            legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
                        }
                    }
                });
            }
        }

        // C. RECENT ACTIVITY (Sekarang sudah menampilkan Nama Sekolah)
        var listHtml = '';
        if(!stats.recent || stats.recent.length === 0) listHtml = '<div style="padding:10px; color:#ccc;">Belum ada aktivitas</div>';
        else {
            stats.recent.forEach(function(r) {
                var color = r.jenjang === 'SD' ? '#3b82f6' : '#8b5cf6'; 
                listHtml += '<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f1f5f9;">' +
                            '<div><div style="font-weight:600; font-size:0.85em; color:#334155;">'+r.sekolah+'</div>' +
                            '<div style="font-size:0.75em; color:#94a3b8;">'+r.waktu+'</div></div>' +
                            '<div style="font-size:0.75em; font-weight:bold; color:'+color+';">'+r.jenjang+'</div>' +
                            '</div>';
            });
        }
        if(elList) elList.innerHTML = listHtml;

    }).getLapbulDashboardStats();
};

// --- INIT HALAMAN LANDING (DENGAN LOGIC DROPDOWN) ---
App.inits['lapbul_landing'] = function() {
    var btn = document.getElementById('btnTogglePetunjuk');
    var content = document.getElementById('contentPetunjuk');
    var icon = document.getElementById('iconChevron');

    if(btn && content && icon) {
        btn.onclick = function() {
            // Cek kondisi saat ini (Hidden atau Block)
            var isClosed = content.style.display === 'none';
            
            // Toggle Display
            content.style.display = isClosed ? 'block' : 'none';
            
            // Putar Icon Panah
            icon.style.transform = isClosed ? 'rotate(180deg)' : 'rotate(0deg)';
        };
    }
};

App.inits['ptk_keadaan_paud'] = function() {

    // 1. Helper Format Angka (0 jadi Kosong)
    var fmt = function(row, colName) {
        // Cari key object secara case-insensitive
        var key = Object.keys(row).find(k => k.toLowerCase() === colName.toLowerCase());
        var val = row[key] || 0;
        return (parseFloat(val) === 0) ? "" : val;
    };

    // 2. Helper Definisi Kolom
    var col = function(name) {
        return { 
            name: name, 
            formatter: function(r) { return fmt(r, name); }
        };
    };

    // 3. Daftar Header (Sesuai Data Spreadsheet)
    var headersList = [
        "Nama Lembaga", 
        "Jenjang", "Status", "Bulan", "Tahun", 
        col("Jumlah Rombel"), 
        col("KS PNS"), col("KS Non ASN"), 
        col("Guru PNS"), col("Guru PPPK"), 
        col("GTY"), col("GTT"), 
        col("Penjaga"), col("Tenaga Admin"), 
        col("Pustakawan"), col("Tendik Lain"), 
        col("Jumlah PTK")
    ];

    // 4. Inisialisasi Smart Table
    App.initSmartTable({
        tableId: 'keadaanPtkPaudTable',
        serverFunc: 'getPtkKeadaanPaudData',
        headers: headersList,
        autoHideZero: true, 
        addTotalRow: false, // Matikan bawaan, kita pakai custom di onRender

        // Daftarkan Filter & Search agar terhubung ke Logika
        filters: [
            { id: 'filterJenjang', col: 'Jenjang', label: 'Semua Jenjang' },
            { id: 'searchKeadaanPaud', col: 'Nama Lembaga' }
        ],

        // 5. FUNGSI RENDER FOOTER (Baris Jumlah)
        onRender: function(rows) {
            var table = document.getElementById('keadaanPtkPaudTable');
            if(!table) return;

            // Fungsi Hitung Ulang
            var updateFooter = function() {
                var tbody = table.querySelector('tbody');
                var tfoot = table.querySelector('tfoot');
                
                // Buat tfoot jika belum ada
                if(!tfoot) {
                    tfoot = document.createElement('tfoot');
                    table.appendChild(tfoot);
                }

                var totals = new Array(headersList.length).fill(0);
                var trs = Array.from(tbody.querySelectorAll('tr'));
                var hasVisible = false;

                // Hitung data yang terlihat (tidak di-hidden filter)
                trs.forEach(function(tr) {
                    if(tr.style.display !== 'none') {
                        hasVisible = true;
                        var tds = tr.querySelectorAll('td');
                        
                        headersList.forEach(function(h, i) {
                            // Mulai hitung dari kolom ke-6 (Index 5: Jml Rombel)
                            if(i >= 5) { 
                                // Ambil text sel (index i+1 karena ada kolom No)
                                var txt = tds[i+1] ? tds[i+1].innerText : "0";
                                var val = parseFloat(txt.replace(/[^\d.-]/g, '')) || 0;
                                totals[i] += val;
                            }
                        });
                    }
                });

                // Tulis ke HTML Footer
                tfoot.innerHTML = "";
                if(hasVisible) {
                    var tr = document.createElement('tr');
                    
                    // Kolom No (Kosong)
                    tr.appendChild(document.createElement('td'));

                    headersList.forEach(function(h, index) {
                        var td = document.createElement('td');
                        
                        if(index === 0) { // Nama Lembaga -> Label JUMLAH
                            td.textContent = "JUMLAH";
                            td.style.textAlign = "left";
                        } 
                        else if(index >= 1 && index < 5) { // Jenjang s.d Tahun -> Strip
                            td.textContent = "-";
                            td.style.textAlign = "center";
                        } 
                        else { 
                            td.textContent = totals[index]; // Angka Total
                            td.style.textAlign = "center";
                        }
                        tr.appendChild(td);
                    });
                    tfoot.appendChild(tr);
                }
            };

            // Jalankan Hitung Awal
            updateFooter();

            // Pasang Trigger saat Filter/Search berubah
            var filterEl = document.getElementById('filterJenjang');
            var searchEl = document.getElementById('searchKeadaanPaud');
            
            if(filterEl) {
                // Gunakan onchange agar tidak menimpa listener lain
                filterEl.addEventListener('change', function() { setTimeout(updateFooter, 250); });
            }
            if(searchEl) {
                searchEl.addEventListener('keyup', function() { setTimeout(updateFooter, 350); });
                searchEl.addEventListener('search', function() { setTimeout(updateFooter, 350); });
            }
        }
    });
};

// --- INIT HALAMAN JUMLAH PTK BULANAN PAUD ---
App.inits['ptk_jumlah_bulanan_paud'] = function() {

    var col = function(name, style) { return { name: name, tdStyle: style || '' }; };

    // Daftar Urutan Bulan yang Benar
    var listBulan = [
        "Januari", "Februari", "Maret", "April", "Mei", "Juni", 
        "Juli", "Agustus", "September", "Oktober", "November", "Desember"
    ];

    App.initSmartTable({
        tableId: 'ptkJumlahBulananPaudTable',
        serverFunc: 'getPtkJumlahBulananPaudData',
        
        headers: [
          "Nama Lembaga", "Jenjang", "Status", "Bulan", "Tahun", 
          "Jumlah Rombel", "KS PNS", "KS Non ASN", "Guru PNS", "Guru PPPK", 
          "GTY", "GTT", "Penjaga", "Tenaga Admin", "Pustakawan", "Tendik Lain", 
          col("Jumlah PTK", "background-color:#f8fafc; font-weight:bold;") 
        ],

        autoHideZero: true,
        addTotalRow: true,
        totalStartCol: 7,

        filters: [
            // Tahun Descending (2025, 2024...)
            { id: 'filterTahun', col: 'Tahun', label: '-- Tahun --', desc: true },
            // Bulan Custom Sort (Jan, Feb...)
            { id: 'filterBulan', col: 'Bulan', label: '-- Bulan --', sortOrder: listBulan },
            { id: 'filterJenjang', col: 'Jenjang', label: '-- Jenjang --' },
            { id: 'filterNamaLembaga', col: 'Nama Lembaga', label: '-- Nama Lembaga --' }
        ],

        // SET DEFAULT VALUE SAAT LOAD
        onLoad: function(rows) {
            var now = new Date();
            var curYear = now.getFullYear().toString();
            
            // Logika Bulan Lalu
            var prevMonthIndex = now.getMonth() - 1; 
            if (prevMonthIndex < 0) {
                prevMonthIndex = 11;
                curYear = (now.getFullYear() - 1).toString();
            }
            var prevMonthName = listBulan[prevMonthIndex];

            // Set Dropdown Tahun (Jika belum dipilih)
            var elTahun = document.getElementById('filterTahun');
            if (elTahun && elTahun.value === "") {
                // Cek apakah tahun tsb ada di opsi
                for(var i=0; i<elTahun.options.length; i++) {
                    if(elTahun.options[i].value == curYear) {
                        elTahun.value = curYear;
                        elTahun.dispatchEvent(new Event('change')); 
                        break;
                    }
                }
            }

            // Set Dropdown Bulan (Jika belum dipilih)
            var elBulan = document.getElementById('filterBulan');
            if (elBulan && elBulan.value === "") {
                for(var i=0; i<elBulan.options.length; i++) {
                    if(elBulan.options[i].value == prevMonthName) {
                        elBulan.value = prevMonthName;
                        elBulan.dispatchEvent(new Event('change')); 
                        break;
                    }
                }
            }
        },

        // LOGIKA FILTER BERANTAI
        onFilterChange: function(filterId, value, filteredRows, allRows) {
            if(filterId === 'filterJenjang') {
                var elNama = document.getElementById('filterNamaLembaga');
                if(!elNama) return;
                
                var currentVal = elNama.value;
                elNama.innerHTML = '<option value="">-- Nama Lembaga --</option>';
                
                // Ambil sekolah sesuai Jenjang yang dipilih
                var sourceData = value ? allRows.filter(r => r.Jenjang === value) : allRows;
                var names = [];
                sourceData.forEach(r => { if(r['Nama Lembaga']) names.push(r['Nama Lembaga']); });
                var uniqueNames = names.filter((v, i, a) => a.indexOf(v) === i).sort();
                
                uniqueNames.forEach(n => elNama.add(new Option(n, n)));
                if(uniqueNames.includes(currentVal)) elNama.value = currentVal;
            }
        }
    });
};

// --- INIT HALAMAN DAFTAR PTK PAUD ---
App.inits['ptk_daftar_paud'] = function() {
    
    // Helper Kolom (Nama, Style)
    var col = function(name, style) { return { name: name, tdStyle: style || '' }; };

    App.initSmartTable({
        tableId: 'daftarPtkPaudTable', 
        serverFunc: 'getPtkDaftarPaudData',

        headers: [
            "Nama Lengkap", 
            col("Nama Lembaga", "text-align:left;"),
            "Jenjang",
            "Status", 
            "NIP/NIY", 
            "Pangkat, Gol./Ruang", 
            "NUPTK", 
            "Jabatan", 
            "TMT", 
            "L/P", 
            "Tempat Lahir", 
            
            // Format Tanggal Lahir
            { 
                name: "Tanggal Lahir", 
                formatter: function(r) {
                    var v = r["Tanggal Lahir"];
                    if(String(v).includes("T")) return v.split("T")[0]; 
                    return v;
                }
            },
            
            "Pendidikan", 
            "Jurusan", 
            "Tahun Lulus", 
            "Serdik", 
            "Dapodik",

            {
                name: "Pensiun",
                formatter: function(r) {
                    var tglStr = r["Pensiun"];
                    if(!tglStr || tglStr === "") return "-";

                    // 1. Parse Tanggal Pensiun (dd-MM-yyyy)
                    var parts = tglStr.split('-');
                    var pDate = new Date(parts[2], parts[1]-1, parts[0]); // yyyy, mm-1, dd
                    var now = new Date();
                    
                    // Reset jam agar hitungan hari akurat
                    now.setHours(0,0,0,0);
                    
                    // 2. Hitung Selisih Hari
                    var diffTime = pDate - now;
                    var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    // 3. Tentukan Style Badge
                    var style = "padding: 2px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; display: inline-block; min-width: 80px; text-align: center;";
                    var label = tglStr; // Default tampilkan tanggal
                    
                    if (diffDays < 0) {
                        // SUDAH PENSIUN (Lewat Tanggal) -> Hitam/Dark
                        style += "background-color: #2d3436; color: #fff;";
                        label += " (Pensiun)";
                    } 
                    else if (diffDays <= 30) {
                        // < 1 BULAN -> Merah (Kritis)
                        style += "background-color: #e74c3c; color: #fff; box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);";
                        label += " (<1 Bln)";
                    }
                    else if (diffDays <= 90) {
                        // < 3 BULAN -> Oranye (Waspada)
                        style += "background-color: #e67e22; color: #fff;";
                    }
                    else if (diffDays <= 180) {
                        // < 6 BULAN -> Kuning (Perhatian)
                        style += "background-color: #f1c40f; color: #2c3e50;";
                    }
                    else if (diffDays <= 365) {
                        // < 1 TAHUN -> Biru (Info)
                        style += "background-color: #3498db; color: #fff;";
                    }
                    else {
                        // MASIH LAMA -> Putih/Biasa
                        return tglStr;
                    }

                    return `<span style="${style}">${label}</span>`;
                }
            }
        ],
        
        autoHideZero: true, 

        // ... Bagian Filters & onFilterChange TETAP SAMA seperti sebelumnya ...
        filters: [
            { id: 'filterJenjang', col: 'Jenjang', label: '-- Jenjang --' },
            { id: 'filterNamaLembaga', col: 'Nama Lembaga', label: '-- Nama Lembaga --' },
            { id: 'filterStatus', col: 'Status', label: '-- Status --' },
            { id: 'filterPendidikan', col: 'Pendidikan', label: '-- Pendidikan --' },
            { id: 'filterSerdik', col: 'Serdik', label: '-- Serdik --' },
            { id: 'filterDapodik', col: 'Dapodik', label: '-- Dapodik --' }
        ],
        
        onFilterChange: function(filterId, value, filteredRows, allRows) {
            if(filterId === 'filterJenjang') {
                var elNama = document.getElementById('filterNamaLembaga');
                if(!elNama) return;
                var currentVal = elNama.value;
                elNama.innerHTML = '<option value="">-- Nama Lembaga --</option>';
                var sourceData = value ? allRows.filter(r => r['Jenjang'] === value) : allRows;
                var names = [];
                sourceData.forEach(r => { if(r['Nama Lembaga']) names.push(r['Nama Lembaga']); });
                var uniqueNames = names.filter((v, i, a) => a.indexOf(v) === i).sort();
                uniqueNames.forEach(n => elNama.add(new Option(n, n)));
                if(uniqueNames.includes(currentVal)) elNama.value = currentVal;
            }
        }
    });
};

// --- LOGIKA HALAMAN KELOLA PTK ---

// Object Helper Khusus Kelola PTK
App.ptkKelola = {
    // 1. Buka Modal (Kosong untuk Baru, Isi untuk Edit)
    openModal: function(rowData) {
        var form = document.getElementById('formPtk');
        form.reset(); // Kosongkan form dulu
        document.getElementById('rowId').value = ""; // Reset ID
        document.getElementById('modalTitle').textContent = "Tambah Data Baru";

        if (rowData) {
            // MODE EDIT: Isi form dengan data
            document.getElementById('modalTitle').textContent = "Edit Data PTK";
            document.getElementById('rowId').value = rowData._rowIndex; // ID Kunci!
            
            // Mapping field manual (pastikan name di HTML sama dengan key di object rowData)
            // Note: Header dari server adalah 'Nama Lengkap', di HTML name='namaLengkap'.
            // Kita perlu mapping sedikit.
            var f = form.elements;
            f.namaLengkap.value = rowData['Nama Lengkap'] || "";
            f.namaLembaga.value = rowData['Nama Lembaga'] || "";
            f.jenjang.value = rowData['Jenjang'] || "KB";
            f.status.value = rowData['Status'] || "";
            f.nipNiy.value = rowData['NIP/NIY'] || "";
            f.pangkat.value = rowData['Pangkat, Gol./Ruang'] || "";
            f.nuptk.value = rowData['NUPTK'] || "";
            f.jabatan.value = rowData['Jabatan'] || "";
            f.tmt.value = rowData['TMT'] || "";
            f.gender.value = rowData['L/P'] || "P";
            f.tempatLahir.value = rowData['Tempat Lahir'] || "";
            
            // Format Tanggal untuk Input Date (yyyy-mm-dd)
            if(rowData['Tanggal Lahir']) {
                var d = new Date(rowData['Tanggal Lahir']);
                if(!isNaN(d)) f.tanggalLahir.value = d.toISOString().split('T')[0];
            }
            
            f.pendidikan.value = rowData['Pendidikan'] || "";
            f.jurusan.value = rowData['Jurusan'] || "";
            f.tahunLulus.value = rowData['Tahun Lulus'] || "";
            f.serdik.value = rowData['Serdik'] || "Belum";
            f.dapodik.value = rowData['Dapodik'] || "Belum";
        }
        
        document.getElementById('modalFormPtk').style.display = 'flex';
    },

    closeModal: function() {
        document.getElementById('modalFormPtk').style.display = 'none';
    },

    // 2. Submit Form (Simpan/Edit)
    submit: function(e) {
        e.preventDefault();
        var form = document.getElementById('formPtk');
        var btn = form.querySelector('.btn-save');
        var originalText = btn.textContent;
        
        btn.textContent = "Menyimpan...";
        btn.disabled = true;

        google.script.run.withSuccessHandler(function(res) {
            btn.textContent = originalText;
            btn.disabled = false;
            if(res.success) {
                App.ptkKelola.closeModal();
                Swal.fire('Berhasil', res.message, 'success');
                App.inits['ptk_kelola'](); // Refresh Tabel
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        }).simpanPtkPaud(form); // Kirim Form HTML langsung
    },

    // 3. Hapus Data
    delete: function(rowIndex, nama) {
        Swal.fire({
            title: 'Hapus Data?',
            text: "Anda akan menghapus data: " + nama,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Ya, Hapus!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Tampilkan loading
                Swal.fire({title: 'Menghapus...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() }});
                
                google.script.run.withSuccessHandler(function(res) {
                    if(res.success) {
                        Swal.fire('Terhapus!', res.message, 'success');
                        App.inits['ptk_kelola'](); // Refresh Tabel
                    } else {
                        Swal.fire('Gagal', res.message, 'error');
                    }
                }).hapusPtkPaud(rowIndex);
            }
        });
    }
};

// ============================================================
// 1. UPDATE ROUTING (Biasanya di bagian paling atas javascript.html)
// ============================================================
// Pastikan variabel 'routes' Anda mencakup baris ini:
/*
var routes = {
    // ...
    'ptk_kelola_paud': 'page_ptk_kelola', // Route PAUD ke file ini
    'ptk_kelola_sd': 'page_ptk_kelola',   // Route SD juga ke file ini
    // ...
};
*/


// ============================================================
// 2. LOGIKA KELOLA PTK (MULTI-JENJANG)
// ============================================================

App.ptkKelola = {
    currentJenjang: 'PAUD',

    // --- 1. CONFIG HEADER TABEL (BEDA PAUD & SD) ---
    getTableHeaders: function() {
        if (this.currentJenjang === 'PAUD') {
            return ["Nama Lengkap", "Nama Lembaga", "Jenjang", "Status", "Jabatan"];
        } else {
            // SD (Header Baru)
            return ["Nama Lengkap", "Nama Sekolah", "Status Pegawai", "Jabatan", "Tugas"];
        }
    },

    // --- 2. SWITCH & REFRESH ---
    switchJenjang: function(jenjang) {
        this.currentJenjang = jenjang;
        var btnPaud = document.getElementById('tabPaud');
        var btnSd = document.getElementById('tabSd');
        if(btnPaud && btnSd) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            (jenjang === 'SD' ? btnSd : btnPaud).classList.add('active');
            var lbl = document.getElementById('labelJenjang');
            if(lbl) lbl.textContent = jenjang;
        }
        this.refresh();
    },

    refresh: function() {
        // Ambil header dinamis
        var displayHeaders = this.getTableHeaders(); 
        
        // Tambah kolom Aksi di depan
        var finalHeaders = [
            { 
                name: "Aksi", width: "100px",
                formatter: function(r) {
                    var rowJson = JSON.stringify(r).replace(/"/g, '&quot;');
                    return `<button class="action-btn-sm btn-edit" onclick="App.ptkKelola.openModal(JSON.parse('${rowJson}'))"><i class="fas fa-edit"></i></button>
                            <button class="action-btn-sm btn-del" onclick="App.ptkKelola.delete('${r._rowIndex}', '${r['Nama Lengkap']}')"><i class="fas fa-trash"></i></button>`;
                }
            }
        ].concat(displayHeaders);

        App.initSmartTable({
            tableId: 'kelolaPtkTable', 
            serverFunc: 'getKelolaPtkData', 
            params: { jenjang: this.currentJenjang },
            headers: finalHeaders, // Header dinamis
            autoHideZero: true,
            filters: [{ id: 'searchFilter', col: 'Nama Lengkap' }]
        });
    },

    // --- 3. OPEN MODAL & MAPPING (BEDA PAUD & SD) ---
    openModal: function(rowData) {
        var form = document.getElementById('formPtk');
        form.reset();
        document.getElementById('rowId').value = "";
        document.getElementById('targetJenjang').value = this.currentJenjang;
        document.getElementById('modalTitle').textContent = "Data " + this.currentJenjang;

        // Tampilkan/Sembunyikan Field Khusus SD
        // (Misal: Agama, Tugas, Tugas Tambahan hanya relevan di SD, di PAUD bisa disembunyikan atau dibiarkan kosong)
        // Disini kita biarkan tampil semua biar tidak rumit, tapi mappingnya kita bedakan.

        if (rowData) {
            document.getElementById('modalTitle').textContent = "Edit " + this.currentJenjang;
            document.getElementById('rowId').value = rowData._rowIndex;
            var f = form.elements;
            
            // MAPPING UMUM
            f.namaLengkap.value = rowData['Nama Lengkap'] || "";
            f.gender.value      = rowData['L/P'] || "L";
            f.tempatLahir.value = rowData['Tempat Lahir'] || "";
            if(rowData['Tanggal Lahir']) {
                var d = new Date(rowData['Tanggal Lahir']);
                if(!isNaN(d)) f.tanggalLahir.value = d.toISOString().split('T')[0];
            }
            f.pendidikan.value  = rowData['Pendidikan'] || "";
            f.jurusan.value     = rowData['Jurusan'] || "";
            f.tahunLulus.value  = rowData['Tahun Lulus'] || "";
            f.nuptk.value       = rowData['NUPTK'] || "";
            f.dapodik.value     = rowData['Dapodik'] || "Belum";
            f.serdik.value      = rowData['Serdik'] || "Belum";

            // === MAPPING SPESIFIK ===
            if (this.currentJenjang === 'PAUD') {
                // Header PAUD: Nama Lembaga, Jenjang, Status, NIP/NIY, Pangkat, Gol./Ruang
                f.namaSekolah.value = rowData['Nama Lembaga'] || ""; // Field form pakai namaSekolah, data dari Nama Lembaga
                f.status.value      = rowData['Status'] || "";
                f.nip.value         = rowData['NIP/NIY'] || "";
                f.pangkat.value     = rowData['Pangkat, Gol./Ruang'] || "";
                f.jabatan.value     = rowData['Jabatan'] || "";
                f.tmt.value         = rowData['TMT'] || "";
                
                // Field SD dikosongkan saat mode PAUD
                f.tugas.value = "";
                f.agama.value = "";
                f.tugasTambahan.value = "";
            } 
            else {
                // Header SD: Nama Sekolah, Status Pegawai, TMT, NIP, Pangkat, Gol./Ruang
                f.namaSekolah.value = rowData['Nama Sekolah'] || "";
                f.status.value      = rowData['Status Pegawai'] || "";
                f.nip.value         = rowData['NIP'] || "";
                f.pangkat.value     = rowData['Pangkat, Gol./Ruang'] || "";
                f.jabatan.value     = rowData['Jabatan'] || "";
                f.tmt.value         = rowData['TMT'] || "";
                f.tugas.value       = rowData['Tugas'] || "";
                f.agama.value       = rowData['Agama'] || "Islam";
                f.tugasTambahan.value = rowData['Tugas Tambahan'] || "";
            }
        }
        document.getElementById('modalFormPtk').style.display = 'flex';
    },
    
    // ... Close, Submit, Delete SAMA ...
    closeModal: function() { document.getElementById('modalFormPtk').style.display = 'none'; },
    submit: function(e) {
        e.preventDefault();
        var form = document.getElementById('formPtk');
        var btn = form.querySelector('.btn-save');
        var txt = btn.textContent; btn.textContent="Menyimpan..."; btn.disabled=true;
        google.script.run.withSuccessHandler(res=>{
            btn.textContent=txt; btn.disabled=false;
            if(res.success){ App.ptkKelola.closeModal(); Swal.fire('Oke',res.message,'success'); App.ptkKelola.refresh(); }
            else Swal.fire('Gagal',res.message,'error');
        }).simpanPtk(form);
    },
    delete: function(r,n) {
        Swal.fire({title:'Hapus?',text:n,icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(res=>{
            if(res.isConfirmed) google.script.run.withSuccessHandler(r=>{ if(r.success) App.ptkKelola.refresh(); }).hapusPtk(r, App.ptkKelola.currentJenjang);
        });
    }
};


// ============================================================
// 3. INIT HALAMAN (SESUAI MENU SIDEBAR)
// ============================================================

// Helper untuk init
App.initKelolaPtk = function(defaultJenjang) {
    App.ptkKelola.switchJenjang(defaultJenjang);
};

// 1. Jika menu 'ptk_kelola_paud' diklik
App.inits['ptk_kelola_paud'] = function() {
    App.initKelolaPtk('PAUD'); 
};

// 2. Jika menu 'ptk_kelola_sd' diklik
App.inits['ptk_kelola_sd'] = function() {
    App.initKelolaPtk('SD');
};

// ==========================================
// LOGIKA KHUSUS SD (App.ptkKelolaSd)
// ==========================================
App.ptkKelolaSd = {
    // Refresh khusus SD
    refresh: function() {
        App.initSmartTable({
            tableId: 'kelolaSdTable', // ID Tabel di HTML SD
            serverFunc: 'getKelolaSdData', // Panggil fungsi backend SD
            headers: [
                { 
                    name: "Aksi", width: "100px",
                    formatter: function(r) {
                         var rowJson = JSON.stringify(r).replace(/"/g, '&quot;');
                         // Perhatikan pemanggilannya: App.ptkKelolaSd
                         return `<button class="action-btn-sm btn-edit" onclick="App.ptkKelolaSd.openModal(JSON.parse('${rowJson}'))"><i class="fas fa-edit"></i></button>
                                 <button class="action-btn-sm btn-del" onclick="App.ptkKelolaSd.delete('${r._rowIndex}', '${r['Nama Lengkap']}')"><i class="fas fa-trash"></i></button>`;
                    }
                },
                "Nama Lengkap", "Nama Sekolah", "Status Pegawai", "Jabatan", "Tugas"
            ],
            autoHideZero: true,
            filters: [{ id: 'searchFilterSd', col: 'Nama Lengkap' }]
        });
    },

    openModal: function(rowData) {
        var form = document.getElementById('formPtkSd'); // ID Form khusus SD
        form.reset();
        document.getElementById('rowIdSd').value = ""; // ID Input Hidden khusus SD
        document.getElementById('modalTitleSd').textContent = "Tambah Data SD";
        
        if (rowData) {
            document.getElementById('modalTitleSd').textContent = "Edit Data SD";
            document.getElementById('rowIdSd').value = rowData._rowIndex;
            
            // MAPPING KHUSUS SD (19 Field)
            var f = form.elements;
            f.namaLengkap.value = rowData['Nama Lengkap'] || "";
            f.namaSekolah.value = rowData['Nama Sekolah'] || "";
            f.status.value      = rowData['Status Pegawai'] || "";
            f.tugas.value       = rowData['Tugas'] || "";
            f.agama.value       = rowData['Agama'] || "Islam";
            f.tugasTambahan.value = rowData['Tugas Tambahan'] || "";
            // ... (Lanjutkan mapping field lainnya: NIP, TMT, dll) ...
        }
        document.getElementById('modalFormSd').style.display = 'flex';
    },

    closeModal: function() { document.getElementById('modalFormSd').style.display = 'none'; },

    submit: function(e) {
        e.preventDefault();
        var form = document.getElementById('formPtkSd');
        // ... (Loading animation) ...
        google.script.run.withSuccessHandler(res => {
            if(res.success) { 
                App.ptkKelolaSd.closeModal(); 
                App.ptkKelolaSd.refresh(); // Refresh tabel SD
                Swal.fire('Sukses', res.message, 'success');
            }
        }).simpanSd(form); // Panggil fungsi backend SD
    },

    delete: function(idx, name) {
        // ... (Konfirmasi SWAL) ...
        // Panggil fungsi backend: hapusSd(idx)
        google.script.run.withSuccessHandler(res => {
             App.ptkKelolaSd.refresh(); 
        }).hapusSd(idx);
    }
};

// INIT SD
App.inits['ptk_kelola_sd'] = function() {
    App.ptkKelolaSd.refresh();
};

// ============================================================
// LOGIKA FRONTEND KHUSUS PAUD (App.ptkKelolaPaud)
// ============================================================

App.ptkKelolaPaud = {
    allLembaga: [], isLembagaLoaded: false, currentTab: 1,

    initData: function() {
        if (!this.isLembagaLoaded) {
            var that = this;
            google.script.run.withSuccessHandler(function(d) { that.allLembaga = d; that.isLembagaLoaded = true; }).getLembagaList();
        }
    },

    refresh: function() {
        var fmtDate = function(row, key) {
            var val = row[key]; if(!val) return "-";
            var parts = String(val).split('-');
            if(parts.length === 3) return `<span style="color:#334155;">${parts[2]}-${parts[1]}-${parts[0]}</span>`;
            return val; 
        };

        App.initSmartTable({
             tableId: 'kelolaPaudTable', serverFunc: 'getKelolaPaudData',
             headers: [ 
                 "Nama Lengkap", 
                 { name: "Nama Lembaga", tdStyle: "text-align:left;" }, 
                 "Jenjang", "Status", "Jabatan",
                 { name: "TMT", formatter: fmtDate }, 
                 { name: "Tanggal Lahir", formatter: fmtDate },
                 
                 { 
                      name: "Aksi", 
                      width: "100px", 
                      formatter: function(r) {
                          var rowJson = JSON.stringify(r).replace(/"/g, '&quot;');
                          return `
                          <div style="display:flex; gap:5px; justify-content:center;">
                              <button class="action-btn-sm btn-edit" title="Edit Data" onclick="App.ptkKelolaPaud.openModal(JSON.parse('${rowJson}'))">
                                  <i class="fas fa-edit"></i>
                              </button>
                              
                              <button class="action-btn-sm btn-mutasi" title="Mutasi / Nonaktifkan" onclick="App.ptkKelolaPaud.openMutasiModal(JSON.parse('${rowJson}'))">
                                  <i class="fas fa-exchange-alt"></i>
                              </button>
                          </div>`;
                      }
                  },
                 
                 // FORMAT TAMPILAN
                 { name: "Tanggal Input", tdStyle: "font-size:0.85em; color:#64748b;" },
                 { name: "Input By", tdStyle: "font-size:0.85em; color:#64748b; text-align:left;" },
                 { name: "Tanggal Update", tdStyle: "font-size:0.85em; color:#64748b;" },
                 
                 // Update By (Seharusnya sekarang bersih, hanya nama User)
                 { name: "Update By", tdStyle: "font-size:0.85em; color:#64748b; text-align:left;" },
                 
                 // Keterangan Mutasi (Kolom V)
                 { name: "Keterangan", tdStyle: "font-size:0.85em; color:#334155; text-align:left; white-space:nowrap; overflow:hidden;" }
             ],
             autoHideZero: true, filters: [{ id: 'searchFilterPaud', col: 'Nama Lengkap' }]
        });
    },

    // ============================================
    // LOGIKA BARU: MUTASI & NONAKTIFKAN
    // ============================================
    
    openMutasiModal: function(row) {
        var m = document.getElementById('modalMutasiPaud');
        var f = document.getElementById('formMutasiPaud');
        f.reset();
        
        // Isi Hidden ID & User
        document.getElementById('rowIdMutasi').value = row._rowIndex;
        try {
            var s = JSON.parse(localStorage.getItem('user_session') || '{}');
            document.getElementById('userMutasi').value = s.nama || 'Admin';
        } catch(e){}

        // Tampilkan Info
        document.getElementById('mutasiNamaPtk').textContent = row['Nama Lengkap'];
        document.getElementById('mutasiLembagaAsal').textContent = row['Nama Lembaga'] + " (" + row['Jenjang'] + ")";

        // --- UPDATE: ISI DROPDOWN JENJANG (UNIK) ---
        var elJenjang = document.getElementById('mutasiJenjang');
        elJenjang.innerHTML = '<option value="">-- Pilih Jenjang --</option>';
        
        // Ambil daftar jenjang unik dari data lembaga yang sudah ada
        if (this.allLembaga && this.allLembaga.length > 0) {
            // Ambil unique jenjang: ["TK", "KB", "SPS", ...]
            var unik = [...new Set(this.allLembaga.map(l => l.jenjang))].sort();
            unik.forEach(function(j) {
                elJenjang.add(new Option(j, j));
            });
        }

        // Reset Dropdown Lembaga
        var elLembaga = document.getElementById('mutasiLembagaBaru');
        elLembaga.innerHTML = '<option value="">-- Pilih Jenjang Terlebih Dahulu --</option>';
        elLembaga.disabled = true;

        // Reset Tampilan Form
        this.toggleMutasiForm();
        m.style.display = 'flex';
    },

    // --- FUNGSI BARU: FILTER LEMBAGA MUTASI BERDASARKAN JENJANG ---
    filterLembagaMutasi: function() {
        var jenjang = document.getElementById('mutasiJenjang').value;
        var elLembaga = document.getElementById('mutasiLembagaBaru');
        
        // Reset isi
        elLembaga.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
        
        if (!jenjang) {
            elLembaga.disabled = true;
            return;
        }

        elLembaga.disabled = false;

        // Filter dari this.allLembaga
        var hasilFilter = this.allLembaga.filter(function(l) {
            return l.jenjang === jenjang;
        });

        // Urutkan Abjad
        hasilFilter.sort(function(a, b) {
            return a.nama.localeCompare(b.nama);
        });

        // Masukkan ke Dropdown
        hasilFilter.forEach(function(l) {
            elLembaga.add(new Option(l.nama, l.nama));
        });
    },

    closeMutasiModal: function() {
        document.getElementById('modalMutasiPaud').style.display = 'none';
    },

    toggleMutasiForm: function() {
        var val = document.getElementById('jenisTindakan').value;
        var pPindah = document.getElementById('panelPindah');
        var pKeluar = document.getElementById('panelKeluar');
        var pUmum = document.getElementById('panelUmum');
        
        // Input Elements
        var inpJenjang = document.getElementById('mutasiJenjang');
        var inpLembaga = document.getElementById('mutasiLembagaBaru');
        var inpAlasan = document.getElementById('alasanMutasi');

        pPindah.style.display = 'none';
        pKeluar.style.display = 'none';
        pUmum.style.display = 'none';
        
        // Reset Required
        inpJenjang.required = false;
        inpLembaga.required = false;
        inpAlasan.required = false;

        if (val === 'pindah') {
            pPindah.style.display = 'block';
            pUmum.style.display = 'block';
            // Set Required untuk Pindah
            inpJenjang.required = true;
            inpLembaga.required = true;
        } else if (val === 'keluar') {
            pKeluar.style.display = 'block';
            pUmum.style.display = 'block';
            inpAlasan.required = true;
        }
    },

    submitMutasi: function(e) {
        e.preventDefault();
        var form = document.getElementById('formMutasiPaud');
        
        // Pastikan input yang disabled (Lembaga Baru) dibuka sebentar agar terbaca validasinya
        var inpLembaga = document.getElementById('mutasiLembagaBaru');
        var isDisabled = inpLembaga.disabled;
        inpLembaga.disabled = false; 

        if (!form.checkValidity()) { 
            form.reportValidity(); 
            if(isDisabled) inpLembaga.disabled = true; // Kembalikan state jika invalid
            return; 
        }
        
        // Jika valid, biarkan enabled agar terkirim valuenya
        
        var btn = form.querySelector('.btn-save');
        var oriText = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Memproses..."; 
        btn.disabled = true;

        google.script.run
        .withSuccessHandler(function(res) {
            btn.innerHTML = oriText; btn.disabled = false;
            if(res.success) {
                App.ptkKelolaPaud.closeMutasiModal();
                if(typeof Swal !== 'undefined') {
                    Swal.fire({ title: 'Berhasil', text: res.message, icon: 'success', width:'400px', timer:2000, showConfirmButton:false })
                    .then(() => App.ptkKelolaPaud.refresh());
                } else {
                    alert(res.message); App.ptkKelolaPaud.refresh();
                }
            } else {
                if(typeof Swal !== 'undefined') Swal.fire('Gagal', res.message, 'error');
                else alert(res.message);
            }
        })
        .withFailureHandler(function(err) {
            btn.innerHTML = oriText; btn.disabled = false;
            alert("Error: " + err.message);
        })
        .prosesMutasiPaud(form);
    },

    openModal: function(rowData) {
        var form = document.getElementById('formPtkPaud');
        form.reset(); 
        document.getElementById('rowIdPaud').value = ""; 
        document.getElementById('modalTitlePaud').textContent = "Tambah Data PTK PAUD";
        this.showTab(1); this.checkJurusan();

        // Ambil Nama User
        try {
            var sessionData = localStorage.getItem('user_session'); 
            var uName = 'Admin';
            if (sessionData) {
                var u = JSON.parse(sessionData);
                if (u.nama) uName = u.nama; 
            }
            document.getElementById('userPenginput').value = uName;
        } catch(e) { console.error(e); }

        // Variabel elemen input untuk dikunci/buka
        var inpJenjang = document.getElementById('inputJenjang');
        var inpLembaga = document.getElementById('inputNamaLembaga');

        if (rowData) {
            // --- MODE EDIT ---
            document.getElementById('modalTitlePaud').textContent = "Edit Data PTK PAUD";
            document.getElementById('rowIdPaud').value = rowData._rowIndex;
            
            // [REQUEST BARU] KUNCI FIELD LEMBAGA SAAT EDIT
            inpJenjang.disabled = true;
            inpLembaga.disabled = true;
            inpJenjang.style.backgroundColor = "#f1f5f9"; // Visual abu-abu
            inpLembaga.style.backgroundColor = "#f1f5f9";

            var f = form.elements;
            
            // Isi Data
            f.jenjang.value = rowData['Jenjang'] || "";
            
            // Kita harus memanggil filterLembaga() dulu lalu set value, 
            // ATAU manual add option jika disabled (untuk keamanan UI)
            this.filterLembaga(); 
            f.namaLembaga.value = rowData['Nama Lembaga'] || "";

            f.namaLengkap.value = rowData['Nama Lengkap'] || "";
            f.gender.value      = rowData['L/P'] || "";
            f.tempatLahir.value = rowData['Tempat Lahir'] || "";
            f.tanggalLahir.value = rowData['Tanggal Lahir'] || ""; 
            f.pendidikan.value  = rowData['Pendidikan'] || "";
            this.checkJurusan();
            f.jurusan.value     = rowData['Jurusan'] || "";
            f.tahunLulus.value  = rowData['Tahun Lulus'] || "";
            f.nuptk.value       = rowData['NUPTK'] || "";
            f.serdik.value      = rowData['Serdik'] || "";
            f.dapodik.value     = rowData['Dapodik'] || "";
            f.status.value      = rowData['Status'] || "";
            f.nip.value         = rowData['NIP/NIY'] || "";
            f.pangkat.value     = rowData['Pangkat, Gol./Ruang'] || "";
            f.jabatan.value     = rowData['Jabatan'] || "";
            f.tmt.value         = rowData['TMT'] || "";

        } else { 
            // --- MODE TAMBAH ---
            // BUKA KUNCI
            inpJenjang.disabled = false;
            inpLembaga.disabled = false;
            inpJenjang.style.backgroundColor = ""; 
            inpLembaga.style.backgroundColor = "";

            this.filterLembaga(); 
        }
        
        var mContent = document.querySelector('#modalFormPaud .modal-content');
        if(mContent) mContent.style.maxWidth = "800px"; 

        document.getElementById('modalFormPaud').style.display = 'flex';
    },

    closeModal: function() { document.getElementById('modalFormPaud').style.display = 'none'; },

    // Submit & Logika Lainnya TETAP SAMA
    submit: function(e) {
        if(e) e.preventDefault(); 
        var form = document.getElementById('formPtkPaud');
        if (!form.checkValidity()) { form.reportValidity(); return; }

        // [PENTING] Karena field disabled tidak terkirim saat submit,
        // kita perlu mengaktifkannya sebentar atau mengambil nilainya manual.
        // Cara termudah: Aktifkan sesaat sebelum kirim
        var inpJenjang = document.getElementById('inputJenjang');
        var inpLembaga = document.getElementById('inputNamaLembaga');
        inpJenjang.disabled = false;
        inpLembaga.disabled = false;

        var btn = form.querySelector('.btn-save');
        var originalText = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Menyimpan..."; 
        btn.disabled = true;
        
        google.script.run
        .withSuccessHandler(function(res) {
            btn.innerHTML = originalText; btn.disabled = false;
            if(res && res.success) { 
                App.ptkKelolaPaud.closeModal(); 
                if(typeof Swal !== 'undefined') {
                     Swal.fire({
                        title: 'Berhasil!',
                        text: res.message,
                        icon: 'success',
                        width: '400px',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => App.ptkKelolaPaud.refresh());
                } else {
                    alert(res.message);
                    App.ptkKelolaPaud.refresh();
                }
            } else {
                if(typeof Swal !== 'undefined') Swal.fire({ title: 'Gagal', text: res.message, icon: 'error', width: '400px' });
                else alert(res.message);
            }
        })
        .withFailureHandler(function(err) {
            btn.innerHTML = originalText; btn.disabled = false;
            alert(err.message);
        })
        .simpanPaud(form);
    },
    
    // Copy Helper Tab & Delete (Sama seperti sebelumnya)
    nextTab: function(t) { var cur = document.getElementById('tab'+this.currentTab); var inps=cur.querySelectorAll('input,select'); var ok=true; for(var i=0; i<inps.length; i++){ if(!inps[i].checkValidity()){ inps[i].reportValidity(); ok=false; break; }} if(ok) this.showTab(t); },
    prevTab: function(t) { this.showTab(t); },
    showTab: function(n) { this.currentTab=n; document.querySelectorAll('#formPtkPaud .tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('#formPtkPaud .tab-link').forEach(e=>e.classList.remove('active')); document.getElementById('tab'+n).classList.add('active'); document.getElementById('btnTab'+n).classList.add('active'); for(var i=1; i<=3; i++) { document.getElementById('btnTab'+i).disabled = (i>n); } },
    filterLembaga: function() { var jenjang=document.getElementById('inputJenjang').value; var el=document.getElementById('inputNamaLembaga'); el.innerHTML='<option value="">-- Pilih Lembaga --</option>'; if(!jenjang) return; var f=this.allLembaga.filter(l=>l.jenjang===jenjang); f.forEach(l=>{ var o=document.createElement('option'); o.value=l.nama; o.text=l.nama; el.add(o); }); },
    checkJurusan: function() { var p=document.getElementById('inputPendidikan').value; var j=document.getElementById('inputJurusan'); var l=document.getElementById('labelJurusanReq'); if(p.includes('SD')||p.includes('SMP')||p==''){ j.required=false; l.style.display='none'; j.placeholder='Tidak wajib'; }else{ j.required=true; l.style.display='inline'; j.placeholder='Wajib diisi'; } },
    delete: function(r,n) { if(confirm("Hapus "+n+"?")) google.script.run.withSuccessHandler(()=>{ App.ptkKelolaPaud.refresh(); }).hapusPaud(r); }
};

App.inits['ptk_kelola_paud'] = function() {
    App.ptkKelolaPaud.initData(); 
    App.ptkKelolaPaud.refresh();
};

// ============================================
// CONTROLLER: DATA NON-AKTIF (RESTORE)
// ============================================
App.ptkNonAktifPaud = {
    refresh: function() {
        var tbody = document.querySelector('#tableNonAktifPaud tbody');
        if(tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#64748b;"><i class="fas fa-spinner fa-spin"></i> Memuat data arsip...</td></tr>';

        App.initSmartTable({
             tableId: 'tableNonAktifPaud', 
             serverFunc: 'getPtkNonAktifPaudData',
             headers: [ 
                 "Nama Lengkap", 
                 { name: "Nama Lembaga", tdStyle: "text-align:left;" }, 
                 "Jenjang", 
                 { name: "Jenis Mutasi", tdStyle: "text-align:left;", formatter: function(r) {
                     var val = r["Jenis Mutasi"] || "-";
                     var color = val.toLowerCase().includes('pindah') ? '#f59e0b' : '#ef4444'; 
                     return `<span style="background:${color}20; color:${color}; padding:2px 8px; border-radius:4px; font-weight:600; font-size:0.85em; display:inline-block;">${val}</span>`;
                 }},
                 { name: "Keterangan Mutasi", tdStyle: "text-align:left; color:#64748b; font-size:0.9em; max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" },
                 "Tanggal Nonaktif",
                 { name: "Aksi", width: "120px", formatter: function(r) {
                        var safeData = encodeURIComponent(r._fullData);
                        return `<button style="background:#10b981; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.85em; display:flex; align-items:center; gap:5px;" 
                                title="Aktifkan Kembali" 
                                onclick="App.ptkNonAktifPaud.restore('${r._rowIndex}', JSON.parse(decodeURIComponent('${safeData}')))">
                            <i class="fas fa-recycle"></i> Pulihkan
                        </button>`;
                 }}
             ],
             autoHideZero: true, 
             filters: [{ id: 'searchFilterNonAktifPaud', col: 'Nama Lengkap' }]
        });
    },

    // --- FUNGSI BARU: SUBMIT RESTORE ---
    submitRestore: function(e) {
        e.preventDefault(); // Mencegah reload halaman
        
        var form = e.target;
        var btn = form.querySelector('button[type="submit"]');
        var originalText = btn.innerHTML;

        // UI Feedback: Loading
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        btn.disabled = true;

        // Panggil Backend simpanPaud
        google.script.run
            .withSuccessHandler(function(res) {
                // Reset Tombol
                btn.innerHTML = originalText;
                btn.disabled = false;

                if (res.success) {
                    // Tutup Modal & Refresh Tabel Non Aktif
                    App.ptkNonAktifPaud.closeModal();
                    App.ptkNonAktifPaud.refresh();
                    
                    // Notifikasi Sukses
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: res.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire('Gagal!', res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                Swal.fire('Error Sistem', err.message, 'error');
            })
            .simpanPaud(form);
    },

    restore: function(rowIndexMutasi, dataArr) {
        var f = document.getElementById('formPtkPaud');
        if(!f) return;
        
        f.reset();
        document.getElementById('modalPtkPaud').style.display = 'flex';
        document.getElementById('isRestorePaud').value = "true";
        document.getElementById('rowIdSourcePaud').value = rowIndexMutasi;

        var el = f.elements;

        // HELPER SUNTIK OPSI
        var injectOption = function(selectEl, val) {
            if (!selectEl || !val) return;
            var exists = false;
            for (var i = 0; i < selectEl.options.length; i++) {
                if (selectEl.options[i].value === val) {
                    exists = true; break;
                }
            }
            if (!exists) {
                var opt = document.createElement('option');
                opt.value = val;
                opt.text = val;
                selectEl.add(opt);
            }
            selectEl.value = val;
        };

        var toInputDate = function(val) {
            if(!val) return "";
            var d = new Date(val);
            if(isNaN(d.getTime())) return "";
            return d.toISOString().split('T')[0];
        };

        // MAPPING DATA
        el.namaLengkap.value = dataArr[0] || "";
        injectOption(el.namaLembaga, dataArr[1]);
        injectOption(el.jenjang, dataArr[2]);
        injectOption(el.status, dataArr[3]);
        el.nip.value = dataArr[4] || "";
        el.pangkat.value = dataArr[5] || "";
        el.nuptk.value = dataArr[6] || "";
        injectOption(el.jabatan, dataArr[7]);
        el.tmt.value = toInputDate(dataArr[8]);
        injectOption(el.gender, dataArr[9]);
        el.tempatLahir.value = dataArr[10] || "";
        el.tanggalLahir.value = toInputDate(dataArr[11]);
        injectOption(el.pendidikan, dataArr[12]);
        el.jurusan.value = dataArr[13] || "";
        el.tahunLulus.value = dataArr[14] || "";
        injectOption(el.dapodik, dataArr[15]);
        injectOption(el.serdik, dataArr[16]);

        this.showTab(1);
    },

    showTab: function(n) {
        var contents = document.querySelectorAll('#modalPtkPaud .tab-content');
        contents.forEach(function(el) { el.style.display = 'none'; });
        
        var btns = document.querySelectorAll('#modalPtkPaud .tab-btn');
        btns.forEach(function(el) { 
            el.style.borderBottom = "3px solid transparent";
            el.style.color = "#64748b";
        });

        var targetContent = document.querySelector('#modalPtkPaud #tab' + n);
        var targetBtn = document.querySelector('#modalPtkPaud #tabBtn' + n);

        if(targetContent) targetContent.style.display = 'block';
        if(targetBtn) {
            targetBtn.style.borderBottom = "3px solid #3b82f6"; 
            targetBtn.style.color = "#3b82f6";
        }
    },

    closeModal: function() {
        document.getElementById('modalPtkPaud').style.display = 'none';
    }
};

// Pastikan Init Router-nya Benar
App.inits['ptk_non_aktif_paud'] = function() {
    console.log("Membuka Halaman Non Aktif PAUD...");
    App.ptkNonAktifPaud.refresh();
};

// Override fungsi openModal milik Kelola PAUD agar flag restore kereset otomatis
var originalOpenModal = App.ptkKelolaPaud.openModal;
App.ptkKelolaPaud.openModal = function(rowData) {
    // Panggil fungsi asli
    originalOpenModal.call(App.ptkKelolaPaud, rowData);

    // Reset Flag Restore (Kembali ke mode normal)
    if(document.getElementById('isRestorePaud')) {
        document.getElementById('isRestorePaud').value = "false";
        document.getElementById('rowIdSourcePaud').value = "";
        document.getElementById('modalTitlePaud').style.color = ""; 
    }
};

// Daftarkan ke sistem routing agar saat menu diklik, fungsi refresh jalan
App.inits['ptk_non_aktif'] = function() {
    App.ptkNonAktifPaud.refresh();
};

// ============================================
// INISIALISASI ROUTER (SESUAI DATA-PAGE)
// ============================================
App.inits['ptk_non_aktif_paud'] = function() {
    // Karena HTML sudah dimuat otomatis oleh router Anda ke #main-content
    // dan kita sudah menghapus display:none, maka kita cukup panggil datanya saja.
    
    console.log("Memuat Data Non Aktif PAUD..."); // Cek di console browser
    App.ptkNonAktifPaud.refresh();
};

// ============================================
// DASHBOARD CONTROLLER
// ============================================
App.ptkPaudMenu = {
    charts: {}, 

    refresh: function() {
        document.getElementById('c-lembaga-tot').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        google.script.run
            .withSuccessHandler(function(res) {
                App.ptkPaudMenu.render(res);
            })
            .withFailureHandler(function(err){
                Swal.fire('Error', 'Gagal memuat dashboard', 'error');
            })
            .getDashboardPaudData();
    },

    render: function(d) {
        const c = d.count;
        // Render Kartu
        document.getElementById('c-lembaga-kb').textContent = c.lembaga_kb;
        document.getElementById('c-lembaga-tk').textContent = c.lembaga_tk;
        document.getElementById('c-lembaga-tot').textContent = c.lembaga_kb + c.lembaga_tk;

        document.getElementById('c-ks-kb').textContent = c.ks_kb;
        document.getElementById('c-ks-tk').textContent = c.ks_tk;
        document.getElementById('c-ks-tot').textContent = c.ks_kb + c.ks_tk;

        document.getElementById('c-guru-kb').textContent = c.guru_kb;
        document.getElementById('c-guru-tk').textContent = c.guru_tk;
        document.getElementById('c-guru-tot').textContent = c.guru_kb + c.guru_tk;

        document.getElementById('c-tendik-kb').textContent = c.tendik_kb;
        document.getElementById('c-tendik-tk').textContent = c.tendik_tk;
        document.getElementById('c-tendik-tot').textContent = c.tendik_kb + c.tendik_tk;

        // Render List Tabel
        this.renderList('listPensiun', d.lists.pensiun, (i) => {
            let sisaStr = "";
            if(i.sisaHari > 365) sisaStr = Math.floor(i.sisaHari/365) + " Thn lg";
            else if(i.sisaHari > 30) sisaStr = Math.floor(i.sisaHari/30) + " Bln lg";
            else sisaStr = i.sisaHari + " Hari lg";
            return `<div><strong>${i.nama}</strong><br><small>${i.lembaga}</small></div>
                    <b style="color:#f59e0b; font-size:0.9em;">${sisaStr}</b>`;
        });

        this.renderList('listNoSerdik', d.lists.noserdik, (i) => 
            `<div><strong>${i.nama}</strong><br><small>${i.lembaga}</small></div><span style="font-size:0.8em; color:#64748b;">${i.jabatan}</span>`
        );

        this.renderList('listNoDapodik', d.lists.nodapodik, (i) => 
            `<div><strong>${i.nama}</strong><br><small>${i.lembaga}</small></div><span style="font-size:0.8em; color:#ef4444;">Cek Data</span>`
        );

        // Render Charts
        this.initCharts(d.charts);
    },

    renderList: function(elId, items, templateFn) {
        const el = document.getElementById(elId);
        if(!items || items.length === 0) {
            el.innerHTML = '<li><span style="color:#22c55e; text-align:center; width:100%;"><i class="fas fa-check"></i> Nihil / Bersih</span></li>';
            return;
        }
        let html = '';
        items.slice(0, 5).forEach(item => { html += `<li>${templateFn(item)}</li>`; });
        if(items.length > 5) html += `<li style="text-align:center; color:#3b82f6; cursor:pointer; font-size:0.8em;">+${items.length - 5} Lainnya...</li>`;
        el.innerHTML = html;
    },

    initCharts: function(d) {
        // Hapus chart lama (termasuk Usia jika ada sisa)
        ['status', 'cert', 'edu', 'usia'].forEach(k => { if(this.charts[k]) this.charts[k].destroy(); });

        // 1. PIE STATUS
        this.charts['status'] = new Chart(document.getElementById('chartStatus'), {
            type: 'pie',
            data: {
                labels: ['PNS', 'PPPK', 'GTY', 'GTT', 'Lain'],
                datasets: [{
                    data: [d.status.pns, d.status.pppk, d.status.gty, d.status.gtt, d.status.lain],
                    backgroundColor: ['#3b82f6', '#0ea5e9', '#10b981', '#f59e0b', '#cbd5e1']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{boxWidth:10, font:{size:10}} } } }
        });

        // 2. BAR PENDIDIKAN (4 Bars)
        this.charts['edu'] = new Chart(document.getElementById('chartEdu'), {
            type: 'bar',
            data: {
                labels: ['SD/SMP', 'SMA/D1', 'D2/D3', 'S1/D4', 'S2/S3'],
                datasets: [
                    { label: 'Pendidik KB', data: d.edu[0], backgroundColor: '#3b82f6' },
                    { label: 'Pendidik TK', data: d.edu[1], backgroundColor: '#1d4ed8' },
                    { label: 'Tendik KB',   data: d.edu[2], backgroundColor: '#f59e0b' },
                    { label: 'Tendik TK',   data: d.edu[3], backgroundColor: '#d97706' }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } } // Sembunyikan legend agar grafik tidak sempit
            }
        });

        // 3. NESTED DOUGHNUT CERT
        this.charts['cert'] = new Chart(document.getElementById('chartCert'), {
            type: 'doughnut',
            data: {
                labels: ['Sudah', 'Belum'],
                datasets: [
                    {   // Luar: TK
                        label: 'TK',
                        data: [d.cert.tk.sudah, d.cert.tk.belum],
                        backgroundColor: ['#22c55e', '#e2e8f0'],
                        weight: 2
                    },
                    {   // Dalam: KB
                        label: 'KB',
                        data: [d.cert.kb.sudah, d.cert.kb.belum],
                        backgroundColor: ['#15803d', '#94a3b8'],
                        weight: 1
                    }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { position: 'bottom', labels:{boxWidth:10, font:{size:10}} } } 
            }
        });
    }
};

// Inisialisasi saat menu dibuka
App.inits['ptk_paud_menu'] = function() {
    App.ptkPaudMenu.refresh();
};

// Inisialisasi saat menu dibuka
App.inits['ptk_paud_menu'] = function() {
    App.ptkPaudMenu.refresh();
};

document.addEventListener('DOMContentLoaded', App.init);
</script>