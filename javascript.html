<div id="appModal" class="modal-overlay">
    <div class="modal-content">
        <div id="modalSpinner" style="display: none;"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div></div>
        <h3 id="modalTitle"></h3>
        <p id="modalMessage"></p>
        <div class="modal-actions">
            <button id="modalOkBtn" class="submit-btn" style="background-color: #3498db;">OK</button>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="deleteModalTitle">Konfirmasi Hapus</h3>
        <div id="deleteModalBody"></div>
        <div class="modal-actions">
            <button id="cancelDeleteBtn" class="cancel-btn">Batal</button>
            <button id="confirmDeleteBtn" class="delete-btn-confirm">Ya, Hapus</button>
        </div>
    </div>
</div>

<script>
/**
 * ===================================================================
 * ======================= 1. FUNGSI INTI & UTILITAS =================
 * ===================================================================
 */
 
// DEKLARASI NAMESPACE UTAMA
const App = {};

App.showAppModal = (state, message, redirectPage = null) => {
    const modal = document.getElementById('appModal');
    const spinner = document.getElementById('modalSpinner');
    const title = document.getElementById('modalTitle');
    const msg = document.getElementById('modalMessage');
    const okBtn = document.getElementById('modalOkBtn');
    spinner.style.display = 'none';
    okBtn.style.display = 'block';
    msg.innerHTML = message;
    if (state === 'loading') {
        title.textContent = "Memproses...";
        spinner.style.display = 'block';
        okBtn.style.display = 'none';
    } else if (state === 'success') {
        title.textContent = 'Sukses!';
        title.style.color = '#27ae60';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => {
            modal.classList.remove('show');
            if (redirectPage) App.loadPage(null, redirectPage);
        };
    } else if (state === 'info') {
        title.textContent = 'Informasi Penting';
        title.style.color = '#00c3ff';
        okBtn.textContent = 'Mengerti';
        okBtn.onclick = () => modal.classList.remove('show');
    } else { // 'error'
        title.textContent = 'Error!';
        title.style.color = '#e74c3c';
        okBtn.textContent = 'OK';
        okBtn.onclick = () => modal.classList.remove('show');
    }
    modal.classList.add('show');
};

App.loadPage = (event, pageName, params = {}) => {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const contentArea = document.getElementById('main-content');
    contentArea.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat halaman...</p></div>';
    
    google.script.run
        .withSuccessHandler(html => {
            try {
                contentArea.innerHTML = html;

                
                
                // KEMBALIKAN KE 0
                setTimeout(() => {
                    if (typeof App.pageInitializers !== 'undefined' && typeof App.pageInitializers[pageName] === 'function') {
                        App.pageInitializers[pageName](params);
                    }
                    App.updateActiveMenu(pageName);
                }, 0); 

            } catch (e) {
                console.error("Client-side error after loading page:", e);
                contentArea.innerHTML = `<div class="error-box" style="padding: 20px; background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; border-radius: 8px; color: white;"><h3>Error JavaScript di Browser!</h3><p><strong>Pesan:</strong> ${e.message}</p><p><strong>Stack:</strong> ${e.stack}</p></div>`;
            }
        })
        .withFailureHandler(err => {
            console.error("Server-side error during include:", err);
            contentArea.innerHTML = `<div class="error-box" style="padding: 20px; background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; border-radius: 8px; color: white;"><h3>Gagal Memuat Konten!</h3><p>Pastikan file HTML 'page_${pageName}.html' ada dan namanya sudah benar.</p><p><strong>Pesan Server:</strong> ${err.message}</p></div>`;
        })
        .include('page_' + pageName);
};

App.updateActiveMenu = (pageName) => {
    document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.sidebar-menu .has-submenu').forEach(el => el.classList.remove('open'));

    let activeLink = document.querySelector(`.sidebar-menu a[data-page="${pageName}"]`);
    let startElement = null;

    if (activeLink) {
        activeLink.classList.add('active');
        startElement = activeLink;
    } else {
        const parentPageName = pageName.split('_').slice(0, -1).join('_');
        const parentLink = document.querySelector(`.sidebar-menu a[data-page-parent="${parentPageName}"]`);
        
        if (parentLink) {
            parentLink.classList.add('active');
            parentLink.parentElement.classList.add('open');
            startElement = parentLink;
        }
    }

    if (!startElement) return;

    let parent = startElement.closest('.has-submenu');
    while (parent) {
        parent.classList.add('open');
        const parentAnchor = parent.querySelector('a[data-page-parent]');
        if (parentAnchor) {
            parentAnchor.classList.add('active');
        }
        parent = parent.parentElement.closest('.has-submenu');
    }
};

App.debounce = (func, timeout = 150) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
    };
};

const parseCustomDateTime = (dateStr) => {
    // Pastikan input adalah string, bersihkan spasi ekstra, dan periksa null/kosong
    const cleanedStr = String(dateStr).trim();
    if (!cleanedStr || cleanedStr === '-') return 0;
    
    // RegEx yang disederhanakan untuk menangkap format dd/MM/yyyy HH:mm:ss
    const parts = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s(\d{1,2}):(\d{1,2}):(\d{1,2})/);

    if (parts && parts.length === 7) {
        // parts[1]: Tanggal (d)
        // parts[2]: Bulan (M) - Kritis: Harus dikurangi 1 (0 = Januari)
        // parts[3]: Tahun (yyyy)
        // parts[4]: Jam (HH)
        // parts[5]: Menit (mm)
        // parts[6]: Detik (ss)
        
        // Buat objek Date. (Bulan: parts[2] - 1)
        return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]).getTime();
    }
    
    // Fallback: Coba konversi sebagai string yang hanya berisi tanggal (dd/MM/yyyy)
    const dateOnly = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (dateOnly) {
        return new Date(dateOnly[3], dateOnly[2] - 1, dateOnly[1]).getTime();
    }
    
    return 0; // Jika tidak ada yang cocok, disortir ke posisi paling akhir
};

App.setupInfoDropdown = (buttonId, contentId, infoItems) => {
    const infoBtn = document.getElementById(buttonId);
    const contentDiv = document.getElementById(contentId);
    if (!infoBtn || !contentDiv) return;
    let isDataLoaded = false;
    if (infoItems && infoItems.length > 0) {
        const infoContent = `<ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">${infoItems.map(item => `<li>${item}</li>`).join('')}</ul>`;
        contentDiv.innerHTML = infoContent;
        isDataLoaded = true;
    } else {
        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
    }
    infoBtn.onclick = function() {
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? contentDiv.scrollHeight + "px" : "0px";
    };
};

const applySorting = (sortConfig) => {
    if (!sortConfig || currentFilteredRows.length === 0) return;

    currentFilteredRows.sort((a, b) => {
        for (let i = 0; i < sortConfig.length; i++) {
            const conf = sortConfig[i];
            
            // Tentukan parser, default adalah fungsi identitas jika tidak ada
            const parser = conf.parser || ((val) => val); 

            // Ambil nilai dan pastikan nilai yang tidak ada (null/undefined) menjadi 0 (untuk disortir terakhir)
            const valA = parser(a[conf.column]) || 0; 
            const valB = parser(b[conf.column]) || 0; 

            const comparison = (valA > valB) ? 1 : (valA < valB) ? -1 : 0;

            if (comparison !== 0) {
                return conf.order === 'DESC' ? -comparison : comparison;
            }
        }
        return 0;
    });

    // Setelah disortir, bangun ulang tabel
    buildTable(); 
};

// ===============================================================
// === FUNGSI GENERIK TABEL DITEMPATKAN DI SINI (SEBELUM INIT) ===
// ===============================================================

App.initializeGenericTablePage = (config) => {
    // VARIABEL LOKAL
    let allDataRows = [], headerCols = [], currentFilteredRows = [], currentPage = 1, rowsPerPage = 15;
    let filterData = null;
    
    config.filters = config.filters || [];
    
    // --- FUNGSI HELPER LOKAL ---
    const getRowValue = (row, key) => {
        const isDataNested = config.tableId === 'kelolaTable' || config.tableId === 'kelolaPtkSdTable';
        return isDataNested ? (row.data ? row.data[key] : row[key]) : row[key];
    };
    
    // FUNGSI PARSER UNTUK SORTING TANGGAL
    const parseCustomDateTime = (dateStr) => {
        const cleanedStr = String(dateStr).trim();
        if (!cleanedStr || cleanedStr === '-') return 0;
        const parts = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s(\d{1,2}):(\d{1,2}):(\d{1,2})/);
        if (parts && parts.length === 7) {
            return new Date(parts[3], parts[2] - 1, parts[1], parts[4], parts[5], parts[6]).getTime();
        }
        const dateOnly = cleanedStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (dateOnly) {
            return new Date(dateOnly[3], dateOnly[2] - 1, dateOnly[1]).getTime();
        }
        return 0;
    };
    
    // FUNGSI SORTING
    const applySorting = (dataArray, sortConfig) => {
        if (!sortConfig || dataArray.length === 0) return dataArray;
        dataArray.sort((a, b) => {
            for (let i = 0; i < sortConfig.length; i++) {
                const conf = sortConfig[i];
                const parser = conf.parser || ((val) => val); 
                const valA = parser(a[conf.column]) || 0; 
                const valB = parser(b[conf.column]) || 0; 
                const comparison = (valA > valB) ? 1 : (valA < valB) ? -1 : 0;
                if (comparison !== 0) {
                    return conf.order === 'DESC' ? -comparison : comparison;
                }
            }
            return 0;
        });
        return dataArray; 
    };
    
    // FUNGSI PAGINATION
    const calculateRowsPerPage = () => {
        const tableContainer = document.getElementById(config.tableId)?.closest('.table-container');
        if (!tableContainer) return 15;
        const paginationContainer = document.getElementById('pagination-container');
        const bottomOffset = paginationContainer ? 180 : 100;
        const rowHeight = 38;
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - bottomOffset;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    };

    const setupPagination = () => {
        const paginationContainer = document.getElementById('pagination-container');
        if (!paginationContainer) return;
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage);
        
        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';
        const pageInfo = `<span class="page-info">Halaman ${currentPage} dari ${pageCount}</span>`;
        const prevBtn = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="App.changePage(-1)">Â«</button>`;
        const nextBtn = `<button class="page-btn" ${currentPage === pageCount ? 'disabled' : ''} onclick="App.changePage(1)">Â»</button>`;
        paginationContainer.innerHTML = prevBtn + pageInfo + nextBtn;
    };

    App.changePage = (direction) => {
        currentPage += direction;
        buildTable();
    };

    // ========================================================
    // ===== FUNGSI buildTable DENGAN LOGIKA FOOTER BARU =====
    // ========================================================
    const buildTable = () => {
        const table = document.getElementById(config.tableId);
        if (!table) return;
        const tableBody = document.getElementById(config.tableId + 'Body') || table.querySelector('tbody');
        const tableFoot = table.querySelector('tfoot');
        if (!tableBody) return;
        
        tableBody.innerHTML = '';
        if (tableFoot) tableFoot.innerHTML = '';

        const usePagination = !!document.getElementById('pagination-container');
        let paginatedRows = currentFilteredRows;
        
        if (usePagination) {
            rowsPerPage = calculateRowsPerPage();
            const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage) || 1;
            currentPage = Math.min(currentPage, pageCount) || 1;
            const start = (currentPage - 1) * rowsPerPage;
            paginatedRows = currentFilteredRows.slice(start, start + rowsPerPage);
            setupPagination();
        }

        if (paginatedRows.length === 0) {
            const colspan = headerCols.length + 1;
            tableBody.innerHTML = `<tr><td colspan="${colspan}">Tidak ada data yang cocok dengan filter.</td></tr>`;
        } else {
            const AppLoadPage = App.loadPage;
            const AppShowDelete = App.showDeleteConfirmation;
            
            paginatedRows.forEach((row, index) => {
                const tr = document.createElement('tr');
                const rowNumber = usePagination ? (currentPage - 1) * rowsPerPage + index + 1 : index + 1;
                const tdNum = document.createElement('td');
                tdNum.textContent = rowNumber;
                tr.appendChild(tdNum);

                headerCols.forEach(header => {
                    const cellData = row[header] ?? '';
                    const td = document.createElement('td');
                    if (header === 'Dokumen' && String(cellData).startsWith('http')) {
                        td.className = 'view-btn-container';
                        const link = document.createElement('a');
                        link.href = cellData;
                        link.target = '_blank';
                        link.className = 'action-btn view-btn';
                        link.innerHTML = '<i class="fas fa-eye"></i> Lihat';
                        td.appendChild(link);
                    } else if (header === 'Aksi') {
                        const rowIndex = row._rowIndex;
                        const source = row._source;
                        if (rowIndex !== undefined && typeof AppLoadPage === 'function' && typeof AppShowDelete === 'function') {
                            td.className = 'action-buttons';
                            let dynamicEditPage = config.editPage || 'lapbul_edit_sd'; 
                            if (config.tableId === 'lapbulKelolaTable') {
                                dynamicEditPage = (source === 'PAUD') ? 'lapbul_edit_paud' : 'lapbul_edit_sd';
                            }
                            const editButton = document.createElement('button');
                            editButton.className = 'action-btn edit-btn';
                            editButton.innerHTML = '<i class="fas fa-pencil-alt"></i> Edit';
                            editButton.addEventListener('click', (e) => {
                                App.loadPage(e, dynamicEditPage, { rowIndex: rowIndex, source: source });
                            });
                            const deleteButton = document.createElement('button');
                            deleteButton.className = 'action-btn delete-btn';
                            deleteButton.innerHTML = '<i class="fas fa-trash"></i> Hapus';
                            deleteButton.dataset.rowInfo = JSON.stringify(row);
                            deleteButton.addEventListener('click', function() {
                                App.showDeleteConfirmation(this);
                            });
                            td.appendChild(editButton);
                            td.appendChild(deleteButton);
                        } else {
                            td.textContent = '-';
                        }
                    } else {
                        td.textContent = (cellData === '' || cellData === null || cellData == 0) ? '-' : cellData;
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }
        
        // ===========================================
        // ===== LOGIKA BARU UNTUK FOOTER (NO-COLSPAN) =====
        // ===========================================
        if (tableFoot && config.footerConfig && config.footerConfig.enabled && currentFilteredRows.length > 0) {
            const totals = {};
            headerCols.forEach(h => totals[h] = 0);
            
            const labelColName = config.footerConfig.labelColumn; // misal: "Nama Lembaga"
            const sumStartColName = config.footerConfig.sumStartColumn; // misal: "Jumlah Rombel"
            const labelColIndex = headerCols.indexOf(labelColName); // misal: 0
            const sumStartIndex = headerCols.indexOf(sumStartColName); // misal: 3

            if (labelColIndex !== -1 && sumStartIndex !== -1) {
                // Hitung total dari SEMUA baris yang difilter (bukan hanya yang dipaginasi)
                currentFilteredRows.forEach(row => {
                    for (let i = sumStartIndex; i < headerCols.length; i++) {
                        const header = headerCols[i];
                        const val = getRowValue(row, header);
                        totals[header] += (parseFloat(val) || 0);
                    }
                });

                const tfootTr = document.createElement('tr');
                let footerCells = [];
                
                // 1. Sel 'No.' (Kolom 0)
                footerCells.push('<td>-</td>');
                
                // 2. Loop melalui headerCols (untuk Kolom 1 s/d ...)
                for (let i = 0; i < headerCols.length; i++) {
                    const header = headerCols[i];
                    
                    if (i === labelColIndex) {
                        // Ini kolom Label (misal: "Nama Lembaga")
                        footerCells.push(`<td style="text-align: left; font-weight: bold;">JUMLAH</td>`);
                    } else if (i < sumStartIndex) {
                        // Ini kolom non-data sebelum data dijumlahkan (misal: "Jenjang", "Status")
                        footerCells.push('<td>-</td>');
                    } else {
                        // Ini kolom data yang dijumlahkan (misal: "Jumlah Rombel", dst.)
                        footerCells.push(`<td>${totals[header]}</td>`);
                    }
                }
                
                tfootTr.innerHTML = footerCells.join('');
                tableFoot.appendChild(tfootTr);
            }
        }
        // ===========================================
        // ===== AKHIR LOGIKA FOOTER =====
        // ===========================================

    }; // END buildTable (Baru)

    // --- FILTER & EVENT LISTENERS (Tetap sama) ---
    const handleFilterChange = () => {
        applyFilters();
    };

    const debouncedFilterChange = App.debounce(handleFilterChange, 300);

    const setupEventListeners = () => {
        const searchInput = document.getElementById('searchFilter');
        if (searchInput) {
            searchInput.removeEventListener('input', debouncedFilterChange);
            searchInput.addEventListener('input', debouncedFilterChange);
        }
        
        config.filters.forEach(filterConf => {
            const dropdown = document.getElementById(filterConf.id);
            if (dropdown) {
                dropdown.removeEventListener('change', handleFilterChange);
                dropdown.addEventListener('change', handleFilterChange);
            }
        });
    };
    
    const applyFilters = () => {
        let filtered = allDataRows;
        
        if (config.initialSort && filtered.length > 0) {
            filtered = applySorting(filtered, config.initialSort); 
        }
        
        config.filters.forEach(filterConf => {
            const dropdown = document.getElementById(filterConf.id);
            if (dropdown && dropdown.value) {
                const filterValue = dropdown.value;
                const filterKey = filterConf.dataColumn;
                
                filtered = filtered.filter(row => {
                    const rowValue = getRowValue(row, filterKey);
                    return String(rowValue).trim() === filterValue;
                });
            }
        });

        currentFilteredRows = filtered;
        currentPage = 1;
        buildTable();
    };

    const populateCascadingFilters = (data, defaultValues = {}) => {
        filterData = data;
        
        config.filters.forEach(filterConf => {
            if (filterConf.type !== 'cascading-local') {
                const dropdown = document.getElementById(filterConf.id);
                const filterKey = filterConf.dataColumn || filterConf.key;
                
                if (dropdown && dropdown.tagName === 'SELECT' && filterKey) {
                    let uniqueValues;
                    if (filterConf.specialSort === 'bulan') {
                        const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                        uniqueValues = [...new Set(allDataRows.map(row => String(getRowValue(row, filterKey))))]
                            .filter(Boolean)
                            .sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
                    } else {
                         uniqueValues = [...new Set(allDataRows.map(row => String(getRowValue(row, filterKey))))].filter(Boolean).sort();
                    }
                    
                    if (filterConf.sortReverse) {
                        uniqueValues.reverse();
                    }

                    const defaultText = filterConf.defaultText || 'Semua';
                    dropdown.innerHTML = `<option value="">${defaultText}</option>`;
                    uniqueValues.forEach(value => {
                        dropdown.innerHTML += `<option value="${value}">${value}</option>`;
                    });
                    if (defaultValues && defaultValues[filterConf.id]) {
                    const defaultValue = defaultValues[filterConf.id];
                    // Cek apakah default value itu ADA di dalam <option>
                    if (uniqueValues.includes(defaultValue)) {
                        dropdown.value = defaultValue;
                    }
                }
                }
            }
        });

        config.filters.forEach(filterConf => {
            if (filterConf.type === 'cascading-local') {
                const dropdown = document.getElementById(filterConf.id);
                const parentDropdown = document.getElementById(filterConf.parent);
                
                if (dropdown && parentDropdown) {
                    const updateDropdown = () => {
                    const selectedParentValue = parentDropdown.value;
                    const keyChild = filterConf.dataColumn || filterConf.key;
                    const keyParent = filterConf.parentKey;

                    dropdown.innerHTML = `<option value="">${filterConf.defaultText || 'Semua'}</option>`;

                    let dataToProcess = allDataRows;

                    // 1. Tentukan sumber data: SEMUA data, atau data yang SUDAH DIFILTER?
                    if (selectedParentValue) {
                    dataToProcess = allDataRows.filter(row => String(getRowValue(row, keyParent)).trim() === selectedParentValue);
                    }
                    // (Jika selectedParentValue kosong, dataToProcess tetap allDataRows)

                    // 2. Ambil nilai unik dari sumber data yang sudah ditentukan
                    const uniqueChildValues = [...new Set(dataToProcess
                   .map(row => String(getRowValue(row, keyChild))))].filter(Boolean).sort();

                    // 3. Isi dropdown
                    uniqueChildValues.forEach(value => {
                    dropdown.innerHTML += `<option value="${value}">${value}</option>`;
                    });

                    handleFilterChange();
                    };
                    parentDropdown.removeEventListener('change', updateDropdown);
                    parentDropdown.addEventListener('change', updateDropdown);
                    dropdown.removeEventListener('change', handleFilterChange);
                    dropdown.addEventListener('change', handleFilterChange);
                    updateDropdown();
                }
            }
        });
    };

    const finalizeSetup = (hasError = false) => {
        const loadingEl = document.getElementById('loadingStatus');
        if (loadingEl) {
            loadingEl.style.display = 'none';
        }
        if (!hasError) {
            const wrapperEl = document.getElementById('tableWrapper');
            if (wrapperEl) {
                wrapperEl.style.display = 'block';
            }
            setupEventListeners();
            applyFilters();
        }
    };

    const serverFunction = config.serverFunction;
    const filterFunction = config.filterFunction;
    
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) { 
                document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Error dari Server: ${data.error}</p>`;
                finalizeSetup(true);
                return;
            }

            allDataRows = data.rows || data; 
            headerCols = config.displayHeaders || data.headers;

            const tableHead = document.querySelector(`#${config.tableId} thead`);
            if (tableHead) {
                tableHead.innerHTML = `<tr><th>No.</th>${headerCols.map(h => `<th>${h}</th>`).join('')}</tr>`;
            }
            
            if (filterFunction) {
                google.script.run
                    .withSuccessHandler(filterResult => {
                        if (filterResult.error) {
                            document.getElementById('loadingStatus').innerHTML = `<p style="color:orange;">Gagal memuat filter: ${filterResult.error}. Tabel ditampilkan tanpa filter.</p>`;
                            filterData = {};
                        } else {
                            populateCascadingFilters(filterResult, config.defaultValues); 
                        }
                        finalizeSetup();
                    })
                    .withFailureHandler(error => {
                        document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat filter data: ${error.message}</p>`;
                        finalizeSetup(true);
                    })
                    [filterFunction](); 
            } else {
                populateCascadingFilters(null, config.defaultValues); 
                finalizeSetup(); 
            }
        })
        .withFailureHandler(error => { 
            document.getElementById('loadingStatus').innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
            finalizeSetup(true);
        })
        [serverFunction]();
};

// ===============================================================
// === "MESIN" UTAMA UNTUK FORMULIR BERTINGKAT (VERSI FINAL) ===
// ===============================================================
App.setupTabForm = (formId) => {
    const form = document.getElementById(formId);
    if (!form) return;

    const navButtons = form.querySelectorAll('.tab-link');
    const contentDivs = form.querySelectorAll('.tab-content-form');
    let currentTabIndex = 0;
    let maxUnlockedTabIndex = 0;
    const customValidations = {};

    function updateTabStates() {
        navButtons.forEach((btn, index) => {
            btn.disabled = index > maxUnlockedTabIndex;
            btn.classList.toggle('active', index === currentTabIndex);
        });
        contentDivs.forEach((div, index) => div.classList.toggle('active', index === currentTabIndex));
        if (document.getElementById('tab-content-wrapper')) {
            document.getElementById('tab-content-wrapper').scrollTop = 0;
        }
    }

    function showTab(tabIndex) {
        if (tabIndex > maxUnlockedTabIndex && tabIndex > 0) return;
        currentTabIndex = tabIndex;
        updateTabStates();
    }

    // ========================================================
    // === PERBAIKAN TOTAL DIMULAI DI SINI ===
    // ========================================================
    function validateTab(tabIndex) {
    const tabContent = contentDivs[tabIndex];
    
    // PERBAIKAN: Hanya validasi field yang 'required' DAN 'enabled' (:not(:disabled))
    const fields = tabContent.querySelectorAll('[required]:not(:disabled)');

    let isValid = true;
    
    // Hapus glow merah HANYA dari field yang akan kita periksa
    fields.forEach(field => field.classList.remove('input-error'));

    fields.forEach(field => {
        let fieldIsValid = true;
        if (field.type === 'file') {
            if (field.files.length === 0) fieldIsValid = false;
        } 
        // ðŸ› ï¸ PERBAIKAN: Input number kosong diizinkan (dianggap 0)
        else if (!field.value && field.type !== 'number') { 
            fieldIsValid = false;
        } 
        else if (field.name === 'jumlahRombel' && field.value === '0') { // Cek Rombel 0
            fieldIsValid = false;
        }
        
        if (!fieldIsValid) {
            isValid = false;
            field.classList.add('input-error'); // Tambahkan glow merah
        }
    });
    return isValid;
    }
    // ========================================================
    // === AKHIR PERBAIKAN ===
    // ========================================================
    
    updateTabStates(); 

    form.addEventListener('click', (e) => {
        const target = e.target;
        if (target.matches('.tab-link:not(:disabled)')) { showTab(Array.from(navButtons).indexOf(target)); }
        if (target.matches('.prev-tab-btn')) { showTab(currentTabIndex - 1); }
        if (target.matches('.next-tab-btn')) {
            let validationFunction = customValidations[currentTabIndex] || (() => validateTab(currentTabIndex));
            if (validationFunction()) {
                maxUnlockedTabIndex = currentTabIndex + 1;
                showTab(currentTabIndex + 1);
            }
        }
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        // Logika submit tetap sama
    });
    
    if (!document.getElementById('form-error-style')) {
        const style = document.createElement('style');
        style.id = 'form-error-style';
        style.textContent = '.input-error { border: 2px solid var(--color-red) !important; animation: shake 0.5s; } @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }';
        document.head.appendChild(style);
    }
    
    return {
        setTabValidation: function(tabIndex, validationFunction) {
            customValidations[tabIndex] = validationFunction;
        },
        unlockTab: function(tabIndex) {
        if (tabIndex > maxUnlockedTabIndex) {
            maxUnlockedTabIndex = tabIndex;
        }
        updateTabStates();
        },
        unlockAndShowTab: function(tabIndex) {
            if (tabIndex > maxUnlockedTabIndex) {
                maxUnlockedTabIndex = tabIndex;
            }
            showTab(tabIndex);
        },
        validateTab: validateTab,
        showTab: showTab
    };
};

// ========================================================
// ===== SEMUA FUNGSI HAPUS SEKARANG ADA DI SINI =====
// ========================================================
App.showDeleteConfirmation = (button) => {
    const rowInfo = JSON.parse(button.dataset.rowInfo);
    const modal = document.getElementById('deleteModal');
    if (!modal) return;

    const modalTitle = modal.querySelector('#deleteModalTitle');
    const modalBody = modal.querySelector('#deleteModalBody');
    const confirmBtn = modal.querySelector('#confirmDeleteBtn');
    const cancelBtn = modal.querySelector('#cancelDeleteBtn');
    
    // Tentukan jenis data untuk pesan
    const isSk = rowInfo._source === 'SK';
    const isPaud = rowInfo._source === 'PAUD';
    const isSd = rowInfo._source === 'SDN' || rowInfo._source === 'SDS';
    // Modifikasi: Cek header 'Nama Sekolah' atau 'Nama Lembaga' untuk Lapbul
    const isLapbul = rowInfo.hasOwnProperty('Nama Sekolah') && (rowInfo._source === 'PAUD' || rowInfo._source === 'SD');

    let infoHtml = '';
    let deleteFunction;
    let reloadPage;
    
    if (isSk) {
        infoHtml = `<p>Apakah Anda yakin ingin menghapus data SK ini?</p>
                    <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                       Sekolah: ${rowInfo['Nama SD']}<br>
                       Tahun Ajaran: ${rowInfo['Tahun Ajaran']}
                    </div>`;
        deleteFunction = App.processDeletionSK;
        reloadPage = 'sk_kelola';
    } else if (isPaud && !isLapbul) { // PTK PAUD (MEMICU PROSES 2 LANGKAH)
        // JANGAN TAMPILKAN MODAL INI
        // Langsung panggil modal Alasan
        App.showDeleteReasonPrompt(rowInfo, App.processDeletionPtkPaud, 'ptk_kelola_paud');
        return;
    } else if (isSd) { // PTK SD
        App.showDeleteReasonPrompt(rowInfo, App.processDeletionPtkSd, 'ptk_kelola_sd');
        return;
    } else if (isLapbul) { // Laporan Bulan (PAUD/SD)
        infoHtml = `<p>Apakah Anda yakin ingin menghapus Laporan Bulan ini?</p>
                    <div style="font-weight: bold; margin: 15px 0; background:rgba(0,0,0,0.1); padding: 10px; border-radius: 5px; line-height: 1.5; text-align: left;">
                       Sekolah: ${rowInfo['Nama Sekolah']}<br>
                       Bulan/Tahun: ${rowInfo['Bulan']} ${rowInfo['Tahun']}
                    </div>`;
        deleteFunction = App.processDeletionLapbul;
        reloadPage = 'lapbul_kelola';
    } else {
        App.showAppModal('error', 'Gagal: Jenis data untuk dihapus tidak teridentifikasi.');
        return;
    }

    modalTitle.textContent = 'Konfirmasi Hapus';
    modalBody.innerHTML = infoHtml;

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.textContent = 'Ya, Hapus';
    newConfirmBtn.onclick = () => App.showDeleteCodePrompt(rowInfo, deleteFunction, reloadPage);

    cancelBtn.onclick = () => modal.classList.remove('show');
    modal.classList.add('show');
};

App.showDeleteReasonPrompt = (rowInfo, deleteFunction, reloadPage) => {
    const modal = document.getElementById('deleteModal');
    const modalTitle = modal.querySelector('#deleteModalTitle');
    const modalBody = modal.querySelector('#deleteModalBody');
    const confirmBtn = modal.querySelector('#confirmDeleteBtn');
    const cancelBtn = modal.querySelector('#cancelDeleteBtn');

    const namaPtk = rowInfo['Nama'] || 'PTK Ini'; // Ambil nama dari data

    modalTitle.textContent = 'Konfirmasi Hapus';
    modalBody.innerHTML = `<p>Tuliskan alasan menghapus <strong>${namaPtk}</strong> dari database.</p>
                           <input type="text" id="alasanHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Contoh: Pensiun, Mutasi, Resign, Meninggal, dsb.">`;

    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.textContent = 'Proses';

    newConfirmBtn.onclick = () => {
        const alasan = document.getElementById('alasanHapusInput').value;
        if (!alasan || alasan.trim() === '') {
            App.showAppModal('error', 'Alasan tidak boleh kosong.');
            return;
        }
        // Panggil Modal 2 (Kode Hapus) dan teruskan alasannya
        App.showDeleteCodePrompt(rowInfo, deleteFunction, reloadPage, alasan);
    };

    cancelBtn.onclick = () => modal.classList.remove('show');
    modal.classList.add('show');

    setTimeout(() => document.getElementById('alasanHapusInput').focus(), 100);
};

App.showDeleteCodePrompt = (rowInfo, deleteFunction, reloadPage, alasan) => {
    const modal = document.getElementById('deleteModal');
    const modalTitle = modal.querySelector('#deleteModalTitle');
    const modalBody = modal.querySelector('#deleteModalBody');
    const confirmBtn = modal.querySelector('#confirmDeleteBtn');

    modalTitle.textContent = 'Masukkan Kode Hapus';
    modalBody.innerHTML = `<p>Kode hapus dapat ditanyakan ke admin Korwil.</p>
                             <input type="password" id="kodeHapusInput" class="custom-modal-input" autocomplete="off" placeholder="Masukkan Kode Hapus">`;
    
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.textContent = 'Konfirmasi & Hapus';
    newConfirmBtn.onclick = () => deleteFunction(rowInfo, reloadPage, alasan);

    modal.querySelector('#cancelDeleteBtn').onclick = () => modal.classList.remove('show');

    setTimeout(() => document.getElementById('kodeHapusInput').focus(), 100);
};

App.processDeletionSK = (rowInfo, reloadPage) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
    App.showAppModal('loading', 'Menghapus data dan file terkait...');
    google.script.run
        .withSuccessHandler(response => {
            document.getElementById('deleteModal').classList.remove('show');
            App.showAppModal('success', response, reloadPage);
        })
        .withFailureHandler(error => App.showAppModal('error', error.message))
        .deleteSKData(rowInfo._rowIndex, deleteCode);
};

App.processDeletionPtkPaud = (rowInfo, reloadPage, alasan) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
    App.showAppModal('loading', 'Menghapus data...');
    google.script.run
        .withSuccessHandler(response => { // <--- TITIK EKSTRA SUDAH DIHAPUS
    document.getElementById('deleteModal').classList.remove('show');

    // --- TAKTIK DEKODER DIMULAI ---
    if (response && response.error) {
        // Jika server mengirim objek { error: "..." }
        App.showAppModal('error', response.error); 
    } else {
        // Jika server mengirim string sukses
        App.showAppModal('success', response, reloadPage); 
    }
        })
        .withFailureHandler(error => App.showAppModal('error', error.message))
        .deletePtkPaudData(rowInfo._rowIndex, deleteCode, alasan);
};

App.processDeletionPtkSd = (rowInfo, reloadPage, alasan) => { // <-- TAMBAHKAN 'alasan'
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
    App.showAppModal('loading', 'Menghapus data...');
    google.script.run
        .withSuccessHandler(response => {
            document.getElementById('deleteModal').classList.remove('show');
            // Tambahkan penanganan error jika server mengembalikan objek { error: "..." }
            if (response && response.error) {
                App.showAppModal('error', response.error); 
            } else {
                App.showAppModal('success', response, reloadPage); 
            }
        })
        .withFailureHandler(error => App.showAppModal('error', error.message))
        .deletePtkSdData(rowInfo._rowIndex, rowInfo._source, deleteCode, alasan); // <-- KIRIM 'alasan'
};

App.processDeletionLapbul = (rowInfo, reloadPage) => {
    const deleteCode = document.getElementById('kodeHapusInput').value;
    if (!deleteCode) { App.showAppModal('error', 'Kode hapus tidak boleh kosong.'); return; }
    App.showAppModal('loading', 'Menghapus data dan file terkait...');
    google.script.run
        .withSuccessHandler(response => {
            document.getElementById('deleteModal').classList.remove('show');
            App.showAppModal('success', response, reloadPage);
        })
        .withFailureHandler(error => App.showAppModal('error', error.message))
        .deleteLapbulData(rowInfo._rowIndex, rowInfo._source, deleteCode);
};
// ========================================================
// ===== AKHIR DARI BLOK FUNGSI HAPUS =====
// ========================================================

/**
 * ===================================================================
 * ======================= 2. SEMUA FUNGSI INISIALISASI HALAMAN ======
 * ===================================================================
 */

function initMenuPage() {
    // Fungsi ini berlaku untuk semua halaman menu yang menggunakan .menu-button
    document.querySelectorAll('#main-content .menu-button').forEach((button, index) => {
        button.style.animationDelay = `${index * 0.07}s`;
    });
}

function initSkUnggahPage() {
    const form = document.getElementById('manualUploadForm');
    if (!form) return;

    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = document.getElementById(elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    google.script.run
        .withSuccessHandler(optionsObject => {
            populateSingleDropdown("namaSD", optionsObject["Nama SD"], "Pilih Sekolah");
            populateSingleDropdown("tahunAjaran", optionsObject["Tahun Ajaran"], "Pilih Tahun Ajaran");
            populateSingleDropdown("semester", optionsObject["Semester"], "Pilih Semester");
            populateSingleDropdown("kriteriaSK", optionsObject["Kriteria SK"], "Pilih Kriteria SK");
            
            // --- TAMBAHKAN 2 BARIS INI ---
            document.getElementById('skeleton-loader').style.display = 'none';
            document.getElementById('form-content').style.display = 'block';
            // --- AKHIR TAMBAHAN ---
        })
        .withFailureHandler(error => {
            console.error('Gagal memuat opsi form SK:', error);
            // --- TAMBAHKAN 2 BARIS INI JUGA ---
            document.getElementById('skeleton-loader').style.display = 'none';
            document.getElementById('form-content').style.display = 'block';
            // --- AKHIR TAMBAHAN ---
        })
        .getMasterSkOptions();

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Sedang memproses dan mengunggah file...');
        const file = document.getElementById('fileUpload').files[0];
        if (!file || file.size > 1024 * 1024) {
            App.showAppModal('error', 'Unggah scan file format PDF ukuran maksimal 1 MB.');
            submitButton.disabled = false;
            return;
        }
        const reader = new FileReader();
        reader.onload = event => {
            const fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            const formData = {
                namaSD: form.namaSD.value,
                tahunAjaran: form.tahunAjaran.value,
                semester: form.semester.value,
                kriteriaSK: form.kriteriaSK.value,
                nomorSK: form.nomorSK.value,
                tanggalSK: form.tanggalSK.value,
                fileData: fileData
            };
            google.script.run
                .withSuccessHandler(response => App.showAppModal('success', response, 'sk_riwayat'))
                .withFailureHandler(error => {
                    App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                    submitButton.disabled = false;
                })
                .processManualForm(formData);
        };
        reader.readAsDataURL(file);
    });
}

function initSkRiwayatPage() {
    App.initializeGenericTablePage({
        tableId: 'riwayatTable', 
        serverFunction: 'getSKRiwayatData', 
        // Menggunakan filter mandiri (Non-Cascading)
        filters: [ 
            // Tahun Ajaran
            { id: 'filterTahun', dataColumn: 'Tahun Ajaran', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            
            // Semester
            { id: 'filterSemester', dataColumn: 'Semester', type: 'dropdown', defaultText: 'Semua Semester' },
            
            // Nama Sekolah
            { id: 'filterNamaSekolah', dataColumn: 'Nama SD', type: 'dropdown', defaultText: 'Semua Sekolah' }
        ]
    });
}

function initSkStatusPage() {
    // Panggil fungsi generik dengan konfigurasi yang tepat
    App.initializeGenericTablePage({
        tableId: 'statusTable',
        serverFunction: 'getSKStatusData', // Memanggil fungsi baru yang sudah kita perbaiki
        filterConfig: [] // Halaman ini tidak memiliki filter, jadi array-nya kosong
    });
}

function initSkKelolaPage() {
    App.initializeGenericTablePage({
        tableId: 'kelolaTable', // ID tabel di page_sk_kelola.html
        serverFunction: 'getSKKelolaData', // Fungsi server untuk Kelola Data SK
        editPage: 'sk_edit', // KUNCI PERBAIKAN: Menambahkan halaman tujuan edit
        filters: [
            // Filter Tahun Ajaran
            { 
                id: 'filterTahun', 
                dataColumn: 'Tahun Ajaran', 
                type: 'dropdown', 
                sortReverse: true, 
                defaultText: 'Semua Tahun' 
            },
            
            // Filter Semester
            { 
                id: 'filterSemester', 
                dataColumn: 'Semester', 
                type: 'dropdown', 
                defaultText: 'Semua Semester' 
            },
            
            // Filter Nama Sekolah
            { 
                id: 'filterNamaSekolah', 
                dataColumn: 'Nama SD', 
                type: 'dropdown', 
                defaultText: 'Semua Sekolah' 
            }
        ]
    });
}

function initSkEditPage(params) {
    const rowIndex = params ? params.rowIndex : null;
    if (!rowIndex) {
        document.getElementById('main-content').innerHTML = `<p style="color:red;">Error: ID baris tidak ditemukan.</p>`;
        return;
    }
    const form = document.getElementById('skEditForm');
    const loadingDiv = document.getElementById('loading-data');
    form.querySelector('#rowIndex').value = rowIndex;
    google.script.run.withSuccessHandler(options => {
        google.script.run.withSuccessHandler(rowData => {
            const fieldMapping = {
                'Nama SD': 'namaSD', 'Tahun Ajaran': 'tahunAjaran', 'Semester': 'semester',
                'Kriteria SK': 'kriteriaSK', 'Nomor SK': 'nomorSK', 'Tanggal SK': 'tanggalSK'
            };
            for (const key in options) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const select = document.getElementById(elementId);
                    if (select && Array.isArray(options[key])) {
                        select.innerHTML = options[key].map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    }
                }
            }
            for (const key in rowData) {
                const elementId = fieldMapping[key];
                if (elementId) {
                    const field = document.getElementById(elementId);
                    if (field) {
                        const savedValue = rowData[key];
                        if (field.tagName === 'SELECT') {
                            field.value = savedValue;
                            let optionExists = Array.from(field.options).some(opt => opt.value === savedValue);
                            if (!optionExists && savedValue) {
                                const newOption = new Option(savedValue, savedValue);
                                field.add(newOption);
                                field.value = savedValue;
                            }
                        }
                        else if (key === 'Tanggal SK' && savedValue) {
                            const parts = savedValue.split('/');
                            if (parts.length === 3) {
                                field.value = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                            } else {
                                field.value = savedValue;
                            }
                        } else {
                            field.value = savedValue;
                        }
                    }
                }
            }
            const fileLink = rowData['Dokumen'];
            document.getElementById('existingFileLink').innerHTML = fileLink ? `<a href="${fileLink}" target="_blank">Lihat File Saat Ini</a>` : 'Tidak ada file.';
            
            loadingDiv.style.display = 'none';
            form.style.display = 'block';
        }).withFailureHandler(err => App.showAppModal('error', `Gagal memuat data baris: ${err.message}`)).getSKDataByRow(rowIndex);
    }).withFailureHandler(err => App.showAppModal('error', `Gagal memuat opsi dropdown: ${err.message}`)).getMasterSkOptions();
 
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');
        const formDataObj = {
            rowIndex: form.rowIndex.value, 'Semester': document.getElementById('semester').value,
            'Kriteria SK': document.getElementById('kriteriaSK').value, 'Nomor SK': document.getElementById('nomorSK').value,
            'Tanggal SK': document.getElementById('tanggalSK').value,
        };
        const fileInput = document.getElementById('fileSK');
        const file = fileInput.files[0];
        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => App.showAppModal('success', res, 'sk_kelola'))
                .withFailureHandler(err => {
                    App.showAppModal('error', err.message);
                    submitButton.disabled = false;
                })
                .updateSKData(data);
        };
        if (file) {
            if (file.size > 1024 * 1024) {
                App.showAppModal('error', 'Ukuran file baru tidak boleh lebih dari 1 MB.');
                submitButton.disabled = false; return;
            }
            const reader = new FileReader();
            reader.onload = function (event) {
                formDataObj.fileData = {
                    fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1]
                };
                sendData(formDataObj);
            };
            reader.readAsDataURL(file);
        } else {
            sendData(formDataObj);
        }
    });
}

function initSkArsipPage() {
    let FOLDER_IDS = {}; 
    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) { 
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;
            if (index < breadcrumbTrail.length - 1) {
                span.onclick = () => {
                    breadcrumbTrail.length = index; 
                    if (item.type === 'root') {
                        renderTahunAjaranView();
                    } else {
                        renderFolderView(item.id, item.name);
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderTahunAjaranView() {
        viewContainer.classList.remove('view-container-scrollable');
        breadcrumbTrail = [{ name: 'Tahun Ajaran', type: 'root', id: FOLDER_IDS.MAIN_SK }]; 
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) { 
                viewContainer.innerHTML = '<p>Tidak ada folder tahun ajaran ditemukan.</p>'; 
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-calendar-alt"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(FOLDER_IDS.MAIN_SK);
    }

    function renderFolderView(folderId, folderName) {
        viewContainer.classList.remove('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
            breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) {
                renderFileView(folderId, folderName);
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.sort((a, b) => a.name.localeCompare(b.name)).forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(folderId);
    }

    function renderFileView(folderId, folderName) {
        viewContainer.classList.add('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
             breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(folderId);
    }
    
    showLoading();
    google.script.run
        .withSuccessHandler(ids => {
            FOLDER_IDS.MAIN_SK = ids.MAIN_SK;
            renderTahunAjaranView();
        })
        .withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat konfigurasi folder: ${err.message}</p>`;
        })
        .getSkArsipFolderIds();
}

function initLapbulUnggahPage() {
    initMenuPage(); 
    google.script.run
        .withSuccessHandler(infoItems => App.setupInfoDropdown('infoDropdownBtn', 'infoDropdownContent', infoItems))
        .withFailureHandler(err => App.setupInfoDropdown('infoDropdownBtn', 'infoDropdownContent', []))
        .getLapbulInfo();
}

App.calculateTotalMuridPaud = (form) => {
    let totalUsia = 0;
    let totalRombel = 0;
    
    // Hitung Total Usia
    form.querySelectorAll('#dataMurid [name^="murid_"]').forEach(input => {
        totalUsia += parseInt(input.value, 10) || 0;
    });

    // Hitung Total Rombel (Kelompok A dan B)
    totalRombel += parseInt(form.querySelector('[name="kelompok_A_L"]').value, 10) || 0;
    totalRombel += parseInt(form.querySelector('[name="kelompok_A_P"]').value, 10) || 0;
    totalRombel += parseInt(form.querySelector('[name="kelompok_B_L"]').value, 10) || 0;
    totalRombel += parseInt(form.querySelector('[name="kelompok_B_P"]').value, 10) || 0;

    // Ambil elemen validasi
    const totalUsiaEl = document.getElementById('totalUsia') || document.getElementById('edit-totalUsia');
    const totalRombelEl = document.getElementById('totalRombel') || document.getElementById('edit-totalRombel');
    const statusEl = document.getElementById('murid-validation-status') || document.getElementById('edit-murid-validation-status');

    // Perbarui tampilan angka
    if (totalUsiaEl) totalUsiaEl.textContent = totalUsia;
    if (totalRombelEl) totalRombelEl.textContent = totalRombel;
    
    // === LOGIKA VALIDASI BARU ===
    if (statusEl) {
        statusEl.classList.remove('status-ok', 'status-error');
        if (totalUsia !== totalRombel) {
            statusEl.textContent = "Jumlah TIDAK SAMA!";
            statusEl.classList.add('status-error');
        } else if (totalUsia === 0) {
            statusEl.textContent = "Isikan jumlah murid.";
            statusEl.classList.add('status-ok');
        } else {
            statusEl.textContent = "Jumlah SAMA!";
            statusEl.classList.add('status-ok');
        }
    }
    // === AKHIR LOGIKA VALIDASI BARU ===
    
    return { totalUsia, totalRombel };
};

function initLapbulFormPaudPage(params) {
    const form = document.getElementById('lapbulFormPaud');
    if (!form) return;

    const formLogic = App.setupTabForm('lapbulFormPaud');

    const bulanSelect = form.querySelector('[name="laporanBulan"]');
    const tahunSelect = form.querySelector('[name="tahun"]');
    const jenjangSelect = document.getElementById('jenjang');
    const namaSekolahSelect = document.getElementById('namaSekolah');
    const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const d = new Date();
    const currentYear = d.getFullYear();
    const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
    bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
    tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');

    
    // --- 1. VALIDASI KUSTOM TAB 1 (DATA LEMBAGA) ---
    formLogic.setTabValidation(0, () => {
    let isValid = true;
    const tabContent = document.getElementById('dataSekolah');
    // Hapus semua indikator error sebelumnya
    tabContent.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
    
    // Hanya periksa elemen yang required
    const fields = tabContent.querySelectorAll('[required]');

    fields.forEach(field => {
        let fieldIsValid = true;
        const isRombel = field.name === 'jumlahRombel';

        // Check for emptiness or invalid select default value
        if (!field.value || field.value === "" || field.value === "-- Pilih Jenjang Dahulu --" || field.value === "-- Pilih Lembaga --") {
            
            // Khusus Rombel: Lolos jika nilainya adalah 0 (meskipun secara teknis dianggap "empty" oleh browser)
            if (isRombel && field.value === "0") {
                fieldIsValid = true;
            } else {
                fieldIsValid = false;
            }
        } 
        
        // Terapkan glow merah jika gagal, tetapi jangan tampilkan popup global
        if (!fieldIsValid) {
            isValid = false;
            field.classList.add('input-error');
        } else {
            field.classList.remove('input-error');
        }
    });

    if (!isValid) {
        // PERUBAHAN: Menghilangkan popup untuk Tab 1 (Hanya glow merah)
        return false;
    }

    return true;
    });

    // --- 2. VALIDASI KUSTOM TAB 2 (DATA MURID) ---
    formLogic.setTabValidation(1, () => {
        // Panggil fungsi global yang sudah kita perbaiki
        const { totalUsia, totalRombel } = App.calculateTotalMuridPaud(form);
        const statusEl = document.getElementById('murid-validation-status');

        // Skenario 2a: Total Murid 0 (Konfirmasi)
        if (totalUsia === 0) {
            const confirmModal = document.getElementById('deleteModal'); // Menggunakan modal yang ada
            confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data Siswa';
            confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah siswa (Total: 0). Tetap lanjut?</p>';
            
            const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
            const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

            confirmBtn.textContent = 'Lanjut';
            cancelBtn.textContent = 'Kembali';

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                 confirmModal.classList.remove('show');
                 formLogic.unlockAndShowTab(2); // Lanjut ke Tab PTK
            };
            cancelBtn.onclick = () => confirmModal.classList.remove('show');

            confirmModal.classList.add('show');
            return false; // Kembali ke tab murid dulu
        }

        // Skenario 2b: Jumlah Murid Tidak Sama (Gagal)
        if (totalUsia !== totalRombel) {
            // Status sudah diatur oleh App.calculateTotalMuridPaud, kita tinggal tampilkan popup
            App.showAppModal('error', 'Kesalahan Validasi: Total Murid Menurut Usia harus SAMA dengan Total Murid Menurut Rombel.');
            return false;
        }

        // Skenario 2c: Valid dan Sama (Lolos)
        return true;
    });

    // --- 3. VALIDASI KUSTOM TAB 3 (DATA PTK) ---
    formLogic.setTabValidation(2, () => {
        const dataPtkContainer = document.getElementById('dataPtk');
        
        // KUNCI PERBAIKAN POIN 2: Validasi Kepala Sekolah PAUD
        const kepsekASN = parseInt(dataPtkContainer.querySelector('[name="kepsek_ASN"]').value, 10) || 0;
        const kepsekNonASN = parseInt(dataPtkContainer.querySelector('[name="kepsek_Non_ASN"]').value, 10) || 0;
        const totalKepsek = kepsekASN + kepsekNonASN;
        
        if (totalKepsek > 1) {
            App.showAppModal('error', 'Jumlah Kepala Sekolah maksimal 1.');
            return false;
        }

        // Hitung Total Semua PTK (untuk Konfirmasi Lanjut)
        const ptkInputs = dataPtkContainer.querySelectorAll('input[type="number"]');
        const totalPtk = Array.from(ptkInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        
        // Skenario: Total PTK 0 (Konfirmasi Lanjut)
        if (totalPtk === 0) {
            const confirmModal = document.getElementById('deleteModal');
            confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data PTK';
            confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah PTK (Total: 0). Tetap lanjut?</p>';
            
            const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
            const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

            confirmBtn.textContent = 'Lanjut';
            cancelBtn.textContent = 'Kembali';

            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

            newConfirmBtn.onclick = () => {
                 confirmModal.classList.remove('show');
                 formLogic.unlockAndShowTab(3);
            };
            cancelBtn.onclick = () => confirmModal.classList.remove('show');

            confirmModal.classList.add('show');
            return false;
        }
        
        return true;
    });

    form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Asumsikan semua tab sebelumnya sudah divalidasi dan dilewati.
    
    const submitButton = form.querySelector('#finalSubmitBtn'); // Menggunakan ID yang lebih spesifik
    submitButton.disabled = true;
    App.showAppModal('loading', 'Mengirim Laporan Bulanan...');

    const fileInput = document.getElementById('fileLapbul');
    const file = fileInput.files[0];
    const MAX_SIZE = 300 * 1024; // 300 KB

    if (!file) {
         // Harusnya tidak terjadi karena input file memiliki attribute required, tapi sebagai fallback
         App.showAppModal('error', 'Unggah Dokumen: File Laporan Bulan wajib dilampirkan.');
         submitButton.disabled = false;
         return;
    }

    if (file.size > MAX_SIZE) {
        // PERBAIKAN POIN 2: Popup jika file melebihi batas
        App.showAppModal('error', 'Ukuran file melebihi batas maksimal 300 KB. Harap kompresi file PDF Anda.');
        submitButton.disabled = false;
        return;
    }
    
    const formData = new FormData(form);
    const payload = Object.fromEntries(formData.entries());
    
    // Ambil nilai dari field yang terkunci (atau yang namanya berbeda dari input)
    payload.laporanBulan = form.querySelector('[name="laporanBulan"]').value;
    payload.tahun = form.querySelector('[name="tahun"]').value;
    payload.jenjang = form.querySelector('[name="jenjang"]').value;
    payload.namaSekolah = form.querySelector('[name="namaSekolah"]').value;

    const sendData = (data) => {
        google.script.run
            .withSuccessHandler(res => {
                if (res && res.error) {
                     App.showAppModal('error', res.error);
                     submitButton.disabled = false;
                } else {
                     // PERBAIKAN POIN 2: Redirect ke Riwayat Pengiriman
                     App.showAppModal('success', 'Laporan berhasil terkirim!', 'lapbul_riwayat');
                }
            })
            .withFailureHandler(err => {
                App.showAppModal('error', `Gagal mengirim laporan: ${err.message}`);
                submitButton.disabled = false;
            })
            .processLapbulFormPaud(data);
    };

    const reader = new FileReader();
    reader.onload = function(event) {
        payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
        sendData(payload);
    };
    reader.readAsDataURL(file);
    });
    
    // Tambahkan event listener untuk update validasi murid secara real-time
    form.querySelector('#dataMurid').addEventListener('input', () => {
        App.calculateTotalMuridPaud(form);
    });

    google.script.run
    .withSuccessHandler(schoolLists => {
        const availableJenjangs = Object.keys(schoolLists).filter(k => schoolLists[k] && schoolLists[k].length > 0);
        
        jenjangSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jenjang --</option>';
        namaSekolahSelect.innerHTML = '<option value="" disabled selected>-- Pilih Jenjang Dahulu --</option>';

        availableJenjangs.forEach(j => {
            jenjangSelect.add(new Option(j, j));
        });

        const handleJenjangChange = () => {
            const selectedJenjang = jenjangSelect.value;
            const schoolList = schoolLists[selectedJenjang] || []; 
            
            namaSekolahSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
            
            schoolList.forEach(school => {
                namaSekolahSelect.add(new Option(school, school));
            });
            namaSekolahSelect.disabled = false;
        };
        
        jenjangSelect.addEventListener('change', handleJenjangChange);
        
        // --- TAMBAHKAN 2 BARIS INI ---
        if(form.querySelector('#skeleton-loader')) form.querySelector('#skeleton-loader').style.display = 'none';
        if(form.querySelector('#form-content')) form.querySelector('#form-content').style.display = 'flex';
        // --- AKHIR TAMBAHAN ---
        
        // Inisialisasi awal validasi murid
        form.querySelector('#dataMurid').dispatchEvent(new Event('input'));
        
        document.getElementById('appModal').classList.remove('show');
    })
    .withFailureHandler(err => {
        App.showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`);
        // --- TAMBAHKAN 2 BARIS INI JUGA ---
        if(form.querySelector('#skeleton-loader')) form.querySelector('#skeleton-loader').style.display = 'none';
        if(form.querySelector('#form-content')) form.querySelector('#form-content').style.display = 'flex';
        // --- AKHIR TAMBAHAN ---
    })
    .getPaudSchoolLists();
}

function initLapbulFormSdPage() {
    const form = document.getElementById('lapbulFormSd');
    if (!form) return;

    // 1. Panggil App.setupTabForm untuk tab utama (Tab 1-4)
    const formLogic = App.setupTabForm('lapbulFormSd'); 

    // ==========================================================
    // === FIX 2: Pindahkan submit listener ke sini ===
    // ==========================================================
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // Mencegah halaman reload
        
        // Cek validasi tab terakhir sebelum kirim
        if (!formLogic.validateTab(0)) { App.showAppModal('error', 'Data Sekolah (Tab 1) belum lengkap.'); formLogic.showTab(0); return; }
        if (!formLogic.validateTab(1)) { formLogic.showTab(1); return; } // Pesan error sudah diatur di validasi
        if (!formLogic.validateTab(2)) { App.showAppModal('error', 'Data PTK (Tab 3) belum lengkap.'); formLogic.showTab(2); return; }

        const submitButton = form.querySelector('#finalSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Mengirim Laporan Bulanan SD...');

        const fileInput = document.getElementById('fileLapbul');
        const file = fileInput.files[0];
        const MAX_SIZE = 300 * 1024; // 300 KB

        if (!file) {
             App.showAppModal('error', 'Unggah Dokumen: File Laporan Bulan wajib dilampirkan.');
             submitButton.disabled = false;
             return;
        }

        if (file.size > MAX_SIZE) {
            App.showAppModal('error', 'Ukuran file melebihi batas maksimal 300 KB. Harap kompresi file PDF Anda.');
            submitButton.disabled = false;
            return;
        }
        
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        
        // Ambil data dari field yang di-disable (jika perlu)
        payload.Bulan = form.querySelector('[name="Bulan"]').value;
        payload.Tahun = form.querySelector('[name="Tahun"]').value;
        payload.Status = form.querySelector('[name="Status"]').value;
        payload['Nama Sekolah'] = form.querySelector('[name="Nama Sekolah"]').value;

        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(res => {
                    if (res && res.error) {
                         App.showAppModal('error', res.error);
                         submitButton.disabled = false;
                    } else {
                         App.showAppModal('success', 'Laporan berhasil terkirim!', 'lapbul_riwayat');
                    }
                })
                .withFailureHandler(err => {
                    App.showAppModal('error', `Gagal mengirim laporan: ${err.message}`);
                    submitButton.disabled = false;
                })
                .processLapbulFormSd(data); // <-- Memanggil fungsi SD yang benar
        };

        const reader = new FileReader();

// [BAGIAN SUKSES]
reader.onload = function(event) {
    payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
    sendData(payload); // Kirim data HANYA jika file sukses dibaca
};

// [INI TAMBAHAN PENTINGNYA]
reader.onerror = function(error) {
    // Tampilkan pesan error dan aktifkan tombol kembali
    App.showAppModal('error', 'Gagal membaca file. Pastikan file tidak rusak dan coba lagi.');
    submitButton.disabled = false; 
    console.error('FileReader Error:', error); // Untuk debugging
};

// Baru jalankan pembacaan file di akhir
reader.readAsDataURL(file);
    });
    // ==========================================================
    // =================== AKHIR BLOK SUBMIT ==================
    // ==========================================================

    // 2. Fungsi Bantuan untuk dropdown Bulan/Tahun
    function setupInitialDropdowns() {
        // ========================================================
        // INI ADALAH PERBAIKANNYA:
        // Mencari [name="Bulan"] (bukan "laporanBulan")
        // Mencari [name="Tahun"] (bukan "tahun")
        const bulanSelect = form.querySelector('[name="Bulan"]');
        const tahunSelect = form.querySelector('[name="Tahun"]');
        // ========================================================

        const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const d = new Date();
        const currentYear = d.getFullYear();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        
        // Ditambahkan pengecekan (if) agar lebih aman
        if (bulanSelect) {
            bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
        }
        if (tahunSelect) {
            tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
        }
    }

    // 3. Fungsi Bantuan untuk Validasi Total Murid
    function checkKelasTotals(kelas) {
        const kelasContent = document.getElementById(`kelas-content-${kelas}`);
        if (!kelasContent) return true; // Jika konten kelas tidak ada, anggap valid

        // === LOGIKA BARU DIMULAI ===
        // 1. Ambil nilai dropdown 'Jumlah Rombel'
        const rombelDropdown = kelasContent.querySelector('.rombel-toggle');
        const jumlahRombelDipilih = parseInt(rombelDropdown.value, 10);
        // === LOGIKA BARU SELESAI ===

        const rombelInputs = kelasContent.querySelectorAll('.rombel-container input[type="number"]');
        const agamaInputs = kelasContent.querySelectorAll('.agama-container-grid input[type="number"]');

        const totalRombel = Array.from(rombelInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        const totalAgama = Array.from(agamaInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);

        const statusEl = document.getElementById(`murid-validation-status-${kelas}`);
        document.getElementById(`totalRombel-${kelas}`).textContent = totalRombel;
        document.getElementById(`totalAgama-${kelas}`).textContent = totalAgama;

        // === VALIDASI BARU ===

        // Aturan 1: Jika dropdown rombel DIPILIH (bukan 0)
        if (jumlahRombelDipilih > 0) {
            // Aturan 1a: Total murid rombel tidak boleh 0
            if (totalRombel === 0) {
                statusEl.textContent = "Isikan jumlah murid per rombel.";
                statusEl.className = 'status-error';
                return false; // Gagal
            }
            // Aturan 1b: Total murid agama tidak boleh 0
            if (totalAgama === 0) {
                statusEl.textContent = "Isikan jumlah murid menurut agama.";
                statusEl.className = 'status-error';
                return false; // Gagal
            }
        }

        // Aturan 2: (Aturan Lama) Total Rombel HARUS SAMA DENGAN Total Agama
        if (totalRombel !== totalAgama) {
            statusEl.textContent = "Jumlah TIDAK SAMA!";
            statusEl.className = 'status-error';
            return false; // Gagal
        }

        // Aturan 3: (Aturan Baru) Jika rombel 0, total murid juga harus 0
        if (jumlahRombelDipilih === 0 && (totalRombel > 0 || totalAgama > 0)) {
            statusEl.textContent = "Rombel 0, tapi Jml Murid ada";
            statusEl.className = 'status-error';
            return false; // Gagal
        }
        
        // === AKHIR VALIDASI BARU ===

        // Jika lolos semua aturan
        statusEl.textContent = "Jumlah Sesuai";
        statusEl.className = 'status-ok';
        return true;
    }
    
    // 4. Fungsi Bantuan untuk Generate HTML (SAMA SEPERTI FUNGSI TAMBAH)
    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        const agamaDefault = { 'Islam': 'Ada', 'Kristen': 'Tidak Ada', 'Katolik': 'Tidak Ada', 'Hindu': 'Tidak Ada', 'Buddha': 'Tidak Ada', 'Konghucu': 'Tidak Ada' };

        let rombelInputsHTML = `
            <div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;">
                <label class="rombel-group-label">Kelas ${kelas}</label>
                <div class="murid-input-pair">
                    <div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_tunggal_L" min="0" required></div>
                    <div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_tunggal_P" min="0" required></div>
                </div>
            </div>
        `;
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_L" min="0" required></div><div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_P" min="0" required></div></div></div>`;
        }
        
        let agamaInputsHTML = '<div class="agama-container-grid">';
        
        for (const ag of agama) {
            const agId = ag.toLowerCase().replace(/\s/g, '_');
            const defaultValue = agamaDefault[ag] || 'Tidak Ada';
            const isVisible = defaultValue === 'Ada';

            agamaInputsHTML += `
                <div class="agama-input-group">
                    <label class="agama-group-label">${ag}</label>
                    <select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}">
                        <option value="Ada" ${defaultValue === 'Ada' ? 'selected' : ''}>Ada</option>
                        <option value="Tidak Ada" ${defaultValue === 'Tidak Ada' ? 'selected' : ''}>Tidak Ada</option>
                    </select>
                    <div class="murid-input-pair" id="agama-input-${kelas}-${agId}" style="display: ${isVisible ? 'flex' : 'none'}; margin-top: 10px;">
                        <div class="form-group"><label>L</label><input type="number" name="k${kelas}_agama_${agId}_L" min="0" required></div>
                        <div class="form-group"><label>P</label><input type="number" name="k${kelas}_agama_${agId}_P" min="0" required></div>
                    </div>
                </div>
            `;
        }
        agamaInputsHTML += '</div>';

        const validationHTML = `<div id="murid-validation-feedback-${kelas}" class="murid-validation-container" style="margin-top: 20px;"><p>Total per Rombel: <span id="totalRombel-${kelas}">0</span></p><p>Total per Agama: <span id="totalAgama-${kelas}">0</span></p><p id="murid-validation-status-${kelas}" class="status-ok">Jumlah Sesuai</p></div>`;
        
        let footerHTML = '';
        if (kelas === 1) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn prev-tab-btn" style="width: auto;">Sebelumnya</button></div>`;
        } else if (kelas === 6) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn next-tab-btn" style="width: auto; margin-left: auto;">Berikutnya</button></div>`;
        }
        
        // FIX: Hapus submit listener dari sini
        return `
            <fieldset class="ptk-fieldset"><legend>Menurut Rombel</legend><div class="form-group form-group-rombel-toggle" style="margin-bottom: 20px;"><label>Jumlah Rombel</label><select class="rombel-toggle" name="k${kelas}_jumlah_rombel" data-kelas="${kelas}"><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="0">0</option></select></div><h4 class="sub-section-title">Jml Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;">${rombelInputsHTML}</div></fieldset>
            <fieldset class="ptk-fieldset" style="margin-top: 20px;"><legend>Menurut Agama</legend>${agamaInputsHTML}</fieldset>
            ${validationHTML}${footerHTML}
        `;
    }

    // 5. Fungsi Bantuan untuk Setup Logika Tab 2 (Murid)
    function setupDataMurid() {
        const tabsContainer = document.getElementById('kelas-tabs');
        const contentContainer = document.getElementById('kelas-content-container');
        
        // KOSONGKAN SEBELUM MENGISI (PENTING)
        tabsContainer.innerHTML = '';
        contentContainer.innerHTML = '';

        for (let i = 1; i <= 6; i++) {
            
            // --- INI ADALAH SENJATA YANG HILANG (G61) ---
            tabsContainer.innerHTML += `<button type="button" class="tab-link ${i === 1 ? 'active' : ''}" data-kelas="${i}">Kelas ${i}</button>`;
            // --- AKHIR SENJATA ---

            const content = document.createElement('div');
            content.id = `kelas-content-${i}`;
            content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i); // Memanggil fungsi generateKelasHTML
            content.dataset.kelas = i;
            contentContainer.appendChild(content);

            const defaultRombelSelect = content.querySelector('.rombel-toggle');
            const defaultRombelCount = parseInt(defaultRombelSelect.value, 10);
            if (defaultRombelCount === 1) document.getElementById(`rombel-${i}-Tunggal`).style.display = 'block';
            
            checkKelasTotals(i);
        }

        // Pastikan event listener hanya dipasang sekali
        if (!tabsContainer.dataset.listener) {
            tabsContainer.addEventListener('click', function(e) { 
                const clickedTab = e.target.closest('.tab-link');
                if (clickedTab) {
                    e.stopPropagation();
                    tabsContainer.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
                    contentContainer.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
                    
                    clickedTab.classList.add('active');
                    document.getElementById(`kelas-content-${clickedTab.dataset.kelas}`).style.display = 'block';
                }
            });
            tabsContainer.dataset.listener = 'true';
        }
        
        if (!contentContainer.dataset.listener) {
            contentContainer.addEventListener('input', function(e) {
                if (e.target.type === 'number') {
                    const kelasContent = e.target.closest('.tab-content');
                    if (kelasContent) {
                        const kelas = kelasContent.dataset.kelas;
                        checkKelasTotals(kelas);
                    }
                }
            });

            contentContainer.addEventListener('change', function(e) {
                const target = e.target;
                const kelasContent = e.target.closest('.tab-content');
                const kelas = target.dataset.kelas || (kelasContent ? kelasContent.dataset.kelas : null);
                if (!kelas) return;

                if (target.classList.contains('rombel-toggle')) {
                    const count = parseInt(target.value, 10);
                    document.querySelectorAll(`#rombel-container-${kelas} .rombel-input-group`).forEach(el => el.style.display = 'none');
                    if (count === 1) { document.getElementById(`rombel-${kelas}-Tunggal`).style.display = 'block'; }
                    else if (count > 1) { ['A', 'B', 'C'].slice(0, count).forEach(r => document.getElementById(`rombel-${kelas}-${r}`).style.display = 'block'); }
                    checkKelasTotals(kelas);
                }
                if (target.classList.contains('agama-toggle')) {
                    document.getElementById(`agama-input-${target.dataset.kelas}-${target.dataset.agama}`).style.display = target.value === 'Ada' ? 'flex' : 'none';
                }
            });
            contentContainer.dataset.listener = 'true';
        }
    }

    // 6. Fungsi Bantuan untuk Setup Logika Tab 1 (Sekolah)
    function setupDataSekolah(schoolLists) {
        // DIUBAH: Mencari [name="Status"]
        const statusSekolah = form.querySelector('[name="Status"]');
        const namaSekolah = document.getElementById('namaSekolah');
        
        // Hapus listener lama jika ada
        const newStatusSekolah = statusSekolah.cloneNode(true);
        statusSekolah.parentNode.replaceChild(newStatusSekolah, statusSekolah);

        newStatusSekolah.addEventListener('change', function() {
            const status = this.value;
            const schoolList = status === 'Negeri' ? schoolLists.SDN : schoolLists.SDS;
            
            namaSekolah.innerHTML = '<option value="" disabled selected>-- Pilih Sekolah --</option>';
            if(schoolList) schoolList.forEach(school => namaSekolah.add(new Option(school, school)));
            namaSekolah.disabled = false;
        });
    }
    
    // ==========================================================
    // === FIX 1: Panggil fungsi statis SEBELUM server call ===
    // ==========================================================
    setupInitialDropdowns();
    setupDataMurid();
    // ==========================================================

    google.script.run
        .withSuccessHandler(schoolLists => {
            
            // setupInitialDropdowns(); // <-- Pindah ke atas
            setupDataSekolah(schoolLists); // <-- Tetap di sini
            // setupDataMurid(); // <-- Pindah ke atas
            
            // --- VALIDASI CUSTOM UNTUK TAB 2 (MURID) ---
            formLogic.setTabValidation(1, () => {
                let allValid = true;
                let firstInvalidKelas = -1;
                for (let i = 1; i <= 6; i++) {
                    if (!checkKelasTotals(i)) {
                        allValid = false;
                        if(firstInvalidKelas === -1) firstInvalidKelas = i;
                    }
                }
                if (!allValid) {
                     document.querySelector(`#kelas-tabs button[data-kelas="${firstInvalidKelas}"]`).click(); 
                     App.showAppModal('error', 'Terdapat isian murid yang belum lengkap atau jumlah tidak sesuai.');
                }
                return allValid;
            });
            
            // --- VALIDASI CUSTOM UNTUK TAB 3 (PTK) - INI ADALAH PERBAIKANNYA ---
            formLogic.setTabValidation(2, () => {
                const totalKepsek = (parseInt(form.querySelector('[name="ptk_kepsek_pns"]').value, 10) || 0) +
                                  (parseInt(form.querySelector('[name="ptk_kepsek_pppk"]').value, 10) || 0) +
                                  (parseInt(form.querySelector('[name="ptk_kepsek_nonasn"]').value, 10) || 0);

                if (totalKepsek > 1) {
                    App.showAppModal('error', 'Jumlah Kepala Sekolah maksimal adalah 1.');
                    return false; // <--- INI AKAN MENCEGAH PINDAH TAB
                }
                return true; // Lolos
            });
            
            // --- TAMBAHKAN 2 BARIS INI ---
            if(form.querySelector('#skeleton-loader')) form.querySelector('#skeleton-loader').style.display = 'none';
            if(form.querySelector('#form-content')) form.querySelector('#form-content').style.display = 'flex';
            // --- AKHIR TAMBAHAN ---
            
            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => {
            App.showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`);
            // --- TAMBAHKAN 2 BARIS INI JUGA ---
            if(form.querySelector('#skeleton-loader')) form.querySelector('#skeleton-loader').style.display = 'none';
            if(form.querySelector('#form-content')) form.querySelector('#form-content').style.display = 'flex';
            // --- AKHIR TAMBAHAN ---
        })
        .getSdSchoolLists();
        
    // (Fungsi submit listener sudah dipindah ke atas)
}

function initLapbulRiwayatPage() {
    App.initializeGenericTablePage({
        tableId: 'lapbulRiwayatTable',
        serverFunction: 'getLapbulRiwayatData', 
        filters: [
            { id: 'filterTahun', dataColumn: 'Tahun', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            { id: 'filterBulan', dataColumn: 'Bulan', type: 'dropdown', specialSort: 'bulan', defaultText: 'Semua Bulan' },
            { id: 'filterJenjang', dataColumn: 'Jenjang', type: 'dropdown', defaultText: 'Semua Jenjang' },
            { 
              id: 'filterNamaSekolah',      
              dataColumn: 'Nama Sekolah',   
              type: 'cascading-local', 
              parent: 'filterJenjang',      
              parentKey: 'Jenjang',      
              defaultText: 'Semua Sekolah' 
            }
        ]
    });
}

function initLapbulStatusPage() {
    App.initializeGenericTablePage({
        tableId: 'lapbulStatusTable',
        serverFunction: 'getLapbulStatusData', 
        filterFunction: 'getLapbulStatusFilterData', 
        filters: [
            // Filter 1: Tahun
            { id: 'filterTahun', dataColumn: 'Tahun', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            
            // Filter 2: Jenjang (Parent)
            { id: 'filterJenjang', dataColumn: 'Jenjang', type: 'dropdown', defaultText: 'Semua Jenjang' },
            
            // Filter 3: Nama Sekolah (Cascading Child)
            { 
                id: 'filterNamaSekolah', 
                dataColumn: 'Nama Sekolah', 
                type: 'cascading-local', 
                parent: 'filterJenjang', 
                parentKey: 'Jenjang', 
                defaultText: 'Semua Sekolah' 
            }
        ]
    });
}

function initLapbulArsipPage() {
    let FOLDER_IDS = {}; 

    let breadcrumbTrail = [];
    const viewContainer = document.getElementById('view-container');
    const breadcrumbDiv = document.getElementById('breadcrumb');

    function updateBreadcrumb() {
        const fragment = document.createDocumentFragment();
        breadcrumbTrail.forEach((item, index) => {
            if (index > 0) {
                const separator = document.createElement('span');
                separator.textContent = ' / ';
                separator.style.margin = '0 5px';
                fragment.appendChild(separator);
            }
            const span = document.createElement('span');
            span.textContent = item.name;

            if (index < breadcrumbTrail.length - 1) {
                span.onclick = () => {
                    breadcrumbTrail.length = index;
                    if (item.type === 'root') {
                        renderJenjangView();
                    } else {
                        renderFolderView(item.id, item.name);
                    }
                };
            } else {
                span.classList.add('inactive');
            }
            fragment.appendChild(span);
        });
        breadcrumbDiv.innerHTML = '';
        breadcrumbDiv.appendChild(fragment);
    }

    function showLoading() {
        viewContainer.innerHTML = '<div class="loading-container"><div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div><p>Memuat...</p></div>';
    }

    function renderJenjangView() {
        viewContainer.classList.remove('view-container-scrollable');
        // Saat kembali ke jenjang, reset breadcrumb ke kondisi awal
        breadcrumbTrail = [{ name: 'Jenjang', type: 'root', id: null }];
        updateBreadcrumb();
        viewContainer.innerHTML = '<div class="card-grid"></div>';
        const cardGrid = viewContainer.querySelector('.card-grid');
        
        const jenjang = [
            { name: 'KB', icon: 'fa-cubes', color: '#3498db' },
            { name: 'TK', icon: 'fa-shapes', color: '#9b59b6' },
            { name: 'SD', icon: 'fa-school', color: '#e74c3c' }
        ];

        jenjang.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.animationDelay = `${index * 0.05}s`;
            card.innerHTML = `<i class="fas ${item.icon}" style="color: ${item.color};"></i><span>${item.name}</span>`;
            card.onclick = () => renderFolderView(FOLDER_IDS[item.name], item.name);
            cardGrid.appendChild(card);
        });
    }

    function renderFolderView(folderId, folderName) {
        viewContainer.classList.remove('view-container-scrollable');
        // Hanya tambahkan ke breadcrumb jika belum ada
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
            breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(folders => {
            if (!folders || folders.length === 0) {
                renderFileView(folderId, folderName);
            } else {
                viewContainer.innerHTML = '<div class="card-grid"></div>';
                const cardGrid = viewContainer.querySelector('.card-grid');
                folders.forEach((folder, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.innerHTML = `<i class="fas fa-folder-open"></i><span>${folder.name}</span>`;
                    card.onclick = () => renderFolderView(folder.id, folder.name);
                    cardGrid.appendChild(card);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat folder: ${err.message}</p>`;
        }).getFolders(folderId);
    }

    function renderFileView(folderId, folderName) {
        viewContainer.classList.add('view-container-scrollable');
        if (breadcrumbTrail[breadcrumbTrail.length - 1].id !== folderId) {
             breadcrumbTrail.push({ name: folderName, id: folderId, type: 'folder' });
        }
        updateBreadcrumb();
        showLoading();
        google.script.run.withSuccessHandler(files => {
            if (!files || files.length === 0) {
                viewContainer.innerHTML = '<p>Tidak ada file ditemukan di folder ini.</p>';
            } else {
                viewContainer.innerHTML = '<div class="file-list-container"></div>';
                const fileList = viewContainer.querySelector('.file-list-container');
                files.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.style.animationDelay = `${index * 0.03}s`;
                    fileItem.innerHTML = `<i class="fas fa-file-pdf"></i><a href="${file.url}" target="_blank">${file.name}</a>`;
                    fileList.appendChild(fileItem);
                });
            }
        }).withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat file: ${err.message}</p>`;
        }).getFiles(folderId);
    }
    
    showLoading();
    google.script.run
        .withSuccessHandler(ids => {
            FOLDER_IDS = ids;
            renderJenjangView();
        })
        .withFailureHandler(err => {
            viewContainer.innerHTML = `<p style="color:red">Gagal memuat konfigurasi folder: ${err.message}</p>`;
        })
        .getLapbulArsipFolderIds();
}

function initLapbulKelolaPage() {
    App.initializeGenericTablePage({
        tableId: 'lapbulKelolaTable',
        serverFunction: 'getLapbulKelolaData',
        filters: [ 
            { id: 'filterTahun', dataColumn: 'Tahun', type: 'dropdown', sortReverse: true, defaultText: 'Semua Tahun' },
            { 
                id: 'filterBulan', 
                dataColumn: 'Bulan', 
                type: 'dropdown', 
                specialSort: 'bulan', // <-- Ini penting agar urut Januari, Februari...
                defaultText: 'Semua Bulan' 
            },
            { id: 'filterJenjang', dataColumn: 'Jenjang', type: 'dropdown', defaultText: 'Semua Jenjang' },
            { 
                id: 'filterNamaSekolah', 
                dataColumn: 'Nama Sekolah', 
                type: 'cascading-local', 
                parent: 'filterJenjang',
                parentKey: 'Jenjang',
                defaultText: 'Semua Sekolah'
            }
        ],
    });
}

function initLapbulEditPaudPage(params) {
    const form = document.getElementById('lapbulEditFormPaud'); 
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-lapbul-form-container'); 
    
    // Menggunakan ID baru untuk elemen navigasi dan konten
    const tabs = [
        document.getElementById('edit-dataSekolah'),
        document.getElementById('edit-dataMurid'),
        document.getElementById('edit-dataPtk'),
        document.getElementById('edit-dataDokumen')
    ].filter(el => el); 
    
    if (!form || !params || !params.rowIndex || !params.source) {
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit tidak lengkap atau tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;
    form.querySelector('[name="source"]').value = params.source;

    let currentActiveTab = 'edit-dataSekolah';

    // --- FUNGSI UTILITY ---
    function showTab(tabId) {
        tabs.forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
            targetTab.style.display = 'block';
            currentActiveTab = tabId;
        }
        document.querySelectorAll('.tabs-container button').forEach(btn => {
            if (btn.getAttribute('data-tab') === tabId) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    // --- LOGIKA PERHITUNGAN DAN VALIDASI (Tab 2: Murid) ---
    const totalUsiaEl = document.getElementById('edit-totalUsia');
    const totalRombelEl = document.getElementById('edit-totalRombel');
    const statusEl = document.getElementById('edit-murid-validation-status');
    const muridInputs = form.querySelectorAll('#edit-dataMurid input[type="number"]');

    function showTab(tabId) {
        tabs.forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none';
        });
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            targetTab.classList.add('active');
            targetTab.style.display = 'block';
            currentActiveTab = tabId;
        }
        document.querySelectorAll('.tabs-container button').forEach(btn => {
            if (btn.getAttribute('data-tab') === tabId) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function updateMuridTotals() {
        let totalUsia = 0;
        form.querySelectorAll('#edit-dataMurid [name^="murid_"]').forEach(input => {
            totalUsia += parseInt(input.value, 10) || 0;
        });

        const rombelA = (parseInt(form.querySelector('[name="kelompok_A_L"]')?.value) || 0) + (parseInt(form.querySelector('[name="kelompok_A_P"]')?.value) || 0);
        const rombelB = (parseInt(form.querySelector('[name="kelompok_B_L"]')?.value) || 0) + (parseInt(form.querySelector('[name="kelompok_B_P"]')?.value) || 0);
        const totalRombel = rombelA + rombelB;
        
        if (totalUsiaEl) totalUsiaEl.textContent = totalUsia;
        if (totalRombelEl) totalRombelEl.textContent = totalRombel;
        
        if (statusEl) {
             statusEl.classList.remove('status-ok', 'status-error');
             if (totalUsia !== totalRombel) {
                 statusEl.textContent = "Jumlah TIDAK SAMA! Harap Koreksi.";
                 statusEl.classList.add('status-error');
             } else if (totalUsia > 0) {
                 statusEl.textContent = "Jumlah SAMA!";
                 statusEl.classList.add('status-ok');
             } else {
                 statusEl.textContent = "Isikan jumlah murid.";
                 statusEl.classList.add('status-ok');
             }
        }
        return { totalUsia, totalRombel };
    }
    
    function validateTab3Ptk(e) {
        e.preventDefault();
        
        const kepsekASN = parseInt(form.querySelector('#edit-dataPtk [name="kepsek_ASN"]')?.value) || 0;
        const kepsekNonASN = parseInt(form.querySelector('#edit-dataPtk [name="kepsek_Non_ASN"]')?.value) || 0;
        const totalKepsek = kepsekASN + kepsekNonASN;
        
        if (totalKepsek > 1) {
            App.showAppModal('error', 'Validasi PTK: Jumlah Kepala Sekolah maksimal 1.');
            return;
        }

        const ptkInputs = form.querySelectorAll('#edit-dataPtk input[type="number"]');
        const totalPtk = Array.from(ptkInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        
        if (totalPtk === 0) {
             const confirmModal = document.getElementById('deleteModal');
             confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data PTK';
             confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah PTK (Total: 0). Tetap lanjut ke dokumen?</p>';
             
             const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
             const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

             confirmBtn.textContent = 'Lanjut';
             cancelBtn.textContent = 'Kembali';

             const newConfirmBtn = confirmBtn.cloneNode(true);
             confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

             newConfirmBtn.onclick = () => {
                  confirmModal.classList.remove('show');
                  showTab('edit-dataDokumen');
             };
             cancelBtn.onclick = () => confirmModal.classList.remove('show');

             confirmModal.classList.add('show');
             return;
        }
        
        showTab('edit-dataDokumen');
    }

    function validateTab2Murid(e) {
        e.preventDefault();
        const { totalUsia, totalRombel } = updateMuridTotals();
        
        if (totalUsia !== totalRombel) {
            App.showAppModal('error', 'Kesalahan Validasi: Total Murid Menurut Usia harus SAMA dengan Total Murid Menurut Rombel.');
            return; 
        } 
        
        if (totalUsia === 0) {
             const confirmModal = document.getElementById('deleteModal');
             confirmModal.querySelector('#deleteModalTitle').textContent = 'Konfirmasi Data Siswa';
             confirmModal.querySelector('#deleteModalBody').innerHTML = '<p>Anda belum mengisikan data jumlah siswa (Total: 0). Tetap lanjut?</p>';
             
             const confirmBtn = confirmModal.querySelector('#confirmDeleteBtn');
             const cancelBtn = confirmModal.querySelector('#cancelDeleteBtn');

             confirmBtn.textContent = 'Lanjut';
             cancelBtn.textContent = 'Kembali';

             const newConfirmBtn = confirmBtn.cloneNode(true);
             confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

             newConfirmBtn.onclick = () => {
                  confirmModal.classList.remove('show');
                  showTab('edit-dataPtk'); 
             };
             cancelBtn.onclick = () => confirmModal.classList.remove('show');

             confirmModal.classList.add('show');
             return;
        }

        showTab('edit-dataPtk');
    }

    google.script.run
        .withSuccessHandler(rowData => {
            document.getElementById('appModal').classList.remove('show');
            
            if (rowData.error) {
                loadingDiv.innerHTML = `<p style="color:red; font-weight:bold;">Error Memuat Data: ${rowData.error}</p>`;
                loadingDiv.style.display = 'block';
                formContainer.style.display = 'none';
                return;
            }
            
            // 1. Isi semua field form
            for (const key in rowData) {
                const field = form.querySelector(`[name="${key}"]`);
                if (field) {
                    let value = rowData[key];
                    if (field.type === 'number' && (value === '' || value === null || value === undefined)) {
                        value = 0;
                    }
                    field.value = value;
                }
            }

            // 2. Update link dokumen
            const fileLinkContainer = document.getElementById('existingFileLink');
            if (rowData.Dokumen) { 
                fileLinkContainer.innerHTML = `<a href="${rowData.Dokumen}" target="_blank">Lihat File Saat Ini</a>`; 
            } else { 
                fileLinkContainer.innerHTML = 'Tidak ada file.'; 
            }

            // 3. Tampilkan form dan tab pertama
            loadingDiv.style.display = 'none';
            formContainer.style.display = 'flex';
            showTab(currentActiveTab); 
            
            // 4. Inisialisasi perhitungan setelah data dimuat
            updateMuridTotals(); 

        })
        .withFailureHandler(err => {
            loadingDiv.innerHTML = `<p style="color:red; font-weight:bold;">Gagal Menghubungi Server: ${err.message}</p>`;
            loadingDiv.style.display = 'flex';
        })
        .getLapbulDataByRow(params.rowIndex, params.source);

    // --- SETUP EVENT LISTENERS TAB & VALIDASI KHUSUS ---
    
    // Event listeners untuk tombol tab di atas
    form.querySelectorAll('.tabs-container button').forEach(button => {
        button.addEventListener('click', function() {
            showTab(this.getAttribute('data-tab'));
        });
    });

    // Event listener untuk tombol NEXT Tab 1 (Sekolah -> Murid)
    const nextSekolahBtn = document.querySelector('#edit-dataSekolah .next-tab-btn');
    if (nextSekolahBtn) {
        nextSekolahBtn.addEventListener('click', (e) => {
            if (form.reportValidity()) {
                showTab('edit-dataMurid');
            } else {
                 App.showAppModal('error', 'Harap lengkapi semua field yang wajib diisi di tab ini.');
            }
        });
    }

    // Event listener untuk tombol NEXT Tab 2 (Murid -> PTK)
    const nextMuridToPtkBtn = document.querySelector('#edit-dataMurid .next-tab-btn');
    if (nextMuridToPtkBtn) {
        nextMuridToPtkBtn.addEventListener('click', validateTab2Murid);
    }

    // Event listener untuk tombol NEXT Tab 3 (PTK -> Dokumen)
    const nextPtkToDokumenBtn = document.querySelector('#edit-dataPtk .next-tab-btn');
    if (nextPtkToDokumenBtn) {
        nextPtkToDokumenBtn.addEventListener('click', validateTab3Ptk);
    }
    
    // Event listeners untuk tombol PREVIOUS
    form.querySelectorAll('.tab-form-footer button[data-target]').forEach(button => {
        if (button.classList.contains('prev-tab-btn')) {
             button.addEventListener('click', function(e) {
                 e.preventDefault();
                 showTab(this.getAttribute('data-target'));
             });
        }
    });

    // Event listener untuk perhitungan input number
    form.querySelectorAll('input[type="number"]').forEach(input => {
        input.addEventListener('input', updateMuridTotals);
    });
    
    // --- LOGIKA FORM SUBMISSION (KRITIS) ---
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitButton = form.querySelector('#edit-lapbul-submit-btn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');

        // 1. Ambil semua data sebagai payload
        const payload = Object.fromEntries(new FormData(form)); 
        
        const fileInput = form.querySelector('input[type="file"]');
        const file = fileInput.files[0];
        
        // 2. KRITIS: Hapus properti fileData dari payload jika tidak ada file yang dipilih
        // Ini mencegah pengiriman objek File yang tidak valid ke server.
        delete payload.fileData; 
        
        const sendData = (data) => {
            google.script.run
                .withSuccessHandler(response => {
                    App.showAppModal('success', response, 'lapbul_kelola');
                })
                .withFailureHandler(error => {
                    App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                    submitButton.disabled = false;
                })
                .updateLapbulData(data); 
        };
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                if (file.size > 300 * 1024) {
                    App.showAppModal('error', 'Ukuran file tidak boleh lebih dari 300 KB.');
                    submitButton.disabled = false;
                    return;
                }
                
                // 3. Jika ada file, tambahkan fileData yang sudah di-encode ke payload
                payload.fileData = { 
                    fileName: file.name, 
                    mimeType: file.type, 
                    data: event.target.result.split(',')[1] 
                };
                sendData(payload);
            };
            reader.readAsDataURL(file);
        } else {
            // 4. Jika tidak ada file, kirim payload tanpa properti fileData
            sendData(payload);
        }
    });
}


function initLapbulEditSdPage(params) {

    // --- AMBIL ELEMEN DARI HALAMAN EDIT ---
    const form = document.getElementById('lapbulEditFormSd');
    const loadingDiv = document.getElementById('loading-data');
    const formContainer = document.getElementById('edit-lapbul-sd-container');

    if (!form || !loadingDiv || !formContainer) {
         console.error("Elemen dasar form edit SD (form, loading, container) tidak ditemukan.");
         document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Error</h3><p>Elemen dasar (form, loading) tidak ditemukan. Halaman HTML mungkin rusak.</p></div>`;
         return;
    }

    if (!params || !params.rowIndex) {
        document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Error</h3><p>Parameter (rowIndex) untuk edit data tidak ditemukan.</p></div>`;
        return;
    }

    // 1. Panggil App.setupTabForm untuk tab utama (Tab 1-4)
    const formLogic = App.setupTabForm('lapbulEditFormSd'); 

    // 2. Fungsi Bantuan untuk dropdown Bulan/Tahun
    function setupInitialDropdowns() {
        // DIUBAH: Mencari nama yang benar (sesuai HTML & code.gs)
        const bulanSelect = form.querySelector('[name="Bulan"]');
        const tahunSelect = form.querySelector('[name="Tahun"]');
        // --- AKHIR PERUBAHAN ---

        const bulanOptions = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const d = new Date();
        const currentYear = d.getFullYear();
        const prevMonthIndex = d.getMonth() === 0 ? 11 : d.getMonth() - 1;
        
        // Cek jika elemen ditemukan sebelum mengatur innerHTML
        if (bulanSelect) {
            bulanSelect.innerHTML = bulanOptions.map((m, i) => `<option value="${m}" ${i === prevMonthIndex ? 'selected' : ''}>${m}</option>`).join('');
        }
        if (tahunSelect) {
            tahunSelect.innerHTML = [currentYear, currentYear - 1].map(y => `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`).join('');
        }
    }

    // 3. Fungsi Bantuan untuk Validasi Total Murid (disalin dari form Tambah)
    function checkKelasTotals(kelas) {
        const kelasContent = document.getElementById(`kelas-content-${kelas}`);
        if (!kelasContent) return true; // Jika konten kelas tidak ada, anggap valid

        // === LOGIKA BARU DIMULAI ===
        // 1. Ambil nilai dropdown 'Jumlah Rombel'
        const rombelDropdown = kelasContent.querySelector('.rombel-toggle');
        // Handle case where dropdown might not be found (shouldn't happen, but good safety)
        if (!rombelDropdown) {
             console.error("Gagal menemukan dropdown rombel for kelas " + kelas);
             return true; // Failsafe
        }
        const jumlahRombelDipilih = parseInt(rombelDropdown.value, 10);
        // === LOGIKA BARU SELESAI ===

        const rombelInputs = kelasContent.querySelectorAll('.rombel-container input[type="number"]');
        const agamaInputs = kelasContent.querySelectorAll('.agama-container-grid input[type="number"]');

        const totalRombel = Array.from(rombelInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);
        const totalAgama = Array.from(agamaInputs).reduce((sum, input) => sum + (parseInt(input.value, 10) || 0), 0);

        const statusEl = document.getElementById(`murid-validation-status-${kelas}`);
        // Safety check for elements
        const rombelEl = document.getElementById(`totalRombel-${kelas}`);
        const agamaEl = document.getElementById(`totalAgama-${kelas}`);

        if (rombelEl) rombelEl.textContent = totalRombel;
        if (agamaEl) agamaEl.textContent = totalAgama;
        if (!statusEl) return true; // Failsafe if status element isn't found

        // === VALIDASI BARU ===

        // Aturan 1: Jika dropdown rombel DIPILIH (bukan 0)
        if (jumlahRombelDipilih > 0) {
            // Aturan 1a: Total murid rombel tidak boleh 0
            if (totalRombel === 0) {
                statusEl.textContent = "Isikan jumlah murid per rombel.";
                statusEl.className = 'status-error';
                return false; // Gagal
            }
            // Aturan 1b: Total murid agama tidak boleh 0
            if (totalAgama === 0) {
                statusEl.textContent = "Isikan jumlah murid menurut agama.";
                statusEl.className = 'status-error';
                return false; // Gagal
            }
        }

        // Aturan 2: (Aturan Lama) Total Rombel HARUS SAMA DENGAN Total Agama
        if (totalRombel !== totalAgama) {
            statusEl.textContent = "Jumlah TIDAK SAMA!";
            statusEl.className = 'status-error';
            return false; // Gagal
        }

        // Aturan 3: (Aturan Baru) Jika rombel 0, total murid juga harus 0
        if (jumlahRombelDipilih === 0 && (totalRombel > 0 || totalAgama > 0)) {
            statusEl.textContent = "Rombel 0, tapi Jml Murid ada";
            statusEl.className = 'status-error';
            return false; // Gagal
        }
        
        // === AKHIR VALIDASI BARU ===

        // Jika lolos semua aturan
        statusEl.textContent = "Jumlah Sesuai";
        statusEl.className = 'status-ok';
        return true;
    }

    // 4. Fungsi Bantuan untuk Generate HTML (SAMA SEPERTI FUNGSI TAMBAH)
    // Kita butuh ini agar bisa mengisi data yang di-load
    function generateKelasHTML(kelas) {
        const rombels = ['A', 'B', 'C'];
        const agama = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
        const agamaDefault = { 'Islam': 'Ada', 'Kristen': 'Tidak Ada', 'Katolik': 'Tidak Ada', 'Hindu': 'Tidak Ada', 'Buddha': 'Tidak Ada', 'Konghucu': 'Tidak Ada' };

        let rombelInputsHTML = `
            <div class="rombel-input-group" id="rombel-${kelas}-Tunggal" style="display: none;">
                <label class="rombel-group-label">Kelas ${kelas}</label>
                <div class="murid-input-pair">
                    <div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_tunggal_L" min="0" required></div>
                    <div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_tunggal_P" min="0" required></div>
                </div>
            </div>
        `;
        for (const rombel of rombels) {
            rombelInputsHTML += `<div class="rombel-input-group" id="rombel-${kelas}-${rombel}" style="display: none;"><label class="rombel-group-label">Kelas ${kelas}${rombel}</label><div class="murid-input-pair"><div class="form-group"><label>L</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_L" min="0" required></div><div class="form-group"><label>P</label><input type="number" name="k${kelas}_rombel_${rombel.toLowerCase()}_P" min="0" required></div></div></div>`;
        }

        let agamaInputsHTML = '<div class="agama-container-grid">';

        for (const ag of agama) {
            const agId = ag.toLowerCase().replace(/\s/g, '_');
            const defaultValue = agamaDefault[ag] || 'Tidak Ada';
            const isVisible = defaultValue === 'Ada';

            agamaInputsHTML += `
                <div class="agama-input-group">
                    <label class="agama-group-label">${ag}</label>
                    <select class="agama-toggle" data-kelas="${kelas}" data-agama="${agId}">
                        <option value="Ada" ${defaultValue === 'Ada' ? 'selected' : ''}>Ada</option>
                        <option value="Tidak Ada" ${defaultValue === 'Tidak Ada' ? 'selected' : ''}>Tidak Ada</option>
                    </select>
                    <div class="murid-input-pair" id="agama-input-${kelas}-${agId}" style="display: ${isVisible ? 'flex' : 'none'}; margin-top: 10px;">
                        <div class="form-group"><label>L</label><input type="number" name="k${kelas}_agama_${agId}_L" min="0" required></div>
                        <div class="form-group"><label>P</label><input type="number" name="k${kelas}_agama_${agId}_P" min="0" required></div>
                    </div>
                </div>
            `;
        }
        agamaInputsHTML += '</div>';

        const validationHTML = `<div id="murid-validation-feedback-${kelas}" class="murid-validation-container" style="margin-top: 20px;"><p>Total per Rombel: <span id="totalRombel-${kelas}">0</span></p><p>Total per Agama: <span id="totalAgama-${kelas}">0</span></p><p id="murid-validation-status-${kelas}" class="status-ok">Jumlah Sesuai</p></div>`;

        let footerHTML = '';
        if (kelas === 1) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn prev-tab-btn" style="width: auto;">Sebelumnya</button></div>`;
        } else if (kelas === 6) {
            footerHTML = `<div class="tab-form-footer"><button type="button" class="submit-btn next-tab-btn" style="width: auto; margin-left: auto;">Berikutnya</button></div>`;
        }

        return `
            <fieldset class="ptk-fieldset"><legend>Menurut Rombel</legend><div class="form-group form-group-rombel-toggle" style="margin-bottom: 20px;"><label>Jumlah Rombel</label><select class="rombel-toggle" name="k${kelas}_jumlah_rombel" data-kelas="${kelas}"><option value="1" selected>1</option><option value="2">2</option><option value="3">3</option><option value="0">0</option></select></div><h4 class="sub-section-title">Jml Murid per Rombel</h4><div class="rombel-container" id="rombel-container-${kelas}" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px;">${rombelInputsHTML}</div></fieldset>
            <fieldset class="ptk-fieldset" style="margin-top: 20px;"><legend>Menurut Agama</legend>${agamaInputsHTML}</fieldset>
            ${validationHTML}${footerHTML}
        `;
    }

// 5. Fungsi Bantuan untuk Setup Logika Tab 2 (Murid)
function setupDataMurid() {
        const tabsContainer = document.getElementById('edit-kelas-tabs');
        const contentContainer = document.getElementById('edit-kelas-content-container');

        if (!tabsContainer || !contentContainer) {
            console.error("Elemen sub-tab (edit-kelas-tabs) tidak ditemukan!");
            return;
        }

        // KOSONGKAN KONTEN (TAPI JANGAN TOMBOL TAB)
        contentContainer.innerHTML = ''; 
        
        for (let i = 1; i <= 6; i++) {
            
            // --- TIDAK ADA 'tabsContainer.innerHTML' DI SINI (INI SUDAH BENAR) ---

            const content = document.createElement('div');
            content.id = `kelas-content-${i}`;
            content.className = 'tab-content';
            content.style.display = i === 1 ? 'block' : 'none';
            content.innerHTML = generateKelasHTML(i); // Memanggil generateKelasHTML
            content.dataset.kelas = i;
            contentContainer.appendChild(content);

            // (Kode 'checkKelasTotals(i);' tidak diperlukan di sini, akan dipanggil saat load data)
        }

        // Pastikan event listener hanya dipasang sekali
        if (!tabsContainer.dataset.listener) {
            tabsContainer.addEventListener('click', function(e) { 
                const clickedTab = e.target.closest('.sub-tab-link'); 
                if (clickedTab) {
                    e.stopPropagation(); 
                    tabsContainer.querySelectorAll('.sub-tab-link').forEach(tab => tab.classList.remove('active')); 
                    contentContainer.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

                    clickedTab.classList.add('active');
                    document.getElementById(`kelas-content-${clickedTab.dataset.kelas}`).style.display = 'block';
                }
            });
            tabsContainer.dataset.listener = 'true';
        }

        if (!contentContainer.dataset.listener) {
            contentContainer.addEventListener('input', function(e) {
                if (e.target.type === 'number') {
                    const kelasContent = e.target.closest('.tab-content');
                    if (kelasContent) {
                         const kelas = kelasContent.id.split('-')[2];
                         checkKelasTotals(kelas);
                    }
                }
            });

            contentContainer.addEventListener('change', function(e) {
                const target = e.target; 
                if (!target) return;

                const kelasContent = target.closest('.tab-content');
                const kelas = target.dataset.kelas || (kelasContent ? kelasContent.id.split('-')[2] : null);
                if (!kelas) return;

                if (target.classList.contains('rombel-toggle')) { 
                    const k = target.dataset.kelas;
                    const c = parseInt(target.value, 10);
                    const groupTunggal = document.getElementById(`rombel-${k}-Tunggal`);
                    const groupA = document.getElementById(`rombel-${k}-A`);
                    const groupB = document.getElementById(`rombel-${k}-B`);
                    const groupC = document.getElementById(`rombel-${k}-C`);

                    if (c === 1) {
                        if (groupTunggal) groupTunggal.style.display = 'block';
                    } else {
                        if (groupTunggal) {
                            groupTunggal.style.display = 'none';
                            groupTunggal.querySelectorAll('input[type="number"]').forEach(input => input.value = 0); 
                        }
                    }
                    if (c === 2 || c === 3) {
                        if (groupA) groupA.style.display = 'block';
                    } else {
                        if (groupA) {
                            groupA.style.display = 'none';
                            groupA.querySelectorAll('input[type="number"]').forEach(input => input.value = 0);
                        }
                    }
                    if (c === 2 || c === 3) {
                        if (groupB) groupB.style.display = 'block';
                    } else {
                        if (groupB) {
                            groupB.style.display = 'none';
                            groupB.querySelectorAll('input[type="number"]').forEach(input => input.value = 0);
                        }
                    }
                    if (c === 3) {
                        if (groupC) groupC.style.display = 'block';
                    } else {
                        if (groupC) {
                            groupC.style.display = 'none';
                            groupC.querySelectorAll('input[type="number"]').forEach(input => input.value = 0);
                        }
                    }
                    checkKelasTotals(k); 
                } 

                if (target.classList.contains('agama-toggle')) { 
                    const agId = target.dataset.agama.toLowerCase().replace(/\s/g, '_');
                    const inputPairContainer = document.getElementById(`agama-input-${kelas}-${agId}`);
                    if (inputPairContainer) {
                        if (target.value === 'Ada') { 
                            inputPairContainer.style.display = 'flex';
                        } else {
                            inputPairContainer.style.display = 'none';
                            inputPairContainer.querySelectorAll('input[type="number"]').forEach(input => { input.value = 0; });
                        }
                    }
                    checkKelasTotals(kelas);
                }
            });
            contentContainer.dataset.listener = 'true';
        }

        // Navigasi Kustom
        const prevBtnKelas1 = document.querySelector('#kelas-content-1 .prev-tab-btn');
        if(prevBtnKelas1) {
            prevBtnKelas1.addEventListener('click', function() {
                formLogic.showTab(0); // Pindah ke Tab 1 (Data Sekolah)
            });
        }

        const nextBtnKelas6 = document.querySelector('#kelas-content-6 .next-tab-btn');
        if (nextBtnKelas6) {
            nextBtnKelas6.addEventListener('click', function() {
                if (formLogic.validateTab(1)) {
                    formLogic.showTab(2); // Pindah ke Tab 3 (Data PTK)
                }
            });
        }
    }

// 6. Fungsi Bantuan untuk Setup Logika Tab 1 (Sekolah)
function setupDataSekolah(schoolLists) {
    // Hapus logika lama (ptkContainer, ptkNegeri, ptkSwasta)
    const statusSekolah = form.querySelector('#statusSekolah');
    const namaSekolah = form.querySelector('[name="Nama Sekolah"]');

    // Buat agar Nama Sekolah BISA DIKETIK (input type text)
    namaSekolah.disabled = false;

    // Hapus event listener lama yang mengubah form PTK
    statusSekolah.removeEventListener('change', null); 
}

// 7. Fungsi Bantuan untuk Mengunci Field
function lockField(fieldName) {
    const field = form.querySelector(`[name="${fieldName}"]`);
    if (field) { field.disabled = true; field.style.cssText = 'background-color: rgba(0,0,0,0.3); cursor: not-allowed;'; if (field.tagName === 'INPUT') field.readOnly = true; }
}

// --- PROSES UTAMA (MODIFIKASI UNTUK EDIT) ---
setupInitialDropdowns();
setupDataMurid(); // Panggil ini dulu untuk membangun HTML kelas 1-6

// Validasi Tab 2 (Murid)
formLogic.setTabValidation(1, () => { 
    let allValid = true;
    let firstInvalidKelas = -1;
    for (let i = 1; i <= 6; i++) {
        if (!checkKelasTotals(i)) {
            allValid = false;
            if(firstInvalidKelas === -1) firstInvalidKelas = i;
        }
    }
    if (!allValid) {
         document.querySelector(`#edit-kelas-tabs .sub-tab-link[data-kelas="${firstInvalidKelas}"]`).click(); 
         App.showAppModal('error', `Data Murid di Kelas ${firstInvalidKelas} tidak valid. Jumlah murid per rombel tidak sama dengan jumlah murid menurut agama.`);
    }
    return allValid;
});

// Validasi Tab 3 (PTK) - Validasi Kepala Sekolah
formLogic.setTabValidation(2, () => { 
    const totalKepsek = (parseInt(form.querySelector('[name="ptk_kepsek_pns"]').value, 10) || 0) +
                              (parseInt(form.querySelector('[name="ptk_kepsek_pppk"]').value, 10) || 0) +
                              (parseInt(form.querySelector('[name="ptk_kepsek_nonasn"]').value, 10) || 0);

    if (totalKepsek > 1) {
        App.showAppModal('error', 'Jumlah Kepala Sekolah maksimal adalah 1.');
        return false;
    }
    return true; 
});

// Panggil data dari server
google.script.run
    .withSuccessHandler(schoolLists => {
        // Panggil setupDataSekolah setelah schoolLists (data sekolah) didapat
        setupDataSekolah(schoolLists);

        // Panggil data baris yang spesifik
        google.script.run
            .withSuccessHandler(rowData => {
                if (rowData.error || !rowData || Object.keys(rowData).length === 0) {
                    loadingDiv.innerHTML = `<p style="color:red;">Gagal: ${rowData.error || `Data untuk baris ${params.rowIndex} tidak ditemukan.`}</p>`;
                    return;
                }

                form.querySelector('[name="rowIndex"]').value = params.rowIndex;

                // Isi semua field (Termasuk 83+ PTK fields baru)
                for (const header in rowData) {
                    const fieldName = header.trim();
                    const field = form.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        let value = rowData[header];
                        if (field.type === 'number' && (value === '' || value === null || value === undefined)) {
                            value = '0';
                        }
                        field.value = value;
                    }
                }

                // (Data Tab 1 diisi oleh loop di atas)

                // Picu 'change' untuk semua dropdown rombel dan agama
                const agama = ['islam', 'kristen', 'katolik', 'hindu', 'buddha', 'konghucu'];
                for (let i = 1; i <= 6; i++) {
                    const rombelSelect = form.querySelector(`[name="k${i}_jumlah_rombel"]`);
                    rombelSelect.dispatchEvent(new Event('change', { bubbles: true }));

                    agama.forEach(ag => {
                        const L = parseInt(rowData[`k${i}_agama_${ag}_L`] || 0, 10);
                        const P = parseInt(rowData[`k${i}_agama_${ag}_P`] || 0, 10);
                        const selectAgama = form.querySelector(`.agama-toggle[data-kelas="${i}"][data-agama="${ag}"]`);
                        if (selectAgama) {
                            selectAgama.value = (L + P > 0) ? 'Ada' : 'Tidak Ada';
                            selectAgama.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                    checkKelasTotals(i); // Hitung ulang total setelah diisi
                }

                // Isi data file
                const fileLinkContainer = document.getElementById('existingFileLink');
                if (rowData['Dokumen']) { fileLinkContainer.innerHTML = `<a href="${rowData['Dokumen']}" target="_blank">Lihat File Saat Ini</a>`; } else { fileLinkContainer.innerHTML = 'Tidak ada file.'; }

                // Kunci field
                lockField('Bulan'); lockField('Tahun'); lockField('Status'); lockField('Nama Sekolah');

                // Buka semua tab
                formLogic.unlockTab(1);
                formLogic.unlockTab(2);
                formLogic.unlockTab(3);
                formLogic.showTab(0); // Mulai di Tab 1

                loadingDiv.style.display = 'none';
                formContainer.style.display = 'flex';
            })
            .withFailureHandler(err => { 
                loadingDiv.style.display = 'none'; 
                formContainer.style.display = 'none'; 
                document.getElementById('main-content').innerHTML = `<div class="error-box"><h3>Gagal Memuat Data</h3><p>Gagal memuat data baris: ${err.message}. Coba muat ulang halaman.</p></div>`;
            })
            .getLapbulDataByRow(params.rowIndex, params.source);
    })
    .withFailureHandler(err => App.showAppModal('error', `Gagal memuat daftar sekolah: ${err.message}`))
    .getSdSchoolLists();

// Logika SUBMIT
form.addEventListener('submit', function (e) {
    e.preventDefault();

    if (!formLogic.validateTab(0)) { App.showAppModal('error', 'Data Sekolah (Tab 1) belum lengkap.'); formLogic.showTab(0); return; }
    if (!formLogic.validateTab(1)) { formLogic.showTab(1); return; }
    if (!formLogic.validateTab(2)) { formLogic.showTab(2); return; }

    const fileInput = form.querySelector('input[type="file"]');
    const file = fileInput.files[0];
    if (file && file.size > 300 * 1024) { 
        App.showAppModal('error', 'Ukuran file tidak boleh lebih dari 300 KB.');
        formLogic.showTab(3); 
        return;
    }

    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    App.showAppModal('loading', 'Menyimpan perubahan...');

    const payload = {};
    const allFields = form.querySelectorAll('input:not(:disabled), select:not(:disabled), textarea:not(:disabled)');
    allFields.forEach(field => {
        if (field.name) {
            if (field.type === 'number' && field.value === '') {
                payload[field.name] = 0;
            } else {
                payload[field.name] = field.value;
            }
        }
    });

    // Tambahkan field yang 'disabled' (kunci) secara manual
    payload.rowIndex = form.querySelector('[name="rowIndex"]').value;
    payload.source = form.querySelector('[name="source"]').value;
    payload.Bulan = form.querySelector('[name="Bulan"]').value;
    payload.Tahun = form.querySelector('[name="Tahun"]').value;
    payload['Nama Sekolah'] = form.querySelector('[name="Nama Sekolah"]').value;
    payload['Status'] = form.querySelector('[name="Status"]').value;
    payload['NPSN'] = form.querySelector('[name="NPSN"]').value;

    const sendData = (data) => {
        google.script.run
            .withSuccessHandler(res => {
                if (res && res.error) {
                     App.showAppModal('error', res.error);
                     if (submitButton) submitButton.disabled = false;
                } else {
                     App.showAppModal('success', res, 'lapbul_kelola');
                }
            })
            .withFailureHandler(err => {
                App.showAppModal('error', err.message);
                if (submitButton) submitButton.disabled = false;
            })
            .updateLapbulData(data); // Panggil fungsi UPDATE
    };

    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            payload.fileData = { fileName: file.name, mimeType: file.type, data: event.target.result.split(',')[1] };
            sendData(payload);
        };
        reader.readAsDataURL(file);
    } else {
        sendData(payload);
    }
  });
}

function initLapbulUnduhFormatPage() {
    initMenuPage();
    const infoBtn = document.getElementById('infoDropdownBtn');
    const contentDiv = document.getElementById('infoDropdownContent');

    if (!infoBtn || !contentDiv) return;
    let isDataLoaded = false;
    infoBtn.onclick = function() {
        const isOpen = this.classList.toggle('active');
        contentDiv.style.maxHeight = isOpen ? contentDiv.scrollHeight + "px" : "0px";
        if (isOpen && !isDataLoaded) {
            google.script.run
                .withSuccessHandler(infoItems => {
                    if (infoItems && infoItems.length > 0) {
                        const infoContent = `
                            <ul style="text-align: left; padding: 10px 20px 10px 35px; line-height: 1.6; margin: 0;">
                                ${infoItems.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        `;
                        contentDiv.innerHTML = infoContent;
                    } else {
                        contentDiv.innerHTML = '<p style="padding: 15px;">Informasi tidak ditemukan.</p>';
                    }
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                    isDataLoaded = true;
                })
                .withFailureHandler(err => {
                    contentDiv.innerHTML = `<p style="color:red; padding: 15px;">Gagal memuat: ${err.message}</p>`;
                    contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
                })
                .getUnduhFormatInfo();
        }
    };
}

// --- Modul Data PTK ---

function initPtkKeadaanPaudPage() {
    App.initializeGenericTablePage({
        tableId: 'keadaanPtkPaudTable',
        serverFunction: 'getPtkKeadaanPaudData',
        filters: [ 
            { id: 'filterJenjang', dataColumn: '_filterJenjang', defaultText: 'Semua Jenjang' } 
        ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga',
            sumStartColumn: 'Jumlah Rombel'
        }
    });
}

function initPtkKeadaanSdPage() {
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('keadaanPtkSdTable');
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatusSekolah');

    let allDataRows = []; // Menyimpan baris data asli (tengah)
    let headerRow1_Data = []; // Data mentah header 1
    let headerRow2_Data = []; // Data mentah header 2
    let statusColumnIndex = -1; // Indeks kolom "Status"
    let dataHeaderCount = 0; // Untuk colspan

    // 1. Fungsi untuk membangun <tbody> DAN <tfoot> (DINAMIS)
    function buildTableBody() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = ''; // Kosongkan footer setiap kali filter
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || statusColumnIndex === -1) {
                return true; // Tampilkan semua jika filter "Semua"
            }
            // Filter berdasarkan nilai kolom Status
            return String(row[statusColumnIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${dataHeaderCount + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            tableFoot.classList.remove('has-content');
            return; // Stop jika tidak ada data
        }

        // --- MULAI PERBAIKAN ---
        
        // Indeks kolom Rombel (kolom ke-6) adalah 4
        // (0:Nama, 1:NPSN, 2:Jenjang, 3:Status, 4:Rombel)
        const sumStartIndex = 4; 
        const totals = new Array(dataHeaderCount).fill(0); // Buat array [0, 0, 0, ...]

        // 1. Bangun <tbody>
        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Tambah "No."
            
            let rowCells = row.map((cell, cellIndex) => {
                // Ambil nilai mentah. Jika kosong/null, set ke 0 (angka). Jika tidak, biarkan (bisa "0" string).
                const rawValue = (cell === "" || cell === null || cell === undefined) ? 0 : cell;
                
                // ===============================================
                // INI PERBAIKANNYA: Gunakan '==' (loose equality)
                // Ini akan menangkap (0 == 0) -> true DAN ("0" == 0) -> true
                const displayValue = (rawValue == 0) ? '-' : rawValue;
                // ===============================================
                
                // Kalkulasi total (hanya jika kolom data)
                if (cellIndex >= sumStartIndex) {
                    // Konversi rawValue (yang bisa "0" string) ke angka untuk penjumlahan
                    const numericValue = parseFloat(String(rawValue).replace(/,/g, '')) || 0;
                    totals[cellIndex] += numericValue; 
                }
                return `<td>${displayValue}</td>`;
            });

            cellsHTML += rowCells.join('');
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });
        // --- Selesai <tbody> ---

        // --- 2. Bangun <tfoot> DINAMIS ---
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>';       // Kolom No.
        footerHTML += '<td>JUMLAH</td>'; // Kolom Nama Sekolah (Index 0)
        footerHTML += '<td>-</td>';       // Kolom NPSN (Index 1)
        footerHTML += '<td>-</td>';       // Kolom Jenjang (Index 2)
        footerHTML += '<td>-</td>';       // Kolom Status (Index 3)
        
        // Loop untuk kolom total (mulai dari index 4 / "Rombel")
        for (let i = sumStartIndex; i < totals.length; i++) {
            // Logika untuk footer (total[i] adalah angka) sudah benar
            let displayTotal = (totals[i] === 0) ? '-' : totals[i];
            footerHTML += `<td>${displayTotal}</td>`;
        }

        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
        tableFoot.classList.add('has-content');
        
        // --- AKHIR PERBAIKAN ---
    }

    // 2. Fungsi buildTableHeader (v2 - sudah benar, JANGAN DIUBAH)
    function buildTableHeader() {
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = ''; 
        dataHeaderCount = headerRow1_Data.length; 

        for (let i = 0; i < headerRow1_Data.length; i++) {
            const header1 = headerRow1_Data[i];
            const header2 = headerRow2_Data[i];

            if (header1 !== "" && header2 === "") {
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } 
            else if (header1 !== "" && header2 !== "") {
                let colspan = 1;
                for (let j = i + 1; j < headerRow1_Data.length; j++) {
                    if (headerRow1_Data[j] === "" && headerRow2_Data[j] !== "") {
                        colspan++;
                    } else {
                        break; 
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } 
            else if (header1 === "" && header2 !== "") {
                 row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 3. Ambil data mentah dari server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            
            if (!data || data.length < 3) {
                loadingStatus.innerHTML = '<p>Data tidak memadai untuk ditampilkan (kurang dari 3 baris).</p>';
                return;
            }

            // --- Logika Pemisahan Data (BARU) ---
            headerRow1_Data = data[0];
            headerRow2_Data = data[1];
            // Kita abaikan baris terakhir (footer statis)
            allDataRows = data.slice(2, data.length - 1); 
            // --- Selesai Logika Pemisahan ---

            statusColumnIndex = headerRow1_Data.indexOf('Status'); 
            buildTableHeader();

            // 4. Buat dropdown filter
            if (statusColumnIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusColumnIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(status => {
                    filterSelect.add(new Option(status, status));
                });
            } else {
                if(filterSelect) filterSelect.parentElement.style.display = 'none';
            }

            // 5. Tampilkan tabel dan jalankan filter pertama kali
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'block';
            filterSelect.addEventListener('change', buildTableBody);
            buildTableBody(); 

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getPtkKeadaanSdData(); // <-- Memanggil fungsi code.gs
}

function initPtkJumlahBulananPaudPage() {
    // --- KODE BARU: Hitung default dinamis ---
    const d = new Date();
    const currentYear = d.getFullYear().toString();
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    let lastMonthIndex = d.getMonth() - 1; // getMonth() itu 0-11
    let yearOfLastMonth = currentYear;

    // Jika sekarang Januari (0), bulan lalu adalah Desember (11) dari TAHUN LALU
    if (lastMonthIndex < 0) { 
        lastMonthIndex = 11; // Desember
        yearOfLastMonth = (d.getFullYear() - 1).toString();
    }
    const lastMonthName = monthNames[lastMonthIndex];
    
    // Tentukan Tahun default. Jika bulan lalu adalah Desember, Tahun defaultnya adalah tahun lalu.
    const defaultTahun = (lastMonthIndex === 11) ? yearOfLastMonth : currentYear;
    // --- AKHIR KODE BARU ---

    App.initializeGenericTablePage({
        tableId: 'ptkJumlahBulananPaudTable',
        serverFunction: 'getPtkJumlahBulananPaudData',
        
        // --- PERUBAHAN DI SINI: Tambahkan properti defaultValues ---
        defaultValues: {
            'filterTahun': defaultTahun,
            'filterBulan': lastMonthName
        },
        // --- AKHIR PERUBAHAN ---

        filters: [
            { id: 'filterTahun', dataColumn: '_filterTahun', type: 'dropdown', sortReverse: true },
            { id: 'filterBulan', dataColumn: '_filterBulan', type: 'dropdown', specialSort: 'bulan' },
            { id: 'filterJenjang', dataColumn: '_filterJenjang', type: 'dropdown' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: 'Nama Lembaga', 
              type: 'cascading-local', 
              parent: 'filterJenjang',
              parentKey: '_filterJenjang'
            }
        ],
        footerConfig: {
            enabled: true,
            labelColumn: 'Nama Lembaga',
            sumStartColumn: 'Jumlah Rombel'
        }
    });
}

function initPtkDaftarPaudPage() {
    
    // (Ini adalah daftar urutan kolom kustom Anda dari misi sebelumnya)
    const kustomHeaders = [
        "Nama", "Nama Lembaga", "Jenjang", "Status", "NIP/NIY", 
        "Pangkat, Gol./Ruang", "NUPTK", "Jabatan", "TMT", "L/P", 
        "Tempat, Tanggal Lahir", "Pendidikan", "Jurusan", "Tahun Lulus", 
        "Serdik", "Dapodik"
    ];

    App.initializeGenericTablePage({
        tableId: 'daftarPtkPaudTable',
        serverFunction: 'getDaftarPtkPaudData',
        displayHeaders: kustomHeaders, 
        
        // â–¼â–¼â–¼ PERBAIKAN DI SINI â–¼â–¼â–¼
        // 1. "filterConfig:" diubah menjadi "filters:"
        // 2. Menambahkan 3 filter baru
        filters: [
            { id: 'filterJenjang', dataColumn: '_filterJenjang', defaultText: 'Semua Jenjang' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: '_filterNamaLembaga', 
              type: 'cascading-local',
              parent: 'filterJenjang',
              parentKey: '_filterJenjang',
              defaultText: 'Semua Lembaga'
            },
            { id: 'filterStatus', dataColumn: '_filterStatus', defaultText: 'Semua Status' },
            { id: 'filterPendidikan', dataColumn: '_filterPendidikan', defaultText: 'Semua Pendidikan' },
            { id: 'filterSerdik', dataColumn: '_filterSerdik', defaultText: 'Semua Serdik' },
            { id: 'filterDapodik', dataColumn: '_filterDapodik', defaultText: 'Semua Dapodik' }
        ]
        // â–²â–²â–² AKHIR PERBAIKAN â–²â–²â–²
    });
}

function initPtkKelolaPaudPage() {

    // --- PERINTAH URUTAN KUSTOM (A, B, C, D, H, Aksi, Q, R) ---
    const kustomHeaders = [
        "Nama",        // A
        "Nama Lembaga",   // B
        "Status",         // D
        "Jabatan",        // H
        "Aksi",           // (Tombol)
        "Tanggal Input",  // Q (sesuai asumsi)
        "Update"          // R (sesuai asumsi)
    ];
    // --- AKHIR PERINTAH ---

    App.initializeGenericTablePage({
        tableId: 'kelolaPtkPaudTable',
        serverFunction: 'getKelolaPtkPaudData',
        displayHeaders: kustomHeaders, // <-- SENJATA BARU DI AKTIFKAN
        editPage: 'ptk_edit_paud',

        // â–¼â–¼â–¼ PERBAIKAN: 'filterConfig' menjadi 'filters' & dibuat cascading â–¼â–¼â–¼
        filters: [
            { id: 'filterJenjang', dataColumn: 'Jenjang', defaultText: 'Semua Jenjang' },
            { 
              id: 'filterNamaLembaga', 
              dataColumn: 'Nama Lembaga', 
              type: 'cascading-local', // <-- Taktik baru
              parent: 'filterJenjang',      // <-- Taktik baru
              parentKey: 'Jenjang',      // <-- Taktik baru
              defaultText: 'Semua Lembaga' // <-- Taktik baru
            }
        ]
        // â–²â–²â–² AKHIR PERBAIKAN â–²â–²â–²
    });

    document.getElementById('tambahPtkBtn').addEventListener('click', (e) => {
        App.loadPage(e, 'ptk_tambah_paud');
    });
}

function initPtkTambahPaudPage() {
    const form = document.getElementById('addPtkPaudForm');
    const skeleton = document.getElementById('skeleton-loader'); 
    
    if (!form) return;

    // Tampilkan skeleton segera (karena form disembunyikan di HTML)
    if (skeleton) skeleton.style.display = 'block';

    // 1. Inisialisasi "Mesin" Tab
    const formLogic = App.setupTabForm('addPtkPaudForm');
    
    // 2. Variabel untuk menyimpan data dropdown dari server
    let serverOptions = {};

    // 3. Fungsi untuk mengisi dropdown
    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = document.getElementById(elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    // 4. Panggil data dari server (Tanpa App.showAppModal di sini)
    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                // Jika error, sembunyikan skeleton, tampilkan modal error, dan HENTIKAN proses pengisian
                if (skeleton) skeleton.style.display = 'none';
                form.style.display = 'flex'; // Tampilkan form agar tombol OK di modal bisa di-klik
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            serverOptions = options; // Simpan data server

            // Isi dropdown Status dan Jabatan
            populateSingleDropdown("status", serverOptions['Status'], "-- Pilih Status --");
            populateSingleDropdown("jabatan", serverOptions['Jabatan'], "-- Pilih Jabatan --");
            
            // Atur listener untuk dropdown "Jenjang"
            form.querySelector('#jenjang').addEventListener('change', function() {
                const selectedJenjang = this.value;
                const lembagaOptions = serverOptions['Nama Lembaga'][selectedJenjang] || [];
                const lembagaSelect = form.querySelector('#namaLembaga');
                
                lembagaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
                lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });
            
            // --- AKTIFKAN FORM DAN TUTUP SKELETON (PERBAIKAN) ---
            if (skeleton) skeleton.style.display = 'none'; // Sembunyikan skeleton
            form.style.display = 'flex'; // Tampilkan form utama sebagai flex
            // --- AKHIR PERBAIKAN ---

            document.getElementById('appModal').classList.remove('show');
        })
        .withFailureHandler(err => {
             // Tangani kegagalan server
            if (skeleton) skeleton.style.display = 'none';
            form.style.display = 'flex';
            App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`);
        })
        .getNewPtkPaudOptions(); 

    // 5. Tentukan Aturan Validasi Kustom
    
    // Validasi Tab 1 (Data Lembaga)
    formLogic.setTabValidation(0, () => formLogic.validateTab(0));

    // Validasi Tab 2 (Data Pribadi)
    formLogic.setTabValidation(1, () => {
        if (!formLogic.validateTab(1)) return false; 
        
        // Validasi Kustom "Jurusan"
        const pendidikan = form.querySelector('#pendidikan').value;
        const jurusanInput = form.querySelector('#jurusan');
        const jurusan = jurusanInput.value;
        const needsJurusan = ['S2', 'S1', 'D4', 'D3', 'D2', 'SMA', 'SMK', 'MA', 'Paket C'].includes(pendidikan);

        if (needsJurusan && !jurusan) {
            App.showAppModal('error', 'Jurusan wajib diisi untuk jenjang pendidikan yang Anda pilih.');
            jurusanInput.classList.add('input-error');
            return false;
        }
        
        return true; // Lolos semua
    });
    
    // Validasi Tab 3 (Data Kepegawaian)
    formLogic.setTabValidation(2, () => formLogic.validateTab(2));


    // 6. Atur Logika "Submit" Final
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Cek semua tab sebelum mengirim
        if (!formLogic.validateTab(0)) {
            App.showAppModal('error', 'Data Lembaga (Tab 1) belum lengkap.');
            formLogic.showTab(0); // Pindahkan ke tab yang error
            return;
        }
        if (!formLogic.validateTab(1)) {
            formLogic.showTab(1); // Pindahkan ke tab yang error
            return;
        }
        if (!formLogic.validateTab(2)) {
            App.showAppModal('error', 'Data Kepegawaian (Tab 3) belum lengkap.');
            formLogic.showTab(2); // Pindahkan ke tab yang error
            return;
        }

        // --- Jika Semua Lolos ---
        const submitButton = form.querySelector('#finalSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                App.showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkPaud(formData); // Memanggil fungsi code.gs yang sudah ada
    });
}

function initPtkEditPaudPage(params) {
    const form = document.getElementById('editPtkPaudForm');
    const skeleton = document.getElementById('skeleton-loader');
    
    if (!form || !params || !params.rowIndex) {
        if(skeleton) skeleton.style.display = 'none';
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;
    if (skeleton) skeleton.style.display = 'block';

    // 2. Inisialisasi "Mesin" Tab
    const formLogic = App.setupTabForm('editPtkPaudForm');
    let serverOptions = {};

    // 3. Fungsi untuk mengisi dropdown
    function populateSingleDropdown(elementId, optionsArray, defaultText) {
        const dropdown = form.querySelector('#' + elementId);
        if (!dropdown) return;
        dropdown.innerHTML = `<option value="" disabled selected>${defaultText}</option>`;
        if (optionsArray && optionsArray.length > 0) {
            optionsArray.forEach(item => {
                let option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                dropdown.appendChild(option);
            });
        }
    }

    // --- PANGGIL DATA OPSI DROPDOWN ---
    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                if (skeleton) skeleton.style.display = 'none';
                form.style.display = 'flex';
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            serverOptions = options; 

            // Isi dropdown Statis (Status dan Jabatan)
            populateSingleDropdown("status", serverOptions['Status'], "-- Pilih Status --");
            populateSingleDropdown("jabatan", serverOptions['Jabatan'], "-- Pilih Jabatan --");
            
            // Atur listener untuk dropdown "Jenjang"
            const jenjangSelect = form.querySelector('#jenjang');
            const lembagaSelect = form.querySelector('#namaLembaga');
            
            jenjangSelect.addEventListener('change', function() {
                const selectedJenjang = this.value;
                const lembagaOptions = serverOptions['Nama Lembaga'][selectedJenjang] || [];
                lembagaSelect.innerHTML = '<option value="" disabled selected>-- Pilih Lembaga --</option>';
                lembagaOptions.forEach(l => lembagaSelect.add(new Option(l, l)));
                lembagaSelect.disabled = false;
            });

            // --- PANGGIL DATA BARIS YANG AKAN DIEDIT (CHAINING) ---
            google.script.run
                .withSuccessHandler(rowData => {
                    if (rowData.error) {
                        App.showAppModal('error', `Gagal memuat data baris: ${rowData.error}`);
                        return;
                    }

                    // 1. Isi Semua Field Form
                    for (const key in rowData) {
                        const field = form.querySelector(`[name="${key}"]`);
                        if (field) {
                            if (key === 'TMT' && rowData[key]) {
                                field.value = rowData[key]; // yyyy-MM-dd
                            } else {
                                field.value = rowData[key];
                            }
                        }
                    }

                    // 2. Taktik Kunci: Isi Dropdown Bertingkat
                    jenjangSelect.value = rowData['Jenjang'];
                    jenjangSelect.dispatchEvent(new Event('change')); // Picu event 'change'
                    lembagaSelect.value = rowData['Nama Lembaga']; // Set nilai anak

                    // 3. Tampilkan Form, Sembunyikan Skeleton
                    if (skeleton) skeleton.style.display = 'none';
                    form.style.display = 'flex';
                    document.getElementById('appModal').classList.remove('show');

                })
                .withFailureHandler(err => { 
                    if (skeleton) skeleton.style.display = 'none';
                    form.style.display = 'flex';
                    App.showAppModal('error', `Gagal mengambil data baris: ${err.message}`);
                })
                .getPtkPaudDataByRow(params.rowIndex); 

        })
        .withFailureHandler(err => { 
            if (skeleton) skeleton.style.display = 'none';
            form.style.display = 'flex';
            App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`);
        })
        .getNewPtkPaudOptions(); 

    // 5. Tentukan Aturan Validasi Kustom
    formLogic.setTabValidation(0, () => formLogic.validateTab(0));
    formLogic.setTabValidation(1, () => {
        if (!formLogic.validateTab(1)) return false; 
        // Validasi Kustom "Jurusan"
        const pendidikan = form.querySelector('#pendidikan').value;
        const jurusanInput = form.querySelector('#jurusan');
        const jurusan = jurusanInput.value;
        const needsJurusan = ['S2', 'S1', 'D4', 'D3', 'D2', 'SMA', 'SMK', 'MA', 'Paket C'].includes(pendidikan);
        if (needsJurusan && !jurusan) {
            App.showAppModal('error', 'Jurusan wajib diisi untuk jenjang pendidikan yang Anda pilih.');
            jurusanInput.classList.add('input-error');
            return false;
        }
        return true; 
    });
    formLogic.setTabValidation(2, () => formLogic.validateTab(2));

    // 6. Atur Logika "Submit" Final
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Cek semua tab
        if (!formLogic.validateTab(0)) { App.showAppModal('error', 'Data Lembaga (Tab 1) belum lengkap.'); formLogic.showTab(0); return; }
        if (!formLogic.validateTab(1)) { formLogic.showTab(1); return; }
        if (!formLogic.validateTab(2)) { App.showAppModal('error', 'Data Kepegawaian (Tab 3) belum lengkap.'); formLogic.showTab(2); return; }

        const submitButton = form.querySelector('#editSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                App.showAppModal('success', response, 'ptk_kelola_paud');
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .updatePtkPaudData(formData); 
    });
}

function initPtkJumlahBulananSdPage() {
    // 1. Tentukan target elemen (menggunakan ID dari page_ptk_jumlah_bulanan_sd.html)
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('jumlahPtkSdBulananTable'); // <-- Target tabel yang benar
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    
    // Ambil semua filter dari halaman
    const filterContainer = document.querySelector('.filter-container');
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterStatus = document.getElementById('filterStatusSekolah'); // <-- PERBAIKI: ID di HTML Anda adalah 'filterStatusSekolah'

    let allDataRows = []; // Menyimpan baris data asli (tengah)
    let headerRow1_Data = []; // Data mentah header 1
    let headerRow2_Data = []; // Data mentah header 2
    
    // Indeks kolom untuk filter
    let tahunColumnIndex = -1;
    let bulanColumnIndex = -1;
    let statusColumnIndex = -1;
    let dataHeaderCount = 0; // Untuk colspan

    // 2. Fungsi untuk membangun <tbody> DAN <tfoot> (DINAMIS)
    function buildTableBody() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = ''; // Kosongkan footer setiap kali filter
        
        const valTahun = filterTahun.value;
        const valBulan = filterBulan.value;
        const valStatus = filterStatus.value; // <-- PERBAIKI: Menggunakan filterStatus
        
        const filteredRows = allDataRows.filter(row => {
            const matchTahun = !valTahun || (tahunColumnIndex !== -1 && String(row[tahunColumnIndex]).trim() === valTahun);
            const matchBulan = !valBulan || (bulanColumnIndex !== -1 && String(row[bulanColumnIndex]).trim() === valBulan);
            const matchStatus = !valStatus || (statusColumnIndex !== -1 && String(row[statusColumnIndex]).trim() === valStatus); // <-- PERBAIKI: Logika filter Status
            return matchTahun && matchBulan && matchStatus;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${dataHeaderCount + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            tableFoot.classList.remove('has-content');
            return; // Stop jika tidak ada data
        }

        // --- MULAI Kalkulasi Total Dinamis ---
        
        // Asumsi: Kolom 5 ("Jml. Rombel") adalah awal penjumlahan (indeks ke-4)
        const sumStartIndex = 4; 
        const totals = new Array(dataHeaderCount).fill(0); // Buat array [0, 0, 0, ...]

        // 1. Bangun <tbody>
        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Tambah "No."
            
            let rowCells = row.map((cell, cellIndex) => {
                const rawValue = (cell === "" || cell === null || cell === undefined) ? 0 : cell;
                const displayValue = (rawValue == 0) ? '-' : rawValue; // Tampilkan 0 sebagai '-'
                
                if (cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(rawValue).replace(/,/g, '')) || 0;
                    totals[cellIndex] += numericValue; 
                }
                return `<td>${displayValue}</td>`;
            });

            cellsHTML += rowCells.join('');
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });
        // --- Selesai <tbody> ---

        // --- 2. Bangun <tfoot> DINAMIS ---
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>';       // Kolom No.
        footerHTML += '<td>JUMLAH</td>'; // Kolom Nama Sekolah (Index 0)
        footerHTML += '<td>-</td>';       // Kolom NPSN (Index 1)
        footerHTML += '<td>-</td>';       // Kolom Jenjang (Index 2)
        footerHTML += '<td>-</td>';       // Kolom Status (Index 3)
        
        // Loop untuk kolom total (mulai dari index 4 / "Rombel")
        for (let i = sumStartIndex; i < totals.length; i++) {
            let displayTotal = (totals[i] === 0) ? '-' : totals[i];
            footerHTML += `<td>${displayTotal}</td>`;
        }

        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
        tableFoot.classList.add('has-content');
    }

    // 3. Fungsi buildTableHeader (v2 - Logika header gabungan yang benar)
    function buildTableHeader() {
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = ''; 
        dataHeaderCount = headerRow1_Data.length; 

        for (let i = 0; i < headerRow1_Data.length; i++) {
            const header1 = headerRow1_Data[i];
            const header2 = headerRow2_Data[i];

            if (header1 !== "" && header2 === "") {
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } 
            else if (header1 !== "" && header2 !== "") {
                let colspan = 1;
                for (let j = i + 1; j < headerRow1_Data.length; j++) {
                    if (headerRow1_Data[j] === "" && headerRow2_Data[j] !== "") {
                        colspan++;
                    } else {
                        break; 
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } 
            else if (header1 === "" && header2 !== "") {
                 row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk mengisi dropdown filter
    function setupFilters() {
        // Cari indeks berdasarkan header baris PERTAMA
        tahunColumnIndex = headerRow1_Data.indexOf('Tahun');
        bulanColumnIndex = headerRow1_Data.indexOf('Bulan');
        statusColumnIndex = headerRow1_Data.indexOf('Status');
        
        const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

        // ===============================================
        // === LOGIKA BARU UNTUK DEFAULT TANGGAL ===
        // ===============================================
        const d = new Date();
        const currentYear = d.getFullYear().toString();
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        
        let lastMonthIndex = d.getMonth() - 1; // getMonth() itu 0-11
        let yearOfLastMonth = currentYear;

        // Penanganan jika sekarang Januari (0), bulan lalu adalah Desember (11) TAHUN LALU
        if (lastMonthIndex < 0) { 
            lastMonthIndex = 11; // Desember
            yearOfLastMonth = (d.getFullYear() - 1).toString();
        }
        const lastMonthName = monthNames[lastMonthIndex];
        // ===============================================
        
        if (tahunColumnIndex !== -1) {
            const unique = [...new Set(allDataRows.map(row => row[tahunColumnIndex]))].filter(Boolean).sort().reverse();
            filterTahun.innerHTML = '<option value="">Semua Tahun</option>';
            unique.forEach(val => filterTahun.add(new Option(val, val)));
            
            // Set default Tahun (Gunakan tahun dari bulan lalu)
            if (unique.includes(yearOfLastMonth)) {
                filterTahun.value = yearOfLastMonth;
            }
        }
        if (bulanColumnIndex !== -1) {
            const unique = [...new Set(allDataRows.map(row => row[bulanColumnIndex]))].filter(Boolean)
                             .sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
            filterBulan.innerHTML = '<option value="">Semua Bulan</option>';
            unique.forEach(val => filterBulan.add(new Option(val, val)));

            // Set default Bulan (Bulan lalu)
            if (unique.includes(lastMonthName)) {
                filterBulan.value = lastMonthName;
            }
        }
        if (statusColumnIndex !== -1) {
            const unique = [...new Set(allDataRows.map(row => row[statusColumnIndex]))].filter(Boolean).sort();
            filterStatus.innerHTML = '<option value="">Semua Status</option>'; // <-- PERBAIKI: Menggunakan filterStatus
            unique.forEach(val => filterStatus.add(new Option(val, val))); // <-- PERBAIKI: Menggunakan filterStatus
        }
        
        // Tampilkan filter & tambahkan listener
        filterContainer.style.display = 'flex';
        filterTahun.addEventListener('change', buildTableBody);
        filterBulan.addEventListener('change', buildTableBody);
        filterStatus.addEventListener('change', buildTableBody); // <-- PERBAIKI: Menggunakan filterStatus
    }

    // 5. Ambil data mentah dari server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            
            if (!data || data.length < 3) {
                loadingStatus.innerHTML = '<p>Data tidak memadai untuk ditampilkan (kurang dari 3 baris).</p>';
                return;
            }

            // --- Logika Pemisahan Data ---
            headerRow1_Data = data[0]; // Baris 1 (Header Grup)
            headerRow2_Data = data[1]; // Baris 2 (Subheader)
            allDataRows = data.slice(2, data.length - 1); // Abaikan footer statis
            // --- Selesai Logika Pemisahan ---
            
            buildTableHeader();
            setupFilters(); // Buat filter

            // Tampilkan tabel dan jalankan filter pertama kali
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'block';
            buildTableBody(); // <-- Panggilan pertama untuk mengisi tabel

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getPtkJumlahBulananSdData(); // <-- Memanggil fungsi code.gs
}

function initPtkDaftarSdnPage() {
    // 1. Tentukan target elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('daftarPtkSdnTable');
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const paginationContainer = document.getElementById('pagination-container');
    
    // Ambil semua filter (TERMASUK 3 YANG BARU)
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const filterStatus = document.getElementById('filterStatus');
    const filterPangkat = document.getElementById('filterPangkat');
    const filterJabatan = document.getElementById('filterJabatan');
    const filterPendidikan = document.getElementById('filterPendidikan'); // <-- BARU
    const filterDapodik = document.getElementById('filterDapodik');       // <-- BARU
    const filterSerdik = document.getElementById('filterSerdik');         // <-- BARU

    let allDataRows = []; // Menyimpan baris data asli (setelah header)
    let allHeaders = [];  // Menyimpan header
    
    // Indeks kolom untuk filter (DITAMBAH 3)
    let filterIndices = {
        'Unit Kerja': -1,
        'Status': -1,
        'Pangkat': -1,
        'Jabatan': -1,
        'Pendidikan': -1, // <-- BARU
        'Dapodik': -1,    // <-- BARU
        'Serdik': -1      // <-- BARU
    };
    
    let currentPage = 1;
    let rowsPerPage = 15; // Default

    // 2. Fungsi Paginasi (disalin dari logika generik)
    const calculateRowsPerPage = () => {
        const tableContainer = table.closest('.table-container');
        if (!tableContainer) return 15;
        const bottomOffset = 180; // Ruang untuk pagination + footer
        const rowHeight = 38; 
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - bottomOffset;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    };

    const setupPagination = (totalRows) => {
        if (!paginationContainer) return;
        const pageCount = Math.ceil(totalRows / rowsPerPage) || 1;
        
        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';
        const pageInfo = `<span class="page-info">Halaman ${currentPage} dari ${pageCount}</span>`;
        const prevBtn = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="App.changePage_DaftarPTKSDN(-1)">Â«</button>`;
        const nextBtn = `<button class="page-btn" ${currentPage === pageCount ? 'disabled' : ''} onclick="App.changePage_DaftarPTKSDN(1)">Â»</button>`;
        paginationContainer.innerHTML = prevBtn + pageInfo + nextBtn;
    };

    // Buat fungsi ganti halaman khusus untuk tabel ini
    App.changePage_DaftarPTKSDN = (direction) => {
        currentPage += direction;
        buildTableBody();
    };

    // 3. Fungsi untuk membangun <tbody> (DITAMBAH 3 LOGIKA FILTER)
    function buildTableBody() {
        tableBody.innerHTML = '';
        
        const valUnitKerja = filterUnitKerja.value;
        const valStatus = filterStatus.value;
        const valPangkat = filterPangkat.value;
        const valJabatan = filterJabatan.value;
        const valPendidikan = filterPendidikan.value; // <-- BARU
        const valDapodik = filterDapodik.value;     // <-- BARU
        const valSerdik = filterSerdik.value;         // <-- BARU
        
        const filteredRows = allDataRows.filter(row => {
            const matchUK = !valUnitKerja || (filterIndices['Unit Kerja'] !== -1 && String(row[filterIndices['Unit Kerja']]).trim() === valUnitKerja);
            const matchStatus = !valStatus || (filterIndices['Status'] !== -1 && String(row[filterIndices['Status']]).trim() === valStatus);
            const matchPangkat = !valPangkat || (filterIndices['Pangkat'] !== -1 && String(row[filterIndices['Pangkat']]).trim() === valPangkat);
            const matchJabatan = !valJabatan || (filterIndices['Jabatan'] !== -1 && String(row[filterIndices['Jabatan']]).trim() === valJabatan);
            
            // LOGIKA FILTER BARU
            const matchPendidikan = !valPendidikan || (filterIndices['Pendidikan'] !== -1 && String(row[filterIndices['Pendidikan']]).trim() === valPendidikan);
            const matchDapodik = !valDapodik || (filterIndices['Dapodik'] !== -1 && String(row[filterIndices['Dapodik']]).trim() === valDapodik);
            const matchSerdik = !valSerdik || (filterIndices['Serdik'] !== -1 && String(row[filterIndices['Serdik']]).trim() === valSerdik);
            
            // Kembalikan semua kondisi
            return matchUK && matchStatus && matchPangkat && matchJabatan && matchPendidikan && matchDapodik && matchSerdik;
        });

        // Hitung ulang paginasi
        rowsPerPage = calculateRowsPerPage();
        const pageCount = Math.ceil(filteredRows.length / rowsPerPage) || 1;
        currentPage = Math.min(currentPage, pageCount) || 1;
        const start = (currentPage - 1) * rowsPerPage;
        const paginatedRows = filteredRows.slice(start, start + rowsPerPage);
        
        setupPagination(filteredRows.length);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Bangun baris <tbody>
        paginatedRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            const rowNumber = (currentPage - 1) * rowsPerPage + index + 1;
            
            let cellsHTML = `<td>${rowNumber}</td>`; // Tambah "No."
            
            // Tambahkan sisa sel dari data
            cellsHTML += row.map(cell => {
                const displayValue = (cell === "" || cell === null || cell === undefined || cell == 0) ? '-' : cell;
                return `<td>${displayValue}</td>`;
            }).join('');
            
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });
    }

    // 4. Fungsi untuk mengisi dropdown filter (DITAMBAH 3 FILTER BARU)
    function setupFilters() {
        // Cari indeks kolom berdasarkan nama header
        filterIndices['Unit Kerja'] = allHeaders.indexOf('Unit Kerja');
        filterIndices['Status'] = allHeaders.indexOf('Status');
        filterIndices['Pangkat'] = allHeaders.indexOf('Pangkat, Gol./Ruang'); // Sesuaikan nama lengkap
        filterIndices['Jabatan'] = allHeaders.indexOf('Jabatan');
        filterIndices['Pendidikan'] = allHeaders.indexOf('Pendidikan'); // <-- BARU
        filterIndices['Dapodik'] = allHeaders.indexOf('Dapodik');       // <-- BARU
        filterIndices['Serdik'] = allHeaders.indexOf('Serdik');         // <-- BARU

        // Fungsi helper untuk mengisi satu dropdown
        function populateFilter(selectEl, columnIndex) {
            if (!selectEl || columnIndex === -1) {
                // Sembunyikan filter jika kolom tidak ditemukan di spreadsheet
                if(selectEl) selectEl.parentElement.style.display = 'none';
                return;
            }
            
            const unique = [...new Set(allDataRows.map(row => String(row[columnIndex]).trim()))].filter(Boolean).sort();
            selectEl.innerHTML = `<option value="">Semua</option>`; // Teks default "Semua"
            unique.forEach(val => selectEl.add(new Option(val, val)));
            
            // Tambahkan event listener
            selectEl.addEventListener('change', () => {
                currentPage = 1; // Reset ke halaman 1 saat filter
                buildTableBody();
            });
        }
        
        // Isi semua filter
        populateFilter(filterUnitKerja, filterIndices['Unit Kerja']);
        populateFilter(filterStatus, filterIndices['Status']);
        populateFilter(filterPangkat, filterIndices['Pangkat']);
        populateFilter(filterJabatan, filterIndices['Jabatan']);
        populateFilter(filterPendidikan, filterIndices['Pendidikan']); // <-- BARU
        populateFilter(filterDapodik, filterIndices['Dapodik']);       // <-- BARU
        populateFilter(filterSerdik, filterIndices['Serdik']);         // <-- BARU
    }

    // 5. Ambil data mentah dari server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            
            if (!data || data.length < 2) {
                loadingStatus.innerHTML = '<p>Data tidak ditemukan di spreadsheet.</p>';
                return;
            }

            // --- Logika Pemisahan Data ---
            allHeaders = data[0]; // Baris 1 adalah Header
            allDataRows = data.slice(1); // Sisanya adalah Data
            // --- Selesai Logika Pemisahan ---
            
            // Buat <thead> (SESUAI PERMINTAAN: Sesuai urutan spreadsheet)
            tableHead.innerHTML = `<tr><th>No.</th>${allHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;

            // Buat filter
            setupFilters(); 

            // Tampilkan tabel dan jalankan filter pertama kali
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'block';
            buildTableBody(); // <-- Panggilan pertama untuk mengisi tabel

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getDaftarPtkSdnData(); // <-- Memanggil fungsi code.gs
}

function initPtkDaftarSdsPage() {
    // 1. Tentukan target elemen (dari page_ptk_daftar_sd_swasta.html)
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('daftarPtkSdsTable'); // <-- Target tabel SWASTA
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const paginationContainer = document.getElementById('pagination-container');
    
    // Ambil semua filter (TERMASUK 3 YANG BARU)
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const filterStatus = document.getElementById('filterStatus');
    const filterJabatan = document.getElementById('filterJabatan');
    const filterPendidikan = document.getElementById('filterPendidikan'); // <-- BARU
    const filterDapodik = document.getElementById('filterDapodik');       // <-- BARU
    const filterSerdik = document.getElementById('filterSerdik');         // <-- BARU

    let allDataRows = []; // Menyimpan baris data asli (setelah header)
    let allHeaders = [];  // Menyimpan header
    
    // Indeks kolom untuk filter (DITAMBAH 3)
    let filterIndices = {
        'Unit Kerja': -1,
        'Status': -1,
        'Jabatan': -1,
        'Pendidikan': -1, // <-- BARU
        'Dapodik': -1,    // <-- BARU
        'Serdik': -1      // <-- BARU
        // (Filter 'Pangkat' tidak ada di sini, sesuai file HTML Anda)
    };
    
    let currentPage = 1;
    let rowsPerPage = 15; // Default

    // 2. Fungsi Paginasi
    const calculateRowsPerPage = () => {
        const tableContainer = table.closest('.table-container');
        if (!tableContainer) return 15;
        const bottomOffset = 180;
        const rowHeight = 38; 
        const availableHeight = window.innerHeight - tableContainer.getBoundingClientRect().top - bottomOffset;
        return Math.max(5, Math.floor(availableHeight / rowHeight));
    };

    const setupPagination = (totalRows) => {
        if (!paginationContainer) return;
        const pageCount = Math.ceil(totalRows / rowsPerPage) || 1;
        
        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';
        const pageInfo = `<span class="page-info">Halaman ${currentPage} dari ${pageCount}</span>`;
        // Buat fungsi ganti halaman unik
        const prevBtn = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="App.changePage_DaftarPTKSDS(-1)">Â«</button>`;
        const nextBtn = `<button class="page-btn" ${currentPage === pageCount ? 'disabled' : ''} onclick="App.changePage_DaftarPTKSDS(1)">Â»</button>`;
        paginationContainer.innerHTML = prevBtn + pageInfo + nextBtn;
    };

    // Fungsi ganti halaman unik untuk tabel SWASTA
    App.changePage_DaftarPTKSDS = (direction) => {
        currentPage += direction;
        buildTableBody();
    };

    // 3. Fungsi untuk membangun <tbody> (DITAMBAH 3 LOGIKA FILTER)
    function buildTableBody() {
        tableBody.innerHTML = '';
        
        const valUnitKerja = filterUnitKerja.value;
        const valStatus = filterStatus.value;
        const valJabatan = filterJabatan.value;
        const valPendidikan = filterPendidikan.value; // <-- BARU
        const valDapodik = filterDapodik.value;     // <-- BARU
        const valSerdik = filterSerdik.value;         // <-- BARU
        
        const filteredRows = allDataRows.filter(row => {
            const matchUK = !valUnitKerja || (filterIndices['Unit Kerja'] !== -1 && String(row[filterIndices['Unit Kerja']]).trim() === valUnitKerja);
            const matchStatus = !valStatus || (filterIndices['Status'] !== -1 && String(row[filterIndices['Status']]).trim() === valStatus);
            const matchJabatan = !valJabatan || (filterIndices['Jabatan'] !== -1 && String(row[filterIndices['Jabatan']]).trim() === valJabatan);
            
            // LOGIKA FILTER BARU
            const matchPendidikan = !valPendidikan || (filterIndices['Pendidikan'] !== -1 && String(row[filterIndices['Pendidikan']]).trim() === valPendidikan);
            const matchDapodik = !valDapodik || (filterIndices['Dapodik'] !== -1 && String(row[filterIndices['Dapodik']]).trim() === valDapodik);
            const matchSerdik = !valSerdik || (filterIndices['Serdik'] !== -1 && String(row[filterIndices['Serdik']]).trim() === valSerdik);
            
            // Kembalikan semua kondisi
            return matchUK && matchStatus && matchJabatan && matchPendidikan && matchDapodik && matchSerdik;
        });

        // Hitung ulang paginasi
        rowsPerPage = calculateRowsPerPage();
        const pageCount = Math.ceil(filteredRows.length / rowsPerPage) || 1;
        currentPage = Math.min(currentPage, pageCount) || 1;
        const start = (currentPage - 1) * rowsPerPage;
        const paginatedRows = filteredRows.slice(start, start + rowsPerPage);
        
        setupPagination(filteredRows.length);

        if (paginatedRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Bangun baris <tbody>
        paginatedRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            const rowNumber = (currentPage - 1) * rowsPerPage + index + 1;
            
            let cellsHTML = `<td>${rowNumber}</td>`; // Tambah "No."
            
            // Tambahkan sisa sel dari data
            cellsHTML += row.map(cell => {
                const displayValue = (cell === "" || cell === null || cell === undefined || cell == 0) ? '-' : cell;
                return `<td>${displayValue}</td>`;
            }).join('');
            
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });
    }

    // 4. Fungsi untuk mengisi dropdown filter (DITAMBAH 3 FILTER BARU)
    function setupFilters() {
        // Cari indeks kolom berdasarkan nama header
        filterIndices['Unit Kerja'] = allHeaders.indexOf('Unit Kerja');
        filterIndices['Status'] = allHeaders.indexOf('Status');
        filterIndices['Jabatan'] = allHeaders.indexOf('Jabatan');
        filterIndices['Pendidikan'] = allHeaders.indexOf('Pendidikan'); // <-- BARU
        filterIndices['Dapodik'] = allHeaders.indexOf('Dapodik');       // <-- BARU
        filterIndices['Serdik'] = allHeaders.indexOf('Serdik');         // <-- BARU

        // Fungsi helper untuk mengisi satu dropdown
        function populateFilter(selectEl, columnIndex) {
            if (!selectEl || columnIndex === -1) {
                // Sembunyikan filter jika kolom tidak ditemukan di spreadsheet
                if(selectEl) selectEl.parentElement.style.display = 'none';
                return;
            }
            
            const unique = [...new Set(allDataRows.map(row => String(row[columnIndex]).trim()))].filter(Boolean).sort();
            selectEl.innerHTML = `<option value="">Semua</option>`; // Teks default "Semua"
            unique.forEach(val => selectEl.add(new Option(val, val)));
            
            // Tambahkan event listener
            selectEl.addEventListener('change', () => {
                currentPage = 1; // Reset ke halaman 1 saat filter
                buildTableBody();
            });
        }
        
        // Isi semua filter
        populateFilter(filterUnitKerja, filterIndices['Unit Kerja']);
        populateFilter(filterStatus, filterIndices['Status']);
        populateFilter(filterJabatan, filterIndices['Jabatan']);
        populateFilter(filterPendidikan, filterIndices['Pendidikan']); // <-- BARU
        populateFilter(filterDapodik, filterIndices['Dapodik']);       // <-- BARU
        populateFilter(filterSerdik, filterIndices['Serdik']);         // <-- BARU
    }

    // 5. Ambil data mentah dari server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            
            if (!data || data.length < 2) {
                loadingStatus.innerHTML = '<p>Data tidak ditemukan di spreadsheet.</p>';
                return;
            }

            // --- Logika Pemisahan Data ---
            allHeaders = data[0]; // Baris 1 adalah Header
            allDataRows = data.slice(1); // Sisanya adalah Data
            // --- Selesai Logika Pemisahan ---
            
            // Buat <thead> (SESUAI PERMINTAAN: Sesuai urutan spreadsheet)
            tableHead.innerHTML = `<tr><th>No.</th>${allHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;

            // Buat filter
            setupFilters(); 

            // Tampilkan tabel dan jalankan filter pertama kali
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'block';
            buildTableBody(); // <-- Panggilan pertama untuk mengisi tabel

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getDaftarPtkSdsData(); // <-- Memanggil fungsi code.gs SWASTA
}

function initPtkKelolaSdPage() {
    // Definisi header yang diinginkan di tabel
    const desiredHeaders = [
        "Nama", "Unit Kerja", "Status", "NIP/NIY", "Jabatan", "Aksi", "Input", "Update"
    ];

    App.initializeGenericTablePage({
        tableId: 'kelolaPtkSdTable',
        serverFunction: 'getKelolaPtkSdData',
        displayHeaders: desiredHeaders, // Gunakan header yang sudah didefinisikan
        editPage: 'ptk_edit_sd',
        
        // KONFIGURASI FILTER BARU (Cascading Filter + Search)
        filters: [
            // Filter 1: Status Sekolah (Parent)
            { 
              id: 'filterStatusSekolah', 
              dataColumn: 'Status', // Sekarang Status Sekolah (Negeri/Swasta)
              defaultText: 'Semua Status' 
            },
            // Filter 2: Unit Kerja (Child)
            { 
              id: 'filterUnitKerja', 
              dataColumn: 'Unit Kerja', 
              type: 'cascading-local',
              parent: 'filterStatusSekolah',      
              parentKey: 'Status',      
              defaultText: 'Semua Unit Kerja' 
            }
        ]
    });

    document.getElementById('tambahPtkSdBtn').addEventListener('click', (e) => {
        App.loadPage(e, 'ptk_tambah_sd');
    });
}

function initPtkTambahSdPage() {
    const form = document.getElementById('addPtkSdForm');
    const skeleton = document.getElementById('skeleton-loader'); 
    
    // Pastikan form disembunyikan sejak awal
    if (form) form.style.display = 'none';

    // Tampilkan skeleton segera
    if (skeleton) skeleton.style.display = 'block';
    
    if (!form) return;

    // 1. Inisialisasi "Mesin" Tab
    const formLogic = App.setupTabForm('addPtkSdForm');
    
    // 2. Variabel untuk elemen form
    const statusSekolahSelect = form.querySelector('#statusSekolah');
    const unitKerjaSelect = form.querySelector('#unitKerja');
    const formNegeri = form.querySelector('#form-negeri');
    const formSwasta = form.querySelector('#form-swasta');
    
    // Variabel untuk dropdown di Tab 2 & 3
    const agamaSelect = form.querySelector('#agama');
    const pendidikanSelect = form.querySelector('#pendidikan');
    const statusNegeriSelect = form.querySelector('#statusNegeri');
    const pangkatNegeriSelect = form.querySelector('#pangkatNegeri');
    const statusSwastaSelect = form.querySelector('#statusSwasta');
    const jabatanSelect = form.querySelector('#jabatan');
    const tugasTambahanSelect = form.querySelector('#tugasTambahan');
    
    let allOptions = {}; // Untuk menyimpan data DARI SERVER

    // 3. Fungsi helper untuk mengisi dropdown
    function populateSelect(selectEl, optionsArr, placeholder) {
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="" disabled selected>-- ${placeholder} --</option>`;
        if (optionsArr) optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
    }

    // 4. Isi dropdown STATIS
    if (typeof DROPDOWN_STATIS !== 'undefined') {
        populateSelect(agamaSelect, DROPDOWN_STATIS['Agama'], 'Pilih Agama');
        populateSelect(pendidikanSelect, DROPDOWN_STATIS['Pendidikan'], 'Pilih Pendidikan');
        populateSelect(statusNegeriSelect, DROPDOWN_STATIS['StatusKepegawaian'], 'Pilih Status');
        populateSelect(statusSwastaSelect, DROPDOWN_STATIS['StatusKepegawaianSwasta'], 'Pilih Status');
        populateSelect(jabatanSelect, DROPDOWN_STATIS['TugasJabatan'], 'Pilih Tugas/Jabatan');
        populateSelect(tugasTambahanSelect, DROPDOWN_STATIS['TugasTambahan'], 'Pilih Tugas Tambahan');
    } else {
        console.error("Gagal memuat DROPDOWN_STATIS.");
    }

    // 5. Panggil data DINAMIS dari server (Unit Kerja, Pangkat)
    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                if (skeleton) skeleton.style.display = 'none';
                form.style.display = 'flex';
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            allOptions = options; // Simpan data server
            
            // 6. Logika Utama: Event Listener for "Status Sekolah" (Tab 1)
            statusSekolahSelect.addEventListener('change', function() {
                const isNegeri = this.value === 'Negeri';
                
                formNegeri.style.display = isNegeri ? 'block' : 'none';
                formSwasta.style.display = isNegeri ? 'none' : 'block';
                
                formNegeri.querySelectorAll('select, input').forEach(el => el.disabled = !isNegeri);
                formSwasta.querySelectorAll('select, input').forEach(el => el.disabled = isNegeri);

                if (isNegeri) {
                    populateSelect(unitKerjaSelect, allOptions['Unit Kerja Negeri'], 'Pilih Unit Kerja (Negeri)');
                } else {
                    populateSelect(unitKerjaSelect, allOptions['Unit Kerja Swasta'], 'Pilih Unit Kerja (Swasta)');
                }
                unitKerjaSelect.disabled = false;
                
                pangkatNegeriSelect.innerHTML = '<option value="">-- Pilih Status Dahulu --</option>';
                pangkatNegeriSelect.disabled = true;
            });

            // 7. Logika Dropdown Bertingkat: "Status Negeri" -> "Pangkat" (Tab 3)
            statusNegeriSelect.addEventListener('change', function() {
                const status = this.value;
                const nipInput = form.querySelector('#nip');
                
                const isPNS = (status === 'PNS');
                const isPPPK = (status === 'PPPK');
                const isPPPKPW = (status === 'PPPK PW'); 
                const isASN = isPNS || isPPPK || isPPPKPW;
                const isNonASN = (status === 'Tenaga Non ASN');

                nipInput.disabled = !isASN;
                nipInput.required = isASN;
                if (!isASN) {
                    nipInput.value = ""; 
                }
                
                pangkatNegeriSelect.disabled = !isASN;

                if (isPNS) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PNS'], 'Pilih Pangkat');
                } else if (isPPPK) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK'], 'Pilih Golongan');
                } else if (isPPPKPW) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK PW'], 'Pilih Golongan'); 
                } else if (isNonASN) {
                    pangkatNegeriSelect.innerHTML = '<option value="â€” Tidak Perlu Diisi â€”" selected>â€” Tidak Perlu Diisi â€”</option>';
                } else {
                     pangkatNegeriSelect.innerHTML = '<option value="">-- Pilih Status Dahulu --</option>';
                }
            });
            
            // --- AKTIFKAN FORM DAN TUTUP SKELETON (PERBAIKAN) ---
            if (skeleton) skeleton.style.display = 'none'; // Sembunyikan skeleton
            form.style.display = 'flex'; // Tampilkan form utama sebagai flex
            // --- AKHIR PERBAIKAN ---
        })
        .withFailureHandler(err => {
            // Sembunyikan skeleton dan tampilkan modal error
            if (skeleton) skeleton.style.display = 'none';
            form.style.display = 'flex';
            App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`);
        })
        .getNewPtkSdOptions(); 


    // 8. Atur Validasi Kustom untuk setiap Tab
    
    // Validasi Tab 1 (Data Sekolah)
    formLogic.setTabValidation(0, () => formLogic.validateTab(0));

    // Validasi Tab 2 (Data Pribadi)
    formLogic.setTabValidation(1, () => {
        if (!formLogic.validateTab(1)) return false; 
        
        const pendidikan = form.querySelector('#pendidikan').value;
        const jurusanInput = form.querySelector('#jurusan');
        const jurusan = jurusanInput.value;
        const needsNoJurusan = ['SD', 'MI', 'SMP', 'MTs', 'Paket A', 'Paket B'].includes(pendidikan);

        if (needsNoJurusan && jurusan !== '-') {
            App.showAppModal('error', 'Jurusan harus diisi tanda - (strip) untuk jenjang SD/SMP sederajat.');
            jurusanInput.classList.add('input-error');
            return false;
        }
        
        const nuptkInput = form.querySelector('#nuptk');
        const nuptkValue = nuptkInput.value.trim();
        const nuptkRegex = /^\d{16}$/; 

        if (nuptkValue !== "" && !nuptkRegex.test(nuptkValue)) {
            App.showAppModal('error', 'NUPTK tidak valid. Harap isikan 16 digit angka atau kosongkan field tersebut.');
            nuptkInput.classList.add('input-error'); 
            return false; 
        }
        
        nuptkInput.classList.remove('input-error');
        return true; 
    });
    
    // Validasi Tab 3 (Data Kepegawaian)
    formLogic.setTabValidation(2, () => formLogic.validateTab(2));

    // 9. Atur Logika "Submit" Final
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!formLogic.validateTab(0)) {
            App.showAppModal('error', 'Data Sekolah (Tab 1) belum lengkap.');
            formLogic.showTab(0); 
            return;
        }
        if (!formLogic.validateTab(1)) {
            formLogic.showTab(1); 
            return;
        }
        if (!formLogic.validateTab(2)) {
            App.showAppModal('error', 'Data Kepegawaian (Tab 3) belum lengkap.');
            formLogic.showTab(2); 
            return;
        }

        const submitButton = form.querySelector('#finalSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan data PTK baru...');

        const formData = Object.fromEntries(new FormData(form));
        
        google.script.run
            .withSuccessHandler(response => {
                if (response && response.error) {
                    App.showAppModal('error', `Gagal: ${response.error}`);
                    submitButton.disabled = false;
                } else {
                    App.showAppModal('success', response, 'ptk_kelola_sd');
                }
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .addNewPtkSd(formData); 
    });
}

function initPtkEditSdPage(params) {
    const form = document.getElementById('editPtkSdForm');
    const skeleton = document.getElementById('skeleton-loader'); 
    
    if (!form || !params || !params.rowIndex || !params.source) {
        if(skeleton) skeleton.style.display = 'none';
        document.getElementById('main-content').innerHTML = `<p style="color:red; text-align:center;">Error: Parameter untuk edit (rowIndex/source) tidak ditemukan.</p>`;
        return;
    }

    form.querySelector('[name="rowIndex"]').value = params.rowIndex;
    form.querySelector('[name="source"]').value = params.source;
    if (skeleton) skeleton.style.display = 'block';

    // 1. Inisialisasi "Mesin" Tab
    const formLogic = App.setupTabForm('editPtkSdForm');
    
    // 2. Variabel untuk elemen form
    const statusSekolahSelect = form.querySelector('#statusSekolah');
    const unitKerjaSelect = form.querySelector('#unitKerja');
    const formNegeri = form.querySelector('#form-negeri');
    const formSwasta = form.querySelector('#form-swasta');
    
    // Variabel untuk dropdown di Tab 2 & 3
    const agamaSelect = form.querySelector('#agama');
    const pendidikanSelect = form.querySelector('#pendidikan');
    const statusNegeriSelect = form.querySelector('#statusNegeri');
    const pangkatNegeriSelect = form.querySelector('#pangkatNegeri');
    const statusSwastaSelect = form.querySelector('#statusSwasta');
    const jabatanSelect = form.querySelector('#jabatan');
    const tugasTambahanSelect = form.querySelector('#tugasTambahan');
    
    let allOptions = {}; // Untuk menyimpan data DARI SERVER

    // 3. Fungsi helper untuk mengisi dropdown
    function populateSelect(selectEl, optionsArr, placeholder) {
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="" disabled selected>-- ${placeholder} --</option>`;
        if (optionsArr) optionsArr.forEach(opt => selectEl.add(new Option(opt, opt)));
    }

    // 4. Isi dropdown STATIS
    if (typeof DROPDOWN_STATIS !== 'undefined') {
        populateSelect(agamaSelect, DROPDOWN_STATIS['Agama'], 'Pilih Agama');
        populateSelect(pendidikanSelect, DROPDOWN_STATIS['Pendidikan'], 'Pilih Pendidikan');
        populateSelect(statusNegeriSelect, DROPDOWN_STATIS['StatusKepegawaian'], 'Pilih Status');
        populateSelect(statusSwastaSelect, DROPDOWN_STATIS['StatusKepegawaianSwasta'], 'Pilih Status');
        populateSelect(jabatanSelect, DROPDOWN_STATIS['TugasJabatan'], 'Pilih Tugas/Jabatan');
        populateSelect(tugasTambahanSelect, DROPDOWN_STATIS['TugasTambahan'], 'Pilih Tugas Tambahan');
    } else {
        console.error("Gagal memuat DROPDOWN_STATIS.");
    }

    // 5. Panggil data DINAMIS dari server
    google.script.run
        .withSuccessHandler(options => {
            if (options.error) {
                if (skeleton) skeleton.style.display = 'none';
                form.style.display = 'flex';
                App.showAppModal('error', `Gagal memuat opsi: ${options.error}`);
                return;
            }
            allOptions = options; 
            
            // --- INI ADALAH LOGIKA BARU UNTUK MEMBUKA KUNCI ---
            // Kita tambahkan listener cascading (sama seperti form Tambah)
            statusSekolahSelect.addEventListener('change', function() {
                const isNegeri = this.value === 'Negeri';
                
                formNegeri.style.display = isNegeri ? 'block' : 'none';
                formSwasta.style.display = isNegeri ? 'none' : 'block';
                
                formNegeri.querySelectorAll('select, input').forEach(el => el.disabled = !isNegeri);
                formSwasta.querySelectorAll('select, input').forEach(el => el.disabled = isNegeri);

                if (isNegeri) {
                    populateSelect(unitKerjaSelect, allOptions['Unit Kerja Negeri'], 'Pilih Unit Kerja (Negeri)');
                } else {
                    populateSelect(unitKerjaSelect, allOptions['Unit Kerja Swasta'], 'Pilih Unit Kerja (Swasta)');
                }
                unitKerjaSelect.disabled = false;
                
                pangkatNegeriSelect.innerHTML = '<option value="">-- Pilih Status Dahulu --</option>';
                pangkatNegeriSelect.disabled = true;
                
                // BARU: Perbarui juga hidden input "source"
                form.querySelector('[name="source"]').value = isNegeri ? 'SDN' : 'SDS';
            });
            // --- AKHIR LOGIKA BARU ---
            
            // Logika Dropdown Bertingkat: "Status Negeri" -> "Pangkat" (Tab 3)
            statusNegeriSelect.addEventListener('change', function() {
                const status = this.value;
                const nipInput = form.querySelector('#nip');
                
                const isPNS = (status === 'PNS');
                const isPPPK = (status === 'PPPK');
                const isPPPKPW = (status === 'PPPK PW'); 
                const isASN = isPNS || isPPPK || isPPPKPW;
                const isNonASN = (status === 'Tenaga Non ASN');

                nipInput.disabled = !isASN;
                nipInput.required = isASN;
                if (!isASN) nipInput.value = ""; 
                
                pangkatNegeriSelect.disabled = !isASN;

                if (isPNS) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PNS'], 'Pilih Pangkat');
                } else if (isPPPK) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK'], 'Pilih Golongan');
                } else if (isPPPKPW) {
                    populateSelect(pangkatNegeriSelect, allOptions['Pangkat PPPK PW'], 'Pilih Golongan'); 
                } else if (isNonASN) {
                    pangkatNegeriSelect.innerHTML = '<option value="â€” Tidak Perlu Diisi â€”" selected>â€” Tidak Perlu Diisi â€”</option>';
                } else {
                     pangkatNegeriSelect.innerHTML = '<option value="">-- Pilih Status Dahulu --</option>';
                }
            });

            // 6. Panggil data baris yang mau diedit
            google.script.run
                .withSuccessHandler(rowData => {
                    if (rowData.error) {
                        App.showAppModal('error', `Gagal memuat data baris: ${rowData.error}`);
                        return;
                    }

                    // Isi Semua Field Form
                    for (const key in rowData) {
                        const field = form.querySelector(`[name="${key}"]`);
                        if (field) {
                            if (key === 'TMT' && rowData[key]) {
                                field.value = rowData[key]; // yyyy-MM-dd
                            } else {
                                // Ganti petik satu (misal: '00123) menjadi 00123
                                field.value = String(rowData[key]).replace(/'/g, ''); 
                            }
                        }
                    }

                    // 7. Taktik Kunci: Isi Dropdown Bertingkat
                    const isNegeri = (params.source === 'SDN');
                    
                    // Triger Tab 1 (Status Sekolah -> Unit Kerja)
                    statusSekolahSelect.value = isNegeri ? 'Negeri' : 'Swasta';
                    statusSekolahSelect.dispatchEvent(new Event('change')); // Picu event 'change'
                    unitKerjaSelect.value = rowData['Unit Kerja']; // Set nilai anak
                    
                    // Triger Tab 3 (Status Kepegawaian -> Pangkat)
                    if (isNegeri) {
                        statusNegeriSelect.value = rowData['Status'];
                        statusNegeriSelect.dispatchEvent(new Event('change'));
                        pangkatNegeriSelect.value = rowData['Pangkat, Gol./Ruang'];
                    } else {
                        statusSwastaSelect.value = rowData['Status'];
                    }

                    // 8. Buka semua tab
                    formLogic.unlockTab(1);
                    formLogic.unlockTab(2);

                    // Sembunyikan Skeleton, Tampilkan Form
                    if (skeleton) skeleton.style.display = 'none';
                    form.style.display = 'flex';

                })
                .withFailureHandler(err => { 
                    if (skeleton) skeleton.style.display = 'none';
                    form.style.display = 'flex';
                    App.showAppModal('error', `Gagal mengambil data baris: ${err.message}`);
                })
                .getPtkSdDataByRow(params.rowIndex, params.source); 

        })
        .withFailureHandler(err => {
             if (skeleton) skeleton.style.display = 'none';
             form.style.display = 'flex';
             App.showAppModal('error', `Gagal memuat opsi form: ${err.message}`);
        })
        .getNewPtkSdOptions(); 

    // 8. Atur Validasi Kustom (Sama seperti Tambah)
    formLogic.setTabValidation(0, () => formLogic.validateTab(0));
    formLogic.setTabValidation(1, () => {
        if (!formLogic.validateTab(1)) return false; 
        const pendidikan = form.querySelector('#pendidikan').value;
        const jurusanInput = form.querySelector('#jurusan');
        const jurusan = jurusanInput.value;
        const needsNoJurusan = ['SD', 'MI', 'SMP', 'MTs', 'Paket A', 'Paket B'].includes(pendidikan);
        if (needsNoJurusan && jurusan !== '-') {
            App.showAppModal('error', 'Jurusan harus diisi tanda - (strip) untuk jenjang SD/SMP sederajat.');
            jurusanInput.classList.add('input-error');
            return false;
        }
        const nuptkInput = form.querySelector('#nuptk');
        const nuptkValue = nuptkInput.value.trim();
        const nuptkRegex = /^\d{16}$/; 
        if (nuptkValue !== "" && !nuptkRegex.test(nuptkValue)) {
            App.showAppModal('error', 'NUPTK tidak valid. Harap isikan 16 digit angka atau kosongkan field tersebut.');
            nuptkInput.classList.add('input-error'); 
            return false; 
        }
        nuptkInput.classList.remove('input-error');
        return true; 
    });
    formLogic.setTabValidation(2, () => formLogic.validateTab(2));

    // 9. Atur Logika "Submit" Final
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!formLogic.validateTab(0)) { App.showAppModal('error', 'Data Sekolah (Tab 1) belum lengkap.'); formLogic.showTab(0); return; }
        if (!formLogic.validateTab(1)) { formLogic.showTab(1); return; }
        if (!formLogic.validateTab(2)) { App.showAppModal('error', 'Data Kepegawaian (Tab 3) belum lengkap.'); formLogic.showTab(2); return; }

        const submitButton = form.querySelector('#editSubmitBtn');
        submitButton.disabled = true;
        App.showAppModal('loading', 'Menyimpan perubahan...');

        // Ambil data dari field yang AKTIF
        const formData = Object.fromEntries(new FormData(form));
        
        // Ambil data dari field yang DI-NONAKTIFKAN (disabled)
        formData.rowIndex = params.rowIndex;
        formData.source = form.querySelector('[name="source"]').value; // Ambil source yang mungkin baru
        formData['Unit Kerja'] = unitKerjaSelect.value;
        formData['statusSekolah'] = statusSekolahSelect.value;
        
        google.script.run
            .withSuccessHandler(response => {
                if (response && response.error) {
                    App.showAppModal('error', `Gagal: ${response.error}`);
                    submitButton.disabled = false;
                } else {
                    // ===================================
                    // ===== INI ADALAH PERBAIKANNYA =====
                    // ===================================
                    App.showAppModal('success', response, 'ptk_kelola_sd'); // <- 'App.showAppModal'
                }
            })
            .withFailureHandler(error => {
                App.showAppModal('error', `Gagal menyimpan: ${error.message}`);
                submitButton.disabled = false;
            })
            .updatePtkSdData(formData); 
    });
}

function initPtkKebutuhanSdPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('kebutuhanGuruTable'); // Target ID baru
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterKebutuhanStatus'); // Target ID filter baru

    // 2. Variabel Penyimpanan Data
    let allData = { negeri: [], swasta: [] };
    let headerData = { negeri: [], swasta: [] };
    let dataRows = { negeri: [], swasta: [] };

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") {
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") {
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") {
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    // PERUBAHAN: Menerima headers1 dan headers2
    function buildTableBodyAndFooter(headers1, headers2, data) {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${headers1.length + 1}">Tidak ada data.</td></tr>`;
            return;
        }

        const sumStartIndex = 1; // Mulai menjumlahkan dari kolom ke-2 (setelah Nama Sekolah)
        const totals = new Array(headers1.length).fill(0);

        data.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                // Perbaikan: Pastikan angka 0 dibaca sebagai string '-'
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                
                // --- KODE BARU: PEWARNAAN DAN FORMAT KONDISIONAL ---
                let classes = [];
                let fontClass = '';
                const subHeaderName = headers2[cellIndex]; // KUNCI PERBAIKAN: Menggunakan sub-header
                
                // 1. Pewarnaan Latar Belakang Grup (Kolom 5-39 / Index 3-37)
                // Col 5-11 (Index 3-9) <-- Digeser dari 4 ke 3
                if (cellIndex >= 3 && cellIndex <= 9) classes.push('cell-bg-blue');      
                // Col 12-18 (Index 10-16) <-- Digeser dari 11 ke 10
                if (cellIndex >= 10 && cellIndex <= 16) classes.push('cell-bg-green');    
                // Col 19-25 (Index 17-23) <-- Digeser dari 18 ke 17
                if (cellIndex >= 17 && cellIndex <= 23) classes.push('cell-bg-purple');   
                // Col 26-32 (Index 24-30) <-- Digeser dari 25 ke 24
                if (cellIndex >= 24 && cellIndex <= 30) classes.push('cell-bg-yellow');   
                // Col 33-39 (Index 31-37) <-- Digeser dari 32 ke 31
                if (cellIndex >= 31 && cellIndex <= 37) classes.push('cell-bg-red');      

                // 2. Format Kondisional Font (HANYA UNTUK KOLOM "KURANG")
                if (subHeaderName === 'Kurang') {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    
                    if (numericValue < 0) fontClass = 'font-red';      
                    else if (numericValue > 0) fontClass = 'font-green';
                    else if (numericValue === 0) fontClass = 'font-blue';
                }
                
                if (fontClass) classes.push(fontClass);
                const classString = classes.length > 0 ? ` class="${classes.join(' ')}"` : '';
                // --- AKHIR KODE BARU ---

                cellsHTML += `<td${classString}>${displayValue}</td>`;
                
                // ... (Logika kalkulasi total footer) ...
                if (cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>';       // Kolom No.
        footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>'; // Kolom Nama Sekolah (Rata Kiri)
        
        for (let i = sumStartIndex; i < totals.length; i++) {
            // Perbaikan: Angka 0 di total juga ditampilkan sebagai '-'
            let displayTotal = (totals[i] === 0) ? '-' : totals[i];
            footerHTML += `<td>${displayTotal}</td>`;
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Fungsi Render Utama
    function renderTable(status) { // status = "negeri" atau "swasta"
        if (!allData[status] || allData[status].length === 0) {
            tableHead.innerHTML = '';
            tableBody.innerHTML = `<tr><td colspan="1">Data untuk ${status} tidak tersedia.</td></tr>`;
            tableFoot.innerHTML = '';
            return;
        }
        
        const headers1 = headerData[status][0];
        const headers2 = headerData[status][1];
        const rows = dataRows[status];
        
        buildTableHeader(headers1, headers2);
        // PERUBAHAN: Memanggil buildTableBodyAndFooter dengan headers1 dan headers2
        buildTableBodyAndFooter(headers1, headers2, rows); 
    }

    // 6. Panggil data dari Server
    google.script.run
        .withSuccessHandler(result => {
            if (result.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${result.error}</p>`;
                return;
            }

            // Pisahkan Header dan Data untuk kedua sumber
            allData.negeri = result.negeri;
            allData.swasta = result.swasta;
            
            // Data Header (Baris 1 dan 2)
            headerData.negeri = [result.negeri[0], result.negeri[1]];
            headerData.swasta = [result.swasta[0], result.swasta[1]];
            
            // Data baris (Baris 3 sampai akhir, dikurangi 1 baris footer statis)
            dataRows.negeri = result.negeri.slice(2, result.negeri.length - 1);
            dataRows.swasta = result.swasta.slice(2, result.swasta.length - 1);

            // 7. Tampilkan tabel default (Negeri)
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex';
            renderTable('negeri'); // Tampilkan data 'negeri' saat pertama kali dimuat

            // 8. Tambahkan Event Listener ke Filter
            filterSelect.addEventListener('change', () => {
                renderTable(filterSelect.value); // Panggil renderTable dengan nilai baru ('negeri' or 'swasta')
            });

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getKebutuhanGuruData(); // Panggil fungsi backend baru
}

function initMuridPaudKelasUsiaPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridPaudKelasUsiaTable');
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterJenjang');

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders = [];
    let jenjangIndex = -1;

    // 3. Fungsi untuk membangun Header (Sederhana)
    function buildTableHeader(headers) {
        tableHead.innerHTML = `<tr><th>No.</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || jenjangIndex === -1) return true; // Tampilkan semua jika filter "Semua"
            return String(row[jenjangIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer (sesuai 'init' Anda sebelumnya)
        const labelColumn = 'Nama Lembaga';
        const sumStartColumn = 'Rombel';
        
        const labelColIndex = allHeaders.indexOf(labelColumn);
        const sumStartIndex = allHeaders.indexOf(sumStartColumn);
        
        const totals = new Array(allHeaders.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (sumStartIndex !== -1 && cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        if (labelColIndex !== -1 && sumStartIndex !== -1) {
            let footerHTML = '<tr>';
            footerHTML += '<td>-</td>'; // Kolom No.
            
            for (let i = 0; i < allHeaders.length; i++) {
                if (i === labelColIndex) {
                    footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
                } else if (i < sumStartIndex) {
                    footerHTML += '<td>-</td>';
                } else {
                    let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                    footerHTML += `<td>${displayTotal}</td>`;
                }
            }
            footerHTML += '</tr>';
            tableFoot.innerHTML = footerHTML;
        }
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 2) {
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders = data[0];
            allDataRows = data.slice(1);
            jenjangIndex = allHeaders.indexOf('Jenjang');

            // 6. Buat filter dropdown
            if (jenjangIndex !== -1) {
                const uniqueJenjang = [...new Set(allDataRows.map(row => row[jenjangIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Jenjang</option>';
                uniqueJenjang.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none'; // Sembunyikan filter jika kolom Jenjang tidak ada
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; // Gunakan flex
            buildTableHeader(allHeaders);
            buildTableBodyAndFooter(); // Render pertama kali

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridPaudKelasUsiaData(); // Panggil fungsi backend
}

function initMuridPaudJenisKelaminPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridPaudJkTable'); // ID Tabel yang Benar
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterJenjang');

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = [];
    let allHeaders2 = [];
    let jenjangIndex = -1;

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { // rowspan 2
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { // colspan
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { // sub-header only
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || jenjangIndex === -1) return true;
            return String(row[jenjangIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer
        const labelColIndex = allHeaders1.indexOf('Nama Lembaga'); // Kolom 2 (index 1)
        const sumStartIndex = allHeaders1.indexOf('Rombel');     // Kolom 3 (index 2)
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (sumStartIndex !== -1 && cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        if (labelColIndex !== -1 && sumStartIndex !== -1) {
            let footerHTML = '<tr>';
            footerHTML += '<td>-</td>'; // Kolom No.
            
            for (let i = 0; i < allHeaders1.length; i++) {
                if (i === labelColIndex) {
                    footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
                } else if (i < sumStartIndex) {
                    footerHTML += '<td>-</td>';
                } else {
                    let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                    footerHTML += `<td>${displayTotal}</td>`;
                }
            }
            footerHTML += '</tr>';
            tableFoot.innerHTML = footerHTML;
        }
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { // Membutuhkan 2 baris header + 1 baris data
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders1 = data[0]; // Header 1
            allHeaders2 = data[1]; // Header 2
            allDataRows = data.slice(2); // Data rows
            jenjangIndex = allHeaders1.indexOf('Jenjang'); // Cari 'Jenjang' di header 1

            // 6. Buat filter dropdown
            if (jenjangIndex !== -1) {
                const uniqueJenjang = [...new Set(allDataRows.map(row => row[jenjangIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Jenjang</option>';
                uniqueJenjang.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none';
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; // Gunakan flex
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); // Render pertama kali

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridPaudJenisKelaminData(); // Panggil fungsi backend
}

function initMuridPaudJumlahBulananPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridPaudBulananTable');
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    
    // Ambil semua 3 filter
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterJenjang = document.getElementById('filterJenjang');

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = [];
    let allHeaders2 = [];
    
    // Indeks untuk 3 filter
    let tahunIndex = -1;
    let bulanIndex = -1;
    let jenjangIndex = -1;

    // --- KODE BARU DIMULAI DI SINI (LANGKAH #2) ---
    // Hitung nilai default untuk filter
    const now = new Date();
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    // Logika "Bulan Lalu"
    let lastMonthIndex = now.getMonth() - 1; // getMonth() itu 0-11
    let defaultTahun = now.getFullYear().toString();

    // Penanganan jika sekarang bulan Januari (0)
    if (lastMonthIndex < 0) { 
        lastMonthIndex = 11; // Bulan lalu adalah Desember (11)
        defaultTahun = (now.getFullYear() - 1).toString(); // Dari tahun lalu
    }
    const defaultBulan = monthNames[lastMonthIndex];
    // --- AKHIR KODE BARU ---


    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { // rowspan 2
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { // colspan
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { // sub-header only
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        
        // Ambil nilai dari 3 filter
        const valTahun = filterTahun.value;
        const valBulan = filterBulan.value;
        const valJenjang = filterJenjang.value;
        
        const filteredRows = allDataRows.filter(row => {
            // Logika filter untuk 3 kolom
            const matchTahun = !valTahun || (tahunIndex !== -1 && String(row[tahunIndex]).trim() === valTahun);
            const matchBulan = !valBulan || (bulanIndex !== -1 && String(row[bulanIndex]).trim() === valBulan);
            const matchJenjang = !valJenjang || (jenjangIndex !== -1 && String(row[jenjangIndex]).trim() === valJenjang);
            return matchTahun && matchBulan && matchJenjang;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer (Sama seperti halaman PAUD lainnya)
        const labelColIndex = allHeaders1.indexOf('Nama Lembaga'); // Kolom 2 (index 1)
        const sumStartIndex = allHeaders1.indexOf('Rombel');     // Kolom 3 (index 2)
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (sumStartIndex !== -1 && cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        if (labelColIndex !== -1 && sumStartIndex !== -1) {
            let footerHTML = '<tr>';
            footerHTML += '<td>-</td>'; // Kolom No.
            
            for (let i = 0; i < allHeaders1.length; i++) {
                if (i === labelColIndex) {
                    footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
                } else if (i < sumStartIndex) {
                    footerHTML += '<td>-</td>';
                } else {
                    let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                    footerHTML += `<td>${displayTotal}</td>`;
                }
            }
            footerHTML += '</tr>';
            tableFoot.innerHTML = footerHTML;
        }
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { // Membutuhkan 2 baris header + 1 baris data
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders1 = data[0]; // Header 1
            allHeaders2 = data[1]; // Header 2
            allDataRows = data.slice(2); // Data rows
            
            // Cari indeks untuk 3 filter di header baris PERTAMA
            tahunIndex = allHeaders1.indexOf('Tahun');
            bulanIndex = allHeaders1.indexOf('Bulan');
            jenjangIndex = allHeaders1.indexOf('Jenjang');

            // 6. Buat filter dropdown (Logika baru untuk 3 filter)
            const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            // Fungsi helper untuk mengisi satu dropdown
            function populateFilter(selectEl, columnIndex, sortLogic) {
                if (!selectEl || columnIndex === -1) {
                    if(selectEl) selectEl.parentElement.style.display = 'none';
                    return;
                }
                const unique = [...new Set(allDataRows.map(row => row[columnIndex]))].filter(Boolean);
                
                if (sortLogic === 'bulan') {
                    unique.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
                } else if (sortLogic === 'reverse') {
                    unique.sort().reverse();
                } else {
                    unique.sort();
                }
                
                selectEl.innerHTML = '<option value="">Semua</option>'; // Ganti default text
                unique.forEach(val => selectEl.add(new Option(val, val)));
                selectEl.addEventListener('change', buildTableBodyAndFooter);
            }
            
            // Panggil helper untuk setiap filter
            populateFilter(filterTahun, tahunIndex, 'reverse');
            populateFilter(filterBulan, bulanIndex, 'bulan');
            populateFilter(filterJenjang, jenjangIndex, 'sort');

            // --- KODE BARU DIMULAI DI SINI (LANGKAH #6) ---
            
            // Helper untuk mengecek apakah opsi ada sebelum mengaturnya
            const optionExists = (selectEl, value) => {
                return Array.from(selectEl.options).some(opt => opt.value === value);
            };

            // Terapkan default TAHUN (HANYA JIKA ADA DI OPSI)
            if (optionExists(filterTahun, defaultTahun)) {
                filterTahun.value = defaultTahun;
            }

            // Terapkan default BULAN (HANYA JIKA ADA DI OPSI)
            if (optionExists(filterBulan, defaultBulan)) {
                filterBulan.value = defaultBulan;
            }
            // --- AKHIR KODE BARU ---

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; // Gunakan flex
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); // Render pertama kali (SEKARANG AKAN MENGGUNAKAN DEFAULT)

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridPaudJumlahBulananData(); // Panggil fungsi backend
}

function initMuridSdKelasPage() {
    // 1. Referensi Elemen (DIUBAH)
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdKelasTable'); // <-- DIUBAH
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatus'); // <-- DIUBAH

    // 2. Variabel Penyimpanan Data (DIUBAH)
    let allDataRows = [];
    let allHeaders = [];
    let statusIndex = -1; // <-- DIUBAH (dari jenjangIndex)

    // 3. Fungsi untuk membangun Header (Sederhana)
    //    (Fungsi ini SAMA, tidak perlu diubah)
    function buildTableHeader(headers) {
        tableHead.innerHTML = `<tr><th>No.</th>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    //    (Fungsi ini DIMODIFIKASI untuk filter 'Status')
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            // --- LOGIKA FILTER DIUBAH ---
            if (!filterValue || statusIndex === -1) return true; // Tampilkan semua jika filter "Semua"
            return String(row[statusIndex]).trim() === filterValue;
            // --- AKHIR PERUBAHAN ---
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer (DIUBAH)
        const labelColumn = 'Nama Sekolah'; // <-- DIUBAH (dari 'Nama Lembaga')
        const sumStartColumn = 'Rombel';   // <-- DIUBAH (Sesuai konfirmasi Anda)
        
        const labelColIndex = allHeaders.indexOf(labelColumn);
        const sumStartIndex = allHeaders.indexOf(sumStartColumn);
        
        const totals = new Array(allHeaders.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (sumStartIndex !== -1 && cellIndex >= sumStartIndex) {
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        if (labelColIndex !== -1 && sumStartIndex !== -1) {
            let footerHTML = '<tr>';
            footerHTML += '<td>-</td>'; // Kolom No.
            
            for (let i = 0; i < allHeaders.length; i++) {
                if (i === labelColIndex) {
                    footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
                } else if (i < sumStartIndex) {
                    footerHTML += '<td>-</td>'; // Kolom sebelum 'Rombel'
                } else {
                    let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                    footerHTML += `<td>${displayTotal}</td>`;
                }
            }
            footerHTML += '</tr>';
            tableFoot.innerHTML = footerHTML;
        }
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 2) { // 1 baris header + 1 baris data
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders = data[0].map(h => String(h).trim()); // <-- DIUBAH: Tambahkan .trim()
            allDataRows = data.slice(1);
            statusIndex = allHeaders.indexOf('Status'); // <-- DIUBAH

            // 6. Buat filter dropdown (DIUBAH)
            if (statusIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none'; 
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex';
            buildTableHeader(allHeaders);
            buildTableBodyAndFooter(); // Render pertama kali

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdKelasData(); // <-- DIUBAH: Panggil fungsi backend yang benar
}

function initMuridSdRombelPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdRombelTable'); 
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatus'); 

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = []; 
    let allHeaders2 = []; 
    let statusIndex = -1;

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { 
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { 
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { 
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || statusIndex === -1) return true;
            return String(row[statusIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // --- INI ADALAH PERBAIKANNYA ---
        const labelColIndex = 0;   // Kolom 'Nama Sekolah' (indeks 0)
        const sumStartIndex = 4;   // Mulai menjumlahkan dari kolom ke-5 (indeks 4)
        // --- AKHIR PERBAIKAN ---
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (cellIndex >= sumStartIndex) { // Mulai menjumlahkan dari index 4
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>'; // Kolom No.
        
        for (let i = 0; i < allHeaders1.length; i++) {
            if (i === labelColIndex) { // Jika index 0 (Nama Sekolah)
                footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
            } else if (i < sumStartIndex) { // Jika index 1, 2, atau 3 (NPSN, Status, Rombel)
                footerHTML += '<td>-</td>';
            } else { // Jika index 4 atau lebih
                let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                footerHTML += `<td>${displayTotal}</td>`;
            }
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { 
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            allHeaders1 = data[0].map(h => String(h).trim()); 
            allHeaders2 = data[1].map(h => String(h).trim()); 
            allDataRows = data.slice(2); 
            
            statusIndex = allHeaders1.indexOf('Status'); 

            // 6. Buat filter dropdown
            if (statusIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none';
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; 
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); 

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdRombelData(); // Panggil fungsi backend
}

function initMuridSdJenisKelaminPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdJkTable'); 
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatus'); 

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = []; 
    let allHeaders2 = []; 
    let statusIndex = -1;

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { 
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { 
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { 
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || statusIndex === -1) return true;
            return String(row[statusIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // --- INI ADALAH PERBAIKANNYA ---
        const labelColIndex = 0;   // Kolom 'Nama Sekolah' (indeks 0)
        const sumStartIndex = 4;   // Mulai menjumlahkan dari kolom ke-5 (indeks 4)
        // --- AKHIR PERBAIKAN ---
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (cellIndex >= sumStartIndex) { // Mulai menjumlahkan dari index 4
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>'; // Kolom No.
        
        for (let i = 0; i < allHeaders1.length; i++) {
            if (i === labelColIndex) { // Jika index 0 (Nama Sekolah)
                footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
            } else if (i < sumStartIndex) { // Jika index 1, 2, atau 3
                footerHTML += '<td>-</td>';
            } else { // Jika index 4 atau lebih
                let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                footerHTML += `<td>${displayTotal}</td>`;
            }
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { 
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            allHeaders1 = data[0].map(h => String(h).trim()); 
            allHeaders2 = data[1].map(h => String(h).trim()); 
            allDataRows = data.slice(2); 
            
            statusIndex = allHeaders1.indexOf('Status'); 

            // 6. Buat filter dropdown
            if (statusIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none';
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; 
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); 

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdJenisKelaminData(); 
}

function initMuridSdAgamaPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdAgamaTable'); 
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    const filterSelect = document.getElementById('filterStatus'); 

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = []; 
    let allHeaders2 = []; 
    let statusIndex = -1;

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { 
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { 
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { 
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        const filterValue = filterSelect.value;
        
        const filteredRows = allDataRows.filter(row => {
            if (!filterValue || statusIndex === -1) return true;
            return String(row[statusIndex]).trim() === filterValue;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // --- INI ADALAH PERBAIKANNYA ---
        const labelColIndex = 0;   // Kolom 'Nama Sekolah' (indeks 0)
        const sumStartIndex = 5;   // Mulai menjumlahkan dari kolom ke-6 (indeks 5)
        // --- AKHIR PERBAIKAN ---
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (cellIndex >= sumStartIndex) { // Mulai menjumlahkan dari index 5
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>'; // Kolom No.
        
        for (let i = 0; i < allHeaders1.length; i++) {
            if (i === labelColIndex) { // Jika index 0 (Nama Sekolah)
                footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
            } else if (i < sumStartIndex) { // Jika index 1, 2, 3, atau 4
                footerHTML += '<td>-</td>';
            } else { // Jika index 5 atau lebih
                let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                footerHTML += `<td>${displayTotal}</td>`;
            }
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { 
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            allHeaders1 = data[0].map(h => String(h).trim()); 
            allHeaders2 = data[1].map(h => String(h).trim()); 
            allDataRows = data.slice(2); 
            
            statusIndex = allHeaders1.indexOf('Status'); 

            // 6. Buat filter dropdown
            if (statusIndex !== -1) {
                const uniqueStatus = [...new Set(allDataRows.map(row => row[statusIndex]))].filter(Boolean).sort();
                filterSelect.innerHTML = '<option value="">Semua Status</option>';
                uniqueStatus.forEach(j => filterSelect.add(new Option(j, j)));
                filterSelect.addEventListener('change', buildTableBodyAndFooter);
            } else {
                filterSelect.parentElement.style.display = 'none';
            }

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; 
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); 

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdAgamaData(); 
}

function initMuridSdJumlahBulananPage() {
    // 1. Referensi Elemen
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('muridSdBulananTable'); 
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const tableFoot = table.querySelector('tfoot');
    
    // Ambil semua 3 filter
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterStatus = document.getElementById('filterStatus'); 

    // 2. Variabel Penyimpanan Data
    let allDataRows = [];
    let allHeaders1 = []; 
    let allHeaders2 = []; 
    
    // Indeks untuk 3 filter
    let tahunIndex = -1;
    let bulanIndex = -1;
    let statusIndex = -1;

    // --- KODE BARU DIMULAI DI SINI ---
    // Hitung nilai default untuk filter
    const now = new Date();
    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    
    // Logika "Bulan Lalu"
    let lastMonthIndex = now.getMonth() - 1; // getMonth() itu 0-11
    let defaultTahun = now.getFullYear().toString(); // Default tahun adalah TAHUN INI

    // Penanganan jika sekarang bulan Januari (0)
    if (lastMonthIndex < 0) { 
        lastMonthIndex = 11; // Bulan lalu adalah Desember (11)
        defaultTahun = (now.getFullYear() - 1).toString(); // Default tahun adalah TAHUN LALU
    }
    const defaultBulan = monthNames[lastMonthIndex];
    // --- AKHIR KODE BARU ---

    // 3. Fungsi untuk membangun Header (Header Bertingkat)
    function buildTableHeader(headers1, headers2) {
        tableHead.innerHTML = '';
        let row1HTML = '<th rowspan="2">No.</th>';
        let row2HTML = '';
        const dataHeaderCount = headers1.length;

        for (let i = 0; i < dataHeaderCount; i++) {
            const header1 = headers1[i];
            const header2 = headers2[i];

            if (header1 !== "" && header2 === "") { 
                row1HTML += `<th rowspan="2">${header1}</th>`;
            } else if (header1 !== "" && header2 !== "") { 
                let colspan = 1;
                for (let j = i + 1; j < dataHeaderCount; j++) {
                    if (headers1[j] === "" && headers2[j] !== "") {
                        colspan++;
                    } else {
                        break;
                    }
                }
                row1HTML += `<th colspan="${colspan}">${header1}</th>`;
                row2HTML += `<th>${header2}</th>`;
            } else if (header1 === "" && header2 !== "") { 
                row2HTML += `<th>${header2}</th>`;
            }
        }
        tableHead.innerHTML = `<tr>${row1HTML}</tr><tr>${row2HTML}</tr>`;
    }

    // 4. Fungsi untuk membangun Body dan Footer (JUMLAH)
    function buildTableBodyAndFooter() {
        tableBody.innerHTML = '';
        tableFoot.innerHTML = '';
        
        // Ambil nilai dari 3 filter
        const valTahun = filterTahun.value;
        const valBulan = filterBulan.value;
        const valStatus = filterStatus.value;
        
        const filteredRows = allDataRows.filter(row => {
            // Logika filter untuk 3 kolom
            const matchTahun = !valTahun || (tahunIndex !== -1 && String(row[tahunIndex]).trim() === valTahun);
            const matchBulan = !valBulan || (bulanIndex !== -1 && String(row[bulanIndex]).trim() === valBulan);
            const matchStatus = !valStatus || (statusIndex !== -1 && String(row[statusIndex]).trim() === valStatus);
            return matchTahun && matchBulan && matchStatus;
        });

        if (filteredRows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${allHeaders1.length + 1}">Tidak ada data yang cocok dengan filter.</td></tr>`;
            return;
        }

        // Konfigurasi Footer (Menggunakan indeks tetap)
        const labelColIndex = 0;   // Kolom 'Nama Sekolah' (indeks 0)
        const sumStartIndex = 5;   // Mulai menjumlahkan dari kolom ke-6 (indeks 5)
        
        const totals = new Array(allHeaders1.length).fill(0);

        filteredRows.forEach((row, index) => {
            const tr = document.createElement('tr');
            let cellsHTML = `<td>${index + 1}</td>`; // Kolom "No."
            
            row.forEach((cell, cellIndex) => {
                const displayValue = (cell === "" || cell === null || cell == 0) ? '-' : cell;
                cellsHTML += `<td>${displayValue}</td>`;
                
                if (cellIndex >= sumStartIndex) { // Mulai menjumlahkan dari index 5
                    const numericValue = parseFloat(String(cell).replace(/\./g, '')) || 0;
                    totals[cellIndex] += numericValue;
                }
            });
            tr.innerHTML = cellsHTML;
            tableBody.appendChild(tr);
        });

        // Bangun Footer (JUMLAH)
        let footerHTML = '<tr>';
        footerHTML += '<td>-</td>'; // Kolom No.
        
        for (let i = 0; i < allHeaders1.length; i++) {
            if (i === labelColIndex) { // Jika index 0 (Nama Sekolah)
                footerHTML += '<td style="text-align: left; font-weight: bold;">JUMLAH</td>';
            } else if (i < sumStartIndex) { // Jika index 1, 2, 3, atau 4
                footerHTML += '<td>-</td>';
            } else { // Jika index 5 atau lebih
                let displayTotal = (totals[i] === 0) ? '-' : totals[i];
                footerHTML += `<td>${displayTotal}</td>`;
            }
        }
        footerHTML += '</tr>';
        tableFoot.innerHTML = footerHTML;
    }

    // 5. Panggil data dari Server
    google.script.run
        .withSuccessHandler(data => {
            if (data.error) {
                loadingStatus.innerHTML = `<p style="color:red;">Error: ${data.error}</p>`;
                return;
            }
            if (!data || data.length < 3) { 
                loadingStatus.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
                return;
            }

            // Pisahkan Header dan Data
            allHeaders1 = data[0].map(h => String(h).trim()); 
            allHeaders2 = data[1].map(h => String(h).trim()); 
            allDataRows = data.slice(2); 
            
            // Cari indeks untuk 3 filter di header baris PERTAMA
            tahunIndex = allHeaders1.indexOf('Tahun');
            bulanIndex = allHeaders1.indexOf('Bulan');
            statusIndex = allHeaders1.indexOf('Status'); 

            // 6. Buat filter dropdown
            const monthOrder = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            // Fungsi helper untuk mengisi satu dropdown
            function populateFilter(selectEl, columnIndex, sortLogic) {
                if (!selectEl || columnIndex === -1) {
                    if(selectEl) selectEl.parentElement.style.display = 'none';
                    return;
                }
                const unique = [...new Set(allDataRows.map(row => row[columnIndex]))].filter(Boolean);
                
                if (sortLogic === 'bulan') {
                    unique.sort((a, b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
                } else if (sortLogic === 'reverse') {
                    unique.sort().reverse();
                } else {
                    unique.sort();
                }
                
                selectEl.innerHTML = '<option value="">Semua</option>'; 
                unique.forEach(val => selectEl.add(new Option(val, val)));
                selectEl.addEventListener('change', buildTableBodyAndFooter);
            }
            
            // Panggil helper untuk setiap filter
            populateFilter(filterTahun, tahunIndex, 'reverse');
            populateFilter(filterBulan, bulanIndex, 'bulan');
            populateFilter(filterStatus, statusIndex, 'sort');

            // --- KODE BARU DIMULAI DI SINI ---
            
            // Helper untuk mengecek apakah opsi ada sebelum mengaturnya
            const optionExists = (selectEl, value) => {
                return Array.from(selectEl.options).some(opt => opt.value === value);
            };

            // Terapkan default TAHUN (HANYA JIKA ADA DI OPSI)
            if (optionExists(filterTahun, defaultTahun)) {
                filterTahun.value = defaultTahun;
            }

            // Terapkan default BULAN (HANYA JIKA ADA DI OPSI)
            if (optionExists(filterBulan, defaultBulan)) {
                filterBulan.value = defaultBulan;
            }
            // --- AKHIR KODE BARU ---

            // 7. Tampilkan tabel
            loadingStatus.style.display = 'none';
            tableWrapper.style.display = 'flex'; 
            buildTableHeader(allHeaders1, allHeaders2);
            buildTableBodyAndFooter(); // Render pertama kali (SEKARANG AKAN MENGGUNAKAN DEFAULT)

        })
        .withFailureHandler(error => { 
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${error.message}</p>`;
        })
        .getMuridSdJumlahBulananData(); 
}

function initSiabaDaftarPresensiPage() {
    // 1. Referensi Elemen
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const terapkanBtn = document.getElementById('terapkanFilterBtn');
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const table = document.getElementById('presensiTable'); 
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');
    const paginationContainer = document.getElementById('pagination-container');
    const keteranganSiaba = document.getElementById('keterangan-siaba');

    // Cek Kritis: Pastikan semua elemen penting ada
    if (!table || !loadingStatus || !tableWrapper || !paginationContainer || !keteranganSiaba) {
        console.error("Inisialisasi Siaba Presensi Gagal: Satu atau lebih elemen HTML inti (tabel, loading, wrapper, paginasi, keterangan) tidak ditemukan.");
        if(loadingStatus) loadingStatus.innerHTML = "<p style='color:red;'>Error Kritis: Elemen HTML halaman rusak.</p>";
        return;
    }

    // Simpan HTML spinner asli
    const originalSpinnerHTML = loadingStatus.innerHTML; 
    const promptMessageHTML = '<p>Silakan pilih filter dan klik "Tampilkan".</p>';

    // Variabel untuk pewarnaan
    const backgroundMap = {
        'HA': 'cell-bg-cream', 'APL': 'cell-bg-cream', 'TAp': 'cell-bg-cream',
        'HU': 'cell-bg-cream', 'U': 'cell-bg-cream', 'TU': 'cell-bg-cream',
        'CT': 'cell-bg-green', 'CAP': 'cell-bg-green', 'CS': 'cell-bg-green', 'CM': 'cell-bg-green',
        'DD': 'cell-bg-blue', 'DL': 'cell-bg-blue',
        'TA': 'cell-bg-yellow', 'Waktu TA': 'cell-bg-yellow', 'PLA': 'cell-bg-yellow', 'Waktu PLA': 'cell-bg-yellow',
        'LA': 'cell-bg-purple'
    };
    const fontColorMap = {
        'CT': 'font-green', 'CAP': 'font-green', 'CS': 'font-green', 'CM': 'font-green',
        'DD': 'font-blue', 'DL': 'font-blue',
        'DP': 'font-brown'
    };
    const redFontColumns = ['TAp', 'TU', 'TA', 'PLA', 'LA'];
    
    let displayHeaders = [];
    
    // Variabel Paginasi
    let currentFilteredRows = []; 
    let currentPage = 1;
    let rowsPerPage = 15; 

    // 2. Fungsi Helper
    function populateSelect(selectElement, options, defaultValue = null) {
        selectElement.innerHTML = '';
        if (selectElement.id === 'filterUnitKerja') {
            selectElement.add(new Option("-- Pilih Unit Kerja --", ""));
            selectElement.add(new Option("Semua Unit Kerja", "Semua"));
        }
        options.forEach(opt => {
            selectElement.add(new Option(opt, opt));
        });
        if (defaultValue && options.includes(defaultValue)) {
            selectElement.value = defaultValue;
        }
    }
    
    // Fungsi Paginasi
    const calculateRowsPerPage = () => {
        // --- PERBAIKAN BUG FATAL ---
        // Kita gunakan 'tableWrapper' yang sudah kita temukan (punya ID)
        // untuk mengukur posisinya. Ini jauh lebih aman.
        if (!tableWrapper) return 15; // Failsafe
        
        const footerNoteHeight = keteranganSiaba ? keteranganSiaba.offsetHeight : 0;
        const paginationHeight = paginationContainer ? paginationContainer.offsetHeight : 0; 

        const bottomOffset = footerNoteHeight + (paginationHeight || 50) + 40; 
        const rowHeight = 38; 
        
        // Ambil posisi 'tableWrapper'
        const rect = tableWrapper.getBoundingClientRect();
        // Jika rect.top adalah 0 (karena display:none), gunakan posisi loadingStatus sebagai gantinya
        const topPosition = rect.top > 0 ? rect.top : (loadingStatus ? loadingStatus.getBoundingClientRect().top : 150);
        
        const availableHeight = window.innerHeight - topPosition - bottomOffset; 
        // --- AKHIR PERBAIKAN ---

        return Math.max(5, Math.floor(availableHeight / rowHeight));
    };

    const setupPagination = () => {
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage) || 1;
        
        if (pageCount <= 1) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';
        const pageInfo = `<span class="page-info">Halaman ${currentPage} dari ${pageCount}</span>`;
        const prevBtn = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="App.changePage_SiabaPresensi(-1)">Â«</button>`;
        const nextBtn = `<button class="page-btn" ${currentPage === pageCount ? 'disabled' : ''} onclick="App.changePage_SiabaPresensi(1)">Â»</button>`;
        paginationContainer.innerHTML = prevBtn + pageInfo + nextBtn;
    };

    App.changePage_SiabaPresensi = (direction) => {
        currentPage += direction;
        renderTable(); 
    };

    // 3. Fungsi Render (Dengan Paginasi)
    function renderTable() { 
        if (!tableBody) return; 
        
        tableBody.innerHTML = '';
        
        rowsPerPage = calculateRowsPerPage(); // <-- PANGGIL FUNGSI YANG SUDAH DIPERBAIKI
        const pageCount = Math.ceil(currentFilteredRows.length / rowsPerPage) || 1;
        currentPage = Math.min(currentPage, pageCount) || 1;
        const start = (currentPage - 1) * rowsPerPage;
        const paginatedRows = currentFilteredRows.slice(start, start + rowsPerPage);
        
        setupPagination(); 

        if (paginatedRows.length === 0) { 
            tableBody.innerHTML = `<tr><td colspan="${displayHeaders.length + 1}">Tidak ada data ditemukan untuk filter ini.</td></tr>`;
            return;
        }

        const tpIndex = displayHeaders.indexOf('TP');
        const dayStartIndex = displayHeaders.indexOf('1D');
        const dayEndIndex = displayHeaders.indexOf('31P');

        paginatedRows.forEach((rowData, index) => { 
            const tr = document.createElement('tr');
            const rowNumber = (currentPage - 1) * rowsPerPage + index + 1;
            let rowHTML = `<td>${rowNumber}</td>`;
            
            rowData.forEach((cell, cellIndex) => {
                const header = displayHeaders[cellIndex];
                let classes = [];
                const isNumericValuePositive = parseInt(cell, 10) > 0;

                if (backgroundMap[header]) {
                    classes.push(backgroundMap[header]);
                }
                
                if (dayStartIndex !== -1 && cellIndex >= dayStartIndex && cellIndex <= dayEndIndex) {
                    if (cell === '' || cell === null || cell === undefined) {
                        classes.push('cell-bg-red');
                    } else if (cell === '-') {
                        classes.push('cell-bg-gray');
                    } else if (fontColorMap[cell]) {
                        classes.push(fontColorMap[cell]);
                    }
                }

                if (cellIndex === tpIndex && isNumericValuePositive) {
                    classes.push('cell-negative');
                }
                
                if (redFontColumns.includes(header) && isNumericValuePositive) {
                    classes.push('font-red');
                }
                
                const classString = classes.length > 0 ? ` class="${classes.join(' ')}"` : '';
                const cellContent = (cell === '' || cell === null || cell === undefined || cell === '0') ? '-' : cell;
                rowHTML += `<td${classString}>${cellContent}</td>`;
            });

            tr.innerHTML = rowHTML;
            tableBody.appendChild(tr);
        });
    }

    // 4. Fungsi Fetch Data (Sekarang menyimpan ke currentFilteredRows)
    function fetchData() {
        if (filterUnitKerja.value === "") {
            App.showAppModal('error', 'Harap pilih "Unit Kerja" terlebih dahulu.');
            return;
        }

        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value,
            unitKerja: filterUnitKerja.value 
        };

        loadingStatus.innerHTML = originalSpinnerHTML; 
        loadingStatus.style.display = 'flex';
        tableWrapper.style.display = 'none';
        paginationContainer.style.display = 'none'; 
        if (keteranganSiaba) keteranganSiaba.style.display = 'none'; 

        google.script.run
            .withSuccessHandler(result => {
                loadingStatus.style.display = 'none'; 
                if (result.error) {
                     loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat data: ${result.error}</p>`;
                     loadingStatus.style.display = 'flex';
                     return;
                }
                
                displayHeaders = result.headers;
                tableHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>No.</th>' + displayHeaders.map(h => `<th>${h}</th>`).join('');
                tableHead.appendChild(headerRow);
                
                currentFilteredRows = result.rows; 
                currentPage = 1;
                
                tableWrapper.style.display = 'flex';
                if (keteranganSiaba) keteranganSiaba.style.display = 'block'; 
                renderTable(); 
            })
            .withFailureHandler(err => {
                loadingStatus.style.display = 'none'; 
                loadingStatus.innerHTML = `<p style="color:red;">Gagal menghubungi server: ${err.message}</p>`;
                loadingStatus.style.display = 'flex';
            });
    }

    // 5. Logika Inisialisasi Halaman (UTAMA)
    loadingStatus.style.display = 'flex'; 
    loadingStatus.innerHTML = promptMessageHTML; 
    tableWrapper.style.display = 'none';
    paginationContainer.style.display = 'none'; 
    if (keteranganSiaba) keteranganSiaba.style.display = 'none'; 

    google.script.run
        .withSuccessHandler(options => {
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = now.toLocaleString('id-ID', { month: 'long' });

            populateSelect(filterTahun, options['Tahun'], currentYear);
            populateSelect(filterBulan, options['Bulan'], currentMonth);
            populateSelect(filterUnitKerja, options['Unit Kerja'], ""); 

            terapkanBtn.addEventListener('click', fetchData);
            
            filterUnitKerja.addEventListener('change', function() {
                if (filterUnitKerja.value !== "") {
                    terapkanBtn.disabled = false;
                } else {
                    terapkanBtn.disabled = true;
                }
            });
        })
        .withFailureHandler(err => {
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat filter. Error: ${err.message}</p>`;
            loadingStatus.style.display = 'flex'; 
        })
        .getSiabaFilterOptions();
}

function initSiabaTidakPresensiPage() {
    const filterTahun = document.getElementById('filterTahun');
    const filterBulan = document.getElementById('filterBulan');
    const filterUnitKerja = document.getElementById('filterUnitKerja');
    const terapkanBtn = document.getElementById('terapkanFilterBtn');
    const loadingStatus = document.getElementById('loadingStatus');
    const tableWrapper = document.getElementById('tableWrapper');
    const tableHead = document.getElementById('tidakPresensiTable').querySelector('thead');
    const tableBody = document.getElementById('tidakPresensiTable').querySelector('tbody');

    function populateSelect(selectElement, options, defaultValue = null) {
        selectElement.innerHTML = '';
        if (selectElement.id === 'filterUnitKerja') {
            selectElement.add(new Option('Semua', 'Semua'));
        }
        options.forEach(opt => {
            selectElement.add(new Option(opt, opt));
        });
        if (defaultValue && options.includes(defaultValue)) {
            selectElement.value = defaultValue;
        } else if (options.length > 0 && selectElement.id !== 'filterUnitKerja') {
             selectElement.selectedIndex = 0;
        }
    }

    function fetchData() {
        const filters = {
            tahun: filterTahun.value,
            bulan: filterBulan.value,
            unitKerja: filterUnitKerja.value
        };
        loadingStatus.style.display = 'flex';
        tableWrapper.style.display = 'none';

        google.script.run
            .withSuccessHandler(result => {
                loadingStatus.style.display = 'none';
                tableHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = '<th>No.</th>' + result.headers.map(h => `<th>${h}</th>`).join('');
                tableHead.appendChild(headerRow);

                tableBody.innerHTML = '';
                if (!result.rows || result.rows.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${result.headers.length + 1}">Tidak ada data ditemukan untuk filter ini.</td></tr>`;
                } else {
                    result.rows.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${index + 1}</td>` + row.map(cell => `<td>${cell || '-'}</td>`).join('');
                        tableBody.appendChild(tr);
                    });
                }
                tableWrapper.style.display = 'flex';
            })
            .withFailureHandler(err => {
                loadingStatus.style.display = 'none';
                tableWrapper.style.display = 'flex';
                tableBody.innerHTML = `<tr><td colspan="7" style="color:red;">Gagal memuat data: ${err.message}</td></tr>`;
            })
            .getSiabaTidakPresensiData(filters);
    }

    google.script.run
        .withSuccessHandler(options => {
            const now = new Date();
            const currentYear = now.getFullYear().toString();
            const currentMonth = now.toLocaleString('id-ID', { month: 'long' });

            populateSelect(filterTahun, options['Tahun'], currentYear);
            populateSelect(filterBulan, options['Bulan'], currentMonth);
            populateSelect(filterUnitKerja, options['Unit Kerja'], 'Semua');

            terapkanBtn.addEventListener('click', fetchData);
            fetchData();
        })
        .withFailureHandler(err => {
            loadingStatus.innerHTML = `<p style="color:red;">Gagal memuat opsi filter: ${err.message}</p>`;
        })
        .getSiabaTidakPresensiFilterOptions();
}


/**
 * ===================================================================
 * =================== 3. OBJEK INISIALISASI & TRIGGER ===============
 * ===================================================================
 */
 
App.pageInitializers = {
    'home': initMenuPage,
    'sk_menu': initMenuPage,
    'sk_unggah': initSkUnggahPage,
    'sk_riwayat': initSkRiwayatPage,
    'sk_status': initSkStatusPage,
    'sk_kelola': initSkKelolaPage,
    'sk_edit': initSkEditPage,
    'sk_arsip': initSkArsipPage,
    'lapbul_menu': initMenuPage,
    'lapbul_unggah': initLapbulUnggahPage,
    'lapbul_form_paud': initLapbulFormPaudPage,
    'lapbul_form_sd': initLapbulFormSdPage,
    'lapbul_riwayat': initLapbulRiwayatPage,
    'lapbul_status': initLapbulStatusPage,
    'lapbul_arsip': initLapbulArsipPage,
    'lapbul_kelola': initLapbulKelolaPage,
    'lapbul_edit_paud': initLapbulEditPaudPage,
    'lapbul_edit_sd': initLapbulEditSdPage,
    'lapbul_unduh_format': initLapbulUnduhFormatPage,
    'ptk_menu': initMenuPage,
    'ptk_paud_menu': initMenuPage,
    'ptk_sd_menu': initMenuPage,
    'ptk_keadaan_paud': initPtkKeadaanPaudPage,
    'ptk_keadaan_sd': initPtkKeadaanSdPage,
    'ptk_jumlah_bulanan_sd': initPtkJumlahBulananSdPage,
    'ptk_jumlah_bulanan_paud': initPtkJumlahBulananPaudPage,
    'ptk_daftar_paud': initPtkDaftarPaudPage,
    'ptk_kelola_paud': initPtkKelolaPaudPage,
    'ptk_tambah_paud': initPtkTambahPaudPage,
    'ptk_edit_paud': initPtkEditPaudPage,
    'ptk_daftar_sd_negeri': initPtkDaftarSdnPage,
    'ptk_daftar_sd_swasta': initPtkDaftarSdsPage,
    'ptk_kelola_sd': initPtkKelolaSdPage,
    'ptk_kebutuhan_sd_negeri': initPtkKebutuhanSdPage,
    'ptk_tambah_sd': initPtkTambahSdPage,
    'ptk_edit_sd': initPtkEditSdPage,
    'ptk_bezetting_sd_negeri': initMenuPage,
    'murid_menu': initMenuPage,
    'murid_paud_kelas_usia': initMuridPaudKelasUsiaPage,
    'murid_paud_jenis_kelamin': initMuridPaudJenisKelaminPage,
    'murid_paud_jumlah_bulanan': initMuridPaudJumlahBulananPage,
    'murid_sd_kelas': initMuridSdKelasPage,
    'murid_sd_rombel': initMuridSdRombelPage,
    'murid_sd_jenis_kelamin': initMuridSdJenisKelaminPage,
    'murid_sd_agama': initMuridSdAgamaPage,
    'murid_sd_jumlah_bulanan': initMuridSdJumlahBulananPage,
    'siaba_menu': initMenuPage,
    'siaba_panduan': initMenuPage,
    'siaba_daftar_presensi': initSiabaDaftarPresensiPage,
    'siaba_tidak_presensi': initSiabaTidakPresensiPage,
    'siaba_apel_upacara': initMenuPage,
    'siaba_lupa_presensi': initMenuPage,
    'siaba_salah_presensi': initMenuPage,
    'siaba_perjalanan_dinas': initMenuPage,
    'siaba_cuti': initMenuPage,
    'siaba_rekap_terlambat': initMenuPage,
    'siaba_rekap_pulang_awal': initMenuPage,
    'siaba_unduh_rekap': initMenuPage,
    'pns_menu': initMenuPage,
    'rapor_pendidikan_menu': initMenuPage,
    'tata_naskah_menu': initMenuPage,
    'mutasi_murid_menu': initMenuPage,
    'tapera_sitara_menu': initMenuPage,
    'administrasi_sekolah_menu': initMenuPage,
    'data_sekolah_menu': initMenuPage,
    'komunitas_belajar_menu': initMenuPage,
    'gelar_karya_menu': initMenuPage
};

document.addEventListener('DOMContentLoaded', () => {
    // PERBAIKAN TIMING ERROR: Menggunakan setTimeout(..., 0)
    setTimeout(() => {
        App.loadPage(null, 'home');
    }, 0);
    
    document.body.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (!link) return;
        const pageName = link.dataset.page;
        const parentLi = link.parentElement;
        const isParentToggle = parentLi.classList.contains('has-submenu');
        if (pageName) {
            e.preventDefault();
            if (isParentToggle && parentLi.classList.contains('open')) {
                parentLi.classList.remove('open');
                return;
            }
            App.loadPage(null, pageName);
        }
    });
});
</script>