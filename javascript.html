<script>
const App = {}; 
var colNo = { name: "No.", width: "40px", formatter: function(row, key, index) { return index + 1; }, tdStyle: "text-align:center; font-weight:bold; color:#64748b;" };


// ===========================================
// GLOBAL HELPER: MODAL & NOTIFIKASI
// ===========================================

App.showAlert = function(type, title, msg) {
    var modal = document.getElementById('customAlertModal');
    if(!modal) return alert(msg.replace(/<br>/g, '\n')); 
    var icon = document.getElementById('alertIcon'); var btn = document.getElementById('btnAlertOk');
    document.getElementById('alertTitle').textContent = title; document.getElementById('alertDesc').innerHTML = msg;
    icon.className = 'confirm-icon'; btn.className = 'btn-confirm-yes';
    if(type === 'error') { icon.classList.add('error'); btn.classList.add('error'); icon.innerHTML = '<i class="fas fa-times-circle"></i>'; } 
    else if(type === 'success') { icon.classList.add('success'); btn.classList.add('success'); icon.innerHTML = '<i class="fas fa-check-circle"></i>'; } 
    else { icon.innerHTML = '<i class="fas fa-info-circle"></i>'; }
    modal.style.display = 'flex'; setTimeout(function() { modal.classList.add('show'); }, 10);
    var newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
    newBtn.onclick = function() { modal.classList.remove('show'); setTimeout(function() { modal.style.display = 'none'; }, 300); };
};

App.showConfirm = function(title, msg, callback) {
    var modal = document.getElementById('customConfirmModal');
    if(!modal) return callback(confirm(msg.replace(/<br>/g, '\n')));
    var btnYes = document.getElementById('btnConfirmYes'); var btnNo = document.getElementById('btnConfirmNo');
    document.getElementById('confirmTitle').textContent = title; document.getElementById('confirmDesc').innerHTML = msg;
    modal.style.display = 'flex'; setTimeout(function() { modal.classList.add('show'); }, 10);
    var newYes = btnYes.cloneNode(true); var newNo = btnNo.cloneNode(true);
    btnYes.parentNode.replaceChild(newYes, btnYes); btnNo.parentNode.replaceChild(newNo, btnNo);
    newYes.onclick = function() { modal.classList.remove('show'); setTimeout(function() { modal.style.display = 'none'; }, 300); callback(true); };
    newNo.onclick = function() { modal.classList.remove('show'); setTimeout(function() { modal.style.display = 'none'; }, 300); callback(false); };
};

App.showAppModal = function(status, msg, redirectPage) {
    var modal = document.getElementById('appModal');
    if(!modal) return alert(msg);
    var content = modal.querySelector('.modal-content'); var iconBox = document.getElementById('modalIconBox'); var title = document.getElementById('modalTitle'); var message = document.getElementById('modalMessage'); var btn = document.getElementById('modalBtnMain');
    content.className = 'modal-content'; btn.style.display = 'block';
    
    if (status === 'loading') {
        content.classList.add('loading'); iconBox.innerHTML = '<div class="modal-spinner"></div>';
        title.textContent = 'Memproses...'; message.textContent = msg || 'Mohon tunggu sebentar...';
        btn.style.display = 'none';
    } else if (status === 'success') {
        content.classList.add('success'); iconBox.innerHTML = '<i class="fas fa-check"></i>';
        title.textContent = 'Berhasil!'; message.innerHTML = msg; btn.textContent = 'Lanjutkan';
    } else if (status === 'error') {
        content.classList.add('error'); iconBox.innerHTML = '<i class="fas fa-exclamation"></i>';
        title.textContent = 'Terjadi Kesalahan'; message.innerHTML = msg; btn.textContent = 'Tutup';
    }
    
    modal.style.display = 'flex'; setTimeout(function() { modal.classList.add('show'); }, 10);
    
    if(status !== 'loading') {
        setTimeout(function(){ btn.focus(); }, 100);
        var newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = function() {
            modal.classList.remove('show');
            setTimeout(function() {
                modal.style.display = 'none';
                if (redirectPage && status === 'success') App.loadPage(null, redirectPage);
            }, 300);
        };
    }
};

App.handleFormSubmit = function(formEl, funcName) {
    var btn = formEl.querySelector('button[type="submit"]'); var fileIn = formEl.querySelector('input[type="file"]');
    if(fileIn) {
        if(fileIn.files.length === 0) return App.showAppModal('error', 'Harap pilih file dokumen yang akan diunggah.');
        if(fileIn.files[0].size > 1048576) return App.showAppModal('error', 'Ukuran file terlalu besar. Maksimal <b>1 MB</b>.');
    }
    var oldTxt = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mengirim...';
    var formData = {}; var els = formEl.querySelectorAll('input, select');
    els.forEach(function(el) { if(el.name) formData[el.name] = el.value; });
    var activeUser = App.currentUser ? App.currentUser.nama : 'Admin/Guest'; formData.User = activeUser;
    var reader = new FileReader();
    reader.onload = function(e) {
        formData.fileData = { data: e.target.result.split(',')[1], mimeType: fileIn.files[0].type, fileName: fileIn.files[0].name };
        google.script.run.withSuccessHandler(function(res) {
            btn.disabled = false; btn.innerHTML = oldTxt; formEl.reset();
            App.showAppModal('success', res, 'lapbul_riwayat'); 
        }).withFailureHandler(function(err) {
            btn.disabled = false; btn.innerHTML = oldTxt; App.showAppModal('error', err.message);
        })[funcName](formData);
    };
    reader.readAsDataURL(fileIn.files[0]);
};

// ===========================================
// INIT SYSTEM & LOGIN
// ===========================================
App.init = function() {
    document.querySelectorAll('.modal-overlay').forEach(function(el) { el.style.display = 'none'; el.classList.remove('show'); });
    var userSession = localStorage.getItem('user_session');
    var sidebar = document.querySelector('.sidebar'); var mainContent = document.getElementById('main-content');
    if (!userSession) {
        if(sidebar) sidebar.style.display = 'none';
        if(mainContent) { mainContent.style.marginLeft = '0'; mainContent.style.width = '100%'; mainContent.style.padding = '0'; mainContent.style.display = 'flex'; mainContent.style.alignItems = 'center'; mainContent.style.justifyContent = 'center'; }
        App.loadPage(null, 'login'); 
    } else {
        var user; try { user = JSON.parse(userSession); } catch (e) { localStorage.removeItem('user_session'); window.location.reload(); return; }
        App.currentUser = user; var role = (user.role || '').toLowerCase(); var isAdmin = (role.indexOf('admin') !== -1);
        if(sidebar) sidebar.style.display = 'flex';
        if(mainContent) mainContent.removeAttribute('style'); 
        var adminMenus = document.querySelectorAll('.admin-only');
        for(var j=0; j<adminMenus.length; j++) { adminMenus[j].style.display = isAdmin ? 'block' : 'none'; }
        setTimeout(function() {
            var elName = document.getElementById('sidebar-user-name'); var elRole = document.getElementById('sidebar-user-role'); var elAvatar = document.querySelector('.user-avatar-small'); 
            if (elName) elName.textContent = user.nama || "User"; if (elRole) elRole.textContent = user.role || "Staff";
            if (elAvatar && user.foto && String(user.foto).trim() !== "") {
                var imgUrl = user.foto.trim();
                if (imgUrl.indexOf('drive.google.com') !== -1) { var parts = imgUrl.split('/d/'); if (parts.length > 1) imgUrl = 'https://drive.google.com/thumbnail?id=' + parts[1].split('/')[0] + '&sz=s1000'; } 
                elAvatar.innerHTML = '<img src="' + imgUrl + '" alt="Profil" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">';
            } else if (elAvatar) { elAvatar.innerHTML = '<i class="fas fa-user"></i>'; }
        }, 50);
        App.setupSidebar();
        var currentContent = mainContent.innerHTML.trim();
        if (!currentContent || document.getElementById('loginForm')) { App.loadPage(null, 'home'); }
        var skMenuLink = document.querySelector('a[data-page="sk_menu"]'); if (skMenuLink) skMenuLink.addEventListener('click', function(e) { App.loadPage(e, 'sk_menu'); });
    }
};

App.loadPage = function(e, p, arg) {
    if(e) e.preventDefault(); var main = document.getElementById('main-content');
    if(p !== 'login' && main) { main.innerHTML = '<div class="loading-container"><div class="app-spinner"></div><p class="loading-text">Memuat...</p></div>'; }
    document.querySelectorAll('.sidebar-menu a').forEach(function(a) { a.classList.remove('active'); });
    document.querySelectorAll('.has-submenu').forEach(function(li) {
        li.classList.remove('open'); var sub = li.querySelector('.submenu'); if(sub) sub.style.maxHeight = null;
        var icon = li.querySelector('.submenu-icon'); if(icon) icon.style.transform = 'rotate(0deg)';
    });
    var activeLink = document.querySelector('.sidebar-menu a[data-page="' + p + '"]');
    if(activeLink) {
        activeLink.classList.add('active'); var parentLi = activeLink.closest('li.has-submenu');
        while(parentLi) {
            parentLi.classList.add('open'); var sub = parentLi.querySelector('.submenu'); if(sub) sub.style.maxHeight = "3000px"; 
            var icon = parentLi.querySelector('.submenu-icon'); if(icon) icon.style.transform = "rotate(90deg)";
            parentLi = parentLi.parentElement.closest('li.has-submenu');
        }
    }
    google.script.run.withSuccessHandler(function(h) {
        if(main) main.innerHTML = h;
        if(App.inits[p]) setTimeout(function() { App.inits[p](arg); }, 50);
    }).withFailureHandler(function(err) { if(main) main.innerHTML = '<div style="color:red;padding:20px;">Error: ' + err.message + '</div>'; }).include('page_' + p);
};

App.setupSidebar = function() {
    var toggles = document.querySelectorAll('.has-submenu > a');
    for(var i=0; i<toggles.length; i++) {
        var menuLink = toggles[i]; var newLink = menuLink.cloneNode(true);
        menuLink.parentNode.replaceChild(newLink, menuLink);
        newLink.addEventListener('click', function(e) {
            e.preventDefault(); var currentLi = this.parentElement; var submenu = currentLi.querySelector('.submenu'); var icon = this.querySelector('.submenu-icon');
            currentLi.classList.toggle('open');
            if(currentLi.classList.contains('open')) { if(submenu) submenu.style.maxHeight = "3000px"; if(icon) icon.style.transform = "rotate(90deg)"; } 
            else { if(submenu) submenu.style.maxHeight = null; if(icon) icon.style.transform = "rotate(0deg)"; }
        });
    }
    var navLinks = document.querySelectorAll('.sidebar-menu a[data-page]');
    for(var k=0; k<navLinks.length; k++) {
        var link = navLinks[k];
        if(link.parentElement.classList.contains('has-submenu')) continue; if(link.getAttribute('data-page') === 'logout') continue;
        var newLink = link.cloneNode(true); link.parentNode.replaceChild(newLink, link);
        newLink.addEventListener('click', function(e) { e.preventDefault(); App.loadPage(e, this.getAttribute('data-page')); });
    }
    var logoutBtn = document.querySelector('a[data-page="logout"]');
    if(logoutBtn) { logoutBtn.onclick = function(e) { e.preventDefault(); localStorage.removeItem('user_session'); App.init(); }; }
};

// ===========================================
// 2. LOGIKA UTAMA HALAMAN (App.inits)
// ===========================================
App.inits = {
    'home': function(){},
    
    // --- SK RIWAYAT ---
    'sk_riwayat': function() {
        App.initSmartTable({
            tableId: 'riwayatTable', serverFunc: 'getSKRiwayatData',
            headers: ["Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK", 
                { 
                    name: "Dokumen", tdStyle: "text-align:center;",
                    formatter: function(row) {
                        var url = row.Dokumen;
                        if (url && url.includes('http')) {
                            var safeUrl = encodeURIComponent(url);
                            var safeTitle = encodeURIComponent('SK ' + (row['Nomor SK'] || ''));
                            return '<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), decodeURIComponent(\'' + safeTitle + '\'))"><i class="fas fa-eye"></i> Lihat</button>';
                        }
                        return '<span style="color:#cbd5e1;">-</span>';
                    }
                },
                "Tanggal Unggah", "Pengunggah"
            ],
            filters: [{id:'filterTahun',col:'Tahun Ajaran',desc:true}, {id:'filterSemester',col:'Semester'}, {id:'filterNamaSekolah',col:'Nama Sekolah'}]
        });
    },

    'sk_kelola': function() {
        App.initSmartTable({
            tableId: 'kelolaTable', serverFunc: 'getSKKelolaData',
            headers: [
                "Nama Sekolah", "Tahun Ajaran", "Semester", "Nomor SK", "Tanggal SK", "Kriteria SK",
                { 
                    name: "Dokumen", tdStyle: "text-align:center;",
                    formatter: function(row) {
                        var url = row.Dokumen;
                        if (url && url.includes('http')) {
                            var safeUrl = encodeURIComponent(url); var safeTitle = encodeURIComponent('SK ' + (row['Nomor SK'] || ''));
                            return '<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), decodeURIComponent(\'' + safeTitle + '\'))"><i class="fas fa-eye"></i> Lihat</button>';
                        }
                        return '<span style="color:#cbd5e1;">-</span>';
                    }
                },
                { name: "Status", tdStyle: "text-align:center;", formatter: function(row) { return row.Status || '<span class="status-badge status-diproses">Proses</span>'; } },
                { name: "Keterangan", tdStyle: "font-size:0.85em; color:#64748b; max-width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" },
                {
                    name: "Aksi", width: "140px", tdStyle: "text-align:center;",
                    formatter: function(row) {
                        var isAdmin = (App.currentUser && App.currentUser.role === 'Admin');
                        var statusRaw = String(row['_statusRaw'] || row['Status'] || '').toLowerCase();
                        var isLocked = statusRaw.includes('ok') || statusRaw.includes('disetujui');
                        var vId = row._rowIndex; var vNama = encodeURIComponent(row['Nama Sekolah'] || '');
                        var vNomor = encodeURIComponent(row['Nomor SK'] || ''); var vTgl = encodeURIComponent(row['Tanggal SK'] || '');
                        var vThn = encodeURIComponent(row['Tahun Ajaran'] || ''); var vSmt = encodeURIComponent(row['Semester'] || '');
                        var vKrit = encodeURIComponent(row['Kriteria SK'] || ''); var vUrl = encodeURIComponent(row['Dokumen'] || '');

                        var editAttr = isLocked ? 'disabled style="background:#cbd5e1; cursor:not-allowed;"' : 'onclick="App.skEdit(\'' + vId + '\', \'' + vNama + '\', \'' + vThn + '\', \'' + vSmt + '\', \'' + vNomor + '\', \'' + vTgl + '\', \'' + vKrit + '\', \'' + vUrl + '\')"';
                        var btnEdit = '<button class="btn-action-sm btn-edit" title="Edit Data" ' + editAttr + '><i class="fas fa-pencil-alt"></i></button>';
                        
                        var delAttr = isLocked ? 'disabled style="background:#cbd5e1; cursor:not-allowed;"' : 'onclick="App.skHapus(\'' + vId + '\', \'' + vNama + '\')"';
                        var btnDel = '<button class="btn-action-sm btn-delete" title="Hapus Data" ' + delAttr + '><i class="fas fa-trash"></i></button>';
                        
                        var btnVerif = '';
                        if (isAdmin) { 
                            // [FIX] Mengirimkan semua parameter yang dibutuhkan oleh App.skVerifikasi
                            btnVerif = '<button class="btn-action-sm btn-verify" title="Verifikasi" onclick="App.skVerifikasi(\'' + vId + '\', \'' + vNama + '\', \'' + vThn + '\', \'' + vSmt + '\', \'' + vUrl + '\', \'' + vNomor + '\', \'' + vTgl + '\', \'' + vKrit + '\')"><i class="fas fa-check-circle"></i></button>'; 
                        }
                        return '<div style="display:flex; justify-content:center; gap:5px;">' + btnVerif + btnEdit + btnDel + '</div>';
                    }
                },
                { name: "Tanggal Unggah", tdStyle: "font-size:0.8em; color:#64748b;" },
                { name: "Pengunggah", tdStyle: "font-size:0.8em; color:#334155;" },
                { name: "Edit", tdStyle: "font-size:0.8em; color:#f59e0b;" },
                { name: "Editor", tdStyle: "font-size:0.8em; color:#f59e0b;" },
                { name: "Verifikasi", tdStyle: "font-size:0.8em; color:#10b981;" },
                { name: "Verifikator", tdStyle: "font-size:0.8em; color:#10b981;" }
            ],
            filters: [ {id:'kelolaTahun',col:'Tahun Ajaran',desc:true}, {id:'kelolaSemester',col:'Semester'}, {id:'kelolaSekolah',col:'Nama Sekolah'}, {id:'kelolaStatus', col:'_statusRaw'} ]
        });
        var searchBox = document.getElementById('kelolaSearch');
        if(searchBox) { searchBox.onkeyup = function() { var term = this.value.toLowerCase(); var rows = document.querySelectorAll('#kelolaTable tbody tr'); rows.forEach(function(r) { r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none'; }); }; }
    },

    // --- UPDATE: SK EDIT (Kirim Nama Editor) ---
    'sk_edit': function() {
        if (!App.tempEditData) { App.loadPage(null, 'sk_kelola'); return; }
        var data = App.tempEditData;
        var form = document.getElementById('skEditForm');
        
        if (form) {
            // ... (Kode populate data form sama seperti sebelumnya) ...
            document.getElementById('editRowIndex').value = data.rowIndex;
            document.getElementById('viewNamaSekolah').value = data.namaSekolah;
            document.getElementById('editNamaSekolah').value = data.namaSekolah;
            document.getElementById('viewTahun').value = data.tahun;
            document.getElementById('editTahun').value = data.tahun;
            document.getElementById('viewSemester').value = data.semester;
            document.getElementById('editSemester').value = data.semester;
            document.getElementById('editNomorSK').value = data.nomor;
            
            var elKriteria = document.getElementById('editKriteria');
            if (elKriteria) {
                google.script.run.withSuccessHandler(function(opts) {
                    var kriteriaList = opts['Kriteria SK'] || [];
                    elKriteria.innerHTML = '<option value="">-- Pilih Kriteria --</option>';
                    kriteriaList.forEach(function(k) { elKriteria.add(new Option(k, k)); });
                    elKriteria.value = data.kriteria;
                }).getMasterSkOptions();
            }
            
            if(data.tanggal && data.tanggal !== 'undefined') {
                var d = null;
                if (typeof data.tanggal === 'string' && data.tanggal.includes('/')) {
                    var parts = data.tanggal.split('/');
                    if(parts.length === 3) d = new Date(parts[2], parts[1] - 1, parts[0]);
                } else { d = new Date(data.tanggal); }
                if(d && !isNaN(d.getTime())) {
                    var yyyy = d.getFullYear();
                    var mm = String(d.getMonth() + 1).padStart(2, '0');
                    var dd = String(d.getDate()).padStart(2, '0');
                    document.getElementById('editTanggalSK').value = `${yyyy}-${mm}-${dd}`;
                }
            }

            var btnContainer = document.getElementById('btnLihatFileContainer');
            if (data.fileUrl && data.fileUrl !== 'undefined' && data.fileUrl !== '') {
                var safeUrl = encodeURIComponent(data.fileUrl);
                var safeTitle = encodeURIComponent('SK ' + data.nomor);
                btnContainer.innerHTML = '<button type="button" class="btn-action-sm btn-view" style="font-size:0.85em; padding:6px 12px;" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), decodeURIComponent(\'' + safeTitle + '\'))"><i class="fas fa-eye"></i> Lihat Dokumen</button>';
            } else { btnContainer.innerHTML = '<span class="text-muted small italic">Tidak ada file.</span>'; }

            // SUBMIT HANDLER
            form.onsubmit = function(e) {
                e.preventDefault();
                var fileInput = document.getElementById('editFile');
                if (fileInput.files.length > 0) {
                    var f = fileInput.files[0];
                    if (f.size > 1048576) { App.showAppModal('error', 'File terlalu besar. Maksimal 1MB.'); return; }
                    if (f.type !== 'application/pdf') { App.showAppModal('error', 'File harus format PDF.'); return; }
                }

                var btn = document.getElementById('btnSimpanEdit');
                var oldHtml = btn.innerHTML;
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';

                // Siapkan Nama Editor
                var editor = (App.currentUser && App.currentUser.nama) ? App.currentUser.nama : 'Admin';

                var dataPayload = {
                    rowIndex: document.getElementById('editRowIndex').value,
                    nomor: document.getElementById('editNomorSK').value,
                    tanggal: document.getElementById('editTanggalSK').value,
                    tahun: document.getElementById('editTahun').value,
                    semester: document.getElementById('editSemester').value,
                    kriteria: document.getElementById('editKriteria').value,
                    editorName: editor // Kirim nama editor
                };

                var send = function() {
                    google.script.run.withSuccessHandler(function(res) {
                        App.showAppModal('success', res, 'sk_kelola'); 
                    }).withFailureHandler(function(err) {
                        btn.disabled = false; btn.innerHTML = oldHtml;
                        App.showAppModal('error', err.message);
                    }).updateSKData(dataPayload);
                };

                if (fileInput.files.length > 0) {
                    var r = new FileReader();
                    r.onload = function(evt) {
                        dataPayload.fileData = {
                            data: evt.target.result.split(',')[1],
                            mimeType: fileInput.files[0].type,
                            fileName: fileInput.files[0].name
                        };
                        send();
                    };
                    r.readAsDataURL(fileInput.files[0]);
                } else {
                    send();
                }
            };
        }
    },

    // --- SK UNGGAH ---
    'sk_unggah': function() {
        var form = document.getElementById('skUnggahForm');
        if (!form) return;
        
        var elTahun = document.getElementById('unggahTahun');
        if(elTahun) elTahun.innerHTML = '<option>Memuat...</option>';

        google.script.run.withSuccessHandler(function(opts) {
            var populate = function(el, data) {
                if(!el) return; 
                el.innerHTML = '<option value="">-- Pilih --</option>';
                if(data) { data.forEach(function(i) { el.add(new Option(i, i)); }); }
            };
            populate(document.getElementById('unggahTahun'), opts['Tahun Ajaran']);
            populate(document.getElementById('unggahSemester'), opts['Semester']);
            populate(document.getElementById('unggahKriteria'), opts['Kriteria SK']);
            
            var schoolMap = opts['Nama Sekolah List'] || {};
            var elStatus = document.getElementById('unggahStatusSekolah');
            populate(elStatus, Object.keys(schoolMap).sort());
            
            if(elStatus) {
                var newStatus = elStatus.cloneNode(true);
                elStatus.parentNode.replaceChild(newStatus, elStatus);
                newStatus.addEventListener('change', function() {
                    var list = schoolMap[this.value] || [];
                    populate(document.getElementById('unggahNamaSekolah'), list);
                });
            }
        }).getMasterSkOptions();

        var newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        newForm.onsubmit = function(e) {
            e.preventDefault();
            var fileInput = document.getElementById('unggahFile');
            if (fileInput.files.length === 0) return App.showAppModal('error', "Pilih file PDF."); 
            if (fileInput.files[0].size > 1048576) return App.showAppModal('error', "Maksimal 1 MB.");
            
            var btn = newForm.querySelector('button[type="submit"]');
            var oriText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            var reader = new FileReader();
            reader.onload = function(ex) {
                var data = {
                    tahunAjaran: document.getElementById('unggahTahun').value,
                    semester: document.getElementById('unggahSemester').value,
                    statusSekolah: document.getElementById('unggahStatusSekolah').value,
                    namaSekolah: document.getElementById('unggahNamaSekolah').value,
                    nomorSK: document.getElementById('unggahNomorSK').value,
                    tanggalSK: document.getElementById('unggahTanggalSK').value,
                    kriteriaSK: document.getElementById('unggahKriteria').value,
                    fileData: { fileName: fileInput.files[0].name, mimeType: fileInput.files[0].type, data: ex.target.result.split(',')[1] },
                    loggedInUser: App.currentUser ? App.currentUser.nama : 'User'
                };
                google.script.run.withSuccessHandler(function(r) {
                    App.showAppModal('success', r, 'sk_riwayat');
                }).withFailureHandler(function(e) {
                    btn.disabled = false; btn.innerHTML = oriText;
                    App.showAppModal('error', e.message);
                }).processManualForm(data);
            };
            reader.readAsDataURL(fileInput.files[0]);
        };
    },

    'sk_trash': function() {
        var session = JSON.parse(localStorage.getItem('user_session') || '{}');
        var role = (session.role || '').toLowerCase();
        if (!role.includes('admin')) { document.getElementById('main-content').innerHTML = '<div style="text-align:center; margin-top:50px; color:#64748b;"><i class="fas fa-lock" style="font-size:3rem; margin-bottom:20px;"></i><h3>Akses Ditolak</h3><p>Halaman ini hanya dapat diakses oleh Administrator.</p></div>'; return; }
        
        App.initSmartTable({ 
            tableId: 'trashTable', 
            serverFunc: 'getSKTrashData', 
            headers: [
                "Nama Sekolah", 
                "Tahun Ajaran", 
                "Semester", 
                { name: "Nomor SK", tdStyle: "text-align:left;"},
                // Kolom 5: Info Hapus (Rata Kiri)
                { name: "Info Hapus", tdStyle: "text-align:left; color:#ef4444; font-size:0.85em;" }, 
                // Kolom 7: Dokumen (Tombol Lihat)
                { 
                    name: "Dokumen", tdStyle: "text-align:center;",
                    formatter: function(row) {
                        var url = row.Dokumen;
                        if (url && url.includes('http')) {
                            var safeUrl = encodeURIComponent(url);
                            var safeTitle = encodeURIComponent('Arsip SK (Deleted)');
                            // Gunakan tombol standar btn-view
                            return '<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), decodeURIComponent(\'' + safeTitle + '\'))"><i class="fas fa-eye"></i> Lihat</button>';
                        }
                        return '<span style="color:#e2e8f0;">-</span>';
                    }
                }
            ] 
        });

        var searchInput = document.getElementById('trashSearch');
        if(searchInput) { 
            searchInput.onkeyup = function() { 
                var val = this.value.toLowerCase(); 
                var tbody = document.querySelector('#trashTable tbody'); 
                var rows = tbody.getElementsByTagName('tr'); 
                for (var i = 0; i < rows.length; i++) { 
                    var text = rows[i].textContent.toLowerCase(); 
                    rows[i].style.display = text.indexOf(val) > -1 ? '' : 'none'; 
                } 
            }; 
        }
    },

    'sk_status': function() { 
        var container = document.getElementById('tableWrapper');
        if(!container) return;

        // SKELETON (Aktif Kembali)
        var skeletonHtml = 
            '<div class="std-filter-card">' +
                 '<div class="skeleton-anim" style="width:250px; height:35px; border-radius:6px;"></div>' +
            '</div>' +
            '<div class="std-table-container" style="overflow:hidden; position:relative;">' +
                '<table class="std-table matrix-mode table-bordered" style="width:100%;">' +
                    '<thead>' +
                        '<tr>' +
                            '<th rowspan="2" class="col-no text-center">No</th>' +
                            '<th rowspan="2" class="col-nama text-center">Nama Sekolah</th>';
        
        for(var k=0; k<6; k++) { skeletonHtml += '<th colspan="2" class="text-center"><div class="skeleton-anim" style="width:60px; height:10px; margin:auto;"></div></th>'; }
        skeletonHtml += '</tr><tr>';
        for(var k=0; k<12; k++) { skeletonHtml += '<th class="col-data"><div class="skeleton-anim" style="width:30px; height:8px; margin:auto;"></div></th>'; }
        skeletonHtml += '</tr></thead><tbody>';
        for(var i=0; i<10; i++) {
            skeletonHtml += 
                '<tr>' +
                    '<td class="col-no text-center"><div class="skeleton-anim" style="width:15px; height:10px; margin:auto;"></div></td>' +
                    '<td class="col-nama"><div class="skeleton-anim" style="width:150px; height:10px;"></div></td>';
            for(var j=0; j<12; j++) { skeletonHtml += '<td class="col-data text-center"><div class="skeleton-anim" style="width:40px; height:15px; margin:auto; border-radius:4px;"></div></td>'; }
            skeletonHtml += '</tr>';
        }
        skeletonHtml += '</tbody></table></div>';
        container.innerHTML = skeletonHtml;

        google.script.run.withSuccessHandler(function(data) {
            if (data.error) { App.showAppModal('error', data.error); return; }

            var html = 
                '<div class="std-filter-card" style="display:flex; align-items:center; padding:15px; gap:10px;">' +
                    '<div style="position: relative; width: 300px; height: 42px;">' +
                        '<i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; pointer-events:none; z-index:1;"></i>' +
                        '<input type="text" id="searchMatrix" class="std-search-input" placeholder="Cari Nama Sekolah..." style="padding-left: 35px; width:100%;">' +
                    '</div>' +
                    '<button onclick="App.inits[\'sk_status\']()" class="std-filter-btn" title="Muat Ulang"><i class="fas fa-sync-alt"></i></button>' +
                    '<div style="margin-left:auto; display:flex; gap:15px; font-size:0.85em; color:#64748b;">' +
                        '<div class="d-flex align-items-center gap-2"><span style="display:inline-block; width:12px; height:12px; background:#dcfce7; border:1px solid #22c55e;"></span> OK</div>' +
                        // Update Legend Diproses menjadi Biru
                        '<div class="d-flex align-items-center gap-2"><span style="display:inline-block; width:12px; height:12px; background:#dbeafe; border:1px solid #1d4ed8;"></span> Diproses</div>' +
                        '<div class="d-flex align-items-center gap-2"><span style="display:inline-block; width:12px; height:12px; background:#fef9c3; border:1px solid #facc15;"></span> Revisi</div>' +
                        '<div class="d-flex align-items-center gap-2"><span style="display:inline-block; width:12px; height:12px; background:#fee2e2; border:1px solid #ef4444;"></span> Ditolak</div>' +
                    '</div>' +
                '</div>' +
                '<div class="std-table-container" style="overflow:auto; max-height:100vh; position:relative;">' +
                    '<table class="std-table matrix-mode table-bordered" id="realMatrixTable" style="width:100%;">' +
                        '<thead><tr><th rowspan="2" class="col-no text-center">No</th><th rowspan="2" class="col-nama text-center">Nama Sekolah</th>';
            
            data.years.forEach(function(th) { html += '<th colspan="2" class="text-center" style="border-bottom:1px solid #cbd5e1;">' + th + '</th>'; });
            html += '</tr><tr>';
            data.years.forEach(function() { html += '<th class="text-center col-data">Sem 1</th><th class="text-center col-data">Sem 2</th>'; });
            html += '</tr></thead><tbody>';

            data.rows.forEach(function(row, i) {
                html += '<tr><td class="col-no text-center">' + (i+1) + '</td><td class="col-nama">' + row.nama + '</td>';
                data.years.forEach(function(th) {
                    ['Ganjil', 'Genap'].forEach(function(smt) {
                        var key = th + '_' + smt;
                        var val = row[key];
                        var cellStyle = '';
                        var content = '-';

                        if(val) {
                            var s = String(val).toLowerCase();
                            
                            if (s.includes('revisi')) {
                                cellStyle = 'background-color:#fef9c3; color:#854d0e; font-weight:bold;'; // Kuning
                                content = 'Revisi';
                            } else if (s.includes('ditolak') || s.includes('x')) {
                                cellStyle = 'background-color:#fee2e2; color:#991b1b; font-weight:bold;'; // Merah
                                content = 'Ditolak';
                            } else if (s.includes('ok') || s.includes('setuju')) {
                                cellStyle = 'background-color:#dcfce7; color:#166534; font-weight:bold;'; // Hijau
                                content = 'OK';
                            } else if (s.includes('proses') || s.includes('diproses')) {
                                // WARNA BIRU UNTUK DIPROSES
                                cellStyle = 'background-color:#dbeafe; color:#1e40af; font-weight:bold;'; 
                                content = 'Diproses';
                            } else {
                                // Default fallback jika ada isi tapi status tidak dikenal
                                cellStyle = 'background-color:#f1f5f9; color:#475569;'; 
                                content = '?';
                            }
                        }

                        html += '<td class="col-data text-center" style="' + cellStyle + '">' + content + '</td>';
                    });
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;

            document.getElementById('searchMatrix').addEventListener('keyup', function() {
               var term = this.value.toLowerCase();
               var trs = document.querySelectorAll('#realMatrixTable tbody tr');
               trs.forEach(function(tr) {
                   var cellNama = tr.querySelector('.col-nama');
                   if(cellNama) { var txt = cellNama.textContent.toLowerCase(); tr.style.display = txt.includes(term) ? '' : 'none'; }
               });
            });
        }).getSKStatusMatrixAll();
    },

    'sk_arsip': function() { App.arsipState.history = [{id: null, name: 'SK Pembagian Tugas'}]; App.loadArsipSK(null); },

    'sk_menu': function() {
        // --- 1. SET LOADING STATE (6 ITEM) ---
        ['statTotal', 'statToday', 'statProses', 'statOK', 'statRevisi', 'statDitolak'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size:0.6em"></i>';
        });
        document.getElementById('listRecent').innerHTML = '<div style="text-align:center; padding:10px;">Memuat...</div>';

        // --- 2. REQUEST DATA ---
        google.script.run.withSuccessHandler(function(stats) {
            if(stats.error) { console.error(stats.error); return; }

            // A. ISI KARTU (ANIMASI)
            var animate = function(id, val) {
                var el = document.getElementById(id);
                if(el) el.textContent = val || 0;
            };
            animate('statTotal', stats.total);
            animate('statToday', stats.today);
            animate('statProses', stats.status.proses);
            animate('statOK', stats.status.ok);
            animate('statRevisi', stats.status.revisi);
            animate('statDitolak', stats.status.ditolak); // <-- TAMBAHAN INI

            // B. UPDATE SEMESTER
            var semHtml = '';
            if (stats.topSemesters && stats.topSemesters.length > 0) {
                stats.topSemesters.forEach(function(s) {
                    semHtml += '<div class="sem-badge">' + 
                               '<i class="fas fa-tag" style="color:#64748b"></i> ' + s.label + 
                               '<span class="sem-count">' + s.count + '</span></div>';
                });
            } else {
                semHtml = '<span style="color:#94a3b8; font-size:0.9em;">Belum ada data semester</span>';
            }
            var elSem = document.getElementById('semesterStats');
            if(elSem) elSem.innerHTML = semHtml;

            // C. RENDER CHART
            if(typeof Chart !== 'undefined') {
                
                // Chart Tren
                var ctxTrend = document.getElementById('chartTrend');
                if (ctxTrend) {
                    if (ctxTrend.chartInstance) ctxTrend.chartInstance.destroy();
                    
                    ctxTrend.chartInstance = new Chart(ctxTrend.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'],
                            datasets: [{
                                label: 'Data Masuk',
                                data: stats.monthlyTrend,
                                backgroundColor: '#3b82f6',
                                borderRadius: 4,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { beginAtZero: true, ticks: { precision: 0 } }, 
                                x: { grid: { display: false } } 
                            }
                        }
                    });
                }

                // Chart Status
                var ctxStatus = document.getElementById('chartStatus');
                if (ctxStatus) {
                    if (ctxStatus.chartInstance) ctxStatus.chartInstance.destroy();

                    ctxStatus.chartInstance = new Chart(ctxStatus.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Diproses', 'OK', 'Revisi', 'Ditolak'],
                            datasets: [{
                                data: [
                                    stats.status.proses, 
                                    stats.status.ok, 
                                    stats.status.revisi, 
                                    stats.status.ditolak
                                ],
                                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '65%',
                            plugins: { 
                                legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
                            }
                        }
                    });
                }
            }

            // D. RECENT ACTIVITY
            var listHtml = '';
            if(stats.recent.length === 0) listHtml = '<div style="padding:10px; color:#ccc;">Belum ada aktivitas</div>';
            else {
                stats.recent.forEach(function(r) {
                    var st = String(r.status).replace(/<[^>]*>?/gm, '').trim(); 
                    var color = '#64748b';
                    if(st.includes('OK') || st.includes('Setuju')) color='#10b981';
                    else if(st.includes('Revisi')) color='#f59e0b';
                    else if(st.includes('Ditolak')) color='#ef4444';
                    
                    listHtml += '<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f1f5f9;">' +
                                '<div><div style="font-weight:600; font-size:0.85em; color:#334155;">'+r.sekolah+'</div>' +
                                '<div style="font-size:0.75em; color:#94a3b8;">'+r.waktu+'</div></div>' +
                                '<div style="font-size:0.75em; font-weight:bold; color:'+color+';">'+st+'</div>' +
                                '</div>';
                });
            }
            var elList = document.getElementById('listRecent');
            if(elList) elList.innerHTML = listHtml;

        }).getSKDashboardStats();
    },
};

// 1. FUNGSI EDIT (NAVIGASI KE HALAMAN BARU)
App.skEdit = function(rowIndex, encNama, encTahun, encSmt, encNomor, encTgl, encKrit, encUrl) {
    // Simpan data di memori sementara
    App.tempEditData = {
        rowIndex: rowIndex,
        namaSekolah: decodeURIComponent(encNama),
        tahun: decodeURIComponent(encTahun),
        semester: decodeURIComponent(encSmt),
        nomor: decodeURIComponent(encNomor),
        tanggal: decodeURIComponent(encTgl),
        kriteria: decodeURIComponent(encKrit),
        fileUrl: decodeURIComponent(encUrl || '')
    };
    // Navigasi ke halaman form edit
    App.loadPage(null, 'sk_edit');
};

// 2. FUNGSI HAPUS (POPUP KONFIRMASI)
App.skHapus = function(rowIndex, encNama) {
    var namaSekolah = decodeURIComponent(encNama);

    // Gunakan Modal Konfirmasi Hapus yang sama dengan Lapbul (App.showDeleteConfirmation)
    // Tapi kita modifikasi sedikit agar fleksibel atau buat fungsi khusus untuk SK
    
    // Kita buat logic custom Swal untuk input kode konfirmasi
    var today = new Date();
    var yyyy = today.getFullYear();
    var mm = String(today.getMonth() + 1).padStart(2, '0');
    var dd = String(today.getDate()).padStart(2, '0');
    var todayCode = yyyy + mm + dd;

    var htmlContent = `
        <div style="text-align:left;">
            <p style="color:#64748b; margin-bottom:15px;">
                Anda akan menghapus data SK dari:<br>
                <strong style="color:#ef4444; font-size:1.1em;">${namaSekolah}</strong>
            </p>
            <div style="background:#fef2f2; border:1px solid #fecaca; border-radius:6px; padding:10px; margin-bottom:15px; font-size:0.9em; color:#b91c1c;">
                <i class="fas fa-exclamation-triangle"></i> 
                Data akan dihapus dari server.
            </div>
            <div class="mb-3">
                <label style="font-weight:600; display:block; margin-bottom:5px; font-size:0.9em;">Masukkan Kode Konfirmasi</label>
                <input type="text" id="delCodeInput" class="swal2-input" style="width:100%; margin:0; text-align:center; letter-spacing:2px; font-weight:bold;" placeholder="_ _ _ _ _ _ _ _">
                <div style="text-align:center; font-size:0.8em; color:#94a3b8; margin-top:5px;">
                    Hubungi admin untuk mendapatkan kode.
                </div>
            </div>
        </div>
    `;

    Swal.fire({
        title: 'Konfirmasi Hapus',
        html: htmlContent,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#94a3b8',
        confirmButtonText: 'Ya, Hapus Data',
        cancelButtonText: 'Batal',
        focusConfirm: false,
        preConfirm: function() {
            var code = document.getElementById('delCodeInput').value;
            if (!code) {
                Swal.showValidationMessage('Kode konfirmasi wajib diisi!');
                return false;
            }
            if (code !== todayCode) {
                Swal.showValidationMessage('Kode konfirmasi salah.');
                return false;
            }
            return code;
        }
    }).then(function(result) {
        if (result.isConfirmed) {
            // Tampilkan Loading
            App.showAppModal('loading', 'Menghapus data...');
            
            // Ambil Info User
            var actorName = 'Admin';
            var actorRole = 'Administrator';
            if (App.currentUser) {
                actorName = App.currentUser.nama || App.currentUser.username || 'Admin';
                actorRole = App.currentUser.role || 'User';
            }

            // Panggil Backend
            google.script.run.withSuccessHandler(function(r) {
                App.showAppModal('success', r);
                if(App.inits['sk_kelola']) App.inits['sk_kelola'](); // Refresh Tabel
            }).withFailureHandler(function(e) {
                App.showAppModal('error', e.message);
            }).deleteSKData(rowIndex, result.value, actorName, actorRole);
        }
    });
};

// 3. FUNGSI VERIFIKASI (POPUP MODAL)
App.skVerifikasi = function(rowIndex, encNama, encTahun, encSemester, encUrl, encNomor, encTgl, encKrit) {
    var namaSekolah = decodeURIComponent(encNama);
    var tahun = decodeURIComponent(encTahun);
    var semester = decodeURIComponent(encSemester);
    var docUrl = decodeURIComponent(encUrl || '');
    
    // Decode data tambahan (Gunakan '-' jika kosong/undefined)
    var nomorSK = encNomor ? decodeURIComponent(encNomor) : '-';
    var tglSK = encTgl ? decodeURIComponent(encTgl) : '-';
    var kriteria = encKrit ? decodeURIComponent(encKrit) : '-';
    
    // Siapkan Iframe Preview
    var previewHtml = '';
    if (docUrl && docUrl.includes('http')) {
        var fileId = "";
        var match = docUrl.match(/[-\w]{25,}/);
        if (match) fileId = match[0];
        var previewLink = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : docUrl;
        
        previewHtml = '<div style="flex:1; height:100%; min-height:500px; background:#f1f5f9; border-radius:8px; border:1px solid #e2e8f0; overflow:hidden; position:relative;">' +
                        '<iframe src="' + previewLink + '" style="width:100%; height:100%; border:none;" allow="autoplay"></iframe>' +
                      '</div>';
    } else {
        previewHtml = '<div style="flex:1; height:100%; min-height:500px; background:#f8fafc; border-radius:8px; border:1px dashed #cbd5e1; display:flex; align-items:center; justify-content:center; color:#94a3b8; flex-direction:column;">' +
                        '<i class="fas fa-file-excel" style="font-size:4em; margin-bottom:15px; opacity:0.5;"></i>' +
                        '<p style="font-weight:500;">Tidak ada dokumen untuk ditampilkan.</p>' +
                      '</div>';
    }

    var htmlContent = 
        '<div style="display:flex; flex-direction:row; gap:25px; text-align:left; font-size:0.95em; height:75vh; max-height:800px;">' +
            // BAGIAN KIRI: PREVIEW
            previewHtml +
            
            // BAGIAN KANAN: FORM & INFO
            '<div style="width:320px; display:flex; flex-direction:column; gap:15px;">' +
                
                // 1. INFO SEKOLAH & SK (Detail Lengkap)
                '<div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #e2e8f0; box-shadow:0 2px 4px rgba(0,0,0,0.02);">' +
                    '<h6 style="margin:0 0 10px 0; color:#64748b; font-size:0.75em; text-transform:uppercase; letter-spacing:0.5px; font-weight:700;">Data Sekolah</h6>' +
                    '<div style="margin-bottom:8px;">' +
                        '<strong style="display:block; color:#1e293b; font-size:1.1em; line-height:1.3;">' + namaSekolah + '</strong>' +
                    '</div>' +
                    '<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">' +
                        '<div style="background:#f8fafc; padding:8px; border-radius:6px; text-align:center;">' +
                            '<span style="display:block; font-size:0.75em; color:#64748b;">Tahun</span>' +
                            '<strong style="color:#334155; font-size:0.9em;">' + tahun + '</strong>' +
                        '</div>' +
                        '<div style="background:#f8fafc; padding:8px; border-radius:6px; text-align:center;">' +
                            '<span style="display:block; font-size:0.75em; color:#64748b;">Semester</span>' +
                            '<strong style="color:#334155; font-size:0.9em;">' + semester + '</strong>' +
                        '</div>' +
                    '</div>' +
                    
                    // Detail SK Tambahan
                    '<div style="border-top:1px dashed #e2e8f0; padding-top:10px;">' +
                         '<div style="margin-bottom:6px;">' +
                            '<span style="font-size:0.75em; color:#64748b; display:block;">Nomor SK:</span>' +
                            '<span style="font-weight:600; color:#334155; word-break:break-all;">' + nomorSK + '</span>' +
                         '</div>' +
                         '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">' +
                             '<div><span style="font-size:0.75em; color:#64748b; display:block;">Tanggal SK:</span><span style="font-weight:600; color:#334155;">' + tglSK + '</span></div>' +
                             '<div><span style="font-size:0.75em; color:#64748b; display:block;">Kriteria:</span><span style="font-weight:600; color:#334155;">' + kriteria + '</span></div>' +
                         '</div>' +
                    '</div>' +
                '</div>' +

                // 2. FORM VERIFIKASI
                '<div style="flex:1; display:flex; flex-direction:column; gap:15px;">' +
                    '<div>' +
                        '<label style="font-weight:600; display:block; margin-bottom:6px; font-size:0.9em; color:#334155;">Keputusan Verifikasi</label>' +
                        '<select id="verifStatus" class="std-filter-select" style="width:100%;">' +
                            '<option value="OK"> Disetujui (OK)</option>' +
                            '<option value="Revisi"> Perlu Revisi</option>' +
                            '<option value="Ditolak"> Ditolak</option>' +
                        '</select>' +
                    '</div>' +
                    
                    '<div style="flex-grow:1; display:flex; flex-direction:column;">' +
                        '<label style="font-weight:600; display:block; margin-bottom:6px; font-size:0.9em; color:#334155;">Catatan Verifikator</label>' +
                        '<textarea id="verifNote" class="swal2-textarea" style="width:100%; margin:0; flex-grow:1; font-size:0.9em; line-height:1.5; padding:10px; border-color:#cbd5e1; resize:none;" placeholder="Berikan catatan perbaikan jika status Revisi atau alasan penolakan..."></textarea>' +
                    '</div>' +
                '</div>' +

                // 3. INFO TAMBAHAN
                '<div style="background:#f0f9ff; padding:12px; border-radius:6px; border:1px solid #bae6fd; font-size:0.85em; color:#0c4a6e; display:flex; gap:10px;">' +
                    '<i class="fas fa-info-circle" style="margin-top:2px;"></i>' +
                    '<div>' +
                        '<strong>Tips:</strong> Pastikan dokumen PDF dapat dibaca dengan jelas, bertanda tangan basah/elektronik yang sah, dan stempel sekolah terlihat.' +
                    '</div>' +
                '</div>' +

            '</div>' +
        '</div>';

    Swal.fire({
        title: 'Verifikasi Data SK',
        html: htmlContent,
        width: '95%',
        padding: '20px',
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-save" style="margin-right:5px;"></i> Simpan Keputusan',
        cancelButtonText: 'Batal',
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#94a3b8',
        reverseButtons: true,
        focusConfirm: false,
        customClass: {
            popup: 'swal-wide-popup'
        },
        preConfirm: function() {
            var status = document.getElementById('verifStatus').value;
            var note = document.getElementById('verifNote').value;
            if (status !== 'OK' && !note) {
                Swal.showValidationMessage('Wajib isi catatan untuk status Revisi/Ditolak!');
                return false;
            }
            return { status: status, note: note };
        }
    }).then(function(result) {
        if (result.isConfirmed) {
            App.showAppModal('loading', 'Menyimpan Verifikasi...');
            google.script.run.withSuccessHandler(function(response) {
                App.showAppModal('success', response);
                if (App.inits['sk_kelola']) App.inits['sk_kelola'](); 
            }).withFailureHandler(function(error) {
                App.showAppModal('error', error.message);
            }).updateSKVerificationStatus({
                rowIndex: rowIndex,
                status: result.value.status,
                keterangan: result.value.note,
                verifikator: 'Admin'
            });
        }
    });
};

// ===========================================
// FUNGSI SMART TABLE & FILE PREVIEW
// ===========================================

App.initSmartTable = function(config) {
    var table = document.getElementById(config.tableId);
    if (!table) return;
    
    var thead = table.querySelector('thead');
    var tbody = table.querySelector('tbody');
    
    var colCount = (config.headers ? config.headers.length : 0) + 1; 

    if (config.headers && thead && !config.skipRenderHeader) {
        var headerHtml = '<tr><th style="width:40px; text-align:center;">No.</th>';
        config.headers.forEach(function(h) {
            var label = (typeof h === 'object') ? h.name : h;
            var width = (typeof h === 'object' && h.width) ? 'width:'+h.width : '';
            headerHtml += '<th style="' + width + '">' + label + '</th>';
        });
        headerHtml += '</tr>';
        thead.innerHTML = headerHtml;
    }

    if (tbody) {
        var skel = '';
        for(var i=0; i<3; i++) {
            skel += '<tr class="row-animate">'; 
            for(var j=0; j<colCount; j++) skel += '<td><div class="skeleton-anim" style="height:12px; background-color:#e2e8f0; width:100%;"></div></td>';
            skel += '</tr>';
        }
        tbody.innerHTML = skel;
    }

    google.script.run.withSuccessHandler(function(response) {
        var allRows = (response && response.rows) ? response.rows : (Array.isArray(response) ? response : []);

        var renderTableBody = function(rows) {
            tbody.innerHTML = ''; 
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="' + colCount + '" style="text-align:center; padding:15px; color:#64748b;">Data tidak ditemukan.</td></tr>';
                return;
            }

            rows.forEach(function(row, i) {
                var tr = document.createElement('tr');
                tr.className = 'row-animate'; 
                
                var tdNo = document.createElement('td');
                tdNo.textContent = i + 1;
                tdNo.style = "text-align:center; font-weight:bold; color:#64748b;";
                tr.appendChild(tdNo);

                config.headers.forEach(function(h) {
                    var td = document.createElement('td');
                    var key = (typeof h === 'object') ? h.name : h;
                    
                    if (typeof h === 'object' && h.formatter) {
                        td.innerHTML = h.formatter(row, key, i);
                    } else {
                        td.textContent = row[key] || ""; 
                    }
                    
                    if (typeof h === 'object' && h.tdStyle) td.style = h.tdStyle;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            var infoEl = document.getElementById(config.tableId + '_info');
            if(infoEl) infoEl.textContent = 'Total: ' + rows.length + ' Data';
        };

        renderTableBody(allRows);
        if (config.onRender) config.onRender(allRows);

        if (config.filters && config.filters.length > 0) {
            config.filters.forEach(function(f) {
                var el = document.getElementById(f.id);
                if (el && el.tagName === 'SELECT' && el.options.length <= 1) {
                    var uniqueValues = [];
                    allRows.forEach(function(r) {
                        var val = r[f.col];
                        if (val && !uniqueValues.includes(val)) uniqueValues.push(val);
                    });
                    if(f.desc) uniqueValues.sort().reverse(); else uniqueValues.sort();
                    uniqueValues.forEach(function(v) {
                        var opt = document.createElement('option');
                        opt.value = v; opt.text = v; el.add(opt);
                    });
                }
            });

            var applyAllFilters = function() {
                var filtered = allRows;
                config.filters.forEach(function(f) {
                    var el = document.getElementById(f.id);
                    if (el) {
                        var term = el.value.toLowerCase();
                        if (term && term !== "") {
                            filtered = filtered.filter(function(r) {
                                var cellVal = String(r[f.col] || "").toLowerCase();
                                return cellVal.includes(term);
                            });
                        }
                    }
                });
                renderTableBody(filtered);
            };

            config.filters.forEach(function(f) {
                var el = document.getElementById(f.id);
                if (el) { el.onchange = applyAllFilters; el.onkeyup = applyAllFilters; }
            });
        }
    }).withFailureHandler(function(err) {
        if(tbody) tbody.innerHTML = '<tr><td colspan="' + colCount + '" style="color:red; text-align:center;">Error: ' + err.message + '</td></tr>';
    })[config.serverFunc](config.params || undefined);
};

// --- FILE PREVIEW ---
App.ensureModalExists = function() {
    var modal = document.getElementById('previewModal');
    if (modal && !modal.querySelector('#previewBody')) { modal.remove(); modal = null; }
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'previewModal';
        modal.className = 'modal-overlay'; 
        modal.style.cssText = "display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10005; justify-content:center; align-items:center; backdrop-filter:blur(5px);";
        modal.innerHTML = 
        '<div class="modal-content" style="width:90%; max-width:1000px; height:90vh; display:flex; flex-direction:column; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.5);">' +
            '<div style="padding:15px 20px; display:flex; justify-content:space-between; align-items:center; background:#1e293b; color:#fff; border-bottom:1px solid #334155; flex-shrink:0;">' +
                '<h3 style="margin:0; font-size:1.1em; color:#fff; font-weight:600; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:60%;">Pratinjau Dokumen</h3>' +
                '<div id="previewHeaderActions" style="display:flex; align-items:center; gap:10px;"></div>' +
            '</div>' +
            '<div id="previewBody" style="flex:1; position:relative; background:#eee; width:100%; height:100%;"></div>' +
        '</div>';
        document.body.appendChild(modal);
    }
    return modal;
};

App.showFilePreview = function(url, title) {
    var modal = App.ensureModalExists();
    var h3 = modal.querySelector('h3');
    if(h3) h3.textContent = title || 'Pratinjau Dokumen';

    var headerActions = modal.querySelector('#previewHeaderActions');
    if (headerActions) {
        headerActions.innerHTML = ''; 
        var fileId = "";
        var match = url.match(/[-\w]{25,}/);
        if (match) fileId = match[0];
        var downloadUrl = fileId ? "https://drive.google.com/uc?export=download&id=" + fileId : url;

        var btnDl = document.createElement('a');
        btnDl.href = downloadUrl; btnDl.target = '_blank';
        btnDl.style.cssText = "background:#10b981; color:#fff; text-decoration:none; padding:6px 12px; border-radius:4px; font-size:0.9em; font-weight:600; display:inline-flex; align-items:center; gap:6px; transition:0.2s;";
        btnDl.innerHTML = '<i class="fas fa-download"></i> Unduh';
        headerActions.appendChild(btnDl);

        var btnClose = document.createElement('button');
        btnClose.innerHTML = '&times;';
        btnClose.style.cssText = "background:none; border:none; color:#cbd5e1; font-size:2.2em; cursor:pointer; line-height:0.8; padding:0 5px; margin-left:10px;";
        btnClose.onclick = function() { App.closePreview(); }; 
        headerActions.appendChild(btnClose);
    }

    var body = modal.querySelector('#previewBody');
    if (body) {
        body.innerHTML = ''; 
        var previewUrl = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : url;
        var iframe = document.createElement('iframe');
        iframe.src = previewUrl;
        iframe.style.cssText = "width:100%; height:100%; border:none; display:block;";
        iframe.setAttribute('allow', 'autoplay');
        body.appendChild(iframe);
    }
    modal.style.display = 'flex';
};

App.closePreview = function() {
    var modal = document.getElementById('previewModal');
    if (modal) {
        modal.style.display = 'none';
        var body = modal.querySelector('#previewBody');
        if(body) body.innerHTML = ''; 
    }
};

// --- FILE MANAGER HELPERS ---
App.arsipState = { currentFiles: [], viewMode: 'grid', history: [] };

App.loadArsipSK = function(folderId, folderName, isBack = false) {
    if (folderId !== undefined) { 
        if (!isBack && folderName) {
            App.arsipState.history.push({id: folderId, name: folderName});
        }
    }
    
    var currentTarget = folderId; 
    if (folderId === undefined) {
         var last = App.arsipState.history[App.arsipState.history.length-1];
         currentTarget = last.id;
    }

    App.renderArsipSkeleton();
    App.renderBreadcrumb();

    google.script.run.withSuccessHandler(function(data) {
        if (data.error) {
            document.getElementById('fileContainer').innerHTML = '<div class="p-4 text-center text-danger">' + data.error + '</div>';
            return;
        }
        App.arsipState.currentFiles = data.items;
        App.renderArsipFiles();
    }).getSKArsipFiles(currentTarget);
};

App.renderArsipSkeleton = function() {
    var container = document.getElementById('fileContainer');
    var html = '';
    if (App.arsipState.viewMode === 'grid') {
        html = '<div class="file-grid">';
        for(var i=0; i<8; i++) {
            html += '<div class="skel-card"><div class="skeleton-anim" style="width:40px; height:40px; border-radius:50%; margin-bottom:10px;"></div><div class="skeleton-anim" style="width:80px; height:10px; border-radius:4px;"></div></div>';
        }
        html += '</div>';
    } else {
        html = '<table class="file-list-table"><thead><tr><th style="width:50%">Nama</th><th style="width:20%">Ukuran</th><th style="width:30%">Tgl Ubah</th></tr></thead><tbody>';
        for(var i=0; i<5; i++) {
            html += '<tr><td><div style="display:flex; align-items:center;"><div class="skeleton-anim" style="width:25px; height:25px; margin-right:10px; border-radius:4px;"></div> <div class="skeleton-anim" style="width:150px; height:10px;"></div></div></td><td><div class="skeleton-anim" style="width:40px; height:10px;"></div></td><td><div class="skeleton-anim" style="width:80px; height:10px;"></div></td></tr>';
        }
        html += '</tbody></table>';
    }
    container.innerHTML = html;
};

App.renderArsipFiles = function() {
    var files = App.arsipState.currentFiles;
    var container = document.getElementById('fileContainer');
    
    if (!files || files.length === 0) {
        container.innerHTML = '<div class="text-center p-5 text-muted"><i class="fas fa-folder-open" style="font-size:3em; opacity:0.3;"></i><p class="mt-2">Folder ini kosong</p></div>';
        return;
    }

    var html = '';
    if (App.arsipState.viewMode === 'grid') {
        html = '<div class="file-grid">';
        files.forEach(function(f) {
            var icon = f.type === 'folder' ? 'fa-folder text-warning' : (f.mime.includes('pdf') ? 'fa-file-pdf text-danger' : 'fa-file text-secondary');
            var action = f.type === 'folder' ? "App.loadArsipSK('" + f.id + "', '" + f.name + "')" : "App.showFilePreview('" + f.url + "', '" + f.name + "')";
            html += '<div class="file-item-card" onclick="' + action + '" title="' + f.name + '"><i class="fas ' + icon + ' file-card-icon"></i><div class="file-card-name">' + f.name + '</div></div>';
        });
        html += '</div>';
    } else {
        html = '<div style="overflow-x:auto;"><table class="file-list-table"><thead><tr><th>Nama File</th><th style="width:100px;">Ukuran</th><th style="width:120px;">Diubah</th></tr></thead><tbody>';
        files.forEach(function(f) {
            var icon = f.type === 'folder' ? 'fa-folder text-warning' : (f.mime.includes('pdf') ? 'fa-file-pdf text-danger' : 'fa-file text-secondary');
            var action = f.type === 'folder' ? "App.loadArsipSK('" + f.id + "', '" + f.name + "')" : "App.showFilePreview('" + f.url + "', '" + f.name + "')";
            var size = f.type === 'folder' ? '-' : f.size;
            html += '<tr onclick="' + action + '"><td><div style="display:flex; align-items:center;"><i class="fas ' + icon + ' file-list-icon"></i> <span class="file-list-name">' + f.name + '</span></div></td><td style="color:#64748b;">' + size + '</td><td style="color:#64748b;">' + f.updated + '</td></tr>';
        });
        html += '</tbody></table></div>';
    }
    container.innerHTML = html;
};

App.renderBreadcrumb = function() {
    var box = document.getElementById('arsipBreadcrumb');
    if(!box) return;
    var hist = App.arsipState.history;
    var html = '';
    hist.forEach(function(h, index) {
        if (index === hist.length - 1) {
            html += '<span class="fm-breadcrumb-item fm-breadcrumb-active">' + h.name + '</span>';
        } else {
            html += '<span class="fm-breadcrumb-item" onclick="App.navBreadcrumb(' + index + ')">' + h.name + '</span><i class="fas fa-chevron-right fm-breadcrumb-separator" style="font-size:0.7em;"></i>';
        }
    });
    box.innerHTML = html;
};

App.navBreadcrumb = function(targetIndex) {
    var target = App.arsipState.history[targetIndex];
    App.arsipState.history = App.arsipState.history.slice(0, targetIndex + 1);
    App.loadArsipSK(target.id, target.name, true);
};

App.navUpArsip = function() {
    if (App.arsipState.history.length > 1) {
        App.navBreadcrumb(App.arsipState.history.length - 2);
    }
};

App.toggleArsipView = function(mode) {
    App.arsipState.viewMode = mode;
    var btnGrid = document.getElementById('btnViewGrid');
    var btnList = document.getElementById('btnViewList');
    if(btnGrid) {
        btnGrid.className = 'view-btn ' + (mode==='grid'?'active':'');
        btnGrid.style.background = mode==='grid'?'#e2e8f0':'white';
    }
    if(btnList) {
        btnList.className = 'view-btn ' + (mode==='list'?'active':'');
        btnList.style.background = mode==='list'?'#e2e8f0':'white';
    }
    App.renderArsipSkeleton(); 
    setTimeout(App.renderArsipFiles, 100); 
};

App.filterArsipFiles = function() {
    var term = document.getElementById('arsipSearchInput').value.toLowerCase();
    var all = App.arsipState.currentFiles || [];
    var filtered = all.filter(function(f) { return f.name.toLowerCase().includes(term); });
    
    var original = App.arsipState.currentFiles;
    App.arsipState.currentFiles = filtered;
    App.renderArsipFiles();
    App.arsipState.currentFiles = original; 
};

App.showAppModal = function(status, msg, redirectPage) {
    var modal = document.getElementById('appModal');
    if(!modal) return alert(msg);
    var content = modal.querySelector('.modal-content');
    var iconBox = document.getElementById('modalIconBox');
    var title = document.getElementById('modalTitle');
    var message = document.getElementById('modalMessage');
    var btn = document.getElementById('modalBtnMain');

    content.className = 'modal-content'; 
    btn.style.display = 'block';
    
    if (status === 'loading') {
        content.classList.add('loading');
        iconBox.innerHTML = '<div class="modal-spinner"></div>';
        title.textContent = 'Memproses...';
        message.textContent = msg || 'Mohon tunggu sebentar...';
        btn.style.display = 'none';
    } else if (status === 'success') {
        content.classList.add('success');
        iconBox.innerHTML = '<i class="fas fa-check"></i>';
        title.textContent = 'Berhasil!';
        message.innerHTML = msg; 
        btn.textContent = 'Lanjutkan';
    } else if (status === 'error') {
        content.classList.add('error');
        iconBox.innerHTML = '<i class="fas fa-exclamation"></i>';
        title.textContent = 'Terjadi Kesalahan';
        message.innerHTML = msg;
        btn.textContent = 'Tutup';
    } else if (status === 'warning') {
        content.classList.add('warning');
        iconBox.innerHTML = '<i class="fas fa-bell"></i>';
        title.textContent = 'Perhatian';
        message.innerHTML = msg;
        btn.textContent = 'Mengerti';
    }

    modal.style.display = 'flex';
    setTimeout(function() { modal.classList.add('show'); }, 10);

    if(status !== 'loading') {
        setTimeout(function(){ btn.focus(); }, 100);
        var newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.onclick = function() {
            modal.classList.remove('show');
            setTimeout(function() {
                modal.style.display = 'none';
                if (redirectPage && status === 'success') {
                    App.loadPage(null, redirectPage);
                }
            }, 300);
        };
    }
};

App.handleLogin = function(e) {
    e.preventDefault();
    var btn = document.getElementById('btnLogin');
    var err = document.getElementById('loginError');
    var u = document.getElementById('username').value;
    var p = document.getElementById('password').value;
    
    if(btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat...'; }
    if(err) err.style.display = 'none';

    google.script.run.withSuccessHandler(function(res) {
        if(res.status === 'success') {
            localStorage.setItem('user_session', JSON.stringify(res.user));
            App.init(); 
        } else {
            if(err) { err.textContent = res.message; err.style.display = 'block'; }
            else alert(res.message);
            if(btn) { btn.disabled = false; btn.innerHTML = 'MASUK'; }
        }
    }).withFailureHandler(function(e) {
        alert("Error: " + e.message);
        if(btn) { btn.disabled = false; btn.innerHTML = 'MASUK'; }
    }).loginUser(u, p);
};

// ===========================================
// CONTROLLER LAPORAN BULAN (PAUD & SD)
// ===========================================

// Helper: Setup Tab Navigasi
App.setupTabs = function(formId) {
    var form = document.getElementById(formId);
    if (!form) return;

    var links = form.querySelectorAll('.tab-link');
    var contents = form.querySelectorAll('.tab-content-form');
    
    // Fungsi aktifkan tab
    function activate(targetId) {
        // Sembunyikan semua
        links.forEach(l => l.classList.remove('active'));
        contents.forEach(c => { c.classList.remove('active'); c.style.display = 'none'; });

        // Munculkan target
        var btn = form.querySelector(`.tab-link[data-tab="${targetId}"]`);
        var panel = document.getElementById(targetId);
        if(btn && panel) {
            btn.classList.add('active');
            btn.disabled = false;
            panel.classList.add('active');
            panel.style.display = 'block';
        }
    }

    // Klik Tab Atas
    links.forEach(btn => {
        btn.onclick = function() { if(!this.disabled) activate(this.dataset.tab); };
    });

    // Klik Tombol Next/Prev
    form.querySelectorAll('.next-tab-btn, .prev-tab-btn').forEach(btn => {
        btn.onclick = function() {
            var curr = form.querySelector('.tab-content-form.active');
            var arr = Array.from(contents);
            var idx = arr.indexOf(curr);
            var nextIdx = btn.classList.contains('next-tab-btn') ? idx + 1 : idx - 1;
            if(arr[nextIdx]) activate(arr[nextIdx].id);
        };
    });
};

// --- INIT FORM PAUD (UPDATE VALIDASI TAB 2) ---
App.inits['lapbul_form_paud'] = function() {
    console.log("Init Form PAUD: Validasi Tab 2...");

    var form = document.getElementById('lapbulFormPaud');
    if (!form) return;

    // 1. SETUP NAVIGASI TAB
    if(App.setupTabs) App.setupTabs('lapbulFormPaud');
    var tabs = form.querySelectorAll('.tab-link');
    // Kunci tab selain tab 1
    tabs.forEach((t, i) => { if (i > 0) t.disabled = true; });

    // FUNGSI PINDAH TAB MANUAL
    function goToTab(tabId) {
        var targetBtn = form.querySelector(`.tab-link[data-tab="${tabId}"]`);
        if(targetBtn) {
            targetBtn.disabled = false;
            // Simulasi klik agar CSS class 'active' berpindah otomatis lewat App.setupTabs
            targetBtn.click(); 
            
            // Scroll ke atas
            var mainContainer = document.querySelector('.manual-form');
            if(mainContainer) mainContainer.scrollTop = 0;
        }
    }

    // 2. DEFAULT TAHUN & BULAN
    var now = new Date();
    var curYear = now.getFullYear();
    var curMonthIdx = now.getMonth() - 1; 
    if (curMonthIdx < 0) curMonthIdx = 11;

    var selTahun = form.querySelector('select[name="tahun"]');
    var selBulan = form.querySelector('select[name="laporanBulan"]');
    
    if(selTahun) selTahun.innerHTML = `<option value="${curYear}" selected>${curYear}</option><option value="${curYear-1}">${curYear-1}</option>`;
    if(selBulan) {
        var bln = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        selBulan.innerHTML = '<option value="">-- Pilih Bulan --</option>' + 
            bln.map((b, i) => `<option value="${b}" ${i === curMonthIdx ? 'selected' : ''}>${b}</option>`).join('');
    }

    // 3. LOAD DATA SEKOLAH
    google.script.run.withSuccessHandler(function(lists) {
        var selJenjang = document.getElementById('jenjang');
        var selNama = document.getElementById('namaSekolah');
        if (selJenjang) {
            selJenjang.innerHTML = '<option value="">-- Pilih --</option><option value="KB">KB</option><option value="TK">TK</option>';
            selJenjang.addEventListener('change', function() {
                if(selNama) {
                    selNama.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
                    selNama.disabled = false;
                    var schools = lists[this.value] || [];
                    schools.forEach(s => selNama.add(new Option(s, s)));
                }
            });
        }
    }).getPaudSchoolLists();


    // ===============================================
    // LOGIKA VALIDASI
    // ===============================================

    // Validasi Tab 1
    function validateTab1() {
        var inputs = form.querySelectorAll('#dataSekolah [required]');
        for(var i=0; i<inputs.length; i++) {
            if(!inputs[i].value || inputs[i].value.trim() === '') {
                App.showAppModal('error', 'Harap lengkapi semua data Lembaga.');
                inputs[i].focus();
                return false;
            }
        }
        return true;
    }

    // --- VALIDASI TAB 2 (MURID) ---
    function checkMuridMatch() {
        var inputsUsiaL = form.querySelectorAll('input[name^="murid_"][name$="_L"]');
        var inputsUsiaP = form.querySelectorAll('input[name^="murid_"][name$="_P"]');
        var inputsRombelL = form.querySelectorAll('input[name^="kelompok_"][name$="_L"]');
        var inputsRombelP = form.querySelectorAll('input[name^="kelompok_"][name$="_P"]');

        var sumUsiaL = 0, sumUsiaP = 0;
        var sumRombelL = 0, sumRombelP = 0;

        inputsUsiaL.forEach(el => sumUsiaL += parseInt(el.value || 0));
        inputsUsiaP.forEach(el => sumUsiaP += parseInt(el.value || 0));
        inputsRombelL.forEach(el => sumRombelL += parseInt(el.value || 0));
        inputsRombelP.forEach(el => sumRombelP += parseInt(el.value || 0));

        var totalUsia = sumUsiaL + sumUsiaP;
        var totalRombel = sumRombelL + sumRombelP;

        // --- UPDATE TEKS VALIDASI (SESUAI REQUEST) ---
        var txtUsia = document.getElementById('val-text-usia');
        var txtRombel = document.getElementById('val-text-rombel');
        var txtStatus = document.getElementById('val-status-msg');
        var box = document.getElementById('murid-validation-feedback');

        if(txtUsia) txtUsia.textContent = `Total Murid (Menurut Usia): L = ${sumUsiaL}, P = ${sumUsiaP}, Jumlah = ${totalUsia}`;
        if(txtRombel) txtRombel.textContent = `Total Murid (Menurut Rombel): L = ${sumRombelL}, P = ${sumRombelP}, Jumlah = ${totalRombel}`;

        // --- LOGIKA STATUS ---
        // 1. Jika Masih 0
        if (totalUsia === 0 && totalRombel === 0) {
            txtStatus.textContent = "Data murid belum diisi.";
            box.className = "murid-val-box neutral"; 
            return false;
        } 
        // 2. Jika Tidak Sama (L vs L atau P vs P)
        else if (sumUsiaL !== sumRombelL || sumUsiaP !== sumRombelP) {
            txtStatus.textContent = "JUMLAH TIDAK SAMA!";
            box.className = "murid-val-box error";
            return false;
        } 
        // 3. Jika Valid
        else {
            txtStatus.textContent = "JUMLAH SAMA (VALID)";
            box.className = "murid-val-box success";
            return true;
        }
    }

    // Listener Input Murid
    form.querySelectorAll('#dataMurid input[type="number"]').forEach(inp => {
        inp.addEventListener('input', checkMuridMatch);
    });


    // Validasi Tab 3 (PTK)
    function validateTab3() {
        var kepsekASN = parseInt(form.querySelector('input[name="kepsek_ASN"]').value) || 0;
        var kepsekNon = parseInt(form.querySelector('input[name="kepsek_Non_ASN"]').value) || 0;
        
        if ((kepsekASN + kepsekNon) > 1) {
            App.showAppModal('error', 'Maksimal 1 Kepala Sekolah (ASN + Non ASN).');
            return false;
        }
        
        var totalPTK = 0;
        form.querySelectorAll('#dataPtk input[type="number"]').forEach(el => {
            totalPTK += parseInt(el.value || 0);
        });
        
        if (totalPTK < 1) {
            App.showAppModal('error', 'Minimal harus ada 1 PTK (Guru/Kepsek).');
            return false;
        }
        return true;
    }


    // ===============================================
    // TOMBOL BERIKUTNYA (AUTO SWITCH)
    // ===============================================
    var nextBtns = form.querySelectorAll('.next-tab-btn');
    nextBtns.forEach(btn => {
        var newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);

        newBtn.addEventListener('click', function() {
            var activePanel = form.querySelector('.tab-content-form.active');
            if(!activePanel) return;

            // DARI TAB 1 KE 2
            if (activePanel.id === 'dataSekolah') {
                if(validateTab1()) goToTab('dataMurid');
            } 
            // DARI TAB 2 KE 3 (CEK DATA MURID)
            else if (activePanel.id === 'dataMurid') {
                if(checkMuridMatch()) {
                    goToTab('dataPtk'); // Pindah Otomatis ke Tab 3
                } else {
                    App.showAppModal('error', 'Data Murid Belum Valid (Jumlah Tidak Sama).');
                }
            }
            // DARI TAB 3 KE 4
            else if (activePanel.id === 'dataPtk') {
                if(validateTab3()) goToTab('dataUnggah');
            }
        });
    });

    // TOMBOL SEBELUMNYA
    var prevBtns = form.querySelectorAll('.prev-tab-btn');
    prevBtns.forEach(btn => {
        var newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = function() {
            var curr = form.querySelector('.tab-content-form.active');
            if(curr.id === 'dataUnggah') goToTab('dataPtk');
            else if(curr.id === 'dataPtk') goToTab('dataMurid');
            else if(curr.id === 'dataMurid') goToTab('dataSekolah');
        };
    });

    // FINAL SUBMIT
    form.onsubmit = function(e) {
        e.preventDefault();
        var fileInput = document.getElementById('fileLapbul');
        if(!fileInput.files.length) return App.showAppModal('error', 'Pilih file PDF!');
        var file = fileInput.files[0];
        if(file.type !== 'application/pdf') return App.showAppModal('error', 'Wajib format PDF.');
        if(file.size > 307200) return App.showAppModal('error', 'File max 300KB.');

        if(App.handleFormSubmit) App.handleFormSubmit(this, 'processLapbulFormPaud');
    };
};

// --- INIT FORM SD (BERSIH & TERINTEGRASI GLOBAL) ---
App.inits['lapbul_form_sd'] = function() {
    console.log("Init Form SD: Global Helpers...");
    var form = document.getElementById('lapbulFormSd');
    if (!form) return;

    // 1. Setup Tab & Lock
    if(App.setupTabs) App.setupTabs('lapbulFormSd');
    var tabs = form.querySelectorAll('.tab-link');
    tabs.forEach((t, i) => { if (i > 0) t.disabled = true; });

    // (Fungsi App.showAlert, App.showConfirm, App.handleFormSubmit SUDAH GLOBAL, dihapus dari sini)

    // --- 2. GENERATOR KELAS ---
    var agamas = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
    var tabContainer = document.getElementById('subTabContainer');
    var contentContainer = document.getElementById('kelasContentArea');
    
    tabContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    for (var k = 1; k <= 6; k++) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = (k === 1) ? 'sub-tab-btn active' : 'sub-tab-btn';
        btn.textContent = 'Kelas ' + k;
        btn.onclick = (function(idx) { return function() { App.navKelas(idx); }; })(k);
        tabContainer.appendChild(btn);

        var div = document.createElement('div');
        div.id = 'kelas_content_' + k;
        div.className = 'kelas-content';
        div.style.display = (k === 1) ? 'block' : 'none';

        var html = `
            <div class="section-divider"><span>Data Kelas ${k} - Menurut Rombel</span></div>
            <div class="rombel-control-box">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Jumlah Rombel</label>
                    <select name="Rombel ${k}" id="select_rombel_${k}" class="form-control" style="width:100px; font-weight:bold;" onchange="App.updateRombelLayout(${k}, this.value)">
                        <option value="1" selected>1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="0">0</option>
                    </select>
                </div>
                <div id="rombel_inputs_container_${k}" class="rombel-inputs-grid"></div>
            </div>

            <div class="section-divider"><span>Data Kelas ${k} - Menurut Agama</span></div>
            <div class="input-grid-container">`;
        
        agamas.forEach(agama => {
            var isIslam = (agama === 'Islam');
            var displayStyle = isIslam ? 'block' : 'none';
            html += `
            <div class="input-box-card">
                <span class="box-title">${agama}</span>
                <select class="status-select" onchange="App.toggleAgamaInput(this)">
                    <option value="Ada" ${isIslam ? 'selected' : ''}>Ada</option>
                    <option value="Tidak" ${!isIslam ? 'selected' : ''}>Tidak Ada</option>
                </select>
                <div class="input-wrapper" style="display:${displayStyle};">
                    <div class="lp-wrapper">
                        <div class="lp-field"><label class="lp-label">L</label><input type="number" name="K${k} ${agama} L" class="form-control-mini input-agama" min="0"></div>
                        <div class="lp-field"><label class="lp-label">P</label><input type="number" name="K${k} ${agama} P" class="form-control-mini input-agama" min="0"></div>
                    </div>
                </div>
            </div>`;
        });

        html += `</div>
            <div class="validation-footer">
                <div id="val_text_rombel_${k}">Jumlah Menurut Rombel: L = 0, P = 0, Jumlah = 0</div>
                <div id="val_text_agama_${k}">Jumlah Menurut Agama: L = 0, P = 0, Jumlah = 0</div>
                <span id="val_status_${k}" class="val-status-text text-green">JUMLAH SESUAI</span>
                
                <div style="margin-top:20px; display:flex; justify-content:space-between;">
                    ${k > 1 ? `<button type="button" class="btn-secondary" onclick="App.navKelas(${k-1})"> < Kelas ${k-1}</button>` : '<div></div>'}
                    ${k < 6 ? `<button type="button" class="btn-primary" onclick="App.navKelas(${k+1})">Kelas ${k+1} ></button>` : '<div></div>'}
                </div>
            </div>`;
        div.innerHTML = html;
        contentContainer.appendChild(div);
        
        // Init Default Rombel 1
        (function(idx) {
            setTimeout(() => { 
                if(document.getElementById(`select_rombel_${idx}`)) App.updateRombelLayout(idx, "1"); 
            }, 0);
        })(k);
    }

    // --- LOGIKA HELPER ---
    App.navKelas = function(k) {
        document.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.kelas-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.sub-tab-btn')[k-1].classList.add('active');
        document.getElementById('kelas_content_' + k).style.display = 'block';
        
        var mainFooter = document.getElementById('tab2Footer');
        if (k === 6) mainFooter.style.display = 'flex'; else mainFooter.style.display = 'none';
        
        var main = document.querySelector('.form-card');
        if(main) main.scrollTop = 0;
    };

    App.updateRombelLayout = function(k, val) {
        if (val === undefined || val === null) {
            var selectEl = document.getElementById(`select_rombel_${k}`);
            val = selectEl ? selectEl.value : "1";
        }
        var container = document.getElementById(`rombel_inputs_container_${k}`);
        if(!container) return;

        var html = '';
        if (val == '1') {
            html = createRombelBox(k, "", `K${k} L`, `K${k} P`, `Kelas ${k}`);
        } else if (val == '2') {
            html = createRombelBox(k, "A", `K${k}A L`, `K${k}A P`) + createRombelBox(k, "B", `K${k}B L`, `K${k}B P`);
        } else if (val == '3') {
            html = createRombelBox(k, "A", `K${k}A L`, `K${k}A P`) + createRombelBox(k, "B", `K${k}B L`, `K${k}B P`) + createRombelBox(k, "C", `K${k}C L`, `K${k}C P`);
        } else if (val == '0') {
            html = '<div style="color:#64748b; font-style:italic; grid-column:1/-1; text-align:center; padding:20px;">Tidak ada rombel (Kelas Kosong)</div>';
        }
        container.innerHTML = html;
        App.calculateSdValidation(k);
    };

    function createRombelBox(k, suffix, nameL, nameP, customLabel) {
        var label = customLabel || `Kelas ${k}${suffix}`;
        return `<div class="input-box-card"><span class="box-title">${label}</span><div class="lp-wrapper"><div class="lp-field"><label class="lp-label">L</label><input type="number" name="${nameL}" class="form-control-box input-rombel" min="0"></div><div class="lp-field"><label class="lp-label">P</label><input type="number" name="${nameP}" class="form-control-box input-rombel" min="0"></div></div></div>`;
    }

    App.toggleAgamaInput = function(selectEl) {
        var wrapper = selectEl.parentElement.querySelector('.input-wrapper');
        var inputs = wrapper.querySelectorAll('input');
        if (selectEl.value === 'Ada') {
            wrapper.style.display = 'block';
        } else {
            wrapper.style.display = 'none';
            inputs.forEach(i => i.value = ''); 
            var parent = selectEl.closest('.kelas-content');
            if(parent) App.calculateSdValidation(parent.id.split('_')[2]);
        }
    };

    App.calculateSdValidation = function(k) {
        var container = document.getElementById('kelas_content_' + k);
        var sumRombelL = 0, sumRombelP = 0;
        container.querySelectorAll('.input-rombel').forEach(el => {
            if(el.name.endsWith('L')) sumRombelL += Number(el.value || 0); else sumRombelP += Number(el.value || 0);
        });
        var sumAgamaL = 0, sumAgamaP = 0;
        container.querySelectorAll('.input-agama').forEach(el => {
            var wrapper = el.closest('.input-wrapper');
            if(wrapper && wrapper.style.display !== 'none') {
                if(el.name.endsWith('L')) sumAgamaL += Number(el.value || 0); else sumAgamaP += Number(el.value || 0);
            }
        });

        document.getElementById(`val_text_rombel_${k}`).textContent = `Jumlah Menurut Rombel: L = ${sumRombelL}, P = ${sumRombelP}, Jumlah = ${sumRombelL+sumRombelP}`;
        document.getElementById(`val_text_agama_${k}`).textContent = `Jumlah Menurut Agama: L = ${sumAgamaL}, P = ${sumAgamaP}, Jumlah = ${sumAgamaL+sumAgamaP}`;

        var statusEl = document.getElementById(`val_status_${k}`);
        if(sumRombelL === sumAgamaL && sumRombelP === sumAgamaP) {
            statusEl.textContent = "JUMLAH SESUAI"; statusEl.className = "val-status-text text-green";
            return true;
        } else {
            statusEl.textContent = "JUMLAH BELUM SESUAI"; statusEl.className = "val-status-text text-red";
            return false;
        }
    };

    form.addEventListener('input', function(e) {
        if(e.target.type === 'number' && form.contains(e.target)) {
            var parentContent = e.target.closest('.kelas-content');
            if(parentContent) App.calculateSdValidation(parentContent.id.split('_')[2]);
        }
    });

    // --- 3. LOGIKA DEFAULT ---
    var now = new Date();
    var curYear = now.getFullYear();
    var curMonthIdx = now.getMonth() - 1; if (curMonthIdx < 0) curMonthIdx = 11;

    var selTahun = form.querySelector('select[name="Tahun"]');
    var selBulan = form.querySelector('select[name="Bulan"]');
    if(selTahun) selTahun.innerHTML = `<option value="${curYear}" selected>${curYear}</option><option value="${curYear-1}">${curYear-1}</option>`;
    if(selBulan) selBulan.innerHTML = '<option value="">-- Pilih Bulan --</option>' + ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"].map((b, i) => `<option value="${b}" ${i === curMonthIdx ? 'selected' : ''}>${b}</option>`).join('');

    google.script.run.withSuccessHandler(function(lists) {
        var selStatus = document.getElementById('statusSekolah');
        var selNama = document.getElementById('namaSekolah');
        selStatus.addEventListener('change', function() {
            selNama.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
            selNama.disabled = false;
            var key = (this.value === 'Negeri') ? 'SDN' : 'SDS';
            (lists[key] || []).forEach(s => selNama.add(new Option(s, s)));
        });
    }).getSdSchoolLists();

    // --- 4. VALIDASI TAB ---
    function validateTab1() {
        var inputs = form.querySelectorAll('#dataSekolah [required]');
        for(var i=0; i<inputs.length; i++) {
            if(!inputs[i].value || inputs[i].value.trim() === '') { App.showAlert('error', 'Data Belum Lengkap', 'Mohon lengkapi semua data sekolah.'); inputs[i].focus(); return false; }
        }
        return true;
    }

    function validateTab2() {
        var emptyClasses = [];
        var invalidClasses = [];
        for(var k=1; k<=6; k++) {
            var container = document.getElementById('kelas_content_' + k);
            var sum = 0;
            container.querySelectorAll('.input-rombel').forEach(el => sum += Number(el.value||0));
            var rombelVal = document.getElementById(`select_rombel_${k}`).value;
            if (rombelVal != '0' && sum === 0) emptyClasses.push(k);
            if(sum > 0 && !App.calculateSdValidation(k)) invalidClasses.push(k);
        }

        if(invalidClasses.length > 0) { App.showAlert('error', 'Data Tidak Sesuai', 'Data Kelas ' + invalidClasses.join(', ') + ' tidak sesuai.'); return false; }
        if(emptyClasses.length > 0) {
            App.showConfirm('Data Siswa Kosong', `Data siswa di <b>Kelas ${emptyClasses.join(', ')}</b> masih kosong.<br>Lanjutkan?`, function(res) {
                if(res) goToTab('dataPtk');
            });
            return false;
        }
        return true;
    }

    function validateTab3() {
        var ks = Number(form.querySelector('input[name="KS PNS"]').value||0) + Number(form.querySelector('input[name="KS PPPK"]').value||0) + Number(form.querySelector('input[name="KS NON ASN"]').value||0);
        if(ks > 1) { App.showAlert('error', 'Data Tidak Valid', 'Maksimal 1 Kepala Sekolah.'); return false; }

        var totalGuru = 0;
        form.querySelectorAll('.matrix-input-table input').forEach(inp => totalGuru += Number(inp.value||0));
        if(totalGuru === 0) {
            App.showConfirm('Data Guru Kosong', 'Data Guru & Tendik kosong.<br>Lanjutkan?', function(res) {
                if(res) goToTab('dataUnggah');
            });
            return false;
        }
        return true;
    }

    function goToTab(tabId) {
        var btn = form.querySelector(`.tab-link[data-tab="${tabId}"]`);
        if(btn) { btn.disabled = false; btn.click(); document.querySelector('.form-card').scrollTop = 0; }
    }

    form.querySelectorAll('.next-tab-btn').forEach(btn => {
        var newBtn = btn.cloneNode(true); btn.parentNode.replaceChild(newBtn, btn);
        newBtn.onclick = function() {
            var curr = form.querySelector('.tab-content-form.active');
            if(curr.id === 'dataSekolah' && validateTab1()) goToTab('dataMurid');
            else if(curr.id === 'dataMurid' && validateTab2()) goToTab('dataPtk');
            else if(curr.id === 'dataPtk' && validateTab3()) goToTab('dataUnggah');
        };
    });

    form.querySelectorAll('.prev-tab-btn').forEach(btn => {
        btn.onclick = function() {
            var curr = form.querySelector('.tab-content-form.active');
            if(curr.id === 'dataUnggah') goToTab('dataPtk');
            else if(curr.id === 'dataPtk') goToTab('dataMurid');
            else if(curr.id === 'dataMurid') goToTab('dataSekolah');
        };
    });

    form.onsubmit = function(e) {
        e.preventDefault();
        // Validasi keberadaan file saja, ukurannya dicek di App.handleFormSubmit
        var fileIn = document.getElementById('fileLapbulSd');
        if(!fileIn.files.length) return App.showAlert('error', 'File Kosong', 'Pilih file PDF!');
        
        // Panggil Global Handler yang Baru
        if(App.handleFormSubmit) App.handleFormSubmit(this, 'processLapbulFormSd');
    };
};

App.inits['lapbul_riwayat'] = function() {
    App.initSmartTable({
        tableId: 'riwayatTable', 
        serverFunc: 'getLapbulRiwayatData',
        
        headers: [
            "Nama Sekolah", 
            { name: "Jenjang", width: "80px", tdStyle: "text-align:center;" },
            { name: "Status", width: "100px", tdStyle: "text-align:center;" },
            { name: "Bulan", width: "100px" },
            { name: "Tahun", width: "80px", tdStyle: "text-align:center;" },
            { name: "Rombel", width: "80px", tdStyle: "text-align:center;" },
            
            // KOLOM DOKUMEN (TOMBOL LIHAT)
            { 
                name: "Dokumen", 
                width: "100px",
                tdStyle: "text-align:center;",
                formatter: function(row) {
                    var url = row.Dokumen;
                    if (url && url.includes('http')) {
                        var safeUrl = encodeURIComponent(url);
                        var safeTitle = encodeURIComponent('Laporan ' + (row['Bulan'] || '') + ' ' + (row['Tahun'] || ''));
                        return `<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent('${safeUrl}'), decodeURIComponent('${safeTitle}'))"><i class="fas fa-eye"></i> Lihat</button>`;
                    }
                    return '<span style="color:#cbd5e1;">-</span>';
                }
            },
            
            { name: "Tanggal Unggah", width: "150px", tdStyle: "text-align:center; color:#64748b; font-size:0.9em;" },
            
            // KOLOM USER (RATA KIRI)
            { name: "User", tdStyle: "text-align:left; color:#334155; font-weight:500;" }
        ],
        
        filters: [
            { id: 'filterTahun', col: 'Tahun', label: '-- Pilih Tahun --', desc: true },
            
            // 1. FILTER BULAN (URUTAN KRONOLOGIS)
            { 
                id: 'filterBulan', 
                col: 'Bulan', 
                label: '-- Pilih Bulan --',
                sortOptions: function(a, b) {
                    var months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                    return months.indexOf(a) - months.indexOf(b);
                }
            },
            
            // 2. FILTER JENJANG (DATA OTOMATIS DARI TABEL)
            { id: 'filterJenjang', col: 'Jenjang', label: '-- Pilih Jenjang --' },
            
            // 3. FILTER SEKOLAH (DEPENDENT)
            { id: 'filterSekolah', col: 'Nama Sekolah', label: '-- Pilih Sekolah --' }
        ],
        
        // CALLBACK UNTUK FILTER BERANTAI (JENJANG -> SEKOLAH)
        onFilterChange: function(filterId, value, filteredRows, allRows) {
            if (filterId === 'filterJenjang') {
                var elSekolah = document.getElementById('filterSekolah');
                if(!elSekolah) return;
                
                // Simpan nilai seleksi saat ini jika masih valid nanti
                var currentVal = elSekolah.value;

                // Reset Dropdown Sekolah
                elSekolah.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
                
                // Ambil data sekolah berdasarkan jenjang yang dipilih
                // Jika value kosong (Pilih Jenjang), ambil semua data
                var sourceData = value ? allRows.filter(function(r) { return r.Jenjang === value; }) : allRows;
                
                // Ekstrak Nama Sekolah Unik
                var schools = [];
                sourceData.forEach(function(r) { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                var uniqueSchools = [...new Set(schools)].sort();
                
                // Isi Dropdown
                uniqueSchools.forEach(function(s) { 
                    elSekolah.add(new Option(s, s)); 
                });
                
                // Coba restore nilai lama jika ada di daftar baru, jika tidak reset
                if (currentVal && uniqueSchools.includes(currentVal)) {
                    elSekolah.value = currentVal;
                } else {
                    elSekolah.value = ""; 
                }
            }
        },
        
        // POPULATE AWAL SAAT DATA DIMUAT
        onLoad: function(allRows) {
             // Pastikan dropdown sekolah terisi lengkap saat pertama buka (sebelum difilter jenjang)
             var elSekolah = document.getElementById('filterSekolah');
             // Hanya isi jika masih kosong (opsi <= 1 karena ada placeholder)
             if(elSekolah && elSekolah.options.length <= 1) {
                 var schools = [];
                 allRows.forEach(function(r) { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                 var uniqueSchools = [...new Set(schools)].sort();
                 uniqueSchools.forEach(function(s) { elSekolah.add(new Option(s, s)); });
             }
        }
    });
    
    // Search Listener Manual (untuk memastikan ID benar)
    var searchBox = document.getElementById('searchFilter');
    if(searchBox) {
        searchBox.onkeyup = function() {
            var term = this.value.toLowerCase();
            var rows = document.querySelectorAll('#riwayatTable tbody tr');
            rows.forEach(function(r) { r.style.display = r.innerText.toLowerCase().includes(term) ? '' : 'none'; });
        };
    }
};

// UPDATE App.initSmartTable AGAR SUPPORT sortOptions DAN onFilterChange
App.initSmartTable = function(config) {
    var table = document.getElementById(config.tableId);
    if (!table) return;
    
    var thead = table.querySelector('thead');
    var tbody = table.querySelector('tbody');
    
    var colCount = (config.headers ? config.headers.length : 0) + 1; 

    // 1. RENDER HEADER
    if (config.headers && thead && !config.skipRenderHeader) {
        var headerHtml = '<tr><th style="width:40px; text-align:center;">No.</th>';
        config.headers.forEach(function(h) {
            var label = (typeof h === 'object') ? h.name : h;
            var width = (typeof h === 'object' && h.width) ? 'width:'+h.width : '';
            headerHtml += `<th style="${width}">${label}</th>`;
        });
        headerHtml += '</tr>';
        thead.innerHTML = headerHtml;
    }

    // 2. SKELETON
    if (tbody) {
        var skel = '';
        for(var i=0; i<3; i++) {
            skel += '<tr class="row-animate">'; 
            for(var j=0; j<colCount; j++) skel += '<td><div class="skeleton-anim" style="height:12px; background-color:#e2e8f0; width:100%;"></div></td>';
            skel += '</tr>';
        }
        tbody.innerHTML = skel;
    }

    // 3. PANGGIL SERVER
    google.script.run.withSuccessHandler(function(response) {
        var allRows = (response && response.rows) ? response.rows : (Array.isArray(response) ? response : []);

        var renderTableBody = function(rows) {
            tbody.innerHTML = ''; 
            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colCount}" style="text-align:center; padding:15px; color:#64748b;">Data tidak ditemukan.</td></tr>`;
                return;
            }

            rows.forEach(function(row, i) {
                var tr = document.createElement('tr');
                tr.className = 'row-animate'; 
                
                var tdNo = document.createElement('td');
                tdNo.textContent = i + 1;
                tdNo.style = "text-align:center; font-weight:bold; color:#64748b;";
                tr.appendChild(tdNo);

                config.headers.forEach(function(h) {
                    var td = document.createElement('td');
                    var key = (typeof h === 'object') ? h.name : h;
                    
                    if (typeof h === 'object' && h.formatter) {
                        td.innerHTML = h.formatter(row, key, i);
                    } else {
                        td.textContent = row[key] || ""; 
                    }
                    
                    if (typeof h === 'object' && h.tdStyle) td.style = h.tdStyle;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            var infoEl = document.getElementById(config.tableId + '_info');
            if(infoEl) infoEl.textContent = 'Total: ' + rows.length + ' Data';
        };

        renderTableBody(allRows);
        // Panggil onLoad jika ada (untuk set filter awal atau manipulasi lain)
        if (config.onLoad) config.onLoad(allRows);
        if (config.onRender) config.onRender(allRows); // Backward compatibility

        // 4. FILTER KUMULATIF & POPULATE DROPDOWN
        if (config.filters && config.filters.length > 0) {
            // Populate Dropdown (Kecuali yang di-handle manual seperti Sekolah)
            config.filters.forEach(function(f) {
                var el = document.getElementById(f.id);
                // Hanya isi jika elemen adalah SELECT dan isinya masih kosong/default
                // KECUALI filterSekolah yang dihandle manual di onLoad/onFilterChange
                if (el && el.tagName === 'SELECT' && el.options.length <= 1 && f.id !== 'filterSekolah') {
                    var uniqueValues = [];
                    allRows.forEach(function(r) {
                        var val = r[f.col];
                        if (val && !uniqueValues.includes(val)) uniqueValues.push(val);
                    });
                    
                    // Sorting Logic
                    if (f.sortOptions) {
                        uniqueValues.sort(f.sortOptions);
                    } else if(f.desc) {
                        uniqueValues.sort().reverse(); 
                    } else {
                        uniqueValues.sort();
                    }
                    
                    uniqueValues.forEach(function(v) {
                        var opt = document.createElement('option');
                        opt.value = v; opt.text = v; el.add(opt);
                    });
                }
            });

            var applyAllFilters = function(triggeredById) {
                var filtered = allRows;
                var activeFilters = {};

                config.filters.forEach(function(f) {
                    var el = document.getElementById(f.id);
                    if (el) {
                        var term = el.value.toLowerCase();
                        if (term && term !== "") {
                            activeFilters[f.id] = el.value; // Simpan value asli
                            filtered = filtered.filter(function(r) {
                                var cellVal = String(r[f.col] || "").toLowerCase();
                                return cellVal.includes(term);
                            });
                        }
                    }
                });
                
                // Search Box Global
                var searchBox = document.getElementById('searchFilter');
                if (searchBox && searchBox.value) {
                    var s = searchBox.value.toLowerCase();
                    filtered = filtered.filter(r => Object.values(r).some(val => String(val).toLowerCase().includes(s)));
                }

                renderTableBody(filtered);
                
                // Callback untuk Dropdown Berantai
                if (config.onFilterChange && triggeredById) {
                     // Cari value filter yang mentrigger
                     var elTrigger = document.getElementById(triggeredById);
                     var valTrigger = elTrigger ? elTrigger.value : "";
                     config.onFilterChange(triggeredById, valTrigger, filtered, allRows);
                }
            };

            config.filters.forEach(function(f) {
                var el = document.getElementById(f.id);
                if (el) { 
                    el.onchange = function() { applyAllFilters(f.id); }; 
                    el.onkeyup = function() { applyAllFilters(f.id); }; 
                }
            });
            
             // Listener untuk Search Global
            var searchBox = document.getElementById('searchFilter');
            if (searchBox) {
                searchBox.onkeyup = function() { applyAllFilters('searchFilter'); };
            }
        }
    }).withFailureHandler(function(err) {
        if(tbody) tbody.innerHTML = `<tr><td colspan="${colCount}" style="color:red; text-align:center;">Error: ${err.message}</td></tr>`;
    })[config.serverFunc](config.params || undefined);
};

App.inits['lapbul_status'] = function() {
    // 1. Setup Filter Data (Tahun & Jenjang)
    var curYear = new Date().getFullYear();
    var selTahun = document.getElementById('filterTahun');
    var selJenjang = document.getElementById('filterJenjang');
    var selSekolah = document.getElementById('filterNamaSekolah');

    // Populate Tahun jika kosong
    if(selTahun && selTahun.options.length === 0) {
        selTahun.innerHTML = '';
        for(var y = curYear; y >= 2023; y--) selTahun.add(new Option(y, y));
    }
    
    // Variabel untuk menyimpan semua data baris (untuk filtering lokal)
    var allTableRows = [];

    // 2. Fungsi Load Table (Ambil Data dari Server)
    var loadTable = function() {
        var params = {
            tahun: selTahun ? selTahun.value : new Date().getFullYear(),
            jenjang: "" // Kita ambil semua data dulu
        };

        App.initSmartTable({
            tableId: 'lapbulStatusTable', 
            serverFunc: 'getLapbulStatusData',
            params: params, 
            
            // KONFIGURASI KOLOM
            headers: [
                "Nama Sekolah", 
                { name: "Jenjang", width: "80px", tdStyle: "text-align:center;" },
                { name: "Januari", width: "70px", tdStyle: "text-align:center;" }, 
                { name: "Februari", width: "70px", tdStyle: "text-align:center;" }, 
                { name: "Maret", width: "70px", tdStyle: "text-align:center;" },
                { name: "April", width: "70px", tdStyle: "text-align:center;" },   
                { name: "Mei", width: "70px", tdStyle: "text-align:center;" },      
                { name: "Juni", width: "70px", tdStyle: "text-align:center;" },
                { name: "Juli", width: "70px", tdStyle: "text-align:center;" },    
                { name: "Agustus", width: "70px", tdStyle: "text-align:center;" },  
                { name: "September", width: "70px", tdStyle: "text-align:center;" },
                { name: "Oktober", width: "70px", tdStyle: "text-align:center;" }, 
                { name: "November", width: "70px", tdStyle: "text-align:center;" },  
                { name: "Desember", width: "70px", tdStyle: "text-align:center;" }
            ],

            filters: [], // Disable default filter logic SmartTable
            
            // CALLBACK SAAT DATA SELESAI DIMUAT
            onLoad: function(rows) {
                 allTableRows = rows; // Simpan data mentah
                 
                 // Populate Filter Jenjang (Ambil unik dari data)
                 if(selJenjang) {
                     var oldVal = selJenjang.value;
                     selJenjang.innerHTML = '<option value="">-- Jenjang --</option>';
                     var uniqueJenjang = [...new Set(rows.map(r => r.Jenjang))].filter(Boolean).sort();
                     uniqueJenjang.forEach(j => selJenjang.add(new Option(j, j)));
                     if(uniqueJenjang.includes(oldVal)) selJenjang.value = oldVal;
                 }

                 // Apply Filter Awal
                 applyFilters();
                 
                 // Styling Sel Tabel (Centang Hijau)
                 var table = document.getElementById('lapbulStatusTable');
                 var cells = table.querySelectorAll('td');
                 cells.forEach(function(td) {
                     if (td.textContent === '' || td.textContent === 'v') {
                         td.innerHTML = '<i class="fas fa-check-circle" style="color:#16a34a; font-size:1.2em;"></i>';
                     } else if (td.textContent === '' || td.textContent === '-') {
                         td.style.backgroundColor = '#f8fafc'; 
                         td.innerHTML = '<span style="color:#e2e8f0;">-</span>';
                     }
                 });
            }
        });
    };
    
    // 3. Logika Filter Client-Side (Jenjang -> Sekolah -> Tampilan Tabel)
    var applyFilters = function() {
        var jenjangVal = selJenjang ? selJenjang.value : "";
        var sekolahVal = selSekolah ? selSekolah.value : "";
        
        var table = document.getElementById('lapbulStatusTable');
        var tbody = table.querySelector('tbody');
        var trs = tbody.querySelectorAll('tr');
        
        var visibleSchools = []; // Untuk update dropdown sekolah
        var visibleCount = 0; // Untuk reset nomor urut

        // Loop setiap baris tabel HTML
        trs.forEach(function(tr, index) {
            // Asumsi: Kolom 0 = No (dari SmartTable default), Kolom 1 = Nama Sekolah, Kolom 2 = Jenjang
            // SmartTable merender kolom No di index 0. Jadi data sekolah ada di index 1.
            
            // Ambil data asli dari allTableRows menggunakan index baris (karena urutan tabel dan allTableRows sama saat awal)
            var rowData = allTableRows[index]; 
            
            if(!rowData) return;

            var txtNama = rowData['Nama Sekolah'] || "";
            var txtJenjang = rowData['Jenjang'] || "";
            
            // Cek Filter Jenjang
            var matchJenjang = (jenjangVal === "" || txtJenjang === jenjangVal);
            
            // Cek Filter Sekolah
            var matchSekolah = (sekolahVal === "" || txtNama === sekolahVal);
            
            if (matchJenjang && matchSekolah) {
                tr.style.display = "";
                visibleCount++;
                // Reset Nomor Urut (Kolom ke-0)
                if(tr.cells[0]) tr.cells[0].textContent = visibleCount;
                
                // Kumpulkan sekolah yang valid untuk jenjang ini
                if(matchJenjang) visibleSchools.push(txtNama); 
            } else {
                tr.style.display = "none";
            }
        });
        
        // B. Update Dropdown Sekolah
        updateSekolahDropdown(visibleSchools);
    };
    
    // Helper Update Dropdown Sekolah
    var updateSekolahDropdown = function(schoolList) {
        if(!selSekolah) return;
        
        var currentVal = selSekolah.value;
        
        // Reset Dropdown
        selSekolah.innerHTML = '<option value="">-- Cari Sekolah --</option>';
        
        // Filter unik & sort
        var uniqueSchools = [...new Set(schoolList)].sort();
        
        uniqueSchools.forEach(function(s) {
            selSekolah.add(new Option(s, s));
        });

        // Restore value jika masih ada di daftar baru
        if (uniqueSchools.includes(currentVal)) {
            selSekolah.value = currentVal;
        } else {
            selSekolah.value = "";
        }
    };

    // 4. Event Listeners
    if (selJenjang) {
        selJenjang.onchange = function() {
            if(selSekolah) selSekolah.value = ""; 
            applyFilters(); 
        };
    }
    
    if (selSekolah) {
        selSekolah.onchange = function() {
            applyFilters();
        };
    }

    // Load Awal
    loadTable();
};

App.inits['lapbul_arsip'] = function() {
    // 1. Setup Dropdown (Tahun, Bulan, Jenjang)
    var curYear = new Date().getFullYear();
    var selTahun = document.getElementById('filterTahun');
    var selBulan = document.getElementById('filterBulan');
    var selJenjang = document.getElementById('filterJenjang');

    // Isi Tahun
    if(selTahun && selTahun.options.length === 0) {
        selTahun.innerHTML = '';
        for(var y = curYear; y >= 2023; y--) selTahun.add(new Option(y, y));
    }
    // Isi Bulan
    if(selBulan && selBulan.options.length === 0) {
        selBulan.innerHTML = '<option value="">Semua Bulan</option>';
        var mList = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        mList.forEach(m => selBulan.add(new Option(m, m)));
    }
    // Isi Jenjang
    if(selJenjang && selJenjang.options.length === 0) {
        selJenjang.innerHTML = '<option value="">Semua Jenjang</option><option value="SD">SD</option><option value="TK">TK</option><option value="KB">KB</option>';
    }

    // 2. Fungsi Load Table
    var loadTable = function() {
        var params = {
            tahun: selTahun ? selTahun.value : curYear,
            bulan: selBulan ? selBulan.value : "",
            jenjang: selJenjang ? selJenjang.value : ""
        };

        App.initSmartTable({
            tableId: 'arsipTable', 
            serverFunc: 'getLapbulArsipData', // Fungsi backend baru
            params: params,
            
            headers: [
                "Nama File", 
                { name: "Jenjang", width: "80px" },
                { name: "Bulan", width: "100px" },
                { name: "Tahun", width: "80px" },
                { name: "Ukuran", width: "80px" },
                { name: "Aksi", width: "100px" }
            ],
            
            // Custom Rendering untuk Tombol Aksi (Download)
            onLoad: function(rows) {
                var tb = document.querySelector('#arsipTable tbody');
                // Kita iterasi manual baris yang baru dirender untuk menyuntikkan tombol
                // Tapi lebih efektif jika kita handle di "Render Data" App.initSmartTable 
                // Namun karena App.initSmartTable kita generik, kita bisa pakai trick ini:
                
                // --- TRICK: Ubah Kolom "Aksi" menjadi Tombol ---
                // Karena data 'Aksi' di JSON backend sebenarnya kosong/undefined, 
                // kita ambil link dari properti row.Link
                
                // Cari index kolom file link
                Array.from(tb.rows).forEach((tr, idx) => {
                    var rowData = rows[idx]; // Data asli JSON
                    if (!rowData) return;

                    var lastCell = tr.lastElementChild; // Asumsi Aksi di akhir
                    var link = rowData.Link;
                    
                    if (link) {
                        lastCell.innerHTML = `
                            <button class="action-btn view-btn" onclick="window.open('${link}', '_blank')">
                                <i class="fas fa-file-download"></i> Buka
                            </button>
                        `;
                        lastCell.style.textAlign = "center";
                    }
                    
                    // Style Nama File agar tebal & truncate
                    var nameCell = tr.cells[1]; // Index 1 karena 0=No
                    nameCell.style.fontWeight = "600";
                    nameCell.style.color = "#334155";
                });
            }
        });
    };

    // 3. Listener
    if(selTahun) selTahun.onchange = loadTable;
    if(selBulan) selBulan.onchange = loadTable;
    if(selJenjang) selJenjang.onchange = loadTable;

    loadTable();
};

// STATE NAVIGASI ARSIP
App.arsipHistory = []; // Stack: [{id:null, name:'Beranda'}, {id:'xxx', name:'SD'}]

App.inits['lapbul_arsip'] = function() {
    App.arsipHistory = [{id: null, name: 'Beranda'}];
    App.toggleArsipView('grid'); // Set default view
    App.loadArsipFolder(null);
};

// Fungsi Helper untuk Refresh Tombol
App.refreshArsip = function() {
    // Ambil ID folder terakhir di history
    var current = App.arsipHistory[App.arsipHistory.length - 1];
    App.loadArsipFolder(current.id, true); // True = jangan tambah history (cuma refresh)
};

// UPDATE FUNGSI INI DI javascript.html
App.loadArsipFolder = function(folderId) {
    var grid = document.getElementById('arsipGrid');
    var loader = document.getElementById('arsipLoader');
    var empty = document.getElementById('arsipEmpty');
    
    if(!grid) return;

    grid.innerHTML = '';
    empty.style.display = 'none';
    if(loader) loader.style.display = 'flex'; 

    google.script.run.withSuccessHandler(function(res) {
        if(loader) loader.style.display = 'none';
        
        if (!res || res.error) {
            App.showAppModal('error', res ? res.error : 'Gagal memuat data.');
            return;
        }

        App.renderBreadcrumb();

        if (!res.items || res.items.length === 0) {
            empty.style.display = 'block';
            return;
        }

        var html = '';
        res.items.forEach(function(item) {
            var iconClass = item.type === 'folder' ? 'fas fa-folder folder-icon' : 'fas fa-file-pdf pdf-icon';
            
            // --- BAGIAN PENTING YANG DIUBAH ---
            var clickAction = '';
            if (item.type === 'folder') {
                clickAction = `onclick="App.enterFolder('${item.id}', '${item.name}')"`;
            } else {
                // SEBELUMNYA: App.previewFile(...) -> Salah (Fungsi lama)
                // SEKARANG: App.showFilePreview(...) -> Benar (Fungsi global baru)
                clickAction = `onclick="App.showFilePreview('${item.url}', '${item.name}')"`;
            }
            // ----------------------------------

            var metaInfo = '';
            if (item.type === 'file') {
                metaInfo = `<span class="item-meta">${item.size} &bull; ${item.updated}</span>`;
            } else {
                metaInfo = `<span class="item-meta">${item.updated || '-'}</span>`;
            }

            html += `
            <div class="explorer-item" ${clickAction} title="${item.name}">
                <i class="${iconClass} explorer-icon"></i>
                <div class="explorer-name">${item.name}</div>
                ${metaInfo}
            </div>`;
        });
        
        grid.innerHTML = html;

    }).withFailureHandler(function(e) {
        if(loader) loader.style.display = 'none';
        App.showAppModal('error', 'Koneksi Gagal: ' + e.message);
    }).getLapbulArsipContent(folderId);
};

// NAVIGASI: MASUK FOLDER (Maju)
App.enterFolder = function(id, name) {
    App.arsipHistory.push({ id: id, name: name });
    App.loadArsipFolder(id);
};

// NAVIGASI: KLIK BREADCRUMB (Mundur/Lompat)
App.jumpToFolder = function(index) {
    // Potong array history sampai index tersebut
    // Misal: [Beranda, SD, 2024]. Klik SD (index 1).
    // History jadi [Beranda, SD].
    var target = App.arsipHistory[index];
    App.arsipHistory = App.arsipHistory.slice(0, index + 1);
    App.loadArsipFolder(target.id);
};

// RENDER BREADCRUMB HTML
App.renderBreadcrumb = function() {
    var el = document.getElementById('arsipBreadcrumb');
    if(!el) return;

    var html = '';
    App.arsipHistory.forEach(function(crumb, idx) {
        // Separator (kecuali item pertama)
        if (idx > 0) html += '<span class="bc-sep"><i class="fas fa-chevron-right"></i></span>';
        
        // Item
        if (idx === App.arsipHistory.length - 1) {
            // Item Terakhir (Aktif) - Tidak bisa diklik
            html += `<span class="bc-item bc-active">${crumb.name}</span>`;
        } else {
            // Item Sebelumnya - Bisa diklik (Jump)
            html += `<span class="bc-item" onclick="App.jumpToFolder(${idx})">${crumb.name}</span>`;
        }
    });
    el.innerHTML = html;
};

App.inits['lapbul_kelola'] = function() {
    
    // 1. SETUP FILTER DENGAN LABEL JELAS
    var curYear = new Date().getFullYear();
    var selTahun = document.getElementById('kelolaTahun');
    var selBulan = document.getElementById('kelolaBulan');
    var selJenjang = document.getElementById('kelolaJenjang');
    var selSekolah = document.getElementById('kelolaSekolah');

    // Reset & Isi Label Default
    if(selTahun && selTahun.options.length <= 1) {
        selTahun.innerHTML = '<option value="">-- Semua Tahun --</option>';
        for(var y = curYear; y >= 2023; y--) selTahun.add(new Option(y, y));
    }
    
    if(selBulan && selBulan.options.length <= 1) {
        selBulan.innerHTML = '<option value="">-- Semua Bulan --</option>';
        var mList = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
        mList.forEach(function(m) { selBulan.add(new Option(m, m)); });
    }

    // Variabel untuk menyimpan data mentah (untuk filter lokal)
    var allTableData = [];

    App.initSmartTable({
        tableId: 'lapbulKelolaTable', 
        serverFunc: 'getLapbulKelolaData',
        
        // URUTAN KOLOM
        headers: [
            "Nama Sekolah", 
            { name: "Jenjang", width: "80px", tdStyle: "text-align:center;" },
            { name: "Status", width: "100px", tdStyle: "text-align:center;" },
            { name: "Bulan", width: "100px" },
            { name: "Tahun", width: "80px", tdStyle: "text-align:center;" },
            
            // [UPDATE] KOLOM DOKUMEN JADI TOMBOL LIHAT
            { 
                name: "Dokumen", 
                width: "100px", 
                tdStyle: "text-align:center;",
                formatter: function(row) {
                    var url = row.Dokumen;
                    if (url && url.includes('http')) {
                        var safeUrl = encodeURIComponent(url);
                        var safeTitle = encodeURIComponent('Laporan ' + (row['Bulan'] || '') + ' ' + (row['Tahun'] || ''));
                        return '<button class="btn-action-sm btn-view" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), decodeURIComponent(\'' + safeTitle + '\'))"><i class="fas fa-eye"></i> Lihat</button>';
                    }
                    return '<span style="color:#cbd5e1;">-</span>';
                }
            },
            
            // Tombol Aksi
            { 
                name: "Aksi", 
                width: "100px",
                tdStyle: "text-align:center;",
                formatter: function(row) {
                    var editPage = (row.Jenjang === 'SD') ? 'lapbul_edit_sd' : 'lapbul_edit_paud';
                    
                    // Button HTML
                    var btnEdit = '<button class="btn-action-sm btn-edit" title="Edit" onclick="App.loadPage(null, \'' + editPage + '\', {rowIndex: ' + row._rowIndex + '})"><i class="fas fa-pencil-alt"></i></button>';
                    
                    // Escape single quote for JSON stringify in onclick
                    var rowStr = JSON.stringify(row).replace(/'/g, "&apos;");
                    var btnDel = '<button class="btn-action-sm btn-delete" title="Hapus" onclick=\'App.showDeleteConfirmation(this)\' data-row-info=\'' + rowStr + '\'><i class="fas fa-trash"></i></button>';

                    return '<div style="display:flex; gap:5px; justify-content:center;">' + btnEdit + btnDel + '</div>';
                }
            },
            { name: "Tanggal Unggah", width: "150px", tdStyle: "color:#64748b; font-size:0.9em;" },
            { name: "User", width: "120px", tdStyle: "text-align:left;" },
            { name: "Update", width: "150px", tdStyle: "color:#64748b; font-size:0.9em;" },
            { name: "User Edit", width: "120px", tdStyle: "text-align:left;" }
        ],
        
        // Filter Custom (ID Baru)
        filters: [
            { id:'kelolaTahun', col:'Tahun', label:'-- Semua Tahun --' },
            { id:'kelolaBulan', col:'Bulan', label:'-- Semua Bulan --' },
            { id:'kelolaJenjang', col:'Jenjang', label:'-- Semua Jenjang --' },
            { id:'kelolaSekolah', col:'Nama Sekolah', label:'-- Cari Sekolah --' }
        ],
        
        onLoad: function(rows) {
            allTableData = rows;
            // 1. Populate Jenjang Unik dari Data
            if(selJenjang) {
                var oldVal = selJenjang.value;
                selJenjang.innerHTML = '<option value="">-- Semua Jenjang --</option>';
                var uniqueJenjang = [...new Set(rows.map(r => r.Jenjang))].filter(Boolean).sort();
                uniqueJenjang.forEach(function(j) {
                     selJenjang.add(new Option(j, j));
                });
                // Restore value jika ada
                if(uniqueJenjang.includes(oldVal)) selJenjang.value = oldVal;
            }

            updateSekolahDropdown(); // Isi dropdown sekolah awal
        }
    });
    
    // 3. LOGIKA FILTER BERANTAI (JENJANG -> SEKOLAH)
    if(selJenjang) {
        selJenjang.addEventListener('change', function() {
            // Reset pilihan sekolah saat jenjang berubah
            if(selSekolah) selSekolah.value = "";
            updateSekolahDropdown();
            // Trigger perubahan pada filter smart table jika perlu (tapi smart table usually listen to change)
            // Di sini kita biarkan SmartTable menangani filter barisnya via config.filters
        });
    }

    // Fungsi Update Dropdown Sekolah (Lokal scope agar aman)
    function updateSekolahDropdown() {
        if(!selSekolah) return;
        
        var selectedJenjang = selJenjang ? selJenjang.value : "";
        var currentSelection = selSekolah.value;

        // Filter data unik
        var uniqueSet = new Set();
        allTableData.forEach(function(r) {
            if (!selectedJenjang || r.Jenjang === selectedJenjang) {
                if (r['Nama Sekolah']) uniqueSet.add(r['Nama Sekolah']);
            }
        });

        var filteredSchools = Array.from(uniqueSet).sort();

        // Render Ulang
        selSekolah.innerHTML = '<option value="">-- Cari Sekolah --</option>';
        filteredSchools.forEach(function(s) {
            selSekolah.add(new Option(s, s));
        });

        // Restore selection
        if(filteredSchools.includes(currentSelection)) {
            selSekolah.value = currentSelection;
        }
    }

    // Search Listener dengan DEBOUNCE (Optimization)
    var searchBox = document.getElementById('kelolaSearch');
    var searchTimeout = null; // Timer untuk debounce

    if(searchBox) {
        searchBox.onkeyup = function() {
            var term = this.value.toLowerCase();
            
            // Hapus timer lama jika user mengetik lagi sebelum 300ms
            if (searchTimeout) clearTimeout(searchTimeout);

            // Set timer baru
            searchTimeout = setTimeout(function() {
                var rows = document.querySelectorAll('#lapbulKelolaTable tbody tr');
                
                // Gunakan requestAnimationFrame untuk rendering lebih halus di browser
                requestAnimationFrame(function() {
                    // Sembunyikan semua dulu (batch DOM manipulation is expensive, but simple display toggle is ok)
                    // Atau lebih efisien: Loop dan toggle
                    var count = 0;
                    rows.forEach(function(r) { 
                        // Optimasi: Hanya cari jika term > 1 karakter atau kosong
                        if (term.length < 2 && term.length > 0) return; 

                        var isMatch = r.innerText.toLowerCase().includes(term);
                        r.style.display = isMatch ? '' : 'none'; 
                    });
                });
            }, 300); // Tunggu 300ms setelah user berhenti mengetik
        };
    }
};

// --- UPDATE HELPER: Agar menerima object row langsung ---
App.openLapbulEdit = function(row) {
    // Cek jika row masih string (kadang terjadi karena parsing HTML)
    if (typeof row === 'string') row = JSON.parse(row);

    var jenjang = (row.Jenjang || '').toUpperCase();
    var targetPage = (jenjang === 'SD') ? 'lapbul_edit_sd' : 'lapbul_edit_paud';
    
    App.loadPage(null, targetPage, {
        rowIndex: row._rowIndex,
        source: (jenjang === 'SD') ? 'SD' : 'PAUD'
    });
};

// --- FUNGSI DELETE KHUSUS LAPBUL ---
App.confirmDeleteLapbul = function(row) {
    if (typeof row === 'string') row = JSON.parse(row);
    var m = document.getElementById('deleteModal');
    if (!m) return;
    var infoHtml = 
        '<div class="delete-detail-row"><span class="delete-detail-label">Sekolah</span><span class="delete-detail-value">' + row['Nama Sekolah'] + '</span></div>' +
        '<div class="delete-detail-row"><span class="delete-detail-label">Laporan</span><span class="delete-detail-value">' + row['Bulan'] + ' ' + row['Tahun'] + '</span></div>';
    
    m.querySelector('.delete-info-card').innerHTML = infoHtml;
    document.getElementById('delCode').value = '';
    m.style.display = 'flex';
    
    document.getElementById('cancelDeleteBtn').onclick = function() { m.style.display='none'; };
    
    var btnConfirm = document.getElementById('confirmDeleteBtn');
    var newBtn = btnConfirm.cloneNode(true);
    btnConfirm.parentNode.replaceChild(newBtn, btnConfirm);
    
    newBtn.onclick = function() {
        var code = document.getElementById('delCode').value;
        if(!code) { App.showAlert('error', 'Kode Kosong', 'Isi kode konfirmasi.'); return; }
        
        App.showAppModal('loading', 'Menghapus...');
        m.style.display = 'none';

        google.script.run.withSuccessHandler(function(res) {
            App.showAppModal('success', 'Berhasil', res);
            App.inits['lapbul_kelola'](); // Refresh
        }).withFailureHandler(function(err) {
            App.showAppModal('error', 'Gagal', err.message);
        }).deleteLapbulData(row._rowIndex, (row.Jenjang==='SD'?'SD':'PAUD'), code);
    };
};

App.inits['lapbul_edit_sd'] = function(params) {
    if (!params || !params.rowIndex) return App.loadPage(null, 'lapbul_kelola');

    var formId = 'lapbulEditFormSd';
    var form = document.getElementById(formId);
    
    // Tampilkan Loading Global
    App.showAppModal('loading', 'Mengambil data SD...');

    google.script.run.withSuccessHandler(function(data) {
        
        // 1. TUTUP MODAL LOADING (KUNCI FIX)
        var globalModal = document.getElementById('appModal');
        if(globalModal) {
            globalModal.classList.remove('show');
            globalModal.style.display = 'none';
        }

        // 2. TAMPILKAN FORM
        var loadingDiv = document.getElementById('loading-data');
        var formContainer = document.getElementById('form-edit-container');
        if(loadingDiv) loadingDiv.style.display = 'none';
        if(formContainer) {
            formContainer.style.display = 'block'; 
            formContainer.style.opacity = '0';
            setTimeout(function(){ formContainer.style.opacity = '1'; }, 100);
        }

        // 3. LOGIKA POPULATE
        if(typeof App.setupSdEditLogic === 'function') App.setupSdEditLogic(form, data);
        if(typeof App.populateForm === 'function') App.populateForm(formId, data);
        
        var inpRow = form.querySelector('input[name="rowIndex"]');
        var inpSrc = form.querySelector('input[name="source"]');
        if(inpRow) inpRow.value = params.rowIndex;
        if(inpSrc) inpSrc.value = 'SD';
        
        if(App.currentUser) {
            var editorName = App.currentUser.nama || App.currentUser.username || 'User';
            var uInput = form.querySelector('input[name="User Edit"]');
            if(!uInput) { uInput = document.createElement('input'); uInput.type='hidden'; uInput.name='User Edit'; form.appendChild(uInput); }
            uInput.value = editorName; 
        }

        var fileBox = document.getElementById('existingFileLink');
        if (fileBox) {
            if (data['Dokumen'] && String(data['Dokumen']).includes('http')) {
                 var safeUrl = encodeURIComponent(data['Dokumen']);
                 fileBox.innerHTML = '<i class="fas fa-file-pdf" style="color:#ef4444; font-size:2em;"></i><div style="flex-grow:1;"><span style="display:block; font-weight:600; color:#334155;">Dokumen Tersimpan</span><span style="font-size:0.85em; color:#94a3b8;">Klik tombol lihat untuk preview</span></div><button type="button" class="btn-download" style="padding:8px 20px; font-weight:bold; background:#3b82f6; color:white;" onclick="App.showFilePreview(decodeURIComponent(\'' + safeUrl + '\'), \'Dokumen Laporan\')"><i class="fas fa-eye"></i> LIHAT</button>';
            } else { fileBox.innerHTML = '<div style="color:#94a3b8; font-style:italic;">Belum ada dokumen yang diunggah.</div>'; }
        }

        if(typeof App.setupFormTabs === 'function') App.setupFormTabs(form);
        if(typeof App.setupSdValidation === 'function') App.setupSdValidation(form);

    }).withFailureHandler(function(e) {
        var globalModal = document.getElementById('appModal');
        if(globalModal) globalModal.style.display = 'none';
        App.showAppModal('error', 'Gagal', e.message);
    }).getLapbulDataByRow(params.rowIndex, 'SD');

    if(form) {
        form.onsubmit = function(e) {
            e.preventDefault();
            var fileInput = document.getElementById('fileLapbulSdEdit');
            if (fileInput && fileInput.files.length > 0) {
                if (fileInput.files[0].size > 307200) return App.showAppModal('error', 'File Terlalu Besar', 'Maksimal 300 KB.');
                if (fileInput.files[0].type !== 'application/pdf') return App.showAppModal('error', 'Format Salah', 'Wajib PDF.');
            }
            if(typeof App.handleEditSubmit === 'function') App.handleEditSubmit(this); 
        };
    }
};

// Helper: Generate Field Kelas SD untuk Edit (Mirip Form Input tapi Value Terisi)
App.generateSdEditClassFields = function(k, data, container) {
    var html = `<div class="section-divider"><span>Data Kelas ${k}</span></div>`;
    
    // Rombel Input
    // Karena form edit SD HTML-nya mungkin belum punya struktur rombel yang sama persis dgn input, 
    // kita inject manual input rombel yang sesuai dengan nama field di Spreadsheet (Backend mapping).
    // Misal: K1 L, K1 P, K1A L, dll.
    
    // Sederhananya, kita tampilkan input Rombel A, B, C (sesuai kebutuhan umum)
    // Atau jika data di spreadsheet flat (K1 L, K1 P), kita tampilkan itu saja.
    
    // Cek Data: Apakah ada data "K1A L"?
    var suffixes = ['', 'A', 'B', 'C']; // K1 L, K1A L...
    
    html += '<div class="input-grid-container">';
    
    suffixes.forEach(suf => {
        var keyL = `K${k}${suf} L`;
        var keyP = `K${k}${suf} P`;
        
        // Hanya render jika salah satu data ada isinya (tidak 0 atau kosong)
        // ATAU render default (tanpa suffix) selalu.
        var valL = data[keyL];
        var valP = data[keyP];
        
        if (suf === '' || (valL && valL != 0) || (valP && valP != 0)) {
            html += `
            <div class="input-box-card">
                <span class="box-title">Kelas ${k}${suf}</span>
                <div class="lp-wrapper">
                    <div class="lp-field"><label class="lp-label">L</label>
                        <input type="number" name="${keyL}" class="form-control-box" value="${valL||0}">
                    </div>
                    <div class="lp-field"><label class="lp-label">P</label>
                        <input type="number" name="${keyP}" class="form-control-box" value="${valP||0}">
                    </div>
                </div>
            </div>`;
        }
    });
    
    html += '</div>';
    
    // Agama Input
    html += `<div class="section-divider"><span>Agama (Kelas ${k})</span></div><div class="input-grid-container">`;
    var agamas = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];
    agamas.forEach(agm => {
        var keyL = `K${k} ${agm} L`;
        var keyP = `K${k} ${agm} P`;
        var valL = data[keyL];
        var valP = data[keyP];
        
        html += `
        <div class="input-box-card">
            <span class="box-title">${agm}</span>
            <div class="lp-wrapper">
                <div class="lp-field"><label class="lp-label">L</label><input type="number" name="${keyL}" class="form-control-mini" value="${valL||0}"></div>
                <div class="lp-field"><label class="lp-label">P</label><input type="number" name="${keyP}" class="form-control-mini" value="${valP||0}"></div>
            </div>
        </div>`;
    });
    html += '</div>';

    container.innerHTML = html;
};

// ===========================================
// FIX FINAL: PREVIEW MODAL SELF-HEALING (AGRESIF)
// (Letakkan/Timpa di paling bawah javascript.html)
// ===========================================

App.ensureModalExists = function() {
    var modal = document.getElementById('previewModal');
    
    // CEK KESEHATAN MODAL:
    // Jika modal ada, TAPI tidak punya elemen kunci '#previewBody',
    // berarti itu modal versi lama/rusak. Kita HAPUS saja biar dibuat ulang.
    if (modal && !modal.querySelector('#previewBody')) {
        console.warn('Modal Preview usang ditemukan. Menghapus dan membuat ulang...');
        modal.remove();
        modal = null; // Reset var
    }

    // JIKA MODAL TIDAK ADA (ATAU BARU DIHAPUS), BUAT BARU
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'previewModal';
        modal.className = 'modal-overlay'; 
        // Style inline super komplit agar tidak tergantung CSS luar
        modal.style.cssText = "display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10005; justify-content:center; align-items:center; backdrop-filter:blur(5px);";
        
        modal.innerHTML = `
        <div class="modal-content" style="width:90%; max-width:1000px; height:90vh; display:flex; flex-direction:column; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
            <div style="padding:15px 20px; display:flex; justify-content:space-between; align-items:center; background:#1e293b; color:#fff; border-bottom:1px solid #334155; flex-shrink:0;">
                <h3 style="margin:0; font-size:1.1em; color:#fff; font-weight:600; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:60%;">Pratinjau Dokumen</h3>
                <div id="previewHeaderActions" style="display:flex; align-items:center; gap:10px;">
                    </div>
            </div>
            <div id="previewBody" style="flex:1; position:relative; background:#eee; width:100%; height:100%;"></div>
        </div>`;
        document.body.appendChild(modal);
    }
    return modal;
};

App.showFilePreview = function(url, title) {
    // 1. Pastikan Modal Siap (Reset jika rusak)
    var modal = App.ensureModalExists();
    
    // 2. Setup Judul
    var h3 = modal.querySelector('h3');
    if(h3) h3.textContent = title || 'Pratinjau Dokumen';

    // 3. Setup Tombol (Header Actions)
    var headerActions = modal.querySelector('#previewHeaderActions');
    if (headerActions) {
        headerActions.innerHTML = ''; // Reset isi lama

        // A. Tombol Download
        var fileId = "";
        var match = url.match(/[-\w]{25,}/);
        if (match) fileId = match[0];
        var downloadUrl = fileId ? "https://drive.google.com/uc?export=download&id=" + fileId : url;

        var btnDl = document.createElement('a');
        btnDl.href = downloadUrl;
        btnDl.target = '_blank';
        // Style inline agar cantik
        btnDl.style.cssText = "background:#10b981; color:#fff; text-decoration:none; padding:6px 12px; border-radius:4px; font-size:0.9em; font-weight:600; display:inline-flex; align-items:center; gap:6px; transition:0.2s;";
        btnDl.innerHTML = '<i class="fas fa-download"></i> Unduh';
        btnDl.onmouseover = function() { this.style.background = '#059669'; };
        btnDl.onmouseout  = function() { this.style.background = '#10b981'; };
        headerActions.appendChild(btnDl);

        // B. Tombol Close (X)
        var btnClose = document.createElement('button');
        btnClose.innerHTML = '&times;';
        btnClose.style.cssText = "background:none; border:none; color:#cbd5e1; font-size:2.2em; cursor:pointer; line-height:0.8; padding:0 5px; margin-left:10px;";
        btnClose.onclick = function() { App.closePreview(); }; 
        btnClose.onmouseover = function() { this.style.color = '#ef4444'; };
        btnClose.onmouseout  = function() { this.style.color = '#cbd5e1'; };
        headerActions.appendChild(btnClose);
    }

    // 4. Setup Iframe (Body)
    var body = modal.querySelector('#previewBody');
    if (body) {
        body.innerHTML = ''; // Bersihkan iframe lama
        
        var previewUrl = fileId ? "https://drive.google.com/file/d/" + fileId + "/preview" : url;
        
        var iframe = document.createElement('iframe');
        iframe.src = previewUrl;
        iframe.style.cssText = "width:100%; height:100%; border:none; display:block;";
        // Tambahkan atribut allow agar lebih permissive
        iframe.setAttribute('allow', 'autoplay');
        
        body.appendChild(iframe);
    }

    // 5. Tampilkan
    modal.style.display = 'flex';
};

App.closePreview = function() {
    var modal = document.getElementById('previewModal');
    if (modal) {
        modal.style.display = 'none';
        var body = modal.querySelector('#previewBody');
        if(body) body.innerHTML = ''; // Hapus iframe
    }
};

// --- HELPER POPULATE FORM ---
// Fungsi sakti untuk mengisi segala jenis input berdasarkan JSON
App.populateForm = function(formId, data) {
    var form = document.getElementById(formId);
    if (!form) return;

    // Loop semua elemen input/select/textarea di form
    var elements = form.querySelectorAll('input, select, textarea');
    elements.forEach(function(el) {
        var name = el.name;
        // Jika input punya nama & datanya ada di object 'data'
        if (name && data.hasOwnProperty(name)) {
            if (el.type === 'radio') {
                if (el.value == data[name]) el.checked = true;
            } else if (el.type === 'checkbox') {
                // Logika checkbox bisa variatif, ini default simpel
                el.checked = (String(data[name]).toLowerCase() === 'true' || el.value == data[name]);
            } else {
                el.value = data[name];
            }
        }
    });
};


// --- INIT PAGE EDIT PAUD (FIX USER EDIT, SPINNER & TAB 4) ---
App.inits['lapbul_edit_paud'] = function(params) {
    if (!params || !params.rowIndex) return App.loadPage(null, 'lapbul_kelola'); 

    var formId = 'lapbulEditFormPaud';
    var form = document.getElementById(formId);
    
    // [FIX 1] Hapus App.showAppModal('loading'...) di sini. 
    // HTML #loading-data sudah cukup.

    google.script.run.withSuccessHandler(function(data) {
        
        // [FIX 1] Transisi Halus (Spinner Hilang)
        var loadingDiv = document.getElementById('loading-data');
        var formContainer = document.getElementById('form-edit-container');
        
        if(loadingDiv) loadingDiv.style.display = 'none';
        if(formContainer) {
            formContainer.style.display = 'block'; 
            formContainer.style.opacity = '0';
            setTimeout(() => formContainer.style.opacity = '1', 100);
        }

        // --- POPULATE FORM ---
        App.populateForm(formId, data);
        
        // Setup Hidden Fields
        if(!form.querySelector('input[name="rowIndex"]')) {
             var ri = document.createElement('input'); ri.type='hidden'; ri.name='rowIndex'; form.appendChild(ri);
             var si = document.createElement('input'); si.type='hidden'; si.name='source'; form.appendChild(si);
        }
        form.querySelector('input[name="rowIndex"]').value = params.rowIndex;
        form.querySelector('input[name="source"]').value = 'PAUD';
        
        // --- [FIX 2] USER EDIT (INJECT NAMA USER) ---
        if(App.currentUser) {
             // Ambil Nama
             var editorName = App.currentUser.nama || App.currentUser.username || 'User';
             
             // Masukkan ke input User Edit
             var uInput = form.querySelector('input[name="User Edit"]');
             if(!uInput) { 
                 uInput = document.createElement('input'); 
                 uInput.type='hidden'; 
                 uInput.name='User Edit'; 
                 form.appendChild(uInput); 
             }
             uInput.value = editorName;
        }

        // --- SETUP FILE LINK (UNTUK TAB 4 BARU) ---
        var fileBox = document.getElementById('existingFileLink');
        if (fileBox) {
            if (data['Dokumen'] && data['Dokumen'].includes('http')) {
                 fileBox.innerHTML = `
                 <i class="fas fa-file-pdf" style="color:#ef4444; font-size:2em;"></i>
                 <div style="flex-grow:1;">
                    <span style="display:block; font-weight:600; color:#334155;">Dokumen Tersimpan</span>
                    <span style="font-size:0.85em; color:#94a3b8;">Klik tombol lihat untuk preview</span>
                 </div>
                 <button type="button" class="btn-download" style="padding:8px 20px; font-weight:bold; background:#3b82f6; color:white;" 
                        onclick="App.showFilePreview('${data['Dokumen']}', 'Dokumen Laporan')">
                        <i class="fas fa-eye"></i> LIHAT
                 </button>`;
            } else {
                 fileBox.innerHTML = '<div style="color:#94a3b8; font-style:italic;">Belum ada dokumen yang diunggah.</div>';
            }
        }

        // Init Tab & Validasi
        App.setupFormTabs(form);
        if(App.setupPaudValidation) App.setupPaudValidation(form);

    }).withFailureHandler(function(e) {
        App.showAppModal('error', 'Gagal', e.message);
    }).getLapbulDataByRow(params.rowIndex, 'PAUD');

    // 3. Handle Submit
    if(form) {
        form.onsubmit = function(e) {
            e.preventDefault();
            
            // Validasi File Baru (ID input harus sesuai HTML: fileLapbulPaudEdit)
            var fileInput = document.getElementById('fileLapbulPaudEdit');
            if (fileInput && fileInput.files.length > 0) {
                if (fileInput.files[0].size > 307200) return App.showAppModal('error', 'File Terlalu Besar', 'Maksimal 300 KB.');
                if (fileInput.files[0].type !== 'application/pdf') return App.showAppModal('error', 'Format Salah', 'Wajib PDF.');
            }

            // Gunakan global helper submit
            App.handleEditSubmit(this); 
        };
    }
};

// --- 2. FUNGSI VALIDASI (WAJIB ADA) ---
App.setupPaudValidation = function(form) {
    if(!form) return;

    // A. SETUP VARIABEL
    var inputsUmur = form.querySelectorAll('.val-umur');
    var inputsKel  = form.querySelectorAll('.val-kel');
    
    var elTotalUmur = document.getElementById('total-umur');
    var elTotalKel  = document.getElementById('total-kel');
    var elStatus    = document.getElementById('val-status-badge');
    var elBox       = document.getElementById('validation-box-paud');
    var elMsg       = document.getElementById('val-msg-box');

    // B. LOGIKA HITUNG MURID
    var validateMurid = function() {
        if(!elTotalUmur) return; 

        var sumUmur = 0;
        inputsUmur.forEach(el => sumUmur += (parseInt(el.value) || 0));

        var sumKel = 0;
        inputsKel.forEach(el => sumKel += (parseInt(el.value) || 0));

        // Update Angka di Layar
        elTotalUmur.textContent = sumUmur;
        elTotalKel.textContent  = sumKel;

        // Cek Kesamaan
        if (sumUmur === sumKel && sumUmur > 0) {
            // Valid (Hijau)
            elBox.style.borderColor = '#10b981';
            elStatus.style.background = '#10b981';
            elStatus.innerHTML = '<i class="fas fa-check"></i> DATA VALID';
            if(elMsg) elMsg.style.display = 'none';
        } else {
            if (sumUmur === 0 && sumKel === 0) {
                // Masih Kosong
                elBox.style.borderColor = '#cbd5e1';
                elStatus.style.background = '#94a3b8';
                elStatus.textContent = 'Belum Diisi';
            } else {
                // Error (Merah)
                elBox.style.borderColor = '#ef4444';
                elStatus.style.background = '#ef4444';
                elStatus.innerHTML = '<i class="fas fa-times"></i> TIDAK SAMA';
                if(elMsg) elMsg.style.display = 'block';
            }
        }
    };

    // C. LOGIKA HITUNG PTK (KS & Guru)
    var inputsKS = form.querySelectorAll('.val-ks');
    var ptkAlert = document.getElementById('ptk-alert-box');

    var validatePtk = function() {
        if(!ptkAlert) return;

        var sumKS = 0;
        inputsKS.forEach(el => sumKS += (parseInt(el.value) || 0));

        if (sumKS > 1) {
            ptkAlert.style.display = 'block';
            ptkAlert.style.background = '#fee2e2';
            ptkAlert.style.color = '#b91c1c';
            ptkAlert.style.border = '1px solid #fecaca';
            ptkAlert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Jumlah Kepala Sekolah maksimal 1.';
        } else {
            ptkAlert.style.display = 'none';
        }
    };

    // D. PASANG LISTENER (Agar hitung real-time saat diketik)
    var allInputs = form.querySelectorAll('input[type="number"]');
    allInputs.forEach(inp => {
        inp.addEventListener('input', function() {
            validateMurid();
            validatePtk();
        });
        inp.addEventListener('keyup', function() {
            validateMurid();
            validatePtk();
        });
    });

    // E. JALANKAN SEKALI SAAT LOAD
    validateMurid();
    validatePtk();
};


// --- INIT HALAMAN EDIT SD (UPDATE) ---
App.inits['lapbul_edit_sd'] = function(params) {
    if (!params || !params.rowIndex) return App.loadPage(null, 'lapbul_kelola');

    var formId = 'lapbulEditFormSd';
    var form = document.getElementById(formId);
    
    App.showAppModal('loading', 'Mengambil data SD...');

    google.script.run.withSuccessHandler(function(data) {
        document.getElementById('appModal').style.display = 'none';

        // 1. Tampilkan Form
        var loadingDiv = document.getElementById('loading-data');
        var formContainer = document.getElementById('form-edit-container');
        if(loadingDiv) loadingDiv.style.display = 'none';
        if(formContainer) {
            formContainer.style.display = 'block'; 
            formContainer.style.opacity = '0';
            setTimeout(() => formContainer.style.opacity = '1', 100);
        }

        // 2. Setup Struktur Kelas Dinamis
        App.setupSdEditLogic(form, data);

        // 3. Isi Form Dasar
        App.populateForm(formId, data);
        
        // 4. Setup Hidden Fields
        if(!form.querySelector('input[name="rowIndex"]')) {
             var ri = document.createElement('input'); ri.type='hidden'; ri.name='rowIndex'; form.appendChild(ri);
             var si = document.createElement('input'); si.type='hidden'; si.name='source'; form.appendChild(si);
        }
        form.querySelector('input[name="rowIndex"]').value = params.rowIndex;
        form.querySelector('input[name="source"]').value = 'SD';
        
        // --- [PERBAIKAN] PISAHKAN USER EDIT & AMBIL NAMA ASLI ---
        if(App.currentUser) {
             // 1. Ambil Nama Lengkap (Prioritas: nama -> username -> 'User')
             var editorName = App.currentUser.nama || App.currentUser.username || 'User';

             // 2. Masukkan ke input dengan name="User Edit" (Sesuai Header Baru di Excel)
             // Dengan begini, kolom "User" (Pengunggah) tidak akan tertimpa.
             var uInput = form.querySelector('input[name="User Edit"]');
             if(!uInput) { 
                 uInput = document.createElement('input'); 
                 uInput.type='hidden'; 
                 uInput.name='User Edit'; // Target Kolom Baru
                 form.appendChild(uInput); 
             }
             uInput.value = editorName; 
        }

        // 5. Setup Tampilan File Lama (TAB 4)
        var fileBox = document.getElementById('existingFileLink');
        if (fileBox) {
            if (data['Dokumen'] && data['Dokumen'].includes('http')) {
                 fileBox.innerHTML = `
                 <i class="fas fa-file-pdf" style="color:#ef4444; font-size:2em;"></i>
                 <div style="flex-grow:1;">
                    <span style="display:block; font-weight:600; color:#334155;">Dokumen Tersimpan</span>
                    <span style="font-size:0.85em; color:#94a3b8;">Klik tombol lihat untuk preview</span>
                 </div>
                 <button type="button" class="btn-download" style="padding:8px 20px; font-weight:bold; background:#3b82f6; color:white;" 
                        onclick="App.showFilePreview('${data['Dokumen']}', 'Dokumen Laporan')">
                        <i class="fas fa-eye"></i> LIHAT
                 </button>`;
            } else {
                 fileBox.innerHTML = '<div style="color:#94a3b8; font-style:italic;">Belum ada dokumen yang diunggah.</div>';
            }
        }

        // 6. Init Tab & Validasi
        App.setupFormTabs(form);
        App.setupSdValidation(form);

    }).withFailureHandler(function(e) {
        App.showAppModal('error', 'Gagal', e.message);
    }).getLapbulDataByRow(params.rowIndex, 'SD');

    // Handle Submit
    if(form) {
        form.onsubmit = function(e) {
            e.preventDefault();
            
            // Cek jika ada file baru
            var fileInput = document.getElementById('fileLapbulSdEdit');
            if (fileInput && fileInput.files.length > 0) {
                if (fileInput.files[0].size > 307200) return App.showAppModal('error', 'File Terlalu Besar', 'Maksimal 300 KB.');
                if (fileInput.files[0].type !== 'application/pdf') return App.showAppModal('error', 'Format Salah', 'Wajib PDF.');
            }

            App.handleEditSubmit(this); 
        };
    }
};

// --- HELPER: SUBMIT EDIT GENERIC (VERSI FINAL) ---
App.handleEditSubmit = function(formElement) {
    // 1. Ambil Elemen Kunci
    var fileInput = formElement.querySelector('input[type="file"]');
    var btn = formElement.querySelector('button[type="submit"]');
    var oldHtml = btn.innerHTML;
    
    // 2. Kumpulkan Data Form
    var formData = {};
    var inputs = formElement.querySelectorAll('input, select, textarea');
    inputs.forEach(el => {
        if(el.name) formData[el.name] = el.value;
    });

    // 3. Definisi Fungsi Kirim
    var sendData = function(filePayload) {
        if (filePayload) formData.fileData = filePayload;
        
        btn.disabled = true; 
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        
        google.script.run.withSuccessHandler(function(res) {
            btn.disabled = false; btn.innerHTML = oldHtml;
            
            // PERUBAHAN PENTING DI SINI:
            // Parameter ke-3 adalah halaman tujuan setelah klik OK ('lapbul_kelola')
            App.showAppModal('success', res, 'lapbul_kelola'); 
            
        }).withFailureHandler(function(err) {
            btn.disabled = false; btn.innerHTML = oldHtml;
            App.showAppModal('error', 'Gagal Menyimpan', err.message);
        }).updateLapbulData(formData);
    };

    // 4. Cek & Proses File Upload
    if (fileInput && fileInput.files.length > 0) {
        var file = fileInput.files[0];
        
        // Validasi Ukuran (300KB)
        if (file.size > 307200) { 
            return App.showAppModal('error', 'File Terlalu Besar', 'Maksimal 300 KB.');
        }
        // Validasi Tipe (PDF Only)
        if (file.type !== 'application/pdf') {
            return App.showAppModal('error', 'Format Salah', 'Wajib format PDF.');
        }

        var reader = new FileReader();
        reader.onload = function(e) {
            sendData({
                data: e.target.result.split(',')[1],
                mimeType: file.type,
                fileName: file.name
            });
        };
        reader.readAsDataURL(file);
    } else {
        // Tidak ada file baru, kirim data teks saja
        sendData(null); 
    }
};

// --- HELPER LOGIKA EDIT SD (GENERATE CLASS & DETECT ROMBEL) ---
App.setupSdEditLogic = function(form, data) {
    var tabContainer = document.getElementById('edit-subTabContainer');
    var contentContainer = document.getElementById('edit-kelasContentArea');
    var agamas = ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Konghucu'];

    if (!tabContainer || !contentContainer) return;

    tabContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    // Fungsi Pembantu Bikin Kotak Input
    var createRombelBox = function(k, suffix, label) {
        var keyL = `K${k}${suffix} L`;
        var keyP = `K${k}${suffix} P`;
        var valL = data[keyL] || 0;
        var valP = data[keyP] || 0;
        
        return `<div class="input-box-card">
                    <span class="box-title">${label}</span>
                    <div class="lp-wrapper">
                        <div class="lp-field"><label>L</label><input type="number" name="${keyL}" class="form-control-mini val-rombel" style="text-align:center;" value="${valL}"></div>
                        <div class="lp-field"><label>P</label><input type="number" name="${keyP}" class="form-control-mini val-rombel" style="text-align:center;" value="${valP}"></div>
                    </div>
                </div>`;
    };

    // LOOP KELAS 1-6
    for (var k = 1; k <= 6; k++) {
        // 1. Tombol Tab
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = (k === 1) ? 'sub-tab-btn active' : 'sub-tab-btn';
        btn.textContent = 'Kelas ' + k;
        // Logic Klik Tab
        btn.onclick = (function(idx) { 
            return function() { 
                form.querySelectorAll('.sub-tab-btn').forEach(b => b.classList.remove('active'));
                form.querySelectorAll('.kelas-content').forEach(c => c.style.display = 'none');
                this.classList.add('active');
                document.getElementById('edit_kelas_' + idx).style.display = 'block';
            }; 
        })(k);
        tabContainer.appendChild(btn);

        // 2. Konten Kelas
        var div = document.createElement('div');
        div.id = 'edit_kelas_' + k;
        div.className = 'kelas-content';
        div.style.display = (k === 1) ? 'block' : 'none';

        // 3. Deteksi Jumlah Rombel dari Data
        // Cek apakah ada data di Rombel C? Jika ya, mode 3. Jika B? Mode 2. Default 1.
        var rombelCount = "1";
        if (data[`K${k}C L`] > 0 || data[`K${k}C P`] > 0) rombelCount = "3";
        else if (data[`K${k}B L`] > 0 || data[`K${k}B P`] > 0) rombelCount = "2";
        
        // Generate Input Rombel
        var rombelInputs = '';
        if (rombelCount === "3") {
            rombelInputs += createRombelBox(k, 'A', `Kelas ${k}A`) + createRombelBox(k, 'B', `Kelas ${k}B`) + createRombelBox(k, 'C', `Kelas ${k}C`);
        } else if (rombelCount === "2") {
            rombelInputs += createRombelBox(k, 'A', `Kelas ${k}A`) + createRombelBox(k, 'B', `Kelas ${k}B`);
        } else {
            rombelInputs += createRombelBox(k, '', `Kelas ${k}`);
        }

        // Generate Input Agama (Hanya tampilkan jika > 0 atau Islam default)
        var agamaInputs = '';
        agamas.forEach(agm => {
            var keyL = `K${k} ${agm} L`;
            var keyP = `K${k} ${agm} P`;
            var valL = data[keyL] || 0;
            var valP = data[keyP] || 0;
            var isAda = (valL > 0 || valP > 0 || agm === 'Islam'); // Default tampil jika ada data
            
            // Kita render semua tapi hide yang tidak ada isinya (kecuali Islam)
            // Agar sederhana di Edit, kita tampilkan semua saja tapi "Ada/Tidak" logic bisa ditambahkan nanti
            // Untuk sekarang, kita tampilkan kotak inputnya langsung
            
            agamaInputs += `
            <div class="input-box-card">
                <span class="box-title">${agm}</span>
                <div class="lp-wrapper">
                    <div class="lp-field"><label>L</label><input type="number" name="${keyL}" class="form-control-mini val-agama" style="text-align:center;" value="${valL}"></div>
                    <div class="lp-field"><label>P</label><input type="number" name="${keyP}" class="form-control-mini val-agama" style="text-align:center;" value="${valP}"></div>
                </div>
            </div>`;
        });

        // Rakit HTML
        div.innerHTML = `
            <div class="section-divider"><span>Data Kelas ${k} - Menurut Rombel</span></div>
            <div class="rombel-control-box">
                <div class="form-group" style="margin-bottom:10px;">
                    <label>Jumlah Rombel Terdeteksi: <b>${rombelCount}</b></label>
                    </div>
                <div class="rombel-inputs-grid">${rombelInputs}</div>
            </div>

            <div class="section-divider"><span>Data Kelas ${k} - Menurut Agama</span></div>
            <div class="input-grid-container">${agamaInputs}</div>

            <div class="validation-footer" style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:10px;">
                <div id="edit_val_rombel_${k}">Rombel: 0</div>
                <div id="edit_val_agama_${k}">Agama: 0</div>
                <span id="edit_status_${k}" class="val-status-text">Checking...</span>
            </div>
        `;
        contentContainer.appendChild(div);
    }
};

// --- VALIDASI SD (SAMA PERSIS DENGAN PAUD LOGIKANYA) ---
App.setupSdValidation = function(form) {
    if(!form) return;

    // 1. Validasi Kelas (Loop 1-6)
    var validateKelas = function() {
        for (var k = 1; k <= 6; k++) {
            var div = document.getElementById('edit_kelas_' + k);
            if (!div) continue;

            var sumRombel = 0;
            div.querySelectorAll('.val-rombel').forEach(el => sumRombel += (parseInt(el.value)||0));
            
            var sumAgama = 0;
            div.querySelectorAll('.val-agama').forEach(el => sumAgama += (parseInt(el.value)||0));

            document.getElementById(`edit_val_rombel_${k}`).textContent = `Total Rombel: ${sumRombel}`;
            document.getElementById(`edit_val_agama_${k}`).textContent = `Total Agama: ${sumAgama}`;
            
            var st = document.getElementById(`edit_status_${k}`);
            if(sumRombel === sumAgama && sumRombel > 0) {
                st.textContent = "VALID"; st.style.color = "green"; st.style.fontWeight="bold";
            } else if (sumRombel === 0 && sumAgama === 0) {
                st.textContent = "Kosong"; st.style.color = "#94a3b8";
            } else {
                st.textContent = "TIDAK SAMA"; st.style.color = "red"; st.style.fontWeight="bold";
            }
        }
    };

    // 2. Validasi PTK
    var validatePtk = function() {
        var ptkAlert = document.getElementById('ptk-alert-box');
        if(!ptkAlert) return;

        var sumKS = 0;
        form.querySelectorAll('.val-ks').forEach(el => sumKS += (parseInt(el.value)||0));
        
        var sumGuru = 0;
        form.querySelectorAll('.val-guru').forEach(el => sumGuru += (parseInt(el.value)||0));

        var msg = "";
        if(sumKS > 1) msg += "<div><i class='fas fa-exclamation-triangle'></i> Maksimal 1 Kepala Sekolah.</div>";
        if(sumGuru === 0) msg += "<div><i class='fas fa-info-circle'></i> Data Guru masih kosong.</div>";

        if(msg) {
            ptkAlert.style.display = 'block';
            ptkAlert.innerHTML = msg;
        } else {
            ptkAlert.style.display = 'none';
        }
    };

    // Listener
    form.addEventListener('input', function(e) {
        if(e.target.type === 'number') {
            validateKelas();
            validatePtk();
        }
    });

    // Run Once
    validateKelas();
    validatePtk();
};

// --- HELPER: TAB FORM SETUP ---
App.setupFormTabs = function(form) {
    // Logika Tab Utama (1, 2, 3, 4)
    var tabs = form.querySelectorAll('.tab-link');
    var panels = form.querySelectorAll('.tab-content-form');
    
    tabs.forEach(btn => {
        btn.onclick = function() {
            // Hapus aktif lama
            tabs.forEach(t => t.classList.remove('active'));
            panels.forEach(p => { 
                p.classList.remove('active'); 
                p.style.display = 'none'; // Paksa hide
            });
            
            // Set aktif baru
            this.classList.add('active');
            var targetId = this.dataset.tab;
            var target = document.getElementById(targetId);
            if(target) {
                target.classList.add('active');
                target.style.display = 'block'; // Paksa show
            }
        };
    });

    // Tombol Next/Prev
    form.querySelectorAll('.next-tab-btn, .prev-tab-btn').forEach(btn => {
        btn.onclick = function() {
            var targetTabId = '';
            // Jika tombol punya data-target langsung (misal: data-target="dataMurid")
            if (this.dataset.target) {
                targetTabId = this.dataset.target;
            } else {
                // Logika otomatis (Cari tab berikutnya/sebelumnya)
                // ... (Opsional: lebih aman pakai data-target di HTML)
            }
            
            // Trigger klik pada tab header
            var tabBtn = form.querySelector(`.tab-link[data-tab="${targetTabId}"]`);
            if(tabBtn) tabBtn.click();
        };
    });
};

// --- INIT HALAMAN UNDUH FORMAT ---
App.inits['lapbul_unduh_format'] = function() {
    var btn = document.getElementById('infoDropdownBtn');
    var content = document.getElementById('infoDropdownContent');
    var chevron = document.getElementById('chevronIcon');
    
    // 1. Logic Dropdown Toggle
    if (btn && content) {
        btn.onclick = function() {
            var isClosed = content.style.display === 'none';
            content.style.display = isClosed ? 'block' : 'none';
            if (chevron) chevron.style.transform = isClosed ? 'rotate(180deg)' : 'rotate(0deg)';
            
            // Load data hanya jika dibuka pertama kali dan masih kosong/loading
            if (isClosed && content.querySelector('.loading-container')) {
                loadInfo();
            }
        };
    }

    // 2. Fungsi Load Data dari Backend
    function loadInfo() {
        google.script.run.withSuccessHandler(function(data) {
            if (!data || data.length === 0) {
                content.innerHTML = '<p style="text-align:center; color:#cbd5e1;">Tidak ada informasi tambahan.</p>';
                return;
            }

            // Render List Informasi
            var html = '<ul style="padding-left:20px; margin:0;">';
            data.forEach(function(item) {
                html += '<li style="margin-bottom:8px;">' + item + '</li>';
            });
            html += '</ul>';
            content.innerHTML = html;

        }).withFailureHandler(function(e) {
            content.innerHTML = '<p style="color:red; text-align:center;">Gagal memuat info: ' + e.message + '</p>';
        }).getUnduhFormatInfo(); // Memanggil fungsi di Lapbul.gs
    }
};

App.inits['lapbul_trash'] = function() {
    
    // CEK ADMIN (Tambahan keamanan)
    var session = JSON.parse(localStorage.getItem('user_session') || '{}');
    if (!(session.role || '').toLowerCase().includes('admin')) {
        document.getElementById('main-content').innerHTML = '<div style="padding:50px;text-align:center;">Akses Ditolak</div>';
        return;
    }

    App.initSmartTable({
        tableId: 'trashTable', 
        serverFunc: 'getLapbulTrashData', // Pastikan fungsi backend ini sudah ada (dari step sebelumnya)
        
        // URUTAN KOLOM TRASH
        // SmartTable otomatis mendeteksi kolom "Dokumen" untuk jadi tombol, 
        // dan kolom pertama (Nama Sekolah) biasanya otomatis Bold oleh CSS .std-table
        headers: [
            "Nama Sekolah", 
            "Jenjang", 
            "Bulan", 
            "Tahun", 
            "Dokumen",       // SmartTable akan otomatis render tombol View/Download
            "Deleted By",    // Info Pen-delete
            "Deleted At"     // Waktu Hapus
        ],
        
        // MAPPING FILTER KE ID BARU
        filters: [
            {id:'filterTrashTahun',   col:'Tahun',    label:'-- Pilih Tahun --', desc:true},
            {id:'filterTrashBulan',   col:'Bulan',    label:'-- Pilih Bulan --'},
            {id:'filterTrashJenjang', col:'Jenjang',  label:'-- Pilih Jenjang --'},
            {id:'filterTrashSekolah', col:'Nama Sekolah', label:'-- Pilih Sekolah --'}
        ],
        
        // LOGIKA DROPDOWN BERANTAI (SAMA PERSIS DENGAN RIWAYAT)
        onFilterChange: function(filterId, value, filteredRows, allRows) {
            if(filterId === 'filterTrashJenjang') {
                var elSekolah = document.getElementById('filterTrashSekolah');
                if(!elSekolah) return;
                elSekolah.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
                
                // Ambil sekolah sesuai jenjang yang dipilih
                var relevantRows = value ? allRows.filter(r => r.Jenjang === value) : allRows;
                var schools = [];
                relevantRows.forEach(r => { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                
                // Urutkan dan Hapus Duplikat
                var uniqueSchools = schools.filter((v, i, a) => a.indexOf(v) === i).sort();
                uniqueSchools.forEach(s => elSekolah.add(new Option(s, s)));
            }
        },
        
        onLoad: function(allRows) {
             // Populate awal sekolah
             var elSekolah = document.getElementById('filterTrashSekolah');
             if(elSekolah && elSekolah.options.length <= 1) {
                 var schools = [];
                 allRows.forEach(r => { if(r['Nama Sekolah']) schools.push(r['Nama Sekolah']); });
                 var uniqueSchools = schools.filter((v, i, a) => a.indexOf(v) === i).sort();
                 uniqueSchools.forEach(s => elSekolah.add(new Option(s, s)));
             }
        }
    });
};

// --- DASHBOARD LAPORAN BULAN (FIX GRAFIK & RECENT) ---
App.inits['lapbul_menu'] = function() {
    
    // 1. SET LOADING STATE
    ['lbTotal', 'lbToday', 'lbSD', 'lbPAUD'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size:0.6em"></i>';
    });
    var elList = document.getElementById('lbListRecent');
    if(elList) elList.innerHTML = '<div style="text-align:center; padding:10px;">Memuat...</div>';

    // 2. REQUEST DATA
    google.script.run.withSuccessHandler(function(stats) {
        if (!stats || stats.error) {
            var errMsg = stats ? stats.error : "Data null";
            console.error(errMsg);
            if(elList) elList.innerHTML = '<div style="color:red; padding:10px;">Error: ' + errMsg + '</div>';
            return;
        }

        // A. ISI KARTU
        var animate = function(id, val) {
            var el = document.getElementById(id);
            if(el) el.textContent = val || 0;
        };
        animate('lbTotal', stats.total);
        animate('lbToday', stats.today);
        animate('lbSD', stats.countSD);
        animate('lbPAUD', stats.countPAUD);

        // B. RENDER CHART
        if(typeof Chart !== 'undefined') {
            
            // 1. CHART TREN (DOUBLE DATASET: SD & PAUD)
            var ctxTrend = document.getElementById('lbChartTrend');
            if (ctxTrend) {
                if (ctxTrend.chartInstance) ctxTrend.chartInstance.destroy();
                
                ctxTrend.chartInstance = new Chart(ctxTrend.getContext('2d'), {
                    type: 'bar', // Gunakan Bar Chart untuk perbandingan yang jelas
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Ags', 'Sep', 'Okt', 'Nov', 'Des'],
                        datasets: [
                            {
                                label: 'SD',
                                data: stats.trendSD, // Data Backend
                                backgroundColor: '#3b82f6', // Biru
                                borderRadius: 4
                            },
                            {
                                label: 'PAUD',
                                data: stats.trendPAUD, // Data Backend
                                backgroundColor: '#8b5cf6', // Ungu
                                borderRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true, position: 'top' }, // Tampilkan Legend
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: { 
                            y: { beginAtZero: true, ticks: { precision: 0 } }, 
                            x: { grid: { display: false } } 
                        }
                    }
                });
            }

            // 2. CHART KOMPOSISI (SD vs PAUD)
            var ctxJenjang = document.getElementById('lbChartJenjang');
            if (ctxJenjang) {
                if (ctxJenjang.chartInstance) ctxJenjang.chartInstance.destroy();

                ctxJenjang.chartInstance = new Chart(ctxJenjang.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['SD', 'PAUD'],
                        datasets: [{
                            data: [stats.countSD, stats.countPAUD],
                            backgroundColor: ['#3b82f6', '#8b5cf6'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: { 
                            legend: { position: 'right', labels: { boxWidth: 12, usePointStyle: true } } 
                        }
                    }
                });
            }
        }

        // C. RECENT ACTIVITY (Sekarang sudah menampilkan Nama Sekolah)
        var listHtml = '';
        if(!stats.recent || stats.recent.length === 0) listHtml = '<div style="padding:10px; color:#ccc;">Belum ada aktivitas</div>';
        else {
            stats.recent.forEach(function(r) {
                var color = r.jenjang === 'SD' ? '#3b82f6' : '#8b5cf6'; 
                listHtml += '<div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #f1f5f9;">' +
                            '<div><div style="font-weight:600; font-size:0.85em; color:#334155;">'+r.sekolah+'</div>' +
                            '<div style="font-size:0.75em; color:#94a3b8;">'+r.waktu+'</div></div>' +
                            '<div style="font-size:0.75em; font-weight:bold; color:'+color+';">'+r.jenjang+'</div>' +
                            '</div>';
            });
        }
        if(elList) elList.innerHTML = listHtml;

    }).getLapbulDashboardStats();
};

// --- INIT HALAMAN LANDING (DENGAN LOGIC DROPDOWN) ---
App.inits['lapbul_landing'] = function() {
    var btn = document.getElementById('btnTogglePetunjuk');
    var content = document.getElementById('contentPetunjuk');
    var icon = document.getElementById('iconChevron');

    if(btn && content && icon) {
        btn.onclick = function() {
            // Cek kondisi saat ini (Hidden atau Block)
            var isClosed = content.style.display === 'none';
            
            // Toggle Display
            content.style.display = isClosed ? 'block' : 'none';
            
            // Putar Icon Panah
            icon.style.transform = isClosed ? 'rotate(180deg)' : 'rotate(0deg)';
        };
    }
};

App.inits['ptk_keadaan_paud'] = function() {

    // 1. Helper Format Angka (0 jadi Kosong)
    var fmt = function(row, colName) {
        // Cari key object secara case-insensitive
        var key = Object.keys(row).find(k => k.toLowerCase() === colName.toLowerCase());
        var val = row[key] || 0;
        return (parseFloat(val) === 0) ? "" : val;
    };

    // 2. Helper Definisi Kolom
    var col = function(name) {
        return { 
            name: name, 
            formatter: function(r) { return fmt(r, name); }
        };
    };

    // 3. Daftar Header (Sesuai Data Spreadsheet)
    var headersList = [
        "Nama Lembaga", 
        "Jenjang", "Status", "Bulan", "Tahun", 
        col("Jumlah Rombel"), 
        col("KS PNS"), col("KS Non ASN"), 
        col("Guru PNS"), col("Guru PPPK"), 
        col("GTY"), col("GTT"), 
        col("Penjaga"), col("Tenaga Admin"), 
        col("Pustakawan"), col("Tendik Lain"), 
        col("Jumlah PTK")
    ];

    // 4. Inisialisasi Smart Table
    App.initSmartTable({
        tableId: 'keadaanPtkPaudTable',
        serverFunc: 'getPtkKeadaanPaudData',
        headers: headersList,
        autoHideZero: true, 
        addTotalRow: false, // Matikan bawaan, kita pakai custom di onRender

        // Daftarkan Filter & Search agar terhubung ke Logika
        filters: [
            { id: 'filterJenjang', col: 'Jenjang', label: 'Semua Jenjang' },
            { id: 'searchKeadaanPaud', col: 'Nama Lembaga' }
        ],

        // 5. FUNGSI RENDER FOOTER (Baris Jumlah)
        onRender: function(rows) {
            var table = document.getElementById('keadaanPtkPaudTable');
            if(!table) return;

            // Fungsi Hitung Ulang
            var updateFooter = function() {
                var tbody = table.querySelector('tbody');
                var tfoot = table.querySelector('tfoot');
                
                // Buat tfoot jika belum ada
                if(!tfoot) {
                    tfoot = document.createElement('tfoot');
                    table.appendChild(tfoot);
                }

                var totals = new Array(headersList.length).fill(0);
                var trs = Array.from(tbody.querySelectorAll('tr'));
                var hasVisible = false;

                // Hitung data yang terlihat (tidak di-hidden filter)
                trs.forEach(function(tr) {
                    if(tr.style.display !== 'none') {
                        hasVisible = true;
                        var tds = tr.querySelectorAll('td');
                        
                        headersList.forEach(function(h, i) {
                            // Mulai hitung dari kolom ke-6 (Index 5: Jml Rombel)
                            if(i >= 5) { 
                                // Ambil text sel (index i+1 karena ada kolom No)
                                var txt = tds[i+1] ? tds[i+1].innerText : "0";
                                var val = parseFloat(txt.replace(/[^\d.-]/g, '')) || 0;
                                totals[i] += val;
                            }
                        });
                    }
                });

                // Tulis ke HTML Footer
                tfoot.innerHTML = "";
                if(hasVisible) {
                    var tr = document.createElement('tr');
                    
                    // Kolom No (Kosong)
                    tr.appendChild(document.createElement('td'));

                    headersList.forEach(function(h, index) {
                        var td = document.createElement('td');
                        
                        if(index === 0) { // Nama Lembaga -> Label JUMLAH
                            td.textContent = "JUMLAH";
                            td.style.textAlign = "left";
                        } 
                        else if(index >= 1 && index < 5) { // Jenjang s.d Tahun -> Strip
                            td.textContent = "-";
                            td.style.textAlign = "center";
                        } 
                        else { 
                            td.textContent = totals[index]; // Angka Total
                            td.style.textAlign = "center";
                        }
                        tr.appendChild(td);
                    });
                    tfoot.appendChild(tr);
                }
            };

            // Jalankan Hitung Awal
            updateFooter();

            // Pasang Trigger saat Filter/Search berubah
            var filterEl = document.getElementById('filterJenjang');
            var searchEl = document.getElementById('searchKeadaanPaud');
            
            if(filterEl) {
                // Gunakan onchange agar tidak menimpa listener lain
                filterEl.addEventListener('change', function() { setTimeout(updateFooter, 250); });
            }
            if(searchEl) {
                searchEl.addEventListener('keyup', function() { setTimeout(updateFooter, 350); });
                searchEl.addEventListener('search', function() { setTimeout(updateFooter, 350); });
            }
        }
    });
};

// --- INIT HALAMAN JUMLAH PTK BULANAN PAUD ---
App.inits['ptk_jumlah_bulanan_paud'] = function() {

    var col = function(name, style) { return { name: name, tdStyle: style || '' }; };

    // Daftar Urutan Bulan yang Benar
    var listBulan = [
        "Januari", "Februari", "Maret", "April", "Mei", "Juni", 
        "Juli", "Agustus", "September", "Oktober", "November", "Desember"
    ];

    App.initSmartTable({
        tableId: 'ptkJumlahBulananPaudTable',
        serverFunc: 'getPtkJumlahBulananPaudData',
        
        headers: [
          "Nama Lembaga", "Jenjang", "Status", "Bulan", "Tahun", 
          "Jumlah Rombel", "KS PNS", "KS Non ASN", "Guru PNS", "Guru PPPK", 
          "GTY", "GTT", "Penjaga", "Tenaga Admin", "Pustakawan", "Tendik Lain", 
          col("Jumlah PTK", "background-color:#f8fafc; font-weight:bold;") 
        ],

        autoHideZero: true,
        addTotalRow: true,
        totalStartCol: 7,

        filters: [
            // Tahun Descending (2025, 2024...)
            { id: 'filterTahun', col: 'Tahun', label: '-- Tahun --', desc: true },
            // Bulan Custom Sort (Jan, Feb...)
            { id: 'filterBulan', col: 'Bulan', label: '-- Bulan --', sortOrder: listBulan },
            { id: 'filterJenjang', col: 'Jenjang', label: '-- Jenjang --' },
            { id: 'filterNamaLembaga', col: 'Nama Lembaga', label: '-- Nama Lembaga --' }
        ],

        // SET DEFAULT VALUE SAAT LOAD
        onLoad: function(rows) {
            var now = new Date();
            var curYear = now.getFullYear().toString();
            
            // Logika Bulan Lalu
            var prevMonthIndex = now.getMonth() - 1; 
            if (prevMonthIndex < 0) {
                prevMonthIndex = 11;
                curYear = (now.getFullYear() - 1).toString();
            }
            var prevMonthName = listBulan[prevMonthIndex];

            // Set Dropdown Tahun (Jika belum dipilih)
            var elTahun = document.getElementById('filterTahun');
            if (elTahun && elTahun.value === "") {
                // Cek apakah tahun tsb ada di opsi
                for(var i=0; i<elTahun.options.length; i++) {
                    if(elTahun.options[i].value == curYear) {
                        elTahun.value = curYear;
                        elTahun.dispatchEvent(new Event('change')); 
                        break;
                    }
                }
            }

            // Set Dropdown Bulan (Jika belum dipilih)
            var elBulan = document.getElementById('filterBulan');
            if (elBulan && elBulan.value === "") {
                for(var i=0; i<elBulan.options.length; i++) {
                    if(elBulan.options[i].value == prevMonthName) {
                        elBulan.value = prevMonthName;
                        elBulan.dispatchEvent(new Event('change')); 
                        break;
                    }
                }
            }
        },

        // LOGIKA FILTER BERANTAI
        onFilterChange: function(filterId, value, filteredRows, allRows) {
            if(filterId === 'filterJenjang') {
                var elNama = document.getElementById('filterNamaLembaga');
                if(!elNama) return;
                
                var currentVal = elNama.value;
                elNama.innerHTML = '<option value="">-- Nama Lembaga --</option>';
                
                // Ambil sekolah sesuai Jenjang yang dipilih
                var sourceData = value ? allRows.filter(r => r.Jenjang === value) : allRows;
                var names = [];
                sourceData.forEach(r => { if(r['Nama Lembaga']) names.push(r['Nama Lembaga']); });
                var uniqueNames = names.filter((v, i, a) => a.indexOf(v) === i).sort();
                
                uniqueNames.forEach(n => elNama.add(new Option(n, n)));
                if(uniqueNames.includes(currentVal)) elNama.value = currentVal;
            }
        }
    });
};

// --- INIT HALAMAN DAFTAR PTK PAUD ---
App.inits['ptk_daftar_paud'] = function() {
    
    // Helper Kolom (Nama, Style)
    var col = function(name, style) { return { name: name, tdStyle: style || '' }; };

    App.initSmartTable({
        tableId: 'daftarPtkPaudTable', 
        serverFunc: 'getPtkDaftarPaudData',

        headers: [
            "Nama Lengkap", 
            col("Nama Lembaga", "text-align:left;"),
            "Jenjang",
            "Status", 
            "NIP/NIY", 
            "Pangkat, Gol./Ruang", 
            "NUPTK", 
            "Jabatan", 
            "TMT", 
            "L/P", 
            "Tempat Lahir", 
            
            // Format Tanggal Lahir
            { 
                name: "Tanggal Lahir", 
                formatter: function(r) {
                    var v = r["Tanggal Lahir"];
                    if(String(v).includes("T")) return v.split("T")[0]; 
                    return v;
                }
            },
            
            "Pendidikan", 
            "Jurusan", 
            "Tahun Lulus", 
            "Serdik", 
            "Dapodik",

            {
                name: "Pensiun",
                formatter: function(r) {
                    var tglStr = r["Pensiun"];
                    if(!tglStr || tglStr === "") return "-";

                    // 1. Parse Tanggal Pensiun (dd-MM-yyyy)
                    var parts = tglStr.split('-');
                    var pDate = new Date(parts[2], parts[1]-1, parts[0]); // yyyy, mm-1, dd
                    var now = new Date();
                    
                    // Reset jam agar hitungan hari akurat
                    now.setHours(0,0,0,0);
                    
                    // 2. Hitung Selisih Hari
                    var diffTime = pDate - now;
                    var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    // 3. Tentukan Style Badge
                    var style = "padding: 2px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; display: inline-block; min-width: 80px; text-align: center;";
                    var label = tglStr; // Default tampilkan tanggal
                    
                    if (diffDays < 0) {
                        // SUDAH PENSIUN (Lewat Tanggal) -> Hitam/Dark
                        style += "background-color: #2d3436; color: #fff;";
                        label += " (Pensiun)";
                    } 
                    else if (diffDays <= 30) {
                        // < 1 BULAN -> Merah (Kritis)
                        style += "background-color: #e74c3c; color: #fff; box-shadow: 0 0 5px rgba(231, 76, 60, 0.5);";
                        label += " (<1 Bln)";
                    }
                    else if (diffDays <= 90) {
                        // < 3 BULAN -> Oranye (Waspada)
                        style += "background-color: #e67e22; color: #fff;";
                    }
                    else if (diffDays <= 180) {
                        // < 6 BULAN -> Kuning (Perhatian)
                        style += "background-color: #f1c40f; color: #2c3e50;";
                    }
                    else if (diffDays <= 365) {
                        // < 1 TAHUN -> Biru (Info)
                        style += "background-color: #3498db; color: #fff;";
                    }
                    else {
                        // MASIH LAMA -> Putih/Biasa
                        return tglStr;
                    }

                    return `<span style="${style}">${label}</span>`;
                }
            }
        ],
        
        autoHideZero: true, 

        // ... Bagian Filters & onFilterChange TETAP SAMA seperti sebelumnya ...
        filters: [
            { id: 'filterJenjang', col: 'Jenjang', label: '-- Jenjang --' },
            { id: 'filterNamaLembaga', col: 'Nama Lembaga', label: '-- Nama Lembaga --' },
            { id: 'filterStatus', col: 'Status', label: '-- Status --' },
            { id: 'filterPendidikan', col: 'Pendidikan', label: '-- Pendidikan --' },
            { id: 'filterSerdik', col: 'Serdik', label: '-- Serdik --' },
            { id: 'filterDapodik', col: 'Dapodik', label: '-- Dapodik --' }
        ],
        
        onFilterChange: function(filterId, value, filteredRows, allRows) {
            if(filterId === 'filterJenjang') {
                var elNama = document.getElementById('filterNamaLembaga');
                if(!elNama) return;
                var currentVal = elNama.value;
                elNama.innerHTML = '<option value="">-- Nama Lembaga --</option>';
                var sourceData = value ? allRows.filter(r => r['Jenjang'] === value) : allRows;
                var names = [];
                sourceData.forEach(r => { if(r['Nama Lembaga']) names.push(r['Nama Lembaga']); });
                var uniqueNames = names.filter((v, i, a) => a.indexOf(v) === i).sort();
                uniqueNames.forEach(n => elNama.add(new Option(n, n)));
                if(uniqueNames.includes(currentVal)) elNama.value = currentVal;
            }
        }
    });
};

// --- LOGIKA HALAMAN KELOLA PTK ---

// Object Helper Khusus Kelola PTK
App.ptkKelola = {
    // 1. Buka Modal (Kosong untuk Baru, Isi untuk Edit)
    openModal: function(rowData) {
        var form = document.getElementById('formPtk');
        form.reset(); // Kosongkan form dulu
        document.getElementById('rowId').value = ""; // Reset ID
        document.getElementById('modalTitle').textContent = "Tambah Data Baru";

        if (rowData) {
            // MODE EDIT: Isi form dengan data
            document.getElementById('modalTitle').textContent = "Edit Data PTK";
            document.getElementById('rowId').value = rowData._rowIndex; // ID Kunci!
            
            // Mapping field manual (pastikan name di HTML sama dengan key di object rowData)
            // Note: Header dari server adalah 'Nama Lengkap', di HTML name='namaLengkap'.
            // Kita perlu mapping sedikit.
            var f = form.elements;
            f.namaLengkap.value = rowData['Nama Lengkap'] || "";
            f.namaLembaga.value = rowData['Nama Lembaga'] || "";
            f.jenjang.value = rowData['Jenjang'] || "KB";
            f.status.value = rowData['Status'] || "";
            f.nipNiy.value = rowData['NIP/NIY'] || "";
            f.pangkat.value = rowData['Pangkat, Gol./Ruang'] || "";
            f.nuptk.value = rowData['NUPTK'] || "";
            f.jabatan.value = rowData['Jabatan'] || "";
            f.tmt.value = rowData['TMT'] || "";
            f.gender.value = rowData['L/P'] || "P";
            f.tempatLahir.value = rowData['Tempat Lahir'] || "";
            
            // Format Tanggal untuk Input Date (yyyy-mm-dd)
            if(rowData['Tanggal Lahir']) {
                var d = new Date(rowData['Tanggal Lahir']);
                if(!isNaN(d)) f.tanggalLahir.value = d.toISOString().split('T')[0];
            }
            
            f.pendidikan.value = rowData['Pendidikan'] || "";
            f.jurusan.value = rowData['Jurusan'] || "";
            f.tahunLulus.value = rowData['Tahun Lulus'] || "";
            f.serdik.value = rowData['Serdik'] || "Belum";
            f.dapodik.value = rowData['Dapodik'] || "Belum";
        }
        
        document.getElementById('modalFormPtk').style.display = 'flex';
    },

    closeModal: function() {
        document.getElementById('modalFormPtk').style.display = 'none';
    },

    // 2. Submit Form (Simpan/Edit)
    submit: function(e) {
        e.preventDefault();
        var form = document.getElementById('formPtk');
        var btn = form.querySelector('.btn-save');
        var originalText = btn.textContent;
        
        btn.textContent = "Menyimpan...";
        btn.disabled = true;

        google.script.run.withSuccessHandler(function(res) {
            btn.textContent = originalText;
            btn.disabled = false;
            if(res.success) {
                App.ptkKelola.closeModal();
                Swal.fire('Berhasil', res.message, 'success');
                App.inits['ptk_kelola'](); // Refresh Tabel
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        }).simpanPtkPaud(form); // Kirim Form HTML langsung
    },

    // 3. Hapus Data
    delete: function(rowIndex, nama) {
        Swal.fire({
            title: 'Hapus Data?',
            text: "Anda akan menghapus data: " + nama,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'Ya, Hapus!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Tampilkan loading
                Swal.fire({title: 'Menghapus...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() }});
                
                google.script.run.withSuccessHandler(function(res) {
                    if(res.success) {
                        Swal.fire('Terhapus!', res.message, 'success');
                        App.inits['ptk_kelola'](); // Refresh Tabel
                    } else {
                        Swal.fire('Gagal', res.message, 'error');
                    }
                }).hapusPtkPaud(rowIndex);
            }
        });
    }
};

// ============================================================
// 1. UPDATE ROUTING (Biasanya di bagian paling atas javascript.html)
// ============================================================
// Pastikan variabel 'routes' Anda mencakup baris ini:
/*
var routes = {
    // ...
    'ptk_kelola_paud': 'page_ptk_kelola', // Route PAUD ke file ini
    'ptk_kelola_sd': 'page_ptk_kelola',   // Route SD juga ke file ini
    // ...
};
*/


// ============================================================
// 2. LOGIKA KELOLA PTK (MULTI-JENJANG)
// ============================================================

App.ptkKelola = {
    currentJenjang: 'PAUD',

    // --- 1. CONFIG HEADER TABEL (BEDA PAUD & SD) ---
    getTableHeaders: function() {
        if (this.currentJenjang === 'PAUD') {
            return ["Nama Lengkap", "Nama Lembaga", "Jenjang", "Status", "Jabatan"];
        } else {
            // SD (Header Baru)
            return ["Nama Lengkap", "Nama Sekolah", "Status Pegawai", "Jabatan", "Tugas"];
        }
    },

    // --- 2. SWITCH & REFRESH ---
    switchJenjang: function(jenjang) {
        this.currentJenjang = jenjang;
        var btnPaud = document.getElementById('tabPaud');
        var btnSd = document.getElementById('tabSd');
        if(btnPaud && btnSd) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            (jenjang === 'SD' ? btnSd : btnPaud).classList.add('active');
            var lbl = document.getElementById('labelJenjang');
            if(lbl) lbl.textContent = jenjang;
        }
        this.refresh();
    },

    refresh: function() {
        // Ambil header dinamis
        var displayHeaders = this.getTableHeaders(); 
        
        // Tambah kolom Aksi di depan
        var finalHeaders = [
            { 
                name: "Aksi", width: "100px",
                formatter: function(r) {
                    var rowJson = JSON.stringify(r).replace(/"/g, '&quot;');
                    return `<button class="action-btn-sm btn-edit" onclick="App.ptkKelola.openModal(JSON.parse('${rowJson}'))"><i class="fas fa-edit"></i></button>
                            <button class="action-btn-sm btn-del" onclick="App.ptkKelola.delete('${r._rowIndex}', '${r['Nama Lengkap']}')"><i class="fas fa-trash"></i></button>`;
                }
            }
        ].concat(displayHeaders);

        App.initSmartTable({
            tableId: 'kelolaPtkTable', 
            serverFunc: 'getKelolaPtkData', 
            params: { jenjang: this.currentJenjang },
            headers: finalHeaders, // Header dinamis
            autoHideZero: true,
            filters: [{ id: 'searchFilter', col: 'Nama Lengkap' }]
        });
    },

    // --- 3. OPEN MODAL & MAPPING (BEDA PAUD & SD) ---
    openModal: function(rowData) {
        var form = document.getElementById('formPtk');
        form.reset();
        document.getElementById('rowId').value = "";
        document.getElementById('targetJenjang').value = this.currentJenjang;
        document.getElementById('modalTitle').textContent = "Data " + this.currentJenjang;

        // Tampilkan/Sembunyikan Field Khusus SD
        // (Misal: Agama, Tugas, Tugas Tambahan hanya relevan di SD, di PAUD bisa disembunyikan atau dibiarkan kosong)
        // Disini kita biarkan tampil semua biar tidak rumit, tapi mappingnya kita bedakan.

        if (rowData) {
            document.getElementById('modalTitle').textContent = "Edit " + this.currentJenjang;
            document.getElementById('rowId').value = rowData._rowIndex;
            var f = form.elements;
            
            // MAPPING UMUM
            f.namaLengkap.value = rowData['Nama Lengkap'] || "";
            f.gender.value      = rowData['L/P'] || "L";
            f.tempatLahir.value = rowData['Tempat Lahir'] || "";
            if(rowData['Tanggal Lahir']) {
                var d = new Date(rowData['Tanggal Lahir']);
                if(!isNaN(d)) f.tanggalLahir.value = d.toISOString().split('T')[0];
            }
            f.pendidikan.value  = rowData['Pendidikan'] || "";
            f.jurusan.value     = rowData['Jurusan'] || "";
            f.tahunLulus.value  = rowData['Tahun Lulus'] || "";
            f.nuptk.value       = rowData['NUPTK'] || "";
            f.dapodik.value     = rowData['Dapodik'] || "Belum";
            f.serdik.value      = rowData['Serdik'] || "Belum";

            // === MAPPING SPESIFIK ===
            if (this.currentJenjang === 'PAUD') {
                // Header PAUD: Nama Lembaga, Jenjang, Status, NIP/NIY, Pangkat, Gol./Ruang
                f.namaSekolah.value = rowData['Nama Lembaga'] || ""; // Field form pakai namaSekolah, data dari Nama Lembaga
                f.status.value      = rowData['Status'] || "";
                f.nip.value         = rowData['NIP/NIY'] || "";
                f.pangkat.value     = rowData['Pangkat, Gol./Ruang'] || "";
                f.jabatan.value     = rowData['Jabatan'] || "";
                f.tmt.value         = rowData['TMT'] || "";
                
                // Field SD dikosongkan saat mode PAUD
                f.tugas.value = "";
                f.agama.value = "";
                f.tugasTambahan.value = "";
            } 
            else {
                // Header SD: Nama Sekolah, Status Pegawai, TMT, NIP, Pangkat, Gol./Ruang
                f.namaSekolah.value = rowData['Nama Sekolah'] || "";
                f.status.value      = rowData['Status Pegawai'] || "";
                f.nip.value         = rowData['NIP'] || "";
                f.pangkat.value     = rowData['Pangkat, Gol./Ruang'] || "";
                f.jabatan.value     = rowData['Jabatan'] || "";
                f.tmt.value         = rowData['TMT'] || "";
                f.tugas.value       = rowData['Tugas'] || "";
                f.agama.value       = rowData['Agama'] || "Islam";
                f.tugasTambahan.value = rowData['Tugas Tambahan'] || "";
            }
        }
        document.getElementById('modalFormPtk').style.display = 'flex';
    },
    
    // ... Close, Submit, Delete SAMA ...
    closeModal: function() { document.getElementById('modalFormPtk').style.display = 'none'; },
    submit: function(e) {
        e.preventDefault();
        var form = document.getElementById('formPtk');
        var btn = form.querySelector('.btn-save');
        var txt = btn.textContent; btn.textContent="Menyimpan..."; btn.disabled=true;
        google.script.run.withSuccessHandler(res=>{
            btn.textContent=txt; btn.disabled=false;
            if(res.success){ App.ptkKelola.closeModal(); Swal.fire('Oke',res.message,'success'); App.ptkKelola.refresh(); }
            else Swal.fire('Gagal',res.message,'error');
        }).simpanPtk(form);
    },
    delete: function(r,n) {
        Swal.fire({title:'Hapus?',text:n,icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(res=>{
            if(res.isConfirmed) google.script.run.withSuccessHandler(r=>{ if(r.success) App.ptkKelola.refresh(); }).hapusPtk(r, App.ptkKelola.currentJenjang);
        });
    }
};


// ============================================================
// 3. INIT HALAMAN (SESUAI MENU SIDEBAR)
// ============================================================

// Helper untuk init
App.initKelolaPtk = function(defaultJenjang) {
    App.ptkKelola.switchJenjang(defaultJenjang);
};

// 1. Jika menu 'ptk_kelola_paud' diklik
App.inits['ptk_kelola_paud'] = function() {
    App.initKelolaPtk('PAUD'); 
};

// 2. Jika menu 'ptk_kelola_sd' diklik
App.inits['ptk_kelola_sd'] = function() {
    App.initKelolaPtk('SD');
};

// ==========================================
// LOGIKA KHUSUS SD (App.ptkKelolaSd)
// ==========================================
App.ptkKelolaSd = {
    // Refresh khusus SD
    refresh: function() {
        App.initSmartTable({
            tableId: 'kelolaSdTable', // ID Tabel di HTML SD
            serverFunc: 'getKelolaSdData', // Panggil fungsi backend SD
            headers: [
                { 
                    name: "Aksi", width: "100px",
                    formatter: function(r) {
                         var rowJson = JSON.stringify(r).replace(/"/g, '&quot;');
                         // Perhatikan pemanggilannya: App.ptkKelolaSd
                         return `<button class="action-btn-sm btn-edit" onclick="App.ptkKelolaSd.openModal(JSON.parse('${rowJson}'))"><i class="fas fa-edit"></i></button>
                                 <button class="action-btn-sm btn-del" onclick="App.ptkKelolaSd.delete('${r._rowIndex}', '${r['Nama Lengkap']}')"><i class="fas fa-trash"></i></button>`;
                    }
                },
                "Nama Lengkap", "Nama Sekolah", "Status Pegawai", "Jabatan", "Tugas"
            ],
            autoHideZero: true,
            filters: [{ id: 'searchFilterSd', col: 'Nama Lengkap' }]
        });
    },

    openModal: function(rowData) {
        var form = document.getElementById('formPtkSd'); // ID Form khusus SD
        form.reset();
        document.getElementById('rowIdSd').value = ""; // ID Input Hidden khusus SD
        document.getElementById('modalTitleSd').textContent = "Tambah Data SD";
        
        if (rowData) {
            document.getElementById('modalTitleSd').textContent = "Edit Data SD";
            document.getElementById('rowIdSd').value = rowData._rowIndex;
            
            // MAPPING KHUSUS SD (19 Field)
            var f = form.elements;
            f.namaLengkap.value = rowData['Nama Lengkap'] || "";
            f.namaSekolah.value = rowData['Nama Sekolah'] || "";
            f.status.value      = rowData['Status Pegawai'] || "";
            f.tugas.value       = rowData['Tugas'] || "";
            f.agama.value       = rowData['Agama'] || "Islam";
            f.tugasTambahan.value = rowData['Tugas Tambahan'] || "";
            // ... (Lanjutkan mapping field lainnya: NIP, TMT, dll) ...
        }
        document.getElementById('modalFormSd').style.display = 'flex';
    },

    closeModal: function() { document.getElementById('modalFormSd').style.display = 'none'; },

    submit: function(e) {
        e.preventDefault();
        var form = document.getElementById('formPtkSd');
        // ... (Loading animation) ...
        google.script.run.withSuccessHandler(res => {
            if(res.success) { 
                App.ptkKelolaSd.closeModal(); 
                App.ptkKelolaSd.refresh(); // Refresh tabel SD
                Swal.fire('Sukses', res.message, 'success');
            }
        }).simpanSd(form); // Panggil fungsi backend SD
    },

    delete: function(idx, name) {
        // ... (Konfirmasi SWAL) ...
        // Panggil fungsi backend: hapusSd(idx)
        google.script.run.withSuccessHandler(res => {
             App.ptkKelolaSd.refresh(); 
        }).hapusSd(idx);
    }
};

// INIT SD
App.inits['ptk_kelola_sd'] = function() {
    App.ptkKelolaSd.refresh();
};

// ============================================================
// LOGIKA FRONTEND KHUSUS PAUD (App.ptkKelolaPaud)
// ============================================================

App.ptkKelolaPaud = {
    allLembaga: [], isLembagaLoaded: false, currentTab: 1,

    initData: function() {
        if (!this.isLembagaLoaded) {
            var that = this;
            google.script.run.withSuccessHandler(function(d) { that.allLembaga = d; that.isLembagaLoaded = true; }).getLembagaList();
        }
    },

    refresh: function() {
        var fmtDate = function(row, key) {
            var val = row[key]; if(!val) return "-";
            var parts = String(val).split('-');
            if(parts.length === 3) return `<span style="color:#334155;">${parts[2]}-${parts[1]}-${parts[0]}</span>`;
            return val; 
        };

        App.initSmartTable({
             tableId: 'kelolaPaudTable', serverFunc: 'getKelolaPaudData',
             headers: [ 
                 "Nama Lengkap", 
                 { name: "Nama Lembaga", tdStyle: "text-align:left;" }, 
                 "Jenjang", "Status", "Jabatan",
                 { name: "TMT", formatter: fmtDate }, 
                 { name: "Tanggal Lahir", formatter: fmtDate },
                 
                 { 
                      name: "Aksi", 
                      width: "100px", 
                      formatter: function(r) {
                          var rowJson = JSON.stringify(r).replace(/"/g, '&quot;');
                          return `
                          <div style="display:flex; gap:5px; justify-content:center;">
                              <button class="action-btn-sm btn-edit" title="Edit Data" onclick="App.ptkKelolaPaud.openModal(JSON.parse('${rowJson}'))">
                                  <i class="fas fa-edit"></i>
                              </button>
                              
                              <button class="action-btn-sm btn-mutasi" title="Mutasi / Nonaktifkan" onclick="App.ptkKelolaPaud.openMutasiModal(JSON.parse('${rowJson}'))">
                                  <i class="fas fa-exchange-alt"></i>
                              </button>
                          </div>`;
                      }
                  },
                 
                 // FORMAT TAMPILAN
                 { name: "Tanggal Input", tdStyle: "font-size:0.85em; color:#64748b;" },
                 { name: "Input By", tdStyle: "font-size:0.85em; color:#64748b; text-align:left;" },
                 { name: "Tanggal Update", tdStyle: "font-size:0.85em; color:#64748b;" },
                 
                 // Update By (Seharusnya sekarang bersih, hanya nama User)
                 { name: "Update By", tdStyle: "font-size:0.85em; color:#64748b; text-align:left;" },
                 
                 // Keterangan Mutasi (Kolom V)
                 { name: "Keterangan", tdStyle: "font-size:0.85em; color:#334155; text-align:left; white-space:nowrap; overflow:hidden;" }
             ],
             autoHideZero: true, filters: [{ id: 'searchFilterPaud', col: 'Nama Lengkap' }]
        });
    },

    // ============================================
    // LOGIKA BARU: MUTASI & NONAKTIFKAN
    // ============================================
    
    openMutasiModal: function(row) {
        var m = document.getElementById('modalMutasiPaud');
        var f = document.getElementById('formMutasiPaud');
        f.reset();
        
        // Isi Hidden ID & User
        document.getElementById('rowIdMutasi').value = row._rowIndex;
        try {
            var s = JSON.parse(localStorage.getItem('user_session') || '{}');
            document.getElementById('userMutasi').value = s.nama || 'Admin';
        } catch(e){}

        // Tampilkan Info
        document.getElementById('mutasiNamaPtk').textContent = row['Nama Lengkap'];
        document.getElementById('mutasiLembagaAsal').textContent = row['Nama Lembaga'] + " (" + row['Jenjang'] + ")";

        // --- UPDATE: ISI DROPDOWN JENJANG (UNIK) ---
        var elJenjang = document.getElementById('mutasiJenjang');
        elJenjang.innerHTML = '<option value="">-- Pilih Jenjang --</option>';
        
        // Ambil daftar jenjang unik dari data lembaga yang sudah ada
        if (this.allLembaga && this.allLembaga.length > 0) {
            // Ambil unique jenjang: ["TK", "KB", "SPS", ...]
            var unik = [...new Set(this.allLembaga.map(l => l.jenjang))].sort();
            unik.forEach(function(j) {
                elJenjang.add(new Option(j, j));
            });
        }

        // Reset Dropdown Lembaga
        var elLembaga = document.getElementById('mutasiLembagaBaru');
        elLembaga.innerHTML = '<option value="">-- Pilih Jenjang Terlebih Dahulu --</option>';
        elLembaga.disabled = true;

        // Reset Tampilan Form
        this.toggleMutasiForm();
        m.style.display = 'flex';
    },

    // --- FUNGSI BARU: FILTER LEMBAGA MUTASI BERDASARKAN JENJANG ---
    filterLembagaMutasi: function() {
        var jenjang = document.getElementById('mutasiJenjang').value;
        var elLembaga = document.getElementById('mutasiLembagaBaru');
        
        // Reset isi
        elLembaga.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
        
        if (!jenjang) {
            elLembaga.disabled = true;
            return;
        }

        elLembaga.disabled = false;

        // Filter dari this.allLembaga
        var hasilFilter = this.allLembaga.filter(function(l) {
            return l.jenjang === jenjang;
        });

        // Urutkan Abjad
        hasilFilter.sort(function(a, b) {
            return a.nama.localeCompare(b.nama);
        });

        // Masukkan ke Dropdown
        hasilFilter.forEach(function(l) {
            elLembaga.add(new Option(l.nama, l.nama));
        });
    },

    closeMutasiModal: function() {
        document.getElementById('modalMutasiPaud').style.display = 'none';
    },

    toggleMutasiForm: function() {
        var val = document.getElementById('jenisTindakan').value;
        var pPindah = document.getElementById('panelPindah');
        var pKeluar = document.getElementById('panelKeluar');
        var pUmum = document.getElementById('panelUmum');
        
        // Input Elements
        var inpJenjang = document.getElementById('mutasiJenjang');
        var inpLembaga = document.getElementById('mutasiLembagaBaru');
        var inpAlasan = document.getElementById('alasanMutasi');

        pPindah.style.display = 'none';
        pKeluar.style.display = 'none';
        pUmum.style.display = 'none';
        
        // Reset Required
        inpJenjang.required = false;
        inpLembaga.required = false;
        inpAlasan.required = false;

        if (val === 'pindah') {
            pPindah.style.display = 'block';
            pUmum.style.display = 'block';
            // Set Required untuk Pindah
            inpJenjang.required = true;
            inpLembaga.required = true;
        } else if (val === 'keluar') {
            pKeluar.style.display = 'block';
            pUmum.style.display = 'block';
            inpAlasan.required = true;
        }
    },

    submitMutasi: function(e) {
        e.preventDefault();
        var form = document.getElementById('formMutasiPaud');
        
        // Pastikan input yang disabled (Lembaga Baru) dibuka sebentar agar terbaca validasinya
        var inpLembaga = document.getElementById('mutasiLembagaBaru');
        var isDisabled = inpLembaga.disabled;
        inpLembaga.disabled = false; 

        if (!form.checkValidity()) { 
            form.reportValidity(); 
            if(isDisabled) inpLembaga.disabled = true; // Kembalikan state jika invalid
            return; 
        }
        
        // Jika valid, biarkan enabled agar terkirim valuenya
        
        var btn = form.querySelector('.btn-save');
        var oriText = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Memproses..."; 
        btn.disabled = true;

        google.script.run
        .withSuccessHandler(function(res) {
            btn.innerHTML = oriText; btn.disabled = false;
            if(res.success) {
                App.ptkKelolaPaud.closeMutasiModal();
                if(typeof Swal !== 'undefined') {
                    Swal.fire({ title: 'Berhasil', text: res.message, icon: 'success', width:'400px', timer:2000, showConfirmButton:false })
                    .then(() => App.ptkKelolaPaud.refresh());
                } else {
                    alert(res.message); App.ptkKelolaPaud.refresh();
                }
            } else {
                if(typeof Swal !== 'undefined') Swal.fire('Gagal', res.message, 'error');
                else alert(res.message);
            }
        })
        .withFailureHandler(function(err) {
            btn.innerHTML = oriText; btn.disabled = false;
            alert("Error: " + err.message);
        })
        .prosesMutasiPaud(form);
    },

    openModal: function(rowData) {
        var form = document.getElementById('formPtkPaud');
        form.reset(); 
        document.getElementById('rowIdPaud').value = ""; 
        document.getElementById('modalTitlePaud').textContent = "Tambah Data PTK PAUD";
        this.showTab(1); this.checkJurusan();

        // Ambil Nama User
        try {
            var sessionData = localStorage.getItem('user_session'); 
            var uName = 'Admin';
            if (sessionData) {
                var u = JSON.parse(sessionData);
                if (u.nama) uName = u.nama; 
            }
            document.getElementById('userPenginput').value = uName;
        } catch(e) { console.error(e); }

        // Variabel elemen input untuk dikunci/buka
        var inpJenjang = document.getElementById('inputJenjang');
        var inpLembaga = document.getElementById('inputNamaLembaga');

        if (rowData) {
            // --- MODE EDIT ---
            document.getElementById('modalTitlePaud').textContent = "Edit Data PTK PAUD";
            document.getElementById('rowIdPaud').value = rowData._rowIndex;
            
            // [REQUEST BARU] KUNCI FIELD LEMBAGA SAAT EDIT
            inpJenjang.disabled = true;
            inpLembaga.disabled = true;
            inpJenjang.style.backgroundColor = "#f1f5f9"; // Visual abu-abu
            inpLembaga.style.backgroundColor = "#f1f5f9";

            var f = form.elements;
            
            // Isi Data
            f.jenjang.value = rowData['Jenjang'] || "";
            
            // Kita harus memanggil filterLembaga() dulu lalu set value, 
            // ATAU manual add option jika disabled (untuk keamanan UI)
            this.filterLembaga(); 
            f.namaLembaga.value = rowData['Nama Lembaga'] || "";

            f.namaLengkap.value = rowData['Nama Lengkap'] || "";
            f.gender.value      = rowData['L/P'] || "";
            f.tempatLahir.value = rowData['Tempat Lahir'] || "";
            f.tanggalLahir.value = rowData['Tanggal Lahir'] || ""; 
            f.pendidikan.value  = rowData['Pendidikan'] || "";
            this.checkJurusan();
            f.jurusan.value     = rowData['Jurusan'] || "";
            f.tahunLulus.value  = rowData['Tahun Lulus'] || "";
            f.nuptk.value       = rowData['NUPTK'] || "";
            f.serdik.value      = rowData['Serdik'] || "";
            f.dapodik.value     = rowData['Dapodik'] || "";
            f.status.value      = rowData['Status'] || "";
            f.nip.value         = rowData['NIP/NIY'] || "";
            f.pangkat.value     = rowData['Pangkat, Gol./Ruang'] || "";
            f.jabatan.value     = rowData['Jabatan'] || "";
            f.tmt.value         = rowData['TMT'] || "";

        } else { 
            // --- MODE TAMBAH ---
            // BUKA KUNCI
            inpJenjang.disabled = false;
            inpLembaga.disabled = false;
            inpJenjang.style.backgroundColor = ""; 
            inpLembaga.style.backgroundColor = "";

            this.filterLembaga(); 
        }
        
        var mContent = document.querySelector('#modalFormPaud .modal-content');
        if(mContent) mContent.style.maxWidth = "800px"; 

        document.getElementById('modalFormPaud').style.display = 'flex';
    },

    closeModal: function() { document.getElementById('modalFormPaud').style.display = 'none'; },

    // Submit & Logika Lainnya TETAP SAMA
    submit: function(e) {
        if(e) e.preventDefault(); 
        var form = document.getElementById('formPtkPaud');
        if (!form.checkValidity()) { form.reportValidity(); return; }

        // [PENTING] Karena field disabled tidak terkirim saat submit,
        // kita perlu mengaktifkannya sebentar atau mengambil nilainya manual.
        // Cara termudah: Aktifkan sesaat sebelum kirim
        var inpJenjang = document.getElementById('inputJenjang');
        var inpLembaga = document.getElementById('inputNamaLembaga');
        inpJenjang.disabled = false;
        inpLembaga.disabled = false;

        var btn = form.querySelector('.btn-save');
        var originalText = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Menyimpan..."; 
        btn.disabled = true;
        
        google.script.run
        .withSuccessHandler(function(res) {
            btn.innerHTML = originalText; btn.disabled = false;
            if(res && res.success) { 
                App.ptkKelolaPaud.closeModal(); 
                if(typeof Swal !== 'undefined') {
                     Swal.fire({
                        title: 'Berhasil!',
                        text: res.message,
                        icon: 'success',
                        width: '400px',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => App.ptkKelolaPaud.refresh());
                } else {
                    alert(res.message);
                    App.ptkKelolaPaud.refresh();
                }
            } else {
                if(typeof Swal !== 'undefined') Swal.fire({ title: 'Gagal', text: res.message, icon: 'error', width: '400px' });
                else alert(res.message);
            }
        })
        .withFailureHandler(function(err) {
            btn.innerHTML = originalText; btn.disabled = false;
            alert(err.message);
        })
        .simpanPaud(form);
    },
    
    // Copy Helper Tab & Delete (Sama seperti sebelumnya)
    nextTab: function(t) { var cur = document.getElementById('tab'+this.currentTab); var inps=cur.querySelectorAll('input,select'); var ok=true; for(var i=0; i<inps.length; i++){ if(!inps[i].checkValidity()){ inps[i].reportValidity(); ok=false; break; }} if(ok) this.showTab(t); },
    prevTab: function(t) { this.showTab(t); },
    showTab: function(n) { this.currentTab=n; document.querySelectorAll('#formPtkPaud .tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('#formPtkPaud .tab-link').forEach(e=>e.classList.remove('active')); document.getElementById('tab'+n).classList.add('active'); document.getElementById('btnTab'+n).classList.add('active'); for(var i=1; i<=3; i++) { document.getElementById('btnTab'+i).disabled = (i>n); } },
    filterLembaga: function() { var jenjang=document.getElementById('inputJenjang').value; var el=document.getElementById('inputNamaLembaga'); el.innerHTML='<option value="">-- Pilih Lembaga --</option>'; if(!jenjang) return; var f=this.allLembaga.filter(l=>l.jenjang===jenjang); f.forEach(l=>{ var o=document.createElement('option'); o.value=l.nama; o.text=l.nama; el.add(o); }); },
    checkJurusan: function() { var p=document.getElementById('inputPendidikan').value; var j=document.getElementById('inputJurusan'); var l=document.getElementById('labelJurusanReq'); if(p.includes('SD')||p.includes('SMP')||p==''){ j.required=false; l.style.display='none'; j.placeholder='Tidak wajib'; }else{ j.required=true; l.style.display='inline'; j.placeholder='Wajib diisi'; } },
    delete: function(r,n) { if(confirm("Hapus "+n+"?")) google.script.run.withSuccessHandler(()=>{ App.ptkKelolaPaud.refresh(); }).hapusPaud(r); }
};

App.inits['ptk_kelola_paud'] = function() {
    App.ptkKelolaPaud.initData(); 
    App.ptkKelolaPaud.refresh();
};

// ============================================
// CONTROLLER: DATA NON-AKTIF (RESTORE)
// ============================================
App.ptkNonAktifPaud = {
    refresh: function() {
        var tbody = document.querySelector('#tableNonAktifPaud tbody');
        if(tbody) tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#64748b;"><i class="fas fa-spinner fa-spin"></i> Memuat data arsip...</td></tr>';

        App.initSmartTable({
             tableId: 'tableNonAktifPaud', 
             serverFunc: 'getPtkNonAktifPaudData',
             headers: [ 
                 "Nama Lengkap", 
                 { name: "Nama Lembaga", tdStyle: "text-align:left;" }, 
                 "Jenjang", 
                 { name: "Jenis Mutasi", tdStyle: "text-align:left;", formatter: function(r) {
                     var val = r["Jenis Mutasi"] || "-";
                     var color = val.toLowerCase().includes('pindah') ? '#f59e0b' : '#ef4444'; 
                     return `<span style="background:${color}20; color:${color}; padding:2px 8px; border-radius:4px; font-weight:600; font-size:0.85em; display:inline-block;">${val}</span>`;
                 }},
                 { name: "Keterangan Mutasi", tdStyle: "text-align:left; color:#64748b; font-size:0.9em; max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" },
                 "Tanggal Nonaktif",
                 { name: "Aksi", width: "120px", formatter: function(r) {
                        var safeData = encodeURIComponent(r._fullData);
                        return `<button style="background:#10b981; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.85em; display:flex; align-items:center; gap:5px;" 
                                title="Aktifkan Kembali" 
                                onclick="App.ptkNonAktifPaud.restore('${r._rowIndex}', JSON.parse(decodeURIComponent('${safeData}')))">
                            <i class="fas fa-recycle"></i> Pulihkan
                        </button>`;
                 }}
             ],
             autoHideZero: true, 
             filters: [{ id: 'searchFilterNonAktifPaud', col: 'Nama Lengkap' }]
        });
    },

    // --- FUNGSI BARU: SUBMIT RESTORE ---
    submitRestore: function(e) {
        e.preventDefault(); // Mencegah reload halaman
        
        var form = e.target;
        var btn = form.querySelector('button[type="submit"]');
        var originalText = btn.innerHTML;

        // UI Feedback: Loading
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        btn.disabled = true;

        // Panggil Backend simpanPaud
        google.script.run
            .withSuccessHandler(function(res) {
                // Reset Tombol
                btn.innerHTML = originalText;
                btn.disabled = false;

                if (res.success) {
                    // Tutup Modal & Refresh Tabel Non Aktif
                    App.ptkNonAktifPaud.closeModal();
                    App.ptkNonAktifPaud.refresh();
                    
                    // Notifikasi Sukses
                    Swal.fire({
                        icon: 'success',
                        title: 'Berhasil!',
                        text: res.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire('Gagal!', res.message, 'error');
                }
            })
            .withFailureHandler(function(err) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                Swal.fire('Error Sistem', err.message, 'error');
            })
            .simpanPaud(form);
    },

    restore: function(rowIndexMutasi, dataArr) {
        var f = document.getElementById('formPtkPaud');
        if(!f) return;
        
        f.reset();
        document.getElementById('modalPtkPaud').style.display = 'flex';
        document.getElementById('isRestorePaud').value = "true";
        document.getElementById('rowIdSourcePaud').value = rowIndexMutasi;

        var el = f.elements;

        // HELPER SUNTIK OPSI
        var injectOption = function(selectEl, val) {
            if (!selectEl || !val) return;
            var exists = false;
            for (var i = 0; i < selectEl.options.length; i++) {
                if (selectEl.options[i].value === val) {
                    exists = true; break;
                }
            }
            if (!exists) {
                var opt = document.createElement('option');
                opt.value = val;
                opt.text = val;
                selectEl.add(opt);
            }
            selectEl.value = val;
        };

        var toInputDate = function(val) {
            if(!val) return "";
            var d = new Date(val);
            if(isNaN(d.getTime())) return "";
            return d.toISOString().split('T')[0];
        };

        // MAPPING DATA
        el.namaLengkap.value = dataArr[0] || "";
        injectOption(el.namaLembaga, dataArr[1]);
        injectOption(el.jenjang, dataArr[2]);
        injectOption(el.status, dataArr[3]);
        el.nip.value = dataArr[4] || "";
        el.pangkat.value = dataArr[5] || "";
        el.nuptk.value = dataArr[6] || "";
        injectOption(el.jabatan, dataArr[7]);
        el.tmt.value = toInputDate(dataArr[8]);
        injectOption(el.gender, dataArr[9]);
        el.tempatLahir.value = dataArr[10] || "";
        el.tanggalLahir.value = toInputDate(dataArr[11]);
        injectOption(el.pendidikan, dataArr[12]);
        el.jurusan.value = dataArr[13] || "";
        el.tahunLulus.value = dataArr[14] || "";
        injectOption(el.dapodik, dataArr[15]);
        injectOption(el.serdik, dataArr[16]);

        this.showTab(1);
    },

    showTab: function(n) {
        var contents = document.querySelectorAll('#modalPtkPaud .tab-content');
        contents.forEach(function(el) { el.style.display = 'none'; });
        
        var btns = document.querySelectorAll('#modalPtkPaud .tab-btn');
        btns.forEach(function(el) { 
            el.style.borderBottom = "3px solid transparent";
            el.style.color = "#64748b";
        });

        var targetContent = document.querySelector('#modalPtkPaud #tab' + n);
        var targetBtn = document.querySelector('#modalPtkPaud #tabBtn' + n);

        if(targetContent) targetContent.style.display = 'block';
        if(targetBtn) {
            targetBtn.style.borderBottom = "3px solid #3b82f6"; 
            targetBtn.style.color = "#3b82f6";
        }
    },

    closeModal: function() {
        document.getElementById('modalPtkPaud').style.display = 'none';
    }
};

// Pastikan Init Router-nya Benar
App.inits['ptk_non_aktif_paud'] = function() {
    console.log("Membuka Halaman Non Aktif PAUD...");
    App.ptkNonAktifPaud.refresh();
};

// Override fungsi openModal milik Kelola PAUD agar flag restore kereset otomatis
var originalOpenModal = App.ptkKelolaPaud.openModal;
App.ptkKelolaPaud.openModal = function(rowData) {
    // Panggil fungsi asli
    originalOpenModal.call(App.ptkKelolaPaud, rowData);

    // Reset Flag Restore (Kembali ke mode normal)
    if(document.getElementById('isRestorePaud')) {
        document.getElementById('isRestorePaud').value = "false";
        document.getElementById('rowIdSourcePaud').value = "";
        document.getElementById('modalTitlePaud').style.color = ""; 
    }
};

// Daftarkan ke sistem routing agar saat menu diklik, fungsi refresh jalan
App.inits['ptk_non_aktif'] = function() {
    App.ptkNonAktifPaud.refresh();
};

// ============================================
// INISIALISASI ROUTER (SESUAI DATA-PAGE)
// ============================================
App.inits['ptk_non_aktif_paud'] = function() {
    // Karena HTML sudah dimuat otomatis oleh router Anda ke #main-content
    // dan kita sudah menghapus display:none, maka kita cukup panggil datanya saja.
    
    console.log("Memuat Data Non Aktif PAUD..."); // Cek di console browser
    App.ptkNonAktifPaud.refresh();
};

// ============================================
// DASHBOARD CONTROLLER
// ============================================
App.ptkPaudMenu = {
    charts: {}, 

    refresh: function() {
        document.getElementById('c-lembaga-tot').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        google.script.run
            .withSuccessHandler(function(res) {
                App.ptkPaudMenu.render(res);
            })
            .withFailureHandler(function(err){
                Swal.fire('Error', 'Gagal memuat dashboard', 'error');
            })
            .getDashboardPaudData();
    },

    render: function(d) {
        const c = d.count;
        // Render Kartu
        document.getElementById('c-lembaga-kb').textContent = c.lembaga_kb;
        document.getElementById('c-lembaga-tk').textContent = c.lembaga_tk;
        document.getElementById('c-lembaga-tot').textContent = c.lembaga_kb + c.lembaga_tk;

        document.getElementById('c-ks-kb').textContent = c.ks_kb;
        document.getElementById('c-ks-tk').textContent = c.ks_tk;
        document.getElementById('c-ks-tot').textContent = c.ks_kb + c.ks_tk;

        document.getElementById('c-guru-kb').textContent = c.guru_kb;
        document.getElementById('c-guru-tk').textContent = c.guru_tk;
        document.getElementById('c-guru-tot').textContent = c.guru_kb + c.guru_tk;

        document.getElementById('c-tendik-kb').textContent = c.tendik_kb;
        document.getElementById('c-tendik-tk').textContent = c.tendik_tk;
        document.getElementById('c-tendik-tot').textContent = c.tendik_kb + c.tendik_tk;

        // Render List Tabel
        this.renderList('listPensiun', d.lists.pensiun, (i) => {
            let sisaStr = "";
            if(i.sisaHari > 365) sisaStr = Math.floor(i.sisaHari/365) + " Thn lg";
            else if(i.sisaHari > 30) sisaStr = Math.floor(i.sisaHari/30) + " Bln lg";
            else sisaStr = i.sisaHari + " Hari lg";
            return `<div><strong>${i.nama}</strong><br><small>${i.lembaga}</small></div>
                    <b style="color:#f59e0b; font-size:0.9em;">${sisaStr}</b>`;
        });

        this.renderList('listNoSerdik', d.lists.noserdik, (i) => 
            `<div><strong>${i.nama}</strong><br><small>${i.lembaga}</small></div><span style="font-size:0.8em; color:#64748b;">${i.jabatan}</span>`
        );

        this.renderList('listNoDapodik', d.lists.nodapodik, (i) => 
            `<div><strong>${i.nama}</strong><br><small>${i.lembaga}</small></div><span style="font-size:0.8em; color:#ef4444;">Cek Data</span>`
        );

        // Render Charts
        this.initCharts(d.charts);
    },

    renderList: function(elId, items, templateFn) {
        const el = document.getElementById(elId);
        if(!items || items.length === 0) {
            el.innerHTML = '<li><span style="color:#22c55e; text-align:center; width:100%;"><i class="fas fa-check"></i> Nihil / Bersih</span></li>';
            return;
        }
        let html = '';
        items.slice(0, 5).forEach(item => { html += `<li>${templateFn(item)}</li>`; });
        if(items.length > 5) html += `<li style="text-align:center; color:#3b82f6; cursor:pointer; font-size:0.8em;">+${items.length - 5} Lainnya...</li>`;
        el.innerHTML = html;
    },

    initCharts: function(d) {
        // Hapus chart lama (termasuk Usia jika ada sisa)
        ['status', 'cert', 'edu', 'usia'].forEach(k => { if(this.charts[k]) this.charts[k].destroy(); });

        // 1. PIE STATUS
        this.charts['status'] = new Chart(document.getElementById('chartStatus'), {
            type: 'pie',
            data: {
                labels: ['PNS', 'PPPK', 'GTY', 'GTT', 'Lain'],
                datasets: [{
                    data: [d.status.pns, d.status.pppk, d.status.gty, d.status.gtt, d.status.lain],
                    backgroundColor: ['#3b82f6', '#0ea5e9', '#10b981', '#f59e0b', '#cbd5e1']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{boxWidth:10, font:{size:10}} } } }
        });

        // 2. BAR PENDIDIKAN (4 Bars)
        this.charts['edu'] = new Chart(document.getElementById('chartEdu'), {
            type: 'bar',
            data: {
                labels: ['SD/SMP', 'SMA/D1', 'D2/D3', 'S1/D4', 'S2/S3'],
                datasets: [
                    { label: 'Pendidik KB', data: d.edu[0], backgroundColor: '#3b82f6' },
                    { label: 'Pendidik TK', data: d.edu[1], backgroundColor: '#1d4ed8' },
                    { label: 'Tendik KB',   data: d.edu[2], backgroundColor: '#f59e0b' },
                    { label: 'Tendik TK',   data: d.edu[3], backgroundColor: '#d97706' }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } } // Sembunyikan legend agar grafik tidak sempit
            }
        });

        // 3. NESTED DOUGHNUT CERT
        this.charts['cert'] = new Chart(document.getElementById('chartCert'), {
            type: 'doughnut',
            data: {
                labels: ['Sudah', 'Belum'],
                datasets: [
                    {   // Luar: TK
                        label: 'TK',
                        data: [d.cert.tk.sudah, d.cert.tk.belum],
                        backgroundColor: ['#22c55e', '#e2e8f0'],
                        weight: 2
                    },
                    {   // Dalam: KB
                        label: 'KB',
                        data: [d.cert.kb.sudah, d.cert.kb.belum],
                        backgroundColor: ['#15803d', '#94a3b8'],
                        weight: 1
                    }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { legend: { position: 'bottom', labels:{boxWidth:10, font:{size:10}} } } 
            }
        });
    }
};

// Inisialisasi saat menu dibuka
App.inits['ptk_paud_menu'] = function() {
    App.ptkPaudMenu.refresh();
};

// Inisialisasi saat menu dibuka
App.inits['ptk_paud_menu'] = function() {
    App.ptkPaudMenu.refresh();
};

document.addEventListener('DOMContentLoaded', App.init);
</script>